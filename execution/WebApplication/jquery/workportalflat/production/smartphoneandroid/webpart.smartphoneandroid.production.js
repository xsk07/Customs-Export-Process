if(bizagi.loader.registerMobileWebpart){bizagi.loader.registerMobileWebpart(["newcase","activity","activityFeed","caseProperties","caseTemplates","caseTemplatesOptions","dashBoard","discussionCase","files","filterBar","homePortal","loadForm","menu","menuHome","overviewPlan","render","renderTemplates","searchesList","shortCut","sortBar","stakeHolder","startForm","stuff","summaryActivity","summaryCase","syncErrors","taskFeed"])};bizagi.workportal.webparts.webpart.extend("bizagi.workportal.webparts.newcase",{},{init:function(e,t,a){var i=this;i._super(e,t,a),i.isMobileDevice=bizagi.util.isMobileDevice(),i.online=i.dataService.online,i.enableOfflineForm=bizagi.util.hasOfflineFormsEnabled(),i.isOfflineFormsV2Supported=i.isMobileDevice&&bizagi.util.isOfflineFormsV2Supported(),bizagi.webpart.subscribe("newcase-refresh",function(e,t){t&&t.refreshCurrentStatus?i.refreshCurrentStatus():i.renderContent({status:"recent"})}),bizagi.webpart.subscribe("createNewCase",function(e,t){return t.notification?t.isBatch?i.createNewCaseNotification(t):i.hasStartForm(t):i.createNewCase(t)}),bizagi.webpart.subscribe("createNewCase-startForm",function(e,t){if(bizagi.util.isNativePluginSupported()&&bizagi.util.isAndroidDevice()){var a={};return a.idProcess=t.idProcess,a.displayName=t.displayName||"",i.createNewCase(a)}})},renderContent:function(e){var t=this;t.online=t.dataService.online,t.currentParams=e;var a=$.Deferred(),i=kendo.template(t.getTemplate("newcase"),{useWithBlock:!1});t.content=i({online:t.online}),$("#content-newCase-drawer",t.canvas).empty(),$("#content-newCase-drawer",t.canvas).html(t.content),$(".km-content:visible").data("kendoMobileScroller")&&$(".km-content:visible").data("kendoMobileScroller").reset();var n=$("#select-process-type",t.canvas).kendoMobileButtonGroup(),r=bizagi.localization.getResource("workportal-widget-newcase-title"),o=e.breadCrumb||[{name:r}];t.changeBreadcrumb(o);var s=e.status||"recent";"recent"===s?n.data("kendoMobileButtonGroup").select(0):n.data("kendoMobileButtonGroup").select(1);var l={status:s,idApp:e.idApp,idCategory:e.idCategory};$(".bz-newcase-list",t.canvas).kendoMobileListView({filterable:!1,template:t.getListTemplate(l),dataBound:function(){$(".bz-newcase-list",t.canvas).on("click","li",function(e){var a=$(this);e.preventDefault(),e.stopPropagation();var i={item:$(".bz-newcase-item",a).data("item")||{},title:$.trim(a.text())},n=t.selectListElement(i,o);n.idProcess?bizagi.util.parseBoolean(bizagi.currentUser.isMultiOrganization)?!0===t.online?t.createOrganizationListByUser(n):$.notifier.add({title:"Error",class_name:"error",text:bizagi.localization.getResource("workportal-offline-error-user-multiorganization","Your user belongs to more than one organization and this device is currently offline. Offline case creation is disabled for users who belong to multiple organizations"),sticky:!0}):t.createNewCase(n):t.renderContent(n)})}});var c={};return bizagi.loading.start(),$.when(t.getData(l)).done(function(e){c=e,$(".bz-newcase-list",t.canvas).data("kendoMobileListView").setDataSource(c),a.resolve()}).fail(function(e){a.resolve()}).always(function(){bizagi.loading.stop()}),$(".bz-grouped-buttons-all, .bz-grouped-buttons-recent",t.canvas).click(function(){$(".km-filter-form",t.canvas).remove(),$(".bz-newcase-list",t.canvas).data("kendoMobileListView").destroy(),$(this).hasClass("bz-grouped-buttons-all")?t.renderContent({status:"all"}):t.renderContent({status:"recent"})}),$(".bz-newcase-search",t.canvas).keyup(function(){c._filter={logic:"or",filters:[{ignoreCase:!0,field:"appName",operator:"contains",value:this.value},{ignoreCase:!0,field:"categoryName",operator:"contains",value:this.value},{ignoreCase:!0,field:"displayName",operator:"contains",value:this.value}]},$(".bz-newcase-list",t.canvas).data("kendoMobileListView").setDataSource(c)}),a.promise()},selectListElement:function(e,t){var a=this;a.online=a.dataService.online;var i=e.item,n={},r=$.trim(i.categoryName||""),o=bizagi.util.parseBoolean(i.isProcess||!0),s=bizagi.util.parseBoolean(i.hasOfflineForm)||!1,l=bizagi.util.parseBoolean(i.forceOffline)&&bizagi.util.isOfflineExecutionSupportedInCurrentEnvironment()||!1,c=bizagi.util.parseBoolean(i.isAdhocProcess)||!1,d=i.appId||null,u=i.idCategory||"",p=i.idWFClass||"",m=i.guidCategory||"";if(d)$(".bz-newcase-list").data("kendoMobileListView").destroy(),$(".km-filter-form").remove(),t.push({name:i.appName||"App",value:d,isApp:!0}),n={status:"all",idApp:d,breadCrumb:t};else if(o){var f=bizagi.util.isEmpty(p)?u:p;f=c?m:f;var g={};g.idProcess=f,g.displayName=e.title,g.isAdhocProcess=c;var h=!a.isOfflineFormsV2Supported&&s&&a.enableOfflineForm,v=a.isOfflineFormsV2Supported&&s&&a.enableOfflineForm&&!a.dataService.online,b=a.isOfflineFormsV2Supported&&l;(h||v||b)&&(g.idOrganization=null,g.isOfflineForm=s,g.process=g.displayName,g.categoryName=r),bizagi.idCategory=f,$("#newCase-drawer").data("kendoMobileDrawer").hide(),n=g}else $(".bz-newcase-list").data("kendoMobileListView").destroy(),$(".km-filter-form").remove(),t.push({name:r,value:u}),n={status:"all",idCategory:u,breadCrumb:t};return n},getData:function(e){var t=this,a=new $.Deferred;if("recent"===e.status){var i={onlyLastProcesses:!0,numberOfProcesses:5};$.when(t.dataService.getRecentProcesses(i)).done(function(e){t.dataSource=new kendo.data.DataSource({transport:{read:function(t){t.success(e.processes)}}}),a.resolve(t.dataSource)}).fail(function(e){var t=bizagi.util.processFailMessage(e);a.reject(t)})}else{var n={};e.idCategory?n={idCategory:e.idCategory}:e.idApp&&(n={idApp:e.idApp}),$.extend(n,{enableOfflineForm:t.enableOfflineForm}),$.when(t.dataService.getCategories(n)).done(function(e){t.dataSource=new kendo.data.DataSource({transport:{read:function(a){var i=t.performCategories(e);a.success(i)}}}),a.resolve(t.dataSource)}).fail(function(e){a.reject($.parseJSON(e.responseText))})}return a.promise()},getListTemplate:function(e){var t=this,a="recent"===e.status?"newCase-categories-recent-process":"newCase-categories-tree";return t.getTemplate(a)},changeBreadcrumb:function(e){var t=this,a=t.getTemplate("newcase-breadcrum"),i=kendo.template(a,{useWithBlock:!1}),n=$(".bz-newcase-title",t.canvas);n.html(i(e)),n.click(function(){t.renderContent(t.clickBreadcrumb(e))})},clickBreadcrumb:function(e){var t={};return e.length>=2?(e.pop(),t={status:"all",breadCrumb:e},e[e.length-1].isApp&&!0===e[e.length-1].isApp?t.idApp=e[e.length-1].value:t.idCategory=e[e.length-1].value):1===e.length&&(t={status:"all"}),t},createNewCase:function(e){var t=this,a=new $.Deferred;if(e.forceOffline&&(e.isOfflineForm=!0),bizagi.loading.start(),e.isOfflineForm){var i={idWfClass:e.idProcess||e.idWFClass,displayName:e.displayName,isOfflineForm:e.isOfflineForm,categoryName:e.categoryName};return t.createCase(i)}return t.dataService.startProcess(e).done(function(i){var n=t.buildCaseParameters(e,i);n.hasStartForm?(n.displayName=e.displayName,t.publish("render-start-form",{params:n})):t.publish("changeCase",n),t.isTabletDevice&&bizagi.webpart.publish("bz-summary-item-clear"),t.publish("bz-update-list-cases",{updateDataList:!0}),a.resolve()}).fail(function(e){var t=$.parseJSON(e.responseText);bizagi.showMessageBox(t.message,"Error"),a.fail()}).always(function(){bizagi.loading.stop()}),a},hasStartForm:function(e){var t=this;return e=e||{},!e.hasStartForm&&e.isShortcut?t.startShortcutProcess(e):t.createNewCaseNotification(e)},startShortcutProcess:function(e){var t=this;t.dataService.actionCreateCase(e).done(function(e){var a=e.caseId;bizagi.loading.stop(),t.dataService.getCaseAssignees({idCase:a}).done(function(e){var i=e.assignees,n=!1;if(void 0!==i&&i.length>0){var r=bizagi.currentUser.idUser;void 0!==i.find(function(e){return e.idUser==r})&&(n=!0)}if(n)t.publish("render-case",{action:"routing",idCase:a});else{var o=bizagi.localization.getResource("workportal-widget-templateengine-action-process-notification");o=o.replace("{0}",a),$.notifier.add({text:o})}})}).fail(function(e){var t=$.parseJSON(e.responseText);bizagi.loading.stop(),bizagi.showMessageBox(t.message,"Error")})},createNewCaseNotification:function(e){var t=this,a=new $.Deferred;return e.hasStartForm?(t.publish("render-start-form",{params:e}),t.publish("bz-update-list-cases",{updateDataList:!0}),bizagi.loading.stop(),a.resolve()):t.dataService.actionCreateCase(e).done(function(i){var n=e.mapping||{},r=e.type||"Process",o={showProcess:!1,isMultiInstance:e.isMultiInstance,notification:!0,hasStartForm:i.hasStartForm,idProcess:i.idProcess,displayName:e.displayName,mapping:n,type:r,idParentCase:e.idParentCase};if($.extend(o,i.caseInfo),e.isBatch){var s=bizagi.localization.getResource("workportal-widget-templateengine-action-process-notification"),l=s.replace("{0}",i.caseNumber),c=printf(bizagi.localization.getResource("workportal-widget-templateengine-message-summary-create-cases-singular"),1);$.notifier.add({title:c,text:l,sticky:!0}),t.publish("bz-update-list-cases",{updateDataList:!0}),bizagi.loading.stop()}else t.dataService.getCaseAssignees({idCase:i.caseId}).done(function(e){var a=e.assignees,n=!1;if(void 0!==a&&a.length>0){var r=bizagi.currentUser.idUser;void 0!==a.find(function(e){return e.idUser==r})&&(n=!0)}if(t.publish("bz-update-list-cases",{updateDataList:!0}),bizagi.loading.stop(),n)t.publish("render-case",{action:"routing",idCase:i.caseId});else{var o=bizagi.localization.getResource("workportal-widget-templateengine-action-process-notification"),s=o.replace("{0}",i.caseNumber),l=printf(bizagi.localization.getResource("workportal-widget-templateengine-message-summary-create-cases-singular"),1);$.notifier.add({title:l,text:s,sticky:!0})}});a.resolve()}).fail(function(e){var t=$.parseJSON(e.responseText);bizagi.loading.stop(),$.notifier.add({title:"Error",class_name:"error",text:t.message,sticky:!0}),a.fail()}),a},createOrganizationListByUser:function(e){var t=this,a=new $.Deferred;return t.isAdjusted=!1,t.dataService.getOrganizationsByUserList().done(function(i){var n=t.getTemplate("newCase-modal-multiorganization"),r=kendo.template(n,{useWithBlock:!1});$(r({list:i.response,idWfClass:e.idProcess,isAdhocProcess:e.isAdhocProcess||!1})).kendoMobileModalView({close:function(){this.destroy(),this.element.remove()},useNativeScrolling:!0,modal:!1}),t.configureModalHandlers();var o=$(".bz-wp-modal-organization").data("kendoMobileModalView");$(".bz-wp-modal-organization-footer div.km-rightitem").addClass("inactive"),o.open();var s=function(){var e,a=$(".bz-wp-modal-organization-list",this.element).height();if(0!==a){var i=$(".bz-wp-modal-organization-content",this.element).width(),n=$(".bz-wp-modal-organization-header",this.wrapper).height()+$(".bz-wp-modal-organization-footer",this.wrapper).height(),r=window.innerHeight,o=window.innerWidth;a+n>=r?e=r-20:(e=a+n,"tablet_ios"!==bizagi.util.detectDevice()?e+=t.isAdjusted?90===Math.abs(window.orientation)?8:35:20:e+=90===Math.abs(window.orientation)?20:22);var s=(r-e)/2,l=(o-i)/2;this.wrapper.parent().css("top",s),this.wrapper.parent().css("left",l),this.wrapper.parent().css("height",e),t.isAdjusted=!0}};o.adjustSize=s,o.adjustSize(),window.addEventListener("orientationchange",function(){bizagi.util.isAndroidDevice()?setTimeout(function(){o.adjustSize()},500):o.adjustSize()},!1),a.resolve()}).fail(function(e){if(e.responseText){var t=$.parseJSON(e.responseText);$.notifier.add({title:"Error",class_name:"error",text:t.message,sticky:!0})}else{var i=bizagi.util.processFailMessage(e);bizagi.showMessageBox(i,"Error")}a.fail()}).always(function(){bizagi.loading.stop()}),a},configureModalHandlers:function(){var e=this;$(".bz-wp-modal-organization").delegate(".bz-wp-modal-organization-footer .km-leftitem","click",function(){$(".bz-wp-modal-organization").data("kendoMobileModalView").close()}),$(".bz-wp-modal-organization").delegate(".bz-wp-modal-organization-list > li","click",function(e){var t=$(e.target);$(".bz-wp-modal-organization-list > li").removeClass("bz-wp-modal-organization-list-item-selected"),$(".bz-wp-modal-organization-footer div.km-rightitem").hasClass("inactive")&&($(".bz-wp-modal-organization-footer div.km-rightitem").removeClass("inactive"),$(".bz-wp-modal-organization-footer div.km-rightitem").addClass("active")),t.addClass("bz-wp-modal-organization-list-item-selected")}),$(".bz-wp-modal-organization").delegate(".bz-wp-modal-organization-footer .km-rightitem","click",function(t){if(t.stopPropagation(),!$(".bz-wp-modal-organization-footer div.km-rightitem").hasClass("inactive")){var a=$(this).closest(".bz-wp-modal-organization"),i=(a.data("adhoc"),a.data("workflow")),n=$(".bz-wp-modal-organization-list-item-selected").data("id"),r={};return r.idProcess=i,void 0!=n&&(r.idOrganization=n),e.createNewCase(r)}})},createCase:function(e){var t=this,a=new $.Deferred,i=!e.isOfflineForm||t.dataService.downloadStartFormOnDemand(e.idProcess||e.idWfClass);return $.when(i).then(function(){return t.dataService.createNewCase(e)}).then(function(i){e.isOfflineForm&&(i.offlineType="start"),t.publish("changeCase",i),t.isTabletDevice&&bizagi.webpart.publish("bz-summary-item-clear"),t.publish("bz-update-list-cases",{updateDataList:!0}),a.resolve()}).fail(function(e){var t=$.parseJSON(e.responseText);bizagi.showMessageBox(t.message,"Error"),a.fail()}).always(function(){bizagi.loading.stop()}),a},buildCaseParameters:function(e,t){var a;if(t.oldVersion)a=t,a.hasStartForm=!e.isOfflineForm&&t.hasStartForm||!1,a.displayName=e.displayName;else{var i=e.mapping||{},n=e.type||"Process";a={showProcess:!0,fromNewCase:!0,isMultiInstance:e.isMultiInstance,hasStartForm:!e.isOfflineForm&&t.hasStartForm,idProcess:t.idProcess,displayName:e.displayName,mapping:i,type:n,idParentCase:e.idParentCase},$.extend(a,t.caseInfo)}return a},performCategories:function(e){var t="";if(e.category)try{t=e.category.map(function(e,t){return e.subCategories&&e.subCategories.length>0&&(e.subCategories=[]),e})}catch(e){t="",bizagi.log("Error to map array")}return t},refreshCurrentStatus:function(){this.renderContent(this.currentParams)}}),bizagi.workportal.webparts.webpart.extend("bizagi.workportal.webparts.activity",{},{init:function(e,t,a){var i=this;i._super(e,t,a),i.template=kendo.template(i.getTemplate("activity-tmpl"),{useWithBlock:!1})},renderContent:function(){var e=this;return e.dataService.getFavourites().then(function(t){return e.content=e.template(t),e.content})},postRender:function(){this.setEventHandlers()},setEventHandlers:function(){var e=this;$(".wp-myfavorites-all",e.content).bind("click",function(){e.publish("homeportalShow",{what:"myFavorites"})})}}),bizagi.workportal.webparts.webpart.extend("bizagi.workportal.webparts.activityFeed",{PAGE_SIZE:30},{init:function(e,t,a){var i=this;i._super(e,t,a),i.properties={},i.properties.page=1,i.properties.pageSize=i.Class.PAGE_SIZE,i.properties.totalPages=0,i.canvas.bind("view-initialized",function(){i.initializeListView()})},renderContent:function(e){var t=this;return kendo.template(t.getTemplate("main-activityFeed-tmpl"),{useWithBlock:!1})({})},postRender:function(e){},initializeListView:function(){var e=this,t=e.getTemplate("item-activityFeed-tmpl");e.listView=new kendo.mobile.ui.ListView($("#activity-list",e.content),{headerTemplate:'#=(value.split("|"))[1]#',fixedHeaders:!0,template:t,selectable:"single"}),e.getDataSource({page:1,pageSize:e.properties.pageSize}).then(function(t){e.listView.setDataSource(t)})},getDataSource:function(e){return this.dataService.getCurrentActivities(e).then(function(e){return new kendo.data.DataSource({data:e,schema:{data:"elements",total:"totalRecords"},sort:[{field:"endDate",dir:"asc"},{field:"idworkitem",dir:"asc"}],group:{field:"group"}})})}}),bizagi.workportal.webparts.activityFeed.extend("bizagi.workportal.webparts.activityFeed",{},{init:function(e,t,a){this._super(e,t,a),bizagi.webpart.subscribe("homeportalShow-taskFeed",function(e,t){})}}),bizagi.workportal.webparts.rendermanager.extend("bizagi.workportal.webparts.caseProperties",{},{init:function(e,t,a){var i=this;i._super(e,t,a),i.caseProperties={}},renderContent:function(e){var t=this,a=$.Deferred(),i=setInterval(function(){bizagi.menuSecurityPromise&&(bizagi.menuSecurityPromise.done(function(){bizagi.menuSecurity.Files||(t.showFilesMenu=!1),bizagi.menuSecurity.Comments||(t.showDiscussionsMenu=!1)}),clearInterval(i))},1e3);return a.resolve(""),a.promise()},postRender:function(e){this.configureHandlers()},configureHandlers:function(){var e=this;e.subscribe("case-properties-init",function(t,a){e.caseProperties=a.params,e.showCasePropertiesOptions=e.caseProperties.allowProperties||!1,e.showFilesMenu=!0,e.showDiscussionsMenu=!0,e.caseProperties.idCase&&$.when(e.getCaseData()).done(function(){bizagi.util.isTabletDevice()&&e.renderCaseSummary();var t=!0,i=void 0!=e.caseProperties.isOfflineForm&&!0===e.caseProperties.isOfflineForm,n=bizagi.util.isConnected();i&&bizagi.util.isTabletDevice()&&(t=!1),i&&!n&&(bizagi.util.isTabletDevice()?t=!1:(e.showDiscussionsMenu=!1,e.showFilesMenu=!1,e.showSummaryFormMenu=!1)),t&&e.configureCaseFolderActionsheet(a.element)})}),bizagi.webpart.subscribe("show-plan-summary",function(t){e.caseProperties.caseDetails&&(e.caseProperties.caseDetails.isActivitySummary=!1,e.renderCaseSummary())}),bizagi.webpart.subscribe("show-case-summary",function(t){e.caseProperties.caseDetails&&(e.caseProperties.caseDetails.isActivitySummary=!0,e.renderCaseSummary())})},renderSummary:function(){this.renderCaseSummary()},configureCaseFolderActionsheet:function(e){var t=this;$(".bz-render-dynamic",e).show().actionSheet({titleLabel:t.getResource("workportal-project-casedashboard-casefolder","case folder"),setDataToShow:function(){return t.getCasePropertiesOptions()},actionClicked:function(e){switch(delete t.caseProperties.data,e.guid){case 0:t.caseProperties.summaryForm=!0,t.publish("render-case",t.caseProperties);break;case 1:t.navigate?t.navigate("#overview-plan"):t.navigator.navigate("#overview-plan"),t.publish("bz-rnd-overviewplan",t.caseProperties);break;case 2:t.caseProperties.summaryForm=!1,t.publish("render-case",t.caseProperties);break;case 3:t.navigate?t.navigate("#discussion-list"):t.navigator.navigate("#discussion-list");var a={globalParent:t.caseProperties.radNumber||t.caseProperties.idCase,dataPlan:{idPlan:t.caseProperties.plan?t.caseProperties.plan.id:null,contextualized:t.caseProperties.plan?t.caseProperties.plan.contextualized:void 0}};t.publish("bz-rnd-discussion",a);break;case 4:t.navigate?t.navigate("#files-list"):t.navigator.navigate("#files-list");var a={globalParent:t.caseProperties.radNumber||t.caseProperties.idCase,dataPlan:{idPlan:t.caseProperties.plan?t.caseProperties.plan.id:null,contextualized:t.caseProperties.plan?t.caseProperties.plan.contextualized:void 0}};t.publish("bz-rnd-files",a);break;case 5:bizagi.webpart.publish("show-case-summary");break;default:t.publish("render-case",t.caseProperties)}},withoutCancel:!0})},getCaseData:function(){var e=this,t=new $.Deferred;return bizagi.loading.start(),bizagi.util.isNativePluginSupported()&&void 0!==bizagiapp.getCase&&e.caseProperties.isOfflineForm?bizagiapp.getCase(e.caseProperties.idCase,function(a){var i=JSON.parse(a);e.caseProperties.caseDetails=i,bizagi.util.isEmpty(i.idPlan)?(e.showSummaryFormMenu=i.showForm,e.showSummaryPlanMenu=!1,t.resolve()):(e.showSummaryFormMenu=!1,e.showSummaryPlanMenu=!0,e.caseProperties.plan={},e.caseProperties.plan.id=i.idPlan,e.caseProperties.plan.contextualized=i.contextualized,t.resolve()),bizagi.loading.stop()},function(e){bizagi.loading.stop(),t.reject()}):e.dataService.summaryCaseDetails({idCase:e.caseProperties.idCase,eventAsTasks:e.caseProperties.eventAsTasks||!1,onlyUserWorkItems:e.caseProperties.onlyUserWorkItems||!1,idWorkitem:e.caseProperties.idWorkitem,isOfflineForm:e.caseProperties.isOfflineForm||!1,offlineType:e.caseProperties.offlineType}).done(function(a){e.caseProperties.caseDetails=a,bizagi.util.isEmpty(a.idPlan)?(e.showSummaryFormMenu=a.showForm,e.showSummaryPlanMenu=!1,t.resolve()):(e.showSummaryFormMenu=!1,e.showSummaryPlanMenu=!0,e.caseProperties.plan={},e.caseProperties.plan.id=a.idPlan,e.caseProperties.plan.contextualized=a.contextualized,t.resolve())}).fail(function(){t.reject()}).always(function(){bizagi.loading.stop()}),t.promise()},getCasePropertiesOptions:function(){var e=this,t=[],a=$(".bz-form",e.canvas).hasClass("ui-bizagi-summary-form");(void 0===e.showCasePropertiesOptions||e.showCasePropertiesOptions&&!0===e.showCasePropertiesOptions)&&(e.showSummaryPlanMenu&&t.push({guid:1,displayName:e.getResource("workportal-project-casedashboard-view-plan"),icon:"bz-mo-icon bz-inbox"}),e.showDiscussionsMenu&&t.push({guid:3,displayName:e.getResource("workportal-project-casedashboard-discussions"),icon:"bz-mo-icon bz-discussions-case"}),e.showFilesMenu&&t.push({guid:4,displayName:e.getResource("workportal-project-casedashboard-files"),icon:"bz-mo-icon bz-clip"})),e.showSummaryFormMenu&&!a&&t.push({guid:0,displayName:e.getResource("workportal-adhoc-processes-summary-form-button","summary form"),icon:"bz-mo-icon bz-note"}),a&&t.push({guid:2,displayName:e.getResource("workportal-project-casedashboard-activity","Activity"),icon:"bz-mo-icon bz-paper"});var i=e.getSummaryMenu();return i&&t.push(i),t}}),bizagi.workportal.webparts.caseProperties.extend("bizagi.workportal.webparts.caseProperties",{},{init:function(e,t,a){this._super(e,t,a)},postRender:function(e){this._super(e)},renderCaseSummary:function(){var e=this;e.publish("bz-summary-case",e.caseProperties)},getSummaryMenu:function(){return{guid:5,displayName:this.getResource("workportal-taskfeed-summary"),icon:"bz-mo-icon bz-files-document"}},configureHandlers:function(){this._super()}}),bizagi.workportal.webparts.webpart.extend("bizagi.workportal.webparts.caseTemplates",{PAGE_SIZE:10},{init:function(e,t,a){var i=this;i._super(e,t,a),i.actionsEvents=new bizagi.actionsEvents(t,"Cases",{homePortalFramework:i.homePortalFramework}),i.caseUsers=new bizagi.caseUsers(t,"Cases",a),i.caseTemplatesGrid=kendo.template(i.getTemplate("case-templates-list"),{useWithBlock:!1}),i.caseTemplatesItem=kendo.template(i.getTemplate("case-templates-item"),{useWithBlock:!1}),i.caseTemplatesActions=kendo.template(i.getTemplate("case-templates-actions"),{useWithBlock:!1}),i.caseTemplatesAssignees=kendo.template(i.getTemplate("case-templates-assignees"),{useWithBlock:!1}),i.caseTemplatesWorkOnIt=kendo.template(i.getTemplate("case-templates-workOnIt"),{useWithBlock:!1}),i.currentPage=1,i.pageSize=i.Class.PAGE_SIZE,i.totalPages=0,i.selectedItems=[],i.entityCollection=[],i.imagesx25={},i.imagesx45={},i.tEnginePromise},renderContent:function(e){return this.caseTemplatesGrid({})},postRender:function(e){var t=this;t.canvas.bind("view-initialized",$.proxy(t.onAfterViewInitialized,t)),t.configureHandler()},configureHandler:function(){var e=this;bizagi.webpart.subscribe("homeportalShow-caseTemplates",function(t,a){var i,n=e.canvas.data("kendoMobileView").contentElement();if(a.onlyFavorites)i={scrollReset:!0,skipAggrupate:!0,taskState:"all",onlyFavorites:!0,myActivities:!0,refresh:a.refresh||!1,idworkflow:void 0!==a?a.idworkflow||null:null,idCase:a.idCase};else switch(i={scrollReset:!0,skipAggrupate:!0,onlyFavorites:!1,refresh:a.refresh||!1,idworkflow:void 0!==a?a.idworkflow||null:null,idCase:a.idCase},a.subcategory){case"ontime":i.taskState="Green";break;case"overdue":i.taskState="Red";break;case"risk":i.taskState="Yellow";break;case"pendings":default:i.taskState="all"}return e.renderTemplatesOptions=i,i.idCase?(i.canvasElement=$('li.wp-case-template-item[data-idcase="'+i.idCase+'"]',n),$(".wp-item-container",i.canvasElement).empty()):($("#tmpl-list",e.content).empty(),e.currentPage=1),i.refresh||bizagi.webpart.publish("display-caseTemplateOptions",i),$.proxy(e.updateCases,e)(i)})},updateCases:function(e){var t,a=this,i={onlyFavorites:e.onlyFavorites,taskState:e.taskState};return e.idCase?(t={idCase:e.idCase||null},$.when(a.getCasesData(t,i)).then(function(i){return a.entityCollection=a.entityCollection.concat(i.entities),a.getCasesTemplates(i,{idCase:t.idCase,canvasElement:e.canvasElement})})):(e.scrollReset&&a.canvas.data("kendoMobileView").scroller.reset(),t={page:a.currentPage,pageSize:a.pageSize},e.idworkflow&&(t.idWorkflow=e.idworkflow),$.when(a.getCasesData(t,i)).then(function(e){if(a.currentPage=e.currentPage,a.totalPages=e.totalPages,a.entityCollection=a.entityCollection.concat(e.entities),e.totalRecords>0)return a.getCasesTemplates(e,{});a.showNoItems(!0)}))},getCasesData:function(e,t){var a=this;return a.showNoItems(!1),a.showLoadMore(!1),t.onlyFavorites?this.dataService.getActivitiesData(e):this.dataService.getPendingsData($.extend(e,{taskState:t.taskState}))},paintHeaderFooterButtons:function(e){var t=this;t.caseUsers.getUsers(e).then(function(a){t.showUsers(e),t.showUsersImagesx25(),t.showUsersImagesx45()}),t.actionsEvents.getEvents(e).done(function(){t.actionsEvents.getActions(e).done(function(){t.showActionsEvents(e)})})},showUsers:function(e){for(var t,a=this,i=-1;t=e[++i];){var n=t.item,r=$(".header-section",n),o=$(".users-section",n).kendoMobileScroller();o=o.data("kendoMobileScroller").scrollElement;var s=a.caseTemplatesAssignees;o.append(s({assignees:t.users})),$("div",$("div.hs-image.createdby",r)).text(t.createdBy.initials).data("user-id",t.createdBy.idUser),void 0===a.imagesx25[t.createdBy.idUser]&&(a.imagesx25[t.createdBy.idUser]={canvas:[]}),a.imagesx25[t.createdBy.idUser].canvas.push($("div.hs-image.createdby",r)),t.assignees.length>0&&t.assignees[0].idUser!==t.createdBy.idUser?($("div",$("div.hs-image.first-asignee",r)).text(t.assignees[0].initials).data("user-id",t.createdBy.idUser),void 0===a.imagesx25[t.assignees[0].idUser]&&(a.imagesx25[t.assignees[0].idUser]={canvas:[]}),a.imagesx25[t.assignees[0].idUser].canvas.push($("div.hs-image.first-asignee",r))):$("div.hs-image.first-asignee",r).hide();for(var l=0;l<t.users.length;l++)void 0===a.imagesx45[t.users[l].idUser]&&(a.imagesx45[t.users[l].idUser]={canvas:[]}),a.imagesx45[t.users[l].idUser].canvas.push($('div.no-picture[data-user-id="'+t.users[l].idUser+'"]',o));if(t.users.length>2){var c=$("div.hs-image.more-asignee",r);c.css("display","inline-block"),$("span",c).text("+"+(t.users.length-2))}a.showWorkOnIt(t)}},showActionsEvents:function(e){for(var t,a=this,i=a.caseTemplatesActions,n=-1;t=e[++n];){var r=$(".actions-section",t.item),o=[];if($.merge(o,t.events),t.actions)for(var s=0,l=t.actions.length;s<l;s++)0!==t.actions[s].multiplicity&&1!==t.actions[s].multiplicity||o.push(t.actions[s]);var c={more:!1,buttons:o};o.length>0&&($(".wp-action-space",r).remove(),o.length>2&&(c.more=!0)),r.prepend(i(c)),a.executeAction(r,o,t)}},showUsersImagesx25:function(){var e=this,t=$.map(e.imagesx25,function(e,t){return t});$.when(e.dataService.getUsersImages({width:25,height:25,square:!0},t)).done(function(t){for(var a=0;a<t.length;a++){var i=t[a];e.imagesx25[i.id].picture=i.picture}jQuery.each(e.imagesx25,function(e,t){var a=t.canvas,i=t.picture;if(void 0!==i)for(var e=0,n=a.length;e<n;e++){var r=$("<img>").attr("src","data:image/png;base64,"+i);a[e].html(r)}})})},showUsersImagesx45:function(){var e=this,t=$.map(e.imagesx45,function(e,t){return t});$.when(e.dataService.getUsersImages({width:45,height:45,square:!0},t)).done(function(t){for(var a=0,i=t.length;a<i;a++){var n=t[a];e.imagesx45[n.id].picture=n.picture}jQuery.each(e.imagesx45,function(e,t){var a=t.canvas,i=t.picture;if(void 0!==i)for(var e=0,n=a.length;e<n;e++){var r=$("<img>").attr("src","data:image/png;base64,"+i);a[e].html(r),a[e].removeClass("no-picture")}})})},markFavorite:function(e,t){var a=this;$(".wp-action-favorite",e).unbind("click").bind("click",function(){var e,i=this,n=$(i).data("id-object");bizagi.util.smartphone.startLoading(a.pane),void 0!==n?(e={idObject:n},$.when(a.dataService.delFavorite(e)).done(function(e){bizagi.util.parseBoolean(e.deleted)&&($(i).removeData("id-object"),$(i).removeAttr("data-id-object"),$(i).addClass("no-mark"))}).always(function(){bizagi.util.smartphone.stopLoading()})):(e={idObject:t,favoriteType:"CASES"},$.when(a.dataService.addFavorite(e)).done(function(e){$(i).data("id-object",e.idFavorites),$(i).removeClass("no-mark")}).always(function(){bizagi.util.smartphone.stopLoading()}))})},getSelectedItems:function(){return this.selectedItems},addSelectedItem:function(e){this.selectedItems.push(e)},deleteSelectedItem:function(e){this.selectedItems.splice(this.selectedItems.indexOf(e),1)},findDataItem:function(e){return this.entityCollection.find(function(t){return t.surrogateKey==e})},handleDataNavigation:function(){var e=this;e.engine.subscribe("onLoadDataNavigation",function(t,a){a.filters=[],e.homePortalFramework._cleanContext(),e.homePortalFramework.addContext(a.data),e.publish("homeportalShow",{what:"stuffTemplates",title:a.data.displayName,params:$.extend(a,{unableBackButton:!1})})})}}),bizagi.workportal.webparts.caseTemplates.extend("bizagi.workportal.webparts.caseTemplates",{},{postRender:function(e){var t=this;t._super(e),t.tEnginePromise=$.when(t.workportalFacade.modules[t.workportalFacade.Class.render_module]).then(function(){var a=e.proxyPrefix||t.dataService.serviceLocator.proxyPrefix,i=new bizagi.render.services.service({proxyPrefix:a}),n=new bizagi.rendering.smartphone.factory(i);return $.when(n.initAsyncStuff()).then(function(){t.engine=new bizagi.templateEngine({renderFactory:n,cache:!0,forcePersonalizedColumns:!0}),t.handleDataNavigation()})})},configureHandler:function(){var e=this;e._super(),$("#tmpl-list",e.content).delegate("div.wp-action-item-check","click",function(t){var a=this.classList.contains("selected"),i=e.findDataItem($(this).data("surrogatekey"));a?($(this).removeClass("selected"),e.deleteSelectedItem(i)):($(this).addClass("selected"),e.addSelectedItem(i)),e.selectedItems.length>0?($(".wp-ly-secondary-header",e.canvas).show(),$(".wp-ly-principal-header",e.canvas).hide()):($(".wp-ly-secondary-header",e.canvas).hide(),$(".wp-ly-principal-header",e.canvas).show())}),$(".bz-case-templates-footer",e.content).unbind().bind("click",function(){e.pane.show(),e.currentPage++,e.updateCases($.extend(e.renderTemplatesOptions,{scrollReset:!1}))}),$("#tmpl-list",e.content).on("click",".header-section .hs-images",function(e){$(e.currentTarget).closest(".wp-case-template-item").addClass("users")}),$("#tmpl-list",e.content).on("click",".header-section .wp-action-item-back",function(e){$(e.currentTarget).closest(".wp-case-template-item").removeClass("users")})},onAfterViewInitialized:function(e,t){var a=this;$(".bz-header-btn5",t.header).actionSheet({setDataToShow:function(){var e=a.actionsEvents.getCommomActions(a.getSelectedItems());return 0===e.length&&bizagi.showConfirmationBox(bizagi.localization.getResource("workportal-widget-no-actions-found"),"Bizagi",!0,[{label:"Ok",action:"resolve"}]),e},actionClicked:function(e){a.actionsEvents.executeActionMultipleData(e,a.entityCollection[0],a.getSelectedItems())}}),$(".wp-ly-secondary-header .bz-header-back-btn",t.header.context).bind("click",function(e){a.removeShowGrouping()})},showWorkOnIt:function(e){var t=this,a=t.caseTemplatesWorkOnIt,i=bizagi.localization.getResource("workportal-case-dialog-box-workOnIt");$(".actions-section",e.item).append(a({displayName:i,icon:"workonit",type:"WorkOnIt"}))},removeShowGrouping:function(){var e=this;e.selectedItems=[],$("div.wp-action-item-check",e.content).removeClass("selected"),$(".wp-ly-secondary-header",e.canvas).hide(),$(".wp-ly-principal-header",e.canvas).show()},showLoadMore:function(e){var t=this;e?t.currentPage===t.totalPages||0===t.totalPages?$(".bz-case-templates-footer",t.content).hide():$(".bz-case-templates-footer",t.content).show():$(".bz-case-templates-footer",t.content).hide()},showNoItems:function(e){var t=this;e?$(".bz-case-templates-no-content",t.content).show():$(".bz-case-templates-no-content",t.content).hide()},updateCases:function(e){var t=this;bizagi.util.smartphone.startLoading(),t._super(e).then(function(e){bizagi.util.smartphone.stopLoading()})},getCasesTemplates:function(e,t){var a=this,i=$("#tmpl-list",a.content);return $.when(a.tEnginePromise).then(function(){var t=$.map(e.entities,function(e){return $.when(a.engine.render(e)).then(function(t){var n=$(a.caseTemplatesItem({idCase:e.idCase,guidFavorite:e.guidFavorite||null,surrogateKey:e.surrogateKey}));n.find(".wp-item-container").append(t);var r=n.appendTo(i);e.item=r,a.markFavorite(r,e.idCase)})});return $.when.apply($,t).then(function(){
a.paintHeaderFooterButtons(e.entities),a.showLoadMore(!0)})})},executeAction:function(e,t,a){var i=this;$(".wp-ct-action-more",e).actionSheet({setDataToShow:function(){return t},actionClicked:function(e){i.actionsEvents.executeActionSingleData(e,a)}}),$(".wp-action",e).unbind("click").bind("click",function(e){var t=bizagi.util.isTabletDevice()?e.target.closest(".wp-case-template-item"):e.target.parentElement.parentElement,n=void 0!==t.dataset.idcase?t.dataset.idcase:t.parentElement.dataset.idcase;i.executeWpAction($(this).data("action"),a),bizagi.util.smartphone.startLoading(),i.dataService.summaryCaseDetails({idCase:n}).done(function(e){e.showForm?$("#overViewMenu").show():$("#overViewMenu").hide()}).always(function(){bizagi.util.smartphone.stopLoading()})})},executeWpAction:function(e,t){this.actionsEvents.executeActionSingleData(e,t)}}),bizagi.workportal.webparts.webpart.extend("bizagi.workportal.webparts.caseTemplatesOptions",{},{init:function(e,t,a){this._super(e,t,a)},postRender:function(e){var t=this;t.configureHandler(),$(".bz-wp-cto-list",t.content).kendoMobileListView({headerTemplate:bizagi.localization.getResource("workportal-widget-processeslist-title-process"),fixedHeaders:!0,filterable:!1,template:t.itemTemplate,click:function(e){e.item.siblings().removeClass("cto-selected"),e.item.addClass("cto-selected"),t.selectOption(e.dataItem)}}),$(".bz-caseTemplatesOptions-search",t.content).keyup(function(){t.dataSource._filter={logic:"or",filters:[{ignoreCase:!0,field:"name",operator:"contains",value:this.value},{ignoreCase:!0,field:"category",operator:"contains",value:this.value}]},$(".bz-wp-cto-list",t.canvas).data("kendoMobileListView").setDataSource(t.dataSource)})},configureHandler:function(){var e=this;bizagi.webpart.subscribe("display-caseTemplateOptions",function(t,a){e.properties=a,e.displayCaseTemplateOptions(a)})},displayCaseTemplateOptions:function(e){var t=this;$.when(t.getData(e)).done(function(){$(".bz-wp-cto-list",t.content).data("kendoMobileListView").setDataSource(t.dataSource),$(".km-group-container .km-list li:first",t.content).addClass("cto-selected")}).always(function(){bizagi.loading.stop()})},getData:function(e){var t=this;return bizagi.loading.start(),$.when(t.dataService.getAllProcesses(e)).done(function(a){t.dataSource=new kendo.data.DataSource({transport:{read:function(t){var i=0,n=[],r={name:bizagi.localization.getResource("workportal-widget-inbox-all-cases"),path:"",category:"Processes",isFavorite:e.onlyFavorites||!1,guidFavorite:"",idworkflow:"",guidWFClass:"",count:0};if(void 0!==a.workflows){for(var o=0,s=a.workflows.workflow.length;o<s;o++)i+=Number(a.workflows.workflow[o].count),a.workflows.workflow[o].category="Processes";r.count=i,n.push(r),$.merge(n,a.workflows.workflow)}else n.push(r);t.success(n)}},group:{field:"category"}})})},selectOption:function(e){var t=this;t.publish("homeportalShow",{what:"caseTemplates",title:"title",params:$.extend(e,{refresh:!0,onlyFavorites:t.properties.onlyFavorites})})}}),bizagi.workportal.webparts.caseTemplatesOptions.extend("bizagi.workportal.webparts.caseTemplatesOptions",{},{init:function(e,t,a){var i=this;i._super(e,t,a),i.itemTemplate=kendo.template(i.getTemplate("case-templates-options-item"),{useWithBlock:!1})},renderContent:function(e){var t=this,a=$.Deferred(),i=t.homePortalFramework.loadComponentTemplate("case-templates-options","caseTemplatesOptions",{});return $(".caseTemplatesOptions-content",t.canvas).html(i),a.resolve(),a.promise()},postRender:function(e){this._super(e)},configureHandler:function(){this._super()}}),bizagi.workportal.webparts.webpart.extend("bizagi.workportal.webparts.dashBoard",{},{init:function(e,t,a){this._super(e,t,a)},renderContent:function(e){return this.homePortalFramework.loadComponentTemplate("dashBoard-tmpl","dashBoard",{useWithBlock:!1})},postRender:function(e){var t=this;return t.homePortalFramework.loadComponents("dashBoard",t.content).done(function(){t.configureHandlers(),t.configureSuscriptions(),$(document).trigger("fetch-offline-processes")})},configureHandlers:function(){var e=this;$(e.content).on("click",".wp-db-item",function(){var t=$(this).data("db-subcategory"),a=$(".wp-db-title",this).text();switch(t){case"favorites":e.publish("homeportalShow",{what:"caseTemplates",title:a,params:{subcategory:t,onlyFavorites:!0},transition:"overlay:right"});break;case"pendings":case"ontime":case"overdue":case"risk":e.publish("homeportalShow",{what:"caseTemplates",title:a,params:{subcategory:t},transition:"overlay:right"});break;case"taskfeed":e.goTaskFeed()}})},goTaskFeed:function(){this.publish("homeportalShow",{what:"taskFeed"})}}),bizagi.workportal.webparts.dashBoard.extend("bizagi.workportal.webparts.dashBoard",{},{init:function(e,t,a){this._super(e,t,a)},configureSuscriptions:function(){bizagi.util.isOfflineExecutionSupportedInCurrentEnvironment()&&!bizagi.util.isiOSSmartphoneDevice()&&bizagi.webpart.subscribe("homeportalShow-menuHome",function(e,t){$(document).trigger("fetch-offline-processes")})}}),bizagi.workportal.webparts.rendermanager.extend("bizagi.workportal.webparts.discussionCase",{QUALITY_PICTURE:80,LIMIT:1,EXTENSIONSIMG:["image/jpeg","jpeg","image","png","jpg"],EXTENSIONSVIDEO:["video/quicktime","quicktime","qt","mov"],EXTENSIONSAUDIO:["audio/wav","audio","wav"],PAGE_SIZE:5},{init:function(e,t,a){var i=this;i._super(e,t,a);var n=i.getTemplate("discussionCase-tmpl-main");i.templateMain=kendo.template(n,{useWithBlock:!1}),bizagi.util.mobility.discussionsViewInit=$.proxy(i.renderViewInit,i),bizagi.util.mobility.commentsViewInit=$.proxy(i.commentsViewInit,i),i.tags=[],i._discussions=[],i._attachmentsToCreate=[],i._attachments=[],i.newDiscussion=!1,i.attchDiscussions={remove:[],addition:[]}},renderContent:function(){return""},commentsViewInit:function(e){var t=this,a=e.view.scroller,i=t.getTemplate("commentsCreation-tmpl"),n=kendo.template(i,{useWithBlock:!1});$(e.view.layout.footer).append(n()),$(".bz-create-attachment",e.view.footer).kendoMobileButton(),$(".bz-create-comment",e.view.footer).kendoMobileButton(),t.configureUploadHandlers(e.view.layout.footer),t.buildUploadResolutionControl(e.view.layout.footer),a.setOptions({pullToRefresh:!0,pull:function(){setTimeout(function(){var e={guid:t._discussionGuid};t.initCommentlist(e),a.pullHandled()},400)}})},renderViewInit:function(e){var t=this;t.discussionsView=e.view,t.content=$(t.templateMain({})),e.view.contentElement().append(t.content),t.configureHandlers(t.content),t.configureDiscussionHeaderHandlers(e.view.layout),t.pane=$("#paneRender").data("kendoMobilePane"),bizagi.util.isNativeHeaderEnabled()||t.configureActionButtons($("#discussion-list",t.canvas))},configureActionButtons:function(e){var t=this;if(bizagi.override.enableFormButtons){var a=[{id:Math.ceil(1e5*Math.random()),action:"add",label:bizagi.localization.getResource("workportal-project-discussion-adddiscussion"),ordinal:1,priority:1,additional:!1}];$(e).formButtons({buttons:a,click:function(){t.openCreateDiscussion()}})}else $(e).mfb({click:function(){t.openCreateDiscussion()}})},initDiscussionList:function(e){var t=this,a=t.getTemplate("discussionCase-tmpl"),i=kendo.template(a,{useWithBlock:!1}),n=t.getCurrentUserInfo(),r=$(".bz-main-list",t.canvas);return t._globalParent=e.globalParent,r.empty(),t.discussionsView.scroller.reset(),e=e||{},t.globalParent=e.globalParent,bizagi.loading.start(),$.when(t.validateNonContextualizedPlan(e)).then(function(e){return t.dataService.getDiscussionCase(e).then(function(e){return e.length?(e.typeResource="discussion",t.organizeListsAndFormat(e).then(function(a){var o=[];$.each(e,function(i,n){t.updateTagsArray(n.tags),n.user?n.user=a.find(function(e){return e.id==n.user}):n.user={id:0,name:"general"},n.attachments&&n.attachments.length>=1&&$.each(n.attachments,function(a,n){if(t.validateFileExtensions(n.name)){var r=$.when(t.dataService.getFilesThumbnail({guids:e[i].attachments[a].guid+"",width:250,height:200,globalParent:t._globalParent})).then(function(e){n.dataAsBase64="data:image/jpg;base64,"+e[n.guid]}).fail(function(e){bizagi.log(e)});o.push(r)}})}),$.when.apply($,o).done(function(){var a=i({discussion:e,currentUser:n});t._discussions=e,$(r).append(a),t.actionListComment()})})):($("#discussion-list",t.canvas).find(".bz-warning").removeClass("hidden"),(new $.Deferred).resolve().promise())})}).fail(function(e){bizagi.showMessageBox(bizagi.localization.getResource("render-document-error-generate"),"Error")}).always(function(){bizagi.loading.stop()})},getCurrentUserInfo:function(){return{name:bizagi.currentUser.userName,id:bizagi.currentUser.idUser,picture:""}},validateNonContextualizedPlan:function(e){var t=this,a=$.Deferred();return void 0===t._contextualizedPlan||t._contextualizedPlan?a.resolve(e):$.when(t.dataService.getFirstParentPlan({idPlan:t._idPlan})).done(function(i){e.globalParent=i&&i.id?i.id:t._idPlan,a.resolve(e)}),a.promise()},openCreateDiscussion:function(e){var t=this,a={},i="";bizagi.loading.start(),void 0!==e?(a=t._discussions.find(function(t){return t.guid==e}),i=bizagi.localization.getResource("workportal-project-discussion-edit")):i=bizagi.localization.getResource("workportal-project-discussion-adddiscussion"),t.pane=t.pane||$("#paneRender").data("kendoMobilePane"),t.pane.navigate("discussion-create");var n=$("#discussion-create").data("kendoMobileView").contentElement(),r=kendo.template(t.getTemplate("discussion-create-tmpl"),{useWithBlock:!1});t.content=r(a),n.empty().append(t.content),$("#discussion-create .bz-render-header .km-view-title span",t.canvas).text(i);var o=$(".bizagi-ui-tags-plugin",n);t.tagsControl=o.uitags(t.workportalFacade,{dataSource:t.tags,value:a.tags||[]}),t.attchDiscussions={addition:a.attachments?a.attachments.slice():[],remove:[]},t.configureUploadHandlers(n),t.buildUploadResolutionControl(n),bizagi.loading.stop()},removeAttachment:function(e){for(var t=this,a=e.data("guid"),i=t.attchDiscussions.addition,n=t.attchDiscussions.remove,r=0,o=i.length;r<o;r++)if(t.getCurrentGuid(i[r])===a){var s=i.splice(r,1),l=t.getCurrentGuid(s[0]);n.push(l),r=o}e.remove()},getCurrentGuid:function(e){var t="";return e&&e.guid&&(t=e.guid),e.params&&e.params.guid&&(t=e.params.guid),t},validateDiscussion:function(e){var t=this,a={};bizagi.loading.start(),t.configureBasicParams(a,e),$.when(t.validateNonContextualizedPlan(a)).done(function(e){t.createOrUpdateDiscussion(a,e)})},configureBasicParams:function(e,t){var a=this,i=$(".bz-form-data").find('[class*="bz-val"]');e.globalParent=a.globalParent,e.guid=t,e.date=(new Date).getTime(),$.each(i,function(t,a){var i=$(a).data("value");e[i]=$(a).val()})},createOrUpdateDiscussion:function(e,t){var a=this;if(e.description&&e.name){var i=a.getDiscussionAttachments(),n=a.tagsControl.getTagsElements();a.updateTagsArray(n),e.user=bizagi.currentUser.idUser;var r={content:{name:t.name,description:t.description,globalParent:t.globalParent,user:e.user,attachments:i.attachments,guid:e.guid||Math.guid(),tags:a.tags,typeResource:"Discussion",general:!1,date:e.date},attachmentsToCreate:i.attachmentsToCreate,attachmentsToDelete:i.attachmentsToDelete};e.guid?a.dataService.editDiscussion(r).done(function(){var e="";a.initDiscussionList({globalParent:a.globalParent}),a.goBack(),bizagi.util.isNativeHeaderEnabled()&&(e="native-header "),$.notifier.add({title:"",text:bizagi.localization.getResource("workportal-project-discussion-edited"),class_name:"success",position:e,sticky:!1})}).fail(function(){a.pane.navigate("discussion-list"),$.notifier.add({title:"Error",text:bizagi.localization.getResource("workportal-project-discussion-error-edition"),class_name:"error",sticky:!1})}).always(function(){bizagi.util.smartphone.stopLoading(),a.attchDiscussions={remove:[],addition:[]}}):a.dataService.createNewDiscussion(r).done(function(){a.initDiscussionList({globalParent:a.globalParent}),a.goBack(),bizagi.loading.stop()}).fail(function(e){bizagi.log(e),bizagi.loading.stop()}).always(function(){bizagi.util.smartphone.stopLoading(),a.attchDiscussions={remove:[],addition:[]}})}else{var o=bizagi.localization.getResource("workportal-widget-admin-dimensions-comfirm-message");bizagi.showMessageBox(o,"Error"),bizagi.util.smartphone.stopLoading()}},getDiscussionAttachments:function(){var e=this,t=[],a=e.attchDiscussions,i=[];a=a||{addition:[],remove:[]};for(var n=0,r=a.addition.length-1;n<=r;n++)t.push({guid:a.addition[n].guid||a.addition[n].params.guid,name:a.addition[n].name||a.addition[n].fileName}),i.push(a.addition[n].guid||a.addition[n].params.guid);return{attachments:t,attachmentsToCreate:i,attachmentsToDelete:a.remove}},updateTagsArray:function(e){var t=this;t.tags=[];for(var a=0,i=e.length;a<i;a++){t.validateTag(e[a]).length>0||""===e[a].tag||t.tags.push(e[a])}},validateTag:function(e){return this.tags.filter(function(t){return t.guid==e.guid})},initCommentlist:function(e){var t=this;bizagi.loading.start(),e=e||{},t._discussionGuid=e.guid,t._commentsCounter=[],t._lastCommentDate=(new Date).getTime(),t.attchDiscussions={remove:[],addition:[]},t._attachmentsToCreate=[],t._attachments=[];var a=t._discussions.find(function(t){return t.guid==e.guid}),i=kendo.template(t.getTemplate("list-comment-tmpl"),{useWithBlock:!1});$("#comment-list",t.canvas).data("kendoMobileView").contentElement().empty().append(i(a)),$("#comment-list .bz-render-header .km-view-title span",t.canvas).text(a.name),t.configureCommentsEvents(),$.when(t.commentList()).always(function(){bizagi.loading.stop()})},commentList:function(){var e=this,t=$("#comment-list .bz-main-list",e.canvas),a=kendo.template(e.getTemplate("commentDiscussion-tmpl"),{useWithBlock:!1}),i=$("#comment-list",e.canvas).find(".bz-more-comments"),n=e.getCurrentUserInfo();return $.when(e.dataService.getCommentCase({idParent:String(e._discussionGuid),count:e.Class.PAGE_SIZE,dateTime:e._lastCommentDate})).then(function(r){if(r.length>=1)return e.organizeListsAndFormat(r).then(function(o){var s=[];$.each(r,function(t,a){a.attachments.length>=1&&$.each(a.attachments,function(a,i){if(e.validateFileExtensions(i.name)){var n=$.when(e.dataService.getFilesThumbnail({guids:r[t].attachments[a].guid+"",width:250,height:200,globalParent:e._globalParent})).then(function(e){i.dataAsBase64="data:image/jpg;base64,"+e[i.guid]}).fail(function(e){bizagi.log(e)});s.push(n)}}),a.user=o.find(function(e){return e.id==a.user}),e._lastCommentDate=a.date,e._commentsCounter++}),$.when.apply($,s).done(function(){var o=a({comments:r,currentUser:n});return $(t).append(o),e.dataService.getCommentsByParent({idParent:String(e._discussionGuid)}).then(function(t){t.count>e._commentsCounter&&i.show()})})}).fail(function(e){bizagi.log(e)});i.hide()}).fail(function(e){bizagi.log(e)})},deleteComment:function(e){var t=this,a=bizagi.localization.getResource("workportal-project-discussion-querydelete");$.when(bizagi.showConfirmationBox(a,"Bizagi","warning")).done(function(){for(var a=$(e.target).closest(".bz-wp-single-comment"),i=a.find(".bz-wp-info-comment-attach"),n=[],r=0,o=i.length;r<o;r++)n.push($(i[r]).data("guid"));var s={content:{guid:a[0].dataset.guid},attachmentsToDelete:n};t.dataService.removeMobileComment(s).done(function(e){if(200===e.status||void 0===e.status)a.remove();else{var i=bizagi.localization.getResource("workportal-project-discussion-errordelete");t.plugins.popupNotification.show(i,"error")}})}).fail(function(){bizagi.log("dont do nothing! :)")})},validateFileExtensions:function(e){return!!/(.jpg|.gif|.png|.bmp|.jpeg)$/i.test(e)},createComment:function(){var e=this,t=new $.Deferred;bizagi.loading.start();var a={content:{guid:Math.guid(),parent:e._discussionGuid,date:(new Date).getTime(),attachments:e._attachments},attachmentsToCreate:e._attachmentsToCreate,attachmentsToDelete:[]},i=$("#comment-list",e.canvas).find('[class*="bz-val"]');return $.each(i,function(e,t){var i=$(t).data("value");a.content[i]=$(t).val()}),a.content.text||0!=e._attachmentsToCreate.length?e.getUserCreation().done(function(n){e._commentsCounter=[],e._lastCommentDate=(new Date).getTime(),$("#comment-list .bz-main-list",e.canvas).empty(),a.content.user=n.idUser,e.dataService.createNewComment({data:a}).done(function(a){$.when(e.commentList()).always(function(){$.each(i,function(e,t){$(t).val("")}),bizagi.loading.stop(),t.resolve("Success")})}).fail(function(e){bizagi.log(e.error),bizagi.loading.stop(),t.reject(e.error)})}):(t.reject("Faltan campos por llenar"),bizagi.loading.stop()),t.promise()},showMoreComments:function(){var e=this;bizagi.loading.start(),$("#comment-list",e.canvas).find(".bz-more-comments").hide(),$.when(e.commentList()).always(function(){bizagi.loading.stop()})},organizeListsAndFormat:function(e){var t=this,a=0,i=[],n=bizagi.util.getFeatureObject("userService.v1.enabled");return e=e||[],$.each(e,function(r,o){1==o.general&&"discussion"==e.typeResource&&(o.name=t.resources.getResource("workportal-project-discussion-generaldiscussion"),a=r),o.user?-1===i.indexOf(o.user)&&i.push(o.user):n||i.push(0);var s=new Date(o.date);o.newDate=bizagi.util.dateFormatter.getRelativeTime(s,"dd/MM/yyyy HH:mm:ss:ff")}),"discussion"==e.typeResource&&(e.splice(0,0,e[a]),a++,e.splice(a,1)),t.dataService.getUsersDiscussion(i.join(","))},getUserCreation:function(){return this.dataService.getCurrentUser()},actionListComment:function(){var e=this,t={};$(".bz-wp-single-discussion",e.canvas).on("click",function(){t.guid=$(this).data("guid"),e.pane.navigate("comment-list"),e.configureDeleteCommentsEvents(),e.initCommentlist(t)}),$(".bz-wp-single-discussion-settings",e.canvas).on("click",function(t){t.stopPropagation();var a=$(this).closest(".bz-wp-single-discussion").data("guid");e.openCreateDiscussion(a)}),$(".bz-wp-discussion-footer li.bz-wp-info-attach",e.canvas).off("click").on("click",function(t){t.stopPropagation(),e.attachGuid=$(this).data("guid");var a=$(this).find("span").text();$.when(e.dataService.getMobileAttachment({idAttachment:e.attachGuid})).then(function(t){bizagi.loading.start(),$.when(bizagi.util.media.downloadFile(t,a)).fail(function(t){t.responseText&&e.getFormContainer().failHandler(t.responseText)}).always(function(){bizagi.loading.stop()})})})},buildUploadResolutionControl:function(e){var t=this,a=[{guid:1,displayName:bizagi.localization.getResource("workportal-size-small")},{guid:2,displayName:bizagi.localization.getResource("workportal-size-medium")},{guid:3,displayName:bizagi.localization.getResource("workportal-size-large")},{guid:4,displayName:bizagi.localization.getResource("workportal-size-original")}];$(".bz-rn-upload-resolution-container",e).actionSheet({actions:a,actionClicked:function(e){t.handlerResolutionUpload(e.guid)}})},handlerResolutionUpload:function(e){var t=this,a=e||0;if(4===a)t.saveImage(t,t.dataImage);else{var i=bizagi.util.media.getImageResolution(a);bizagi.loading.start(),$.when(bizagi.util.media.transformImageSize(t.dataImage,i)).done(function(e){t.editedImageURL=e.localUrl,t.saveImage(t,t.dataImage)}).fail(function(e){bizagi.showMessageBox("An error has occurred: Code = "+e.code)}).always(function(e){bizagi.loading.stop()})}},configureDeleteCommentsEvents:function(){var e=this;$("#comment-list",e.canvas).off("click",".bz-delete-comment").on("click",".bz-delete-comment",function(t){e.deleteComment(t)})},configureCommentsEvents:function(){var e=this;$(".bz-more-comments",e.canvas).on("click",function(){e.showMoreComments()}),$(".bz-wp-box-discussion",e.canvas).delegate(".bz-wp-info-comment-attach","click",function(t){e.attachGuid=!(!t.currentTarget||!t.currentTarget.attributes[0])&&t.currentTarget.attributes[0].nodeValue;var a=$(this).find("img").data("name");bizagi.util.isCordovaSupported()?$.when(e.dataService.getMobileAttachment({idAttachment:e.attachGuid})).then(function(t){bizagi.loading.start(),$.when(bizagi.util.media.downloadFile(t,a)).fail(function(t){t.responseText&&e.getFormContainer().failHandler(t.responseText)}).always(function(){bizagi.loading.stop()})}):e.processAttachment(t)})},processAttachment:function(e){var t=this;e.toElement.currentSrc?(t.slideFormParams={preview:bizagi.localization.getResource("workportal-actionsheet-upload-image-preview")},t.slideForm=$($.kendoTmpl(t.getTemplate("discussion-image-view"),t.slideFormParams)),$("#paneRender").append(t.slideForm),t.view=new kendo.mobile.ui.View(t.slideForm,{useNativeScrolling:!0}),t.pane=$("#paneRender").data("kendoMobilePane"),t.pane.navigate(t.view.id),t.scrollContent=$("#render-content",t.view.contentElement()),t.configureViewHandlers(),t.renderEdition(t.attachGuid)):$.when(t.dataService.getMobileAttachment({idAttachment:t.attachGuid})).then(function(e){window.open(e,"_system")})},configureViewHandlers:function(){var e=this;$(".bz-render-back",e.slideForm).bind("click",function(){e.goBack()})},goBack:function(){this.pane.navigate("#:back")},renderEdition:function(e){var t=this;t.imageGuid=e,$.when(t.dataService.getFilesThumbnail({guids:t.imageGuid,width:600,height:800,globalParent:t._globalParent})).then(function(e){var a="data:image/jpg;base64,"+e[t.imageGuid];$(".ui-bizagi-render-preview").remove(),t.inputEdition=kendo.template(t.getTemplate("discussion-image-preview"),{useWithBlock:!1}),$("#render-content",t.view.content).append(t.inputEdition({url:a})),t.kendoViewOptions={zoom:!0},t.renderEditionType="preview",t.titleLable=!0,setTimeout(function(){var e=t.view.element,a=$(".ui-bizagi-render-preview",e).width();e.width()<a&&e.width();$(".ui-bizagi-container-inputs",e).css("padding",0)},200)}).fail(function(e){bizagi.log(e)})},configureHandlers:function(e){var t=this;t.subscribe("bz-rnd-discussion",function(e,a){t._idPlan=a.dataPlan?a.dataPlan.idPlan:void 0,t._contextualizedPlan=a.dataPlan?a.dataPlan.contextualized:void 0,t.initDiscussionList(a).done(function(){a.navigateToDiscussion&&(t.pane.navigate("comment-list"),t.configureDeleteCommentsEvents(),t.initCommentlist({guid:a.guidDiscussion}))})}),$("#discussion-create",t.canvas).on("click",".bz-send-discussion",function(){var e=$(this).data("guid");void 0!==e&&""!==e?t.validateDiscussion(e):t.validateDiscussion(null)})},configureDiscussionHeaderHandlers:function(e){var t=this;$("input.ui-bz-wp-discussions-list-input-search",e.element).keyup(function(){var e=$(this).val();$(".bz-wp-box-discussion li").each(function(){$(this).text().search(new RegExp(e,"i"))<0?$(this).fadeOut():$(this).show()})}),$(".bz-discussion-back",e.element).bind(t.Class.BIZAGI_TAP_EVENT,function(e){e.stopImmediatePropagation(),t.navigator.goHome()}),$(".ui-bz-wp-discussions-list-search-icon",e.element).on("click",function(e){$(this).closest("#discussion-list").find(".ui-bz-wp-discussions-list-search-bar").addClass("active").find("input").trigger("focus")}),$(".ui-bz-wp-discussions-list-cancel-icon",e.element).on("click",function(e){$(this).closest("#discussion-list").find(".ui-bz-wp-discussions-list-search-bar").removeClass("active").find("input").val("").trigger("keyup")})},configureUploadHandlers:function(e){var t=this;if($(".bz-create-comment",e).on("click",function(){t.createComment()}),$(".bizagi-ui-discussion-attachments",e).on("click","li i.right-icon",function(){var e=$(this).closest("li"),a=bizagi.localization.getResource("workportal-project-file-querydelete");$.when(bizagi.showConfirmationBox(a,"Bizagi","warning")).done(function(){t.removeAttachment(e)})}),$(".bizagi-ui-discussion-attachments",e).on("click","li.bz-wp-info-attach span",function(e){var a=$(this.parentNode).data("guid"),i=$(this).text();$.when(t.dataService.getMobileAttachment({idAttachment:a})).then(function(e){bizagi.loading.start(),$.when(bizagi.util.media.downloadFile(e,i)).fail(function(e){e.responseText&&t.getFormContainer().failHandler(e.responseText)}).always(function(){bizagi.loading.stop()})})}),bizagi.util.isCordovaSupported()){var a=[{guid:1,displayName:bizagi.localization.getResource("workportal-actionsheet-upload-take-photo")},{guid:2,displayName:bizagi.localization.getResource("workportal-actionsheet-upload-choose-photo")}];$(".bz-create-attachment",e).actionSheet({actions:a,actionClicked:function(a){switch(t.newDiscussion=$(".bz-create-attachment",e).closest("#discussion-create").length>0,a.guid){case 1:t.uploadTakePhoto();break;case 2:t.uploadChoosePhoto()}}})}else bizagi.util.media.fileAPISupported()?($(e).off("change").on("change",".bz-rn-upload-files-web",function(){t.newDiscussion=$(this).closest("#discussion-create").length>0,t.saveImage(this)}),$(".bz-create-attachment",e).off("click").click(function(){($(this).closest(".bz-form-data").length>0?$(this).closest(".bz-form-data"):$(this).closest(".km-footer")).find(".bz-rn-upload-files-web").click()})):($(".bz-create-attachment",e).hide(),$(".bizagi-ui-discussion-files-icon",e).hide())},uploadTakePhoto:function(){var e=this;navigator.camera.getPicture(function(t){e.dataImage=t,$.when(bizagi.util.media.getFileDataInfo(e.dataImage)).then(function(a){e.fileProperties=a,e.saveImage(t)})},e.onFail,{quality:e.Class.QUALITY_PICTURE,sourceType:navigator.camera.PictureSourceType.CAMERA,mediaType:navigator.camera.MediaType.PICTURE,destinationType:Camera.DestinationType.FILE_URI,correctOrientation:!0})},uploadChoosePhoto:function(){var e=this;navigator.camera.getPicture(function(t){e.dataImage=t,$.when(bizagi.util.media.getFileDataInfo(e.dataImage)).then(function(t){e.fileProperties=t,$(".bz-rn-upload-resolution-container",e.canvas).click()})},e.onFail,{quality:e.Class.QUALITY_PICTURE,sourceType:Camera.PictureSourceType.PHOTOLIBRARY})},uploadTakeVideo:function(){var e=this;navigator.device.capture.captureVideo(function(t){e.saveVideo(t)},e.onFail,{limit:e.Class.LIMIT})},uploadRecordAudio:function(){var e=this;navigator.device.capture.captureAudio(function(t){e.saveAudio(t)},e.onFail,{limit:e.Class.LIMIT})},saveImage:function(e){var t=this,a={};if(bizagi.util.isCordovaSupported()){var i,n={guid:Math.guid()},r=t.fileProperties.name;t.editedImageURL?i=t.editedImageURL:t.fileProperties&&(i=t.fileProperties.url),i=bizagi.util.media.getImagePath(i),t.editedImageURL=null,t.fileProperties=null;var o={dataFile:i,data:n};o.options={fileName:r,addUrl:t.dataService.serviceLocator.getUrl("new-comment-attach"),uploadKey:{key:"file[]"}},a={fileName:r,mimeType:"image/jpeg",params:n,dataFile:i},bizagi.loading.start(),$.when(bizagi.util.media.uploadFile(o)).done(function(e){t.onUploadFileCompleted(a,e)}).fail(function(e){var t=JSON.parse(e.responseText);bizagi.showMessageBox(t.message,t.type)}).always(function(){bizagi.loading.stop()})}else if(e&&e.value){a.fileKey="file[]",a.fileName=e.value.substr(e.value.replace(/([\\\/]+)/g,"/").lastIndexOf("/")+1),a.mimeType="image/jpeg",a.params={guid:Math.guid()};var s=new FormData($(e).closest("form")[0]);s.append("guid",a.params.guid),$.ajax({url:t.dataService.serviceLocator.getUrl("new-comment-attach"),data:s,type:"POST",contentType:!1,processData:!1}).done(function(e){t.onUploadFileCompleted(a,e)}).fail(t.onFail).always(function(){bizagi.loading.stop()})}},saveAudio:function(e){var t=this,a=t.properties,i=t.buildAddParams(),n="q_"+bizagi.util.encodeXpath(t.getUploadXpath()),r=new FileUploadOptions,o=new FileTransfer;i.queueID=n,r.fileName=e[0].name,r.params=i,o.upload(e[0].fullPath,a.addUrl,function(e){var a=JSON.parse(decodeURIComponent(e.response));"error"===a.type?bizagi.showMessageBox(a.message,"Error"):t.onUploadFileCompleted(a)},function(e){bizagi.log("An error has occurred: Code = "+e.code)},r)},saveVideo:function(e){var t=this,a=new FileUploadOptions,i=new FileTransfer;a.fileName=e[0].name,a.mimeType="video/quicktime",a.params={guid:Math.guid()},i.upload(e[0].fullPath,t.dataService.serviceLocator.getUrl("new-comment-attach"),function(e){if(e.responseCode>=200&&e.responseCode<=299)try{JSON.parse(decodeURIComponent(e.response));t.onUploadFileCompleted(a,e)}catch(e){bizagi.showMessageBox(bizagi.localization.getResource("workportal-general-error-generic"),"Error")}else bizagi.showMessageBox(e.responseCode,"Error")},function(e){bizagi.log("An error has occurred: "+e.code)},a)},onFail:function(e){bizagi.log("Error: "+e.code),bizagi.util.smartphone.stopLoading()},onUploadFileCompleted:function(e,t){var a=this;a._attachments.push({guid:e.params.guid,name:e.fileName}),a._attachmentsToCreate.push(e.params.guid),bizagi.loading.start(),a.newDiscussion?a.onSuccessFile(e,t):$.when(a.createComment()).done(function(e){bizagi.log(e)}).fail(function(e){bizagi.log(e)}).always(function(){a._attachmentsToCreate=[],a._attachments=[],bizagi.loading.stop()})},onSuccessFile:function(e,t){var a=this,i=[e];$.isEmptyObject(t)?bizagi.log("No subido!"):(Array.prototype.push.apply(a.attchDiscussions.addition,i),i[0]&&i[0].params&&(i[0].params.isNew=a.newDiscussion),a.renderAttachments(i))},renderAttachments:function(e){var t=this,a=$("#discussion-create ul.bizagi-ui-discussion-attachments",t.canvas),i=kendo.template(t.getTemplate("discussion-attachment"),{useWithBlock:!1});bizagi.loading.stop(),a.append(i(e))}}),bizagi.workportal.webparts.discussionCase.extend("bizagi.workportal.webparts.discussionCase",{},{}),bizagi.workportal.webparts.rendermanager.extend("bizagi.workportal.webparts.files",{QUALITY_PICTURE:50,LIMIT:1,EXTENSIONSIMG:["image/jpeg","jpeg","image","png","jpg"],EXTENSIONSVIDEO:["video/quicktime","quicktime","qt","mov"],EXTENSIONSAUDIO:["audio/wav","audio","wav"],PAGE_SIZE:5},{init:function(e,t,a){var i=this;i._super(e,t,a);var n=i.getTemplate("files-tmpl-main");i.mainTemplate=kendo.template(n,{useWithBlock:!1}),bizagi.util.mobility.filesViewInit=$.proxy(i.filesViewInit,i)},filesViewInit:function(e){var t=this,a=e.view.scroller,i=t.getTemplate("file-pull-loader"),n=t.getTemplate("file-refresh-loader");t.content=$(t.mainTemplate({})),e.view.contentElement().append(t.content),t.configureFilesHeaderHandlers(e.view),bizagi.util.isNativeHeaderEnabled()||(bizagi.override.enableFormButtons?t.configureFormButtons($("#files-list",t.canvas)):t.configureFloatingButton($("#files-list",t.canvas))),t.actionFiles(),a.setOptions({pullToRefresh:!0,messages:{pullTemplate:i,refreshTemplate:n,releaseTemplate:i},pull:function(){setTimeout(function(){var e={globalParent:t._globalParent};t.initFilesList(e),a.pullHandled()},400)}}),t.pane=$("#paneRender").data("kendoMobilePane")},configureHandlers:function(e){var t=this;$(".bz-wp-single-files-delete-file",e).on("click",function(e){e.stopPropagation();var a=$(this).closest(".bz-wp-single-files").data("position");t.deleteFile(a)})},configureFloatingButton:function(e){var t=this;if(bizagi.util.isCordovaSupported())if((bizagi.util.getAndroidVersion()>=4.4||bizagi.util.isNativePluginSupported())&&bizagi.override.enableMfb){var a=[{label:bizagi.localization.getResource("workportal-actionsheet-upload-take-photo"),link:1,icon:"mo-icon bz-camera"},{label:bizagi.localization.getResource("workportal-actionsheet-upload-choose-photo"),link:2,icon:"mo-icon bz-image"}];$(".ui-bizagi-container-children-form",e).addClass("ui-bizagi-form-no-buttons"),$(".ui-bizagi-button-container",e).hide(),$(e).mfb({restingIcon:"mo-icon bz-plus",activeIcon:"mo-icon bz-cancel",activePrincipalButton:!0,buttons:a,click:function(e,a){switch(a.link){case 1:t.uploadTakePhoto();break;case 2:t.uploadChoosePhoto()}}})}else{var i=[{guid:1,displayName:bizagi.localization.getResource("workportal-actionsheet-upload-take-photo")},{guid:2,displayName:bizagi.localization.getResource("workportal-actionsheet-upload-choose-photo")}];$(".ui-bizagi-container-children-form",e).addClass("ui-bizagi-form-no-buttons"),$(".ui-bizagi-button-container",e).hide(),$(e).mfb({restingIcon:"mo-icon bz-plus"}),$(".mfb-component__main-icon--resting",e).off("click").actionSheet({actions:i,actionClicked:function(e){switch(e.guid){case 1:t.uploadTakePhoto();break;case 2:t.uploadChoosePhoto()}}})}else bizagi.util.media.fileAPISupported()&&($(t.container).find(".bz-rn-upload-files-web").change(function(){t.saveImage(this),this.value=""}),$(e).mfb({restingIcon:"mo-icon bz-plus",click:function(){t.pane.container().content.find(".bz-rn-upload-files-web").off("click").click()}}))},deleteFile:function(e){
var t=this,a=bizagi.localization.getResource("workportal-project-file-querydelete");$.when(bizagi.showConfirmationBox(a,"","info")).done(function(){t.removeFile(e)})},removeFile:function(e){var t=this,a={content:{guid:t.params.data[e].guid},attachmentsToDelete:[t.params.data[e].attachment.guid],index:e};$.when(t.dataService.deleteFile(a)).done(function(e){var t=JSON.parse(this.data).index;$("li.bz-wp-single-files[data-position="+t+"]").remove()})},postRender:function(){var e=this;bizagi.webpart.subscribe("bz-rnd-files",function(t,a){e._idPlan=void 0,e._contextualizedPlan=void 0,e.initFilesList(a)})},renderContent:function(){return""},configureViewHandlers:function(){var e=this;$(".bz-render-back",e.slideForm).bind("click",function(){e.goBack()}),$(".bz-edit-attachment",e.slideForm).bind("click",function(){e.downloadFile()})},goBack:function(){var e=this;e.pane.replace("#files-list"),e.view.destroy(),e.params&&e._globalParent&&e.view.attachedElement.refreshView&&e.initFilesList({globalParent:e._globalParent})},configureDescriptionHandlers:function(){var e=this;$(".cancel-edit-description",e.slideForm).on("click",function(t){$(".km-box-body.description-file",e.slideForm).unbind(),t.stopImmediatePropagation(),e.configureViewEvents(""),$(".km-box-body.description-file",e.slideForm).attr({placeholder:bizagi.localization.getResource("workportal-actionsheet-upload-description-unavailable")}),e.updateDescription("")}),$(".add-new-description",e.slideForm).bind("click",function(t){var a=$(".km-box-body.description-file",e.slideForm).val();$(".km-box-body.description-file",e.slideForm).unbind(),t.stopImmediatePropagation(),e.configureViewEvents(a),e.updateDescription(a)})},updateDescription:function(e){var t=this;$(".km-box-body.description-file",t.slideForm).val(e);var a=t.params.data[t.view.attachedElement.position],i={content:{guid:a.guid,description:e,attachment:a.attachment,name:a.name,date:a.date,user:a.user.id,globalParent:a.globalParent}};$.when(t.dataService.updateProjectFile(i)).always(function(e){200===e.status||201===e.status||void 0===e.status?t.view.attachedElement.refreshView=!0:bizagi.log("Error en la carga de la informacin...")})},downloadFile:function(){var e=this;$.when(e.dataService.getMobileAttachment({idAttachment:e.view.attachedElement.guid})).then(function(e){window.open(e,"_system","location=yes")})},deleteDescription:function(){var e=this,t=$(".bz-files-description-box",e.view.content),a=$(".description-file",e.view.content);0!==t.length&&$(".bz-files-description-box",e.view.content).remove(),a.text(bizagi.localization.getResource("workportal-actionsheet-upload-description-unavailable")),e.updateDescription(!0)},uploadTakePhoto:function(){var e=this;navigator.camera.getPicture(function(t){e.saveImage(t)},e.onFail,{quality:e.Class.QUALITY_PICTURE,sourceType:navigator.camera.PictureSourceType.CAMERA,mediaType:navigator.camera.MediaType.PICTURE,destinationType:Camera.DestinationType.FILE_URI,correctOrientation:!0})},uploadChoosePhoto:function(){var e=this;navigator.camera.getPicture(function(t){e.dataImage=t,$.when(bizagi.util.media.getFileDataInfo(e.dataImage)).then(function(t){e.fileProperties=t,e.saveImage(e.dataImage)})},e.onFail,{quality:e.Class.QUALITY_PICTURE,sourceType:Camera.PictureSourceType.PHOTOLIBRARY})},saveImage:function(e){var t=this,a={};if(bizagi.loading.start(),bizagi.util.isCordovaSupported()){var i={guid:Math.guid()},n=e.substr(e.lastIndexOf("/")+1);t.fileProperties&&t.fileProperties.name&&(n=t.fileProperties.name),e=bizagi.util.media.getImagePath(e);var r={dataFile:e,data:i};r.options={fileName:n,addUrl:t.dataService.serviceLocator.getUrl("new-comment-attach"),uploadKey:{key:"file[]"}},a={fileName:n,mimeType:"image/jpeg",params:i,dataFile:e},t.fileProperties=null,$.when(bizagi.util.media.uploadFile(r)).done(function(e){t.onUploadFileCompleted(a,e)}).fail(function(e){var t=JSON.parse(e.responseText);bizagi.showMessageBox(t.message||t.error_description||"error",t.type)}).always(function(){bizagi.loading.stop()})}else if(e&&e.value){a.fileKey="file[]",a.fileName=e.value.substr(e.value.replace(/([\\\/]+)/g,"/").lastIndexOf("/")+1),a.mimeType="image/jpeg",a.params={guid:Math.guid()};var o=new FormData($(e).closest("form")[0]);o.append("guid",a.params.guid),$.ajax({url:t.dataService.serviceLocator.getUrl("new-comment-attach"),data:o,type:"POST",contentType:!1,processData:!1}).done(function(e){t.onUploadFileCompleted(a,e)}).fail(t.onFail).always(function(){bizagi.loading.stop()})}},onUploadFileCompleted:function(e,t){var a=this;$.when(a.createFile(e)).done(function(e){bizagi.log(e)}).fail(function(e){bizagi.log(e)}).always(function(){bizagi.loading.stop()})},createFile:function(e){var t=this,a=new $.Deferred,i=Math.guid(),n=(new Date).getTime(),r={attachmentsToCreate:[e.params.guid],content:{guid:i,description:"",attachment:{name:e.fileName,guid:e.params.guid},name:e.fileName,date:n,user:bizagi.currentUser.idUser,globalParent:t._globalParent}};return t._filesCounter=0,t._lastFileDate=n,$.when(t.dataService.createProjectFile(r)).done(function(e){200===e.status||201===e.status||void 0===e.status?(bizagi.log("Subida de archivo exitosa"),t.initFilesList({globalParent:t._globalParent}),a.resolve("Success")):a.reject("Error en la carga del archivo...")}).fail(function(){bizagi.log("Error en la subida....")}),a.promise()},initFilesList:function(e){var t=this;e=e||{},t._globalParent=e.globalParent,t._filesCounter=0,t._lastFileDate=(new Date).getTime(),bizagi.loading.start(),t._idPlan||(t._idPlan=e.dataPlan&&e.dataPlan.idPlan?e.dataPlan.idPlan:void 0),t._contextualizedPlan||(t._contextualizedPlan=e.dataPlan&&e.dataPlan.contextualized?e.dataPlan.contextualized:void 0),t.params.data={},$(".bz-main-list",t.canvas).empty(),$.when(t.filesList()).always(function(){t.configureHandlers($("#files-list",t.canvas)),bizagi.loading.stop()})},filesList:function(){var e=this;if(void 0===e._contextualizedPlan||e._contextualizedPlan)return e.getFilesList(void 0);$.when(e.dataService.getFirstParentPlan({idPlan:e._idPlan})).done(function(t){return t&&t.id?e.getFilesList(t.id):e.getFilesList(e._idPlan)})},getFilesList:function(e){var t=this,a=kendo.template(t.getTemplate("files-tmpl"),{useWithBlock:!1}),i=$(".bz-main-list",t.canvas),n=$("#files-list",t.canvas).find(".bz-more-files"),r=t.getCurrentUserInfo(),o=bizagi.util.getFeatureObject("userService.v1.enabled");return $.when(t.dataService.getFilesList({globalParent:String(e||t._globalParent),count:t.Class.PAGE_SIZE,dateTime:t._lastFileDate})).then(function(e){if(e.length)return t.organizeListsAndFormat(e).done(function(s){$.each(e,function(e,a){a.user=s.find(function(e){return e.id==(o?a.guidUser||a.user:a.user)})||[],t._lastFileDate=a.date,t._filesCounter++});var l=a({files:e,currentUser:r});return $(i).append(l),t.actionListFiles(),t.dataService.getFilesCount({globalParent:String(t._globalParent)}).then(function(a){return a.count>t._filesCounter&&n.show(),t.params.data=e,$.Deferred().resolve()})}).fail(function(e){bizagi.log(e)});n.hide()}).fail(function(e){bizagi.log(e)})},getCurrentUserInfo:function(){return{name:bizagi.currentUser.userName,id:bizagi.currentUser.idUser,picture:""}},initPreview:function(e){var t=this;e=e||{};var a=t.params.data[e.position],i=a.attachment.guid,n={guid:i,position:e.position,refreshView:!1};bizagi.loading.start(),a.attachment.isImage?$.when(t.setThumbnail(i)).done(function(e){a.attachment.thumbnail="data:image/png;base64,"+e[i],t.initViewFile(n),t.renderEdition(a),bizagi.loading.stop()}).fail(function(e){bizagi.log(e)}):$.when(t.setAttachment(i)).done(function(e){a.attachment.link=e[i],t.initViewFile(n),t.renderEdition(a),bizagi.loading.stop()}).fail(function(e){bizagi.log(e)})},renderEdition:function(e){var t=this,a=t.getTemplate("file-preview-tmpl");t.inputEdition=kendo.template(a,{useWithBlock:!1}),$("#render-content",t.view.content).append(t.inputEdition(e)),t.configureViewEvents(e.description)},configureViewEvents:function(e){var t=this;$(".cancel-edit-description",t.slideForm).hide(),$(".add-new-description",t.slideForm).hide(),$(".km-box-body.description-file",t.slideForm).val(e),$(".km-box-body.description-file",t.slideForm).on("click",function(){var e=2*this.value.length;this.focus(),this.setSelectionRange(e,e),t.showActions(!0),t.configureDescriptionHandlers()})},showActions:function(e){var t=$(".cancel-edit-description",self.slideForm),a=$(".add-new-description",self.slideForm);e?(t.show(),a.show()):(t.hide(),a.hide())},initViewFile:function(e){var t=this;t.slideFormParams={preview:bizagi.localization.getResource("workportal-actionsheet-upload-file-preview")},t.slideForm=$($.kendoTmpl(t.getTemplate("file-view"),t.slideFormParams)),$("#paneRender").append(t.slideForm),t.view=new kendo.mobile.ui.View(t.slideForm,{useNativeScrolling:!0,destroy:function(e,t){this.element.remove()}}),t.pane.replace(t.view.id),t.view.attachedElement=e,t.scrollContent=$("#render-content",t.view.contentElement()),t.configureViewHandlers()},setThumbnail:function(e){var t=this,a={guids:e,width:320,height:420,globalParent:t._globalParent};return t.dataService.getFilesThumbnail(a)},setAttachment:function(e,t){var a=this,i={idAttachment:e,sessionId:t};return a.dataService.getAttachment(i)},actionListFiles:function(){var e=this,t={};$(".bz-wp-single-files",e.canvas).bind("click",function(){t.position=$(this).data("position"),e.pane.navigate("files-list"),e.initPreview(t)})},organizeListsAndFormat:function(e){var t=this,a=[],i=bizagi.util.getFeatureObject("userService.v1.enabled"),e=e||{};return $.each(e,function(e,n){a.push(i?n.guidUser||n.user:n.user);var r=new Date(n.date);n.newDate=bizagi.util.dateFormatter.getRelativeTime(r,"dd/MM/yyyy HH:mm:ss:ff"),n.attachment.iconSrc=t.getIconExtension(n.attachment)}),t.dataService.getUsersDiscussion(a.join(","))},getIconExtension:function(e){return e=e||{},e.iconExtension=e.name.split(".").pop().toLowerCase(),["jpg","jpeg","png"].indexOf(e.iconExtension)>-1?(e.isImage=!0,"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADQAAABHCAYAAABIzmSEAAAD8UlEQVR42u2ah0/TQRTH+TcQFyEoONEYSFwxRo0mkiiOgGwFFBVxSwwaERGIDBmFClK2gmVUNlWBAiJ7CGVDZQkUEPwLnvcOqBqMAVroNbmXfJPer79xn9x77+7e76enx40bN27cuDFmicVN4JdSDs9WWcKcOtA4TEWzAg7eTgJ967BVl5FjFHiLSjQLVVzTDebXRfQBHpGF4JMoWxXNQ60hsnmeBSsCVN6igImpn6siCmODCqe/bf2zQeeBjBwFcNI7DTY5R4PBhXBwfpEDXQNK0Fkg00tCiMmth+B3VbS9wS4SnAiUTgOlfmihbYGkVhVX1urEFCtAYxPTEJT+GUwuCtWLKVaAUIrhCQhMqwRjElNrlxtTLAGhvo1MQohYjZhiDWhekdk1NK3rL3We0iYQulbg20qQNfUv0Kf6XnANyfs9TwVIgHkgA9JZU5dXsPtq3D+1zTWGzk94LsaUV+xHYBbo+MO3S177OQa+ZxdoKcJ44kAciAMxCDQ4OgUV5JyShl6NqbZ9EEaV09oBklS0w17PBNjl/lpjOvc0A1p7v2sH6GVmtWrJcvheilo6dDcZNtpHgrmHCOo7hrQDFJLxhZ7n/jJfdUw5OUNdZmT8B9kCzCw6LoaI+x64ncQWEEJkyNrgWnghnHoihscJpbRzykkdBSpp6FNdi1pvGwFuofnQPTCue0BK0o6Ye9BpMjp5VZ10t2nhEQ818oG/rksoaoJjXqmQ9ukr20Chc21bfwlUkmsNHQT0XtVts0DjJL7iCxtpEsHzdl6JhfTSVhp3TLqctLYHzEjqnXc5XOK7BOdSl8NOJ0mb6TYA/zO7MnueORlBcVkbm0A40SaTTjuQB50l88kdoZSOFMKIyMjsvjoLYeUjhqxyOVg+SqftPeR5cQWN7AFhmi6q7gIR6VyHYozWA/C4MLcONs9Vb6xIfGFMoYuWN/fDibl9kAlxQ6bmIRyFTJkctpIdJx7Duhqm8XiSAExdZmGOPkhdkCDw5cC+m4kqN2UCCPf64tI22O4WA+tIqsatNMo9rEAVM8e83lD3+9d9yhr76EqBGSBMzVvIyGCZ6VJQLngKiv7aKp8hMVMrH/zvvbAQsuNyDBtA87IPkEB7/yiNHd9kGX3fc943k7jZoG5NrOhelt7pNMv9+b9iZILGkc6t5XALUdbURwN+ucKMZ3Ejng0gjB/MYOroyP0UMLQXaBcIly3r7SI0+p51/61EaOwa1g4QTqQNnUMgrevRmOQkqfAiCQfiQByIA3EgDsSBOBAHWgCEF+ZUdjCnO9HS5QFhhRMLH6zJ2Clq8UBoNn5ZWvnmdCnCggzW0vknz9y4cePGjdsK2i8pjnlZMxAysQAAAABJRU5ErkJggg=="):["pdf"].indexOf(e.iconExtension)>-1?(e.isImage=!1,"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADYAAABBCAYAAACaYlekAAAD5ElEQVR42u2a+U8TURDH/UPEMxpFSTwTz2D8wXjE4weMiEQ5VDTiAfG+E8VEjcSLQ045NICIoojKISAIgiDVogVbsJRSenDIX/D1zRCNRGMolna7vkkm7W433ffJe/N9M7M7bpw0adKkudJyy1vgbs971YK3LSaMGVRs3ltMCIzH+C1xbnW659oTuah83zE2cCeTK+ATGIcVUfcQFVfqFg+88Jjh6L7LDmZBa+jBmIEdji+Do2/QLf6o6vPPWfMRn3N2paJO2wnVgK06mgN/sVJ+fC97Z4AqwKLFsnxW28ZQHHPHc1HlqpjzNFinpRfvW81YfSxnKOYOuCjmlABG52o/GnnmfMTMzY1IQ+2/xpxSwMhLG/RDM+eKmFMSGHmFiLFhMdc8yphTGhj5rzG3ZH/m6GLOk2CRN15Cq7fAYHL85s/rvrCQ0HXzItJFDDoZc54E8w1N5sEvP5j9R6ffOUMRvu5kHho+OZFbegKsoqkd03ckOZVb+oWncuKsaDCLbQDNbWY06rpG5F4D5qwrAowCv73LoR4wm+MbCqt1CLtShNDLRWgWkq0KML3Jjt3XijFt+x3eXC9mVqsDTNPWjY2n87EtppDBTqVUqAOM4opmbMq2BHWBWUWMXcquwWQBNnFrPG4+bFCPKj4W4jF3dxomBSWwkKgGzNTTx5k5gVHJoRqwRp2Zczz6v4jY5zBZ+tQBdr9UywNYKhLb+XvSXbYcPS4ep1MrubQvbzTwQIKF9Ou+Wr0bTGuwYPP5AgQIt/d+w+2CBpb+G/n1sIljrwUretMKv52piHs0JPOf2nsQcvkpZoWlILvkAzrEPqfrsOLd5y6eRbO1X/lgNEO0IS/al4E3H418rkso5PUH9VwszhZwQRcLEXCuAGuO5fKs0vWtRpuywayOASzYexd7hRKSYBxJLMfiyEzMDEke9sBjobjmwK0S7tdT5UwFp2LBum39iM2r45tT1jE1OJEHQQ85ouNLeTAl9XpuytDv/ofuier5DtaLUr9phBWAW8F67AOo1hgRk1WDeULaZ4QkYcOpBzgjlJHa1sbu4d0nqpjPplWyUlJpQ30PxcWYvXeQc8GV0fc5yyCJJ6mnthnJ/t9aAvpOOzrMDmWq4pGEMl5yM3Yk8fLyDUvmesyrWwM55Vq+0aYz+aJSfsqFZXqxxvt7HhcyXvP1wZeecCYffvWZOpo51ZqvLNu0BKlapg1XFWAkHNQGKBbKR313Ov4v2m8STIJJMAkmwSSYBJNgEkx9YBHXitGkMyvS/wmMehaLIjMV6aMCy3ih4a6Ru98JdsbpBRZ6Banmg3HsXo6WJk2aNNXYd5EIhV1Uqgx7AAAAAElFTkSuQmCC"):["doc","docx"].indexOf(e.iconExtension)>-1?(e.isImage=!1,"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADMAAAA/CAYAAABNY/BRAAADy0lEQVR42u2a6U8TQRjG/TfEI+oHFW+jiVfQxBiiicYDYwTFE6+g9SReoKLxiolGQAEBgaoglxyiHMolRbHKUaEcLaW00JZSEP0LHucdpB/UD1uF7WJmkifNTibd/WXmeWfed3fcONFEE+2fWqnWgHxNi+yqaujEiIK8eKfHgsMJGL/9vuxaciwZz8ubRg4opbgBM/bFYe7BRwiNei2Lgm7mchifwPtYHPoYBTWtGFGY9eEZcA18l0VVjZ3u2fFhmrb7ISpHYsl5E2b+oQT4n0vDpB3RmLk/DtlVeoxZmLUX0vkS2379xZCHVP/oIW/DNJns0JscCLiazT20KDQJL2vaMGZhqK+n9yu2cqAo7qGKehPGLAypvr0HgTdyuYd8Q+I995CSYEhavfXvPaQ0GFJL5y8eei/RQ96EobD8ubUbVsfAbzJYnNgQkcHHkYfK6yR4yJswU3c9wDJVCvxOqf+ohUcS3Zvr7AOPUPzRAMXB1LV1s3vGenSOo6AQqa5SHoyjbxC1zRZodGZJogOpYmE81Uq25ASMgBEwXoLRGW1Ie6sbVRmtffLAJL2qG/V6QInWIA9MfVsPEhnQaKqtq1d4RsB4Kjr15rDkSqpMcgWAv9Hr2nbMYtmiVJXVdSgXpojBUGFRqihfkQ2mkGV7pVqjez9o7rDzvpovZtidg+jr/84eqANvPhlhtQ8o2zP+557B72QqMiua+PWtdA3mHUpA8K08NJsc6HV9w6rTTxAQmY1Gg03ZMEejizAhMAo306r59ZbILHfx+wPLTXQMgMpEe+4UwGjpg9nm4ktHqiz2fvlgUksa+MOfiStFl62f14hXhz3lv5TOqksaOczt5xo+Pl/TqswTwHConRIcgx03cnn5hyonIXcLMX1vLJKL6nEqthRzmJEzyoeWIb172XwlS7LeN3fJG83WnH3GZyMiuYIvuQf5Wn6j84llWHchHStPq3k6TGNtzq9oNfdKlp2l0rLChMW/4abfeCkTE4Ki0NDeg23XcnjRbvLOaGy6nAmHa3BsnADoQOjzc41T1KIQrIop5iUj8gvN2PBYqh03sfAtVTSTssLQPuK7P47D3E4fMjr90o0mspnKq25xj1V0ACC1dzlxL+sDLiaVQdti5X1UrY9UVyL8cTmPcsNjq3VmBLFgIVUf9RZ5YWiXp92elpCz/xvvo83Sxq6p79famKnbJVn0PyIFEDACRsAIGAEjYASMgPkPYeidvCf5h5xafjzFMxjK75eqkhUpymIlwVBlZcWJVK98o+mJ6MMgqtmJz4NFE000d/sBkmT1hmD0wlMAAAAASUVORK5CYII="):void(e.isImage=!1)},actionFiles:function(){var e=this;$(".bz-more-files",e.content).bind("click",function(){e.showMoreFiles()})},showMoreFiles:function(){var e=this;bizagi.loading.start(),$("#files-list",e.canvas).find(".bz-more-files").hide(),$.when(e.filesList({globalParent:e._globalParent})).always(function(){bizagi.loading.stop()})},configureFilesHeaderHandlers:function(e){var t=this;$(".bz-files-back",e.layout.element).on(t.Class.BIZAGI_TAP_EVENT,function(e){e.stopImmediatePropagation(),t.navigator.goHome()}),$("input.ui-bz-wp-files-list-input-search",e.layout.element).keyup(function(){var e=$(this).val();$(".bz-wp-box-files li").each(function(){$(this).text().search(new RegExp(e,"i"))<0?$(this).fadeOut():$(this).show()}),""===e?$(this).closest("#files-list").find(".bz-more-files").show():$(this).closest("#files-list").find(".bz-more-files").hide()}),$(".ui-bz-wp-file-list-search-icon",e.layout.element).on("click",function(e){$(this).closest("#files-list").find(".ui-bz-wp-file-list-search-bar").addClass("active").find("input").trigger("focus")}),$(".ui-bz-wp-file-list-cancel-icon",e.layout.element).on("click",function(e){$(this).closest("#files-list").find(".ui-bz-wp-file-list-search-bar").removeClass("active").find("input").val("").trigger("keyup")})},configureFormButtons:function(e){var t=this,a=[];$(".ui-bizagi-container-children-form",e).addClass("ui-bizagi-form-no-buttons"),$(".ui-bizagi-button-container",e).hide(),bizagi.util.isNativePluginSupported()?a=[{id:Math.ceil(1e5*Math.random()),action:"take",label:bizagi.localization.getResource("workportal-actionsheet-upload-take-photo"),ordinal:1,priority:1,additional:!1},{id:Math.ceil(1e5*Math.random()),action:"choose",label:bizagi.localization.getResource("workportal-actionsheet-upload-choose-photo"),ordinal:2,priority:2,additional:!1}]:bizagi.util.media.fileAPISupported()&&($(t.container).find(".bz-rn-upload-files-web").change(function(){t.saveImage(this),this.value=""}),a=[{id:Math.ceil(1e5*Math.random()),action:"choose",label:bizagi.localization.getResource("workportal-actionsheet-upload-choose-photo"),ordinal:3,priority:1,additional:!1}]),a.length>0&&(bizagi.util.sortJSON(a,"priority","desc"),$(e).formButtons({buttons:a,click:function(e,a){switch(a.ordinal){case 1:t.uploadTakePhoto();break;case 2:t.uploadChoosePhoto();break;default:case 3:t.pane.container().content.find(".bz-rn-upload-files-web").off("click").click()}}}))}}),bizagi.workportal.webparts.files.extend("bizagi.workportal.webparts.files",{},{}),bizagi.workportal.webparts.webpart.extend("bizagi.workportal.webparts.filterBar",{},{init:function(e,t,a){var i=this;i._super(e,t,a),i.criteriaSearchApplied=a.filters?bizagi.clone(a.filters):[],i.filtersApplied=[],i.previousCalculatedFilters=[],i.filterControlArray=[]},renderContent:function(){var e=this;return kendo.template(e.getTemplate("wp-filterBar"))({})},configureHandlers:function(){var e=this;e.unsubscribe("setFiltersData.filterBar"),e.subscribe("setFiltersData.filterBar",function(t,a){e.buildFilters(t,a)}),e.unsubscribe("setOrderBy.sortBar"),e.subscribe("setOrderBy.sortBar",function(t,a){e.setOrderBy(t,a)})},getFilters:function(){return this.filtersApplied},setOrderBy:function(e,t){var a=this;a.orderBy=t,a.triggerFilter({calculateFilters:!1})},buildFilter:function(e,t){var a=this;switch(t.type){case"Entity":a.buildFilterMultiple(e,t);break;case"Number":a.buildFilterNumber(e,t);break;case"Money":a.buildFilterMoney(e,t);break;case"Datetime":a.buildFilterDate(e,t);break;case"Boolean":a.buildFilterBoolean(e,t)}},setFilterData:function(e,t){e.widget.setData(t)},buildFilterNumber:function(e,t){var a=this,i=$("#"+t.id,a.content);e=new bizagi.filterNumber({properties:t,numericFormat:a.getResource("numericFormat"),$content:a.$modalViewTemplate,$opener:i,onApply:function(e){a._changeContainerTopMargin(),a.addFilterSelection(e),a.triggerFilter({calculateFilters:!0})},onClear:function(e){a._changeContainerTopMargin(),a.removeFilterApplied(e),a.triggerFilter({calculateFilters:!0})},getResource:function(e){return bizagi.localization.getResource(e)}}),i.click(function(){e.showDialog()}),a.filterControlArray.push({type:t.type,xpath:t.attribute,widget:e})},buildFilterBoolean:function(e,t){var a=this,i=$("#"+t.id,a.content);e=new bizagi.filterBoolean({properties:t,$content:a.$modalViewTemplate,$opener:i,onApply:function(e){a._changeContainerTopMargin(),a.addFilterSelection(e),a.triggerFilter({calculateFilters:!0})},onClear:function(e){a._changeContainerTopMargin(),a.removeFilterApplied(e),a.triggerFilter({calculateFilters:!0})},getResource:function(e){return bizagi.localization.getResource(e)}}),i.click(function(){e.showDialog()}),a.filterControlArray.push({type:t.type,xpath:t.attribute,widget:e})},buildFilterMoney:function(e,t){var a=this,i=$("#"+t.id,a.content);e=new bizagi.filterMoney({properties:t,numericFormat:a.getResource("numericFormat"),$content:a.$modalViewTemplate,$opener:i,onApply:function(e){a._changeContainerTopMargin(),a.addFilterSelection(e),a.triggerFilter({calculateFilters:!0})},onClear:function(e){a._changeContainerTopMargin(),a.removeFilterApplied(e),a.triggerFilter({calculateFilters:!0})},getResource:function(e){return bizagi.localization.getResource(e)}}),i.click(function(){e.showDialog()}),a.filterControlArray.push({type:t.type,xpath:t.attribute,widget:e})},buildFilterDate:function(e,t){var a=this,i=$("#"+t.id,a.content);e=new bizagi.filterDate({properties:t,$opener:i,$content:a.$modalViewTemplate,onApply:function(e){a._changeContainerTopMargin(),a.addFilterSelection(e),a.triggerFilter({calculateFilters:!0})},onClear:function(e){a._changeContainerTopMargin(),a.removeFilterApplied(e),a.triggerFilter({calculateFilters:!0})},getResource:function(e){return a.getResource(e)}}),i.click(function(){e.showDialog()}),a.filterControlArray.push({type:t.type,xpath:t.attribute,widget:e})},buildFilterMultiple:function(e,t){var a=this,i=$("#"+t.id,a.content);e=new bizagi.filterMultiple({properties:t,$content:a.$modalViewTemplate,$opener:i,onApply:function(e){a._changeContainerTopMargin(),a.addFilterSelection(e),a.triggerFilter({calculateFilters:!0})},onClear:function(e){a._changeContainerTopMargin(),a.removeFilterApplied(e),a.triggerFilter({calculateFilters:!0})},getResource:function(e){return bizagi.localization.getResource(e)}}),i.click(function(){e.showDialog()}),a.filterControlArray.push({type:t.type,xpath:t.attribute,widget:e})},addFilterSelection:function(e){for(var t=this,a=0,i=e.length;a<i;a++)t.removeFilterApplied([e[a].properties.xpath]),t.filtersApplied.push(e[a])},removeFilterApplied:function(e){for(var t,a=this,i=-1;t=e[++i];){var n=a.filtersApplied.find(function(e){return e.properties.xpath===t});n&&a.filtersApplied.splice(a.filtersApplied.indexOf(n),1)}},triggerFilter:function(e){for(var t,a=this,i=a.criteriaSearchApplied?bizagi.clone(a.criteriaSearchApplied):[],n=i.length,r=a.filtersApplied.slice(),o=-1;t=r[++o];)a.dataService.defineFilterObject(t,i);var s=i.length-n;a.orderBy&&a.dataService.defineFilterObject(a.orderBy,i);var l={guidSearch:a.params.guidSearch,filters:i,page:1,calculateFilters:e.calculateFilters||!1,filtersAppliedCounter:s,defaultFilterApplied:!1,typeSearch:"filter",pageSize:10,totalRecords:-1};bizagi.webpart.publish("update-Templates",l)}}),bizagi.workportal.webparts.filterBar.extend("bizagi.workportal.webparts.filterBar",{},{postRender:function(){var e=this,t=kendo.template(e.getTemplate("wp-filterModalView"));e.$modalViewTemplate=$(t({})),e.configureHandlers()},buildFilters:function(e,t){var a=this,i=a.getContent(),n=$(".wp-actions-filters",i),r=t.totalRecords>0?t.filters:a.previousCalculatedFilters,o=kendo.template(a.getTemplate("wp-filterItem"));if(t.defaultFilterApplied&&(a.filtersApplied=t.filtersApplied),0===a.filterControlArray.length){for(var s,l=-1;s=r[++l];){s.id="my-search-filter-"+s.attribute.replace(/\./g,"-");var c=$(o(s));"Text"!==s.type&&"Link"!==s.type&&s.data&&(s.data.defaultValues&&s.data.defaultValues.length>0||s.data.min&&s.data.max)&&(n.append(c),a.buildFilter(c,s))}0===n.children().length?$(".wp-actions-filter").hide():$(".wp-actions-filter").show()}else for(var s,l=-1;s=a.filterControlArray[++l];){var d=r.find(function(e){return e.attribute===s.xpath});d&&a.setFilterData(s,d.data)}},_changeContainerTopMargin:function(){var e=this,t=$(".bz-wp-filterBar",e.canvas).height()+80;$(e.container).animate({marginTop:t+"px"},200,"swing")}}),$.Class.extend("bizagi.filterBase",{},{init:function(e){this.options=e},showDialog:function(){var e=this;e.modalView=e.options.$content.clone(),e._render(),e.modalView.kendoMobileModalView({close:function(){this.destroy(),this.element.remove()}}),e.modalView.kendoMobileModalView("open"),e._configureHandlers(),e._setDisplayValue(),e.adjustModalViewHeight()},setData:function(e){var t=this;t.options.properties.data=void 0!==e?e:t.options.properties.data},setDisplayNameToDefault:function(){var e=this,t=e.options.$opener.text().split(":");e.options.$opener.text(t[0])},adjustModalViewHeight:function(){var e=this,t=e.modalView;if(t){var a=t.find("div.km-header").outerHeight(!0),i=0,n=t.find("div.km-scroll-container");n.is(":visible")&&(i+=n.outerHeight(!0)+10);var r=t.find("div.km-footer").outerHeight(!0),o=a+i+r;$(t.parent().parent()).css("max-height",t.css("max-height"));var s=$(document).height();s>o?(t.height(o),t.parent().parent().height(o)):(t.height(s-20),t.parent().parent().height(s-20))}}}),bizagi.filterBase.extend("bizagi.filterNumber",{},{init:function(e){var t=this;t._super(e),t._setReturnObject()},_render:function(){var e=this,t=e.options,a=t.getResource("bz-rp-components-time-from-label")+" ("+e._formatNumber(t.properties.data.min)+"):",i=t.getResource("bz-rp-components-time-to-label")+" ("+e._formatNumber(t.properties.data.max)+"):",n='<input type="number">';$("#ui-bizagi-title",e.modalView).text(t.properties.display),$("#filter-wrapper",e.modalView).empty(),$("#filter-wrapper",e.modalView).append("<li><label>"+a+"</label></li>"),$("#filter-wrapper",e.modalView).append('<li class="ui-bizagi-number-filter-min">'+n+"</li>"),$("#filter-wrapper",e.modalView).append("<li><label>"+i+"</label></li>"),$("#filter-wrapper",e.modalView).append('<li class="ui-bizagi-number-filter-max">'+n+"</li>"),$("#filter-wrapper",e.modalView).append('<li class="ui-bizagi-number-filter-notification" style="display: none;"><span></span></li>'),e._enableNotification(!1)},_setReturnObject:function(){var e=this,t=e.options.properties.attribute;e.returnObject=[{properties:{xpath:t+"@from",type:"number",typeSearch:"range",rangeQuery:"from"}},{properties:{xpath:t+"@to",type:"number",typeSearch:"range",rangeQuery:"to"}}]},_setValue:function(){var e=this,t=$(".ui-bizagi-number-filter-min input",e.modalView).asNumber(),a=$(".ui-bizagi-number-filter-max input",e.modalView).asNumber();e.returnObject[0].value=""===t?a:t,e.returnObject[1].value=""===a?t:a},_configureHandlers:function(){var e=this,t=e.options,a=$(".ui-bizagi-number-filter-min input",e.modalView),i=$(".ui-bizagi-number-filter-max input",e.modalView),n="return (event.charCode >= 48 && event.charCode <= 57) || event.charCode == 46 || event.charCode == 44";a.attr("onkeypress",n),i.attr("onkeypress",n),a.unbind().keyup(function(){var a=$(".ui-bizagi-number-filter-max input",e.modalView).asNumber(),i=$(this).asNumber(),n=parseFloat(i)<t.properties.data.min,r=parseFloat(a)>t.properties.data.max,o=parseFloat(i)>parseFloat(a);if(o||n||r){var s="Verifique los datos";n?s=t.getResource("workportal-my-search-lower-limit-notification"):r?s=t.getResource("workportal-my-search-upper-limit-notification"):o&&(s=t.getResource("workportal-my-search-max-min-notification")),e._enableNotification(!0,s)}else e._disableNotification()}),i.unbind().keyup(function(){var a=$(this).asNumber(),i=$(".ui-bizagi-number-filter-min input",e.modalView).asNumber(),n=parseFloat(i)<t.properties.data.min,r=parseFloat(a)>t.properties.data.max,o=parseFloat(i)>parseFloat(a);if(o||n||r){var s="Verifique los datos";n?s=t.getResource("workportal-my-search-lower-limit-notification"):r?s=t.getResource("workportal-my-search-upper-limit-notification"):o&&(s=t.getResource("workportal-my-search-max-min-notification")),e._enableNotification(!0,s)}else e._disableNotification()}),e._configureCallbacks()},_configureCallbacks:function(){var e=this,t=e.options;$("#ui-bizagi-cancel-filter",e.modalView).unbind().click(function(){e.modalView.kendoMobileModalView("close")}),$("#ui-bizagi-clear-filters",e.modalView).unbind().click(function(){var a=[e.returnObject[0].properties.xpath,e.returnObject[1].properties.xpath];e.setDisplayNameToDefault(),e._setReturnObject(),t.onClear(a),e.modalView.kendoMobileModalView("close")}),$("#ui-bizagi-apply-filter",e.modalView).unbind().click(function(){e._setValue(),e._addFiltersToDisplayName(),t.onApply(e.returnObject),e.modalView.kendoMobileModalView("close")})},_enableNotification:function(e,t){var a=this;e?($(".ui-bizagi-number-filter-notification span",a.modalView).text(t),$(".ui-bizagi-number-filter-notification",a.modalView).show()):$(".ui-bizagi-number-filter-notification",a.modalView).hide(),$("#ui-bizagi-apply-filter",a.modalView).attr("disabled","disabled"),$("#ui-bizagi-apply-filter",a.modalView).addClass("ui-state-disabled")},_disableNotification:function(){var e=this;$(".ui-bizagi-number-filter-notification",e.modalView).hide(),$("#ui-bizagi-apply-filter",e.modalView).removeAttr("disabled"),$("#ui-bizagi-apply-filter",e.modalView).removeClass("ui-state-disabled")},_addFiltersToDisplayName:function(){var e=this,t=e.options,a=t.$opener.text().split(":");t.$opener.text(a[0]+": "+e._formatNumber(e.returnObject[0].value)+" "+t.getResource("bz-rp-components-time-to-label")+" "+e._formatNumber(e.returnObject[1].value))},_setDisplayValue:function(){var e=this;e.returnObject[0].value&&e.returnObject[1].value&&($(".ui-bizagi-number-filter-min input",e.modalView).val(e.returnObject[0].value),$(".ui-bizagi-number-filter-max input",e.modalView).val(e.returnObject[1].value))},_formatNumber:function(e){var t=$('<input type="text">');return t.val(e),t.val()},_getFormatOptions:function(){return formatOptions={symbol:"",roundToDecimalPlace:0,eventOnDecimalsEntered:!0}}}),bizagi.filterBase.extend("bizagi.filterMoney",{},{init:function(e){var t=this;t._super(e),t._setReturnObject()},_render:function(){var e=this,t=e.options,a=t.getResource("bz-rp-components-time-from-label")+" ("+e._formatNumber(t.properties.data.min)+"):",i=t.getResource("bz-rp-components-time-to-label")+" ("+e._formatNumber(t.properties.data.max)+"):",n='<input type="number">';$("#ui-bizagi-title",e.modalView).text(t.properties.display),$("#filter-wrapper",e.modalView).empty(),$("#filter-wrapper",e.modalView).append("<li><label>"+a+"</label></li>"),$("#filter-wrapper",e.modalView).append('<li class="ui-bizagi-money-filter-min">'+n+"</li>"),$("#filter-wrapper",e.modalView).append("<li><label>"+i+"</label></li>"),$("#filter-wrapper",e.modalView).append('<li class="ui-bizagi-money-filter-max">'+n+"</li>"),$("#filter-wrapper",e.modalView).append('<li class="ui-bizagi-money-filter-notification" style="display: none;"><span></span></li>'),e._enableNotification(!1)},_setReturnObject:function(){var e=this,t=e.options.properties.attribute;e.returnObject=[{properties:{xpath:t+"@from",type:"money",typeSearch:"range",rangeQuery:"from"}},{properties:{xpath:t+"@to",type:"money",typeSearch:"range",rangeQuery:"to"}}]},_setValue:function(){var e=this,t=$(".ui-bizagi-money-filter-min input",e.modalView).asNumber(),a=$(".ui-bizagi-money-filter-max input",e.modalView).asNumber();e.returnObject[0].value=""===t?a:t,e.returnObject[1].value=""===a?t:a},_configureHandlers:function(){var e=this,t=e.options,a=$(".ui-bizagi-money-filter-min input",e.modalView),i=$(".ui-bizagi-money-filter-max input",e.modalView);a.attr("onkeypress","return event.charCode >= 48 && event.charCode <= 57"),i.attr("onkeypress","return event.charCode >= 48 && event.charCode <= 57"),a.unbind().keyup(function(){var a=$(".ui-bizagi-money-filter-max input",e.modalView).asNumber(),i=$(this).asNumber(),n=parseInt(i)<t.properties.data.min,r=parseInt(a)>t.properties.data.max,o=parseInt(i)>parseInt(a);if(o||n||r){var s="Verifique los datos";n?s=t.getResource("workportal-my-search-lower-limit-notification"):r?s=t.getResource("workportal-my-search-upper-limit-notification"):o&&(s=t.getResource("workportal-my-search-max-min-notification")),e._enableNotification(!0,s)}else e._disableNotification()}),i.unbind().keyup(function(){var a=$(this).asNumber(),i=$(".ui-bizagi-money-filter-min input",e.modalView).asNumber(),n=parseInt(i)<t.properties.data.min,r=parseInt(a)>t.properties.data.max,o=parseInt(i)>parseInt(a);if(o||n||r){var s="Verifique los datos";n?s=t.getResource("workportal-my-search-lower-limit-notification"):r?s=t.getResource("workportal-my-search-upper-limit-notification"):o&&(s=t.getResource("workportal-my-search-max-min-notification")),e._enableNotification(!0,s)}else e._disableNotification()}),e._configureCallbacks()},_configureCallbacks:function(){var e=this,t=e.options;$("#ui-bizagi-cancel-filter",e.modalView).unbind().click(function(){e.modalView.kendoMobileModalView("close")}),$("#ui-bizagi-clear-filters",e.modalView).unbind().click(function(){var a=[e.returnObject[0].properties.xpath,e.returnObject[1].properties.xpath];e.setDisplayNameToDefault(),e._setReturnObject(),t.onClear(a),e.modalView.kendoMobileModalView("close")}),$("#ui-bizagi-apply-filter",e.modalView).unbind().click(function(){e._setValue(),e._addFiltersToDisplayName(),t.onApply(e.returnObject),e.modalView.kendoMobileModalView("close")})},_enableNotification:function(e,t){
var a=this;e?($(".ui-bizagi-money-filter-notification span",a.modalView).text(t),$(".ui-bizagi-money-filter-notification",a.modalView).show()):$(".ui-bizagi-money-filter-notification",a.modalView).hide(),$("#ui-bizagi-apply-filter",a.modalView).attr("disabled","disabled"),$("#ui-bizagi-apply-filter",a.modalView).addClass("ui-state-disabled")},_disableNotification:function(){var e=this;$(".ui-bizagi-money-filter-notification",e.modalView).hide(),$("#ui-bizagi-apply-filter",e.modalView).removeAttr("disabled"),$("#ui-bizagi-apply-filter",e.modalView).removeClass("ui-state-disabled")},_addFiltersToDisplayName:function(){var e=this,t=e.options,a=t.$opener.text().split(":");t.$opener.text(a[0]+": "+e._formatNumber(e.returnObject[0].value)+" "+t.getResource("bz-rp-components-time-to-label")+" "+e._formatNumber(e.returnObject[1].value))},_setDisplayValue:function(){var e=this;e.returnObject[0].value&&e.returnObject[1].value&&($(".ui-bizagi-money-filter-min input",e.modalView).val(e.returnObject[0].value),$(".ui-bizagi-money-filter-max input",e.modalView).val(e.returnObject[1].value))},_formatNumber:function(e){var t=this,a=$('<input type="text">');return a.val(e),a.formatCurrency(t._getFormatOptions()),a.val()},_getFormatOptions:function(){var e=this,t=e.options.numericFormat;return formatOptions={symbol:t.symbol,roundToDecimalPlace:0,eventOnDecimalsEntered:!0}}}),bizagi.filterBase.extend("bizagi.filterDate",{},{init:function(e){var t=this;t._super(e),t._setReturnObject(),t.selectedValues={}},_render:function(){var e=this,t=e.options,a=e._getDateFromInvariant(t.properties.data.min),i=e._getDateFromInvariant(t.properties.data.max),n=t.getResource("bz-rp-components-time-from-label")+" ("+e._formatDate(a,t.getResource("dateFormat"))+"): ",r=t.getResource("bz-rp-components-time-to-label")+" ("+e._formatDate(i,t.getResource("dateFormat"))+"): ",o='<input type="text">';$("#ui-bizagi-title",e.modalView).text(t.properties.display),$("#filter-wrapper",e.modalView).empty(),$("#filter-wrapper",e.modalView).append("<li><label>"+n+"</label></li>"),$("#filter-wrapper",e.modalView).append('<li class="ui-bizagi-date-filter-from">'+o+"</li>"),$("#filter-wrapper",e.modalView).append("<li><label>"+r+"</label></li>"),$("#filter-wrapper",e.modalView).append('<li class="ui-bizagi-date-filter-to">'+o+"</li>"),$("#filter-wrapper",e.modalView).append('<li class="ui-bizagi-date-filter-notification" style="display: none;"><span></span></li>'),e._enableNotification(!1)},_setReturnObject:function(){var e=this,t=e.options.properties.attribute;e.returnObject=[{properties:{xpath:t+"@from",type:"date",typeSearch:"range",rangeQuery:"from"}},{properties:{xpath:t+"@to",type:"date",typeSearch:"range",rangeQuery:"to"}}]},_configureHandlers:function(){var e=this,t=e.options,a=new Date(e._getDateFromInvariant(t.properties.data.min)),i=new Date(e._getDateFromInvariant(t.properties.data.max)),n={defaultValue:a,display:"modal",mode:"mixed",cancelText:t.getResource("workportal-general-button-label-cancel"),setText:t.getResource("workportal-general-select"),dateFormat:t.getResource("dateFormat").toLowerCase(),showOnFocus:"true",min:a,max:i,onShow:function(e,t){$(".km-modalview-root").hide()},onClose:function(e,t){$(".km-modalview-root").show()},onSet:function(t,a){var i=a.getVal();e.selectedValues.fromDate=new Date(i.getFullYear(),i.getMonth(),i.getDate()),e._verifyData()}},r={defaultValue:i,display:"modal",mode:"mixed",cancelText:t.getResource("workportal-general-button-label-cancel"),setText:t.getResource("workportal-general-select"),dateFormat:t.getResource("dateFormat").toLowerCase(),showOnFocus:"true",min:a,max:i,onShow:function(e,t){$(".km-modalview-root").hide()},onClose:function(e,t){$(".km-modalview-root").show()},onSet:function(t,a){var i=a.getVal();e.selectedValues.toDate=new Date(i.getFullYear(),i.getMonth(),i.getDate()),e._verifyData()}};e._getFromControl().mobiscroll().calendar(n),e._getToControl().mobiscroll().calendar(r),e._configureCallbacks()},_configureCallbacks:function(){var e=this,t=e.options;$("#ui-bizagi-cancel-filter",e.modalView).unbind().click(function(){e.modalView.kendoMobileModalView("close")}),$("#ui-bizagi-clear-filters",e.modalView).unbind().click(function(){var a=[e.returnObject[0].properties.xpath,e.returnObject[1].properties.xpath];e.setDisplayNameToDefault(),e._setReturnObject(),t.onClear(a),e.modalView.kendoMobileModalView("close")}),$("#ui-bizagi-apply-filter",e.modalView).unbind().click(function(){e._setValuesOfReturnObject(),e._setDisplayTitle(),t.onApply(e.returnObject),e.modalView.kendoMobileModalView("close")})},_setValuesOfReturnObject:function(){var e=this,t=e._getFromControl().mobiscroll("getDate"),a=e._getToControl().mobiscroll("getDate");e.returnObject[0].value=null!==t?e._formatDate(t,"MM/dd/yyyy"):e._formatDate(a,"MM/dd/yyyy"),e.returnObject[1].value=null!==a?e._formatDate(a,"MM/dd/yyyy"):e._formatDate(t,"MM/dd/yyyy")},_setDisplayTitle:function(){var e=this,t=e.options,a=t.$opener.text().split(":"),i=e._getDateFromInvariant(e.returnObject[0].value),n=e._getDateFromInvariant(e.returnObject[1].value);t.$opener.text(a[0]+": "+e._formatDate(i,t.getResource("dateFormat"))+" "+t.getResource("bz-rp-components-time-to-label")+" "+e._formatDate(n,t.getResource("dateFormat")))},_setDisplayValue:function(){},_enableNotification:function(e,t){var a=this;e?($(".ui-bizagi-date-filter-notification span",a.modalView).text(t),$(".ui-bizagi-date-filter-notification",a.modalView).show()):$(".ui-bizagi-date-filter-notification",a.modalView).hide(),$("#ui-bizagi-apply-filter",a.modalView).attr("disabled","disabled"),$("#ui-bizagi-apply-filter",a.modalView).addClass("ui-state-disabled")},_disableNotification:function(){var e=this;$(".ui-bizagi-date-filter-notification",e.modalView).hide(),$("#ui-bizagi-apply-filter",e.modalView).removeAttr("disabled"),$("#ui-bizagi-apply-filter",e.modalView).removeClass("ui-state-disabled")},_formatDate:function(e,t){return bizagi.util.dateFormatter.formatDate(e,t)},_getFromControl:function(){var e=this;return $(".ui-bizagi-date-filter-from input",e.modalView)},_getToControl:function(){var e=this;return $(".ui-bizagi-date-filter-to input",e.modalView)},_getDateFromInvariant:function(e){return bizagi.util.dateFormatter.getDateFromInvariant(e)},_verifyData:function(){var e=this,t=e.options,a=void 0===e.selectedValues.fromDate,i=void 0===e.selectedValues.toDate,n=e.selectedValues.fromDate<new Date(t.properties.data.min).setHours(0,0,0,0),r=e.selectedValues.toDate>new Date(t.properties.data.max).setHours(0,0,0,0),o=e.selectedValues.fromDate>e.selectedValues.toDate;if(a||i)e._enableNotification(!1);else if(o||n||r){var s="Verifique los datos";n?s=t.getResource("workportal-my-search-lower-limit-notification"):r?s=t.getResource("workportal-my-search-upper-limit-notification"):o&&(s=t.getResource("workportal-my-search-max-min-notification")),e._enableNotification(!0,s)}else e._disableNotification()}}),bizagi.filterBase.extend("bizagi.filterMultiple",{},{init:function(e){var t=this;t._super(e),t._setReturnObject(),t._bindDefaultFilter()},_bindDefaultFilter:function(){for(var e,t=this,a=t.options.properties.data||[],i=": ",n=-1,r=!1;e=a.defaultValues[++n];)e.applied&&(r=!0,t.returnObject.value.push({id:e.id}),i+=e.displayName);if(r){var o=t.options.$opener.text().split(":");t.options.$opener.text(o[0]+i)}},_render:function(){var e,t=this,a=t.options,i=-1,n=a.getResource("render-boolean-yes"),r=a.getResource("render-boolean-no");for($("#ui-bizagi-title",t.modalView).text(a.properties.display),$("#filter-wrapper",t.modalView).empty();e=a.properties.data.defaultValues[++i];)if(""!=e.id&&""!=e.displayName){var o="<li>"+e.displayName;o+='<input data-role="switch" data-off-label="'+r+'" data-on-label="'+n,o+='" data-displayname="'+e.displayName+'" id="'+e.id+'" type="checkbox" >',o+="</li>",e.applied&&$(o).kendoMobileSwitch({checked:!0}),$("#filter-wrapper",t.modalView).append($(o))}t._disableApply()},_setReturnObject:function(){var e=this;e.returnObject={properties:{xpath:e.options.properties.attribute,type:"entity",typeSearch:"exact"},value:[]}},_setValue:function(e,t){var a=this;if(t)a.returnObject.value.push({id:e}),a._enableApply();else{var i=a.returnObject.value.find(function(t){return t.id==e});i&&a.returnObject.value.splice(a.returnObject.value.indexOf(i),1),0==a.returnObject.value.length?a._disableApply():a._enableApply()}},_configureHandlers:function(){var e=this;$("#filter-wrapper input:checkbox",e.modalView).each(function(){$(this).data("kendoMobileSwitch").bind("change",function(t){e._setValue(t.sender.element.attr("id"),t.checked)})}),e._configureCallbacks()},_configureCallbacks:function(){var e=this,t=e.options;$("#ui-bizagi-cancel-filter",e.modalView).unbind().click(function(){e.modalView.kendoMobileModalView("close")}),$("#ui-bizagi-clear-filters",e.modalView).unbind().click(function(){var a=[e.returnObject.properties.xpath];e.setDisplayNameToDefault(),e._setReturnObject(),t.onClear(a),e.modalView.kendoMobileModalView("close")}),$("#ui-bizagi-apply-filter",e.modalView).unbind().click(function(){e._addFiltersToDisplayName(),t.onApply([e.returnObject]),e.modalView.kendoMobileModalView("close")})},_enableApply:function(){var e=this,t=$("#ui-bizagi-apply-filter",e.modalView);t.removeAttr("disabled"),t.removeClass("ui-state-disabled")},_disableApply:function(){var e=this,t=$("#ui-bizagi-apply-filter",e.modalView);t.attr("disabled","disabled"),t.addClass("ui-state-disabled")},_addFiltersToDisplayName:function(){var e=this,t=e.options.$opener.text().split(":"),a=t[0]+": ",i=e.returnObject.value.length;$("#filter-wrapper input:checked",e.modalView).each(function(){i--,a=a+$(this).data("displayname")+(0==i?"":", ")}),e.options.$opener.text(a)},_setDisplayValue:function(){for(var e,t=this,a=-1;e=t.returnObject.value[++a];){$("#filter-wrapper input#"+e.id+":checkbox",t.modalView).data("kendoMobileSwitch").toggle()}}}),bizagi.filterBase.extend("bizagi.filterBoolean",{},{init:function(e){var t=this;t._super(e),t._setReturnObject()},_render:function(){var e,t=this,a=t.options,i=-1;for($("#ui-bizagi-title",t.modalView).text(a.properties.display),$("#filter-wrapper",t.modalView).empty();e=a.properties.data.defaultValues[++i];)""!=e.id&&""!=e.displayName&&$("#filter-wrapper",t.modalView).append($('<li class="filter-item"><input type="radio" name="filterBoolean" id="'+e.id+'" class="k-radio"><label class="k-radio-label" for="'+e.id+'">'+bizagi.util.formatBoolean(e.displayName)+"</label></li>"));void 0!==t.returnObject.value&&t._disableApply()},_setReturnObject:function(){var e=this;e.returnObject={properties:{xpath:e.options.properties.attribute,type:"boolean",typeSearch:"exact"}}},_setValue:function(e){var t=this;t.returnObject.value=e,t._enableApply()},_configureHandlers:function(){var e=this;$("#filter-wrapper input:radio",e.modalView).bind("change",function(t){e._setValue(this.id)}),e._configureCallbacks()},_configureCallbacks:function(){var e=this,t=e.options;$("#ui-bizagi-cancel-filter",e.modalView).unbind().click(function(){e.modalView.kendoMobileModalView("close")}),$("#ui-bizagi-clear-filters",e.modalView).unbind().click(function(){var a=[e.returnObject.properties.xpath];e.setDisplayNameToDefault(),e._setReturnObject(),t.onClear(a),e.modalView.kendoMobileModalView("close")}),$("#ui-bizagi-apply-filter",e.modalView).unbind().click(function(){e._addFiltersToDisplayName(),t.onApply([e.returnObject]),e.modalView.kendoMobileModalView("close")})},_enableApply:function(){var e=this,t=$("#ui-bizagi-apply-filter",e.modalView);t.removeAttr("disabled"),t.removeClass("ui-state-disabled")},_disableApply:function(){var e=this,t=$("#ui-bizagi-apply-filter",e.modalView);t.attr("disabled","disabled"),t.addClass("ui-state-disabled")},_addFiltersToDisplayName:function(){var e=this,t=e.options.$opener,a=bizagi.util.formatBoolean(e.returnObject.value),i=t.text().indexOf(":")>0?t.text().substring(0,t.text().indexOf(":")):t.text();t.text(i+": "+a)},_setDisplayValue:function(){var e=this;if(void 0!==e.returnObject.value){e.returnObject.value,$("#filter-wrapper input:radio",e.modalView).click()}}}),bizagi.workportal.webparts.webpart.extend("bizagi.workportal.webparts.homePortal",{DEVICE_TABLET_IOS:"tablet_ios",DEVICE_TABLET_ANDROID:"tablet_android",TEMPLATE_CONTENT_NAME:"homePortal-tmpl",SMARTINBOX_SHARE:"sharedSmartInbox",LAST_PROCESS_ICON:"#a-last-open-inbox-icon",LAST_PROCESS_NAME:"#a-last-open-inbox-name",DIV_LAST_PROCESS:"#div-last-open-inbox-item",BZ_WP_HOME_PROCESSES_LIST:".bz-wp-home-processes-list-container",ACTIVE_PROCESS_LIST:"#active-process-list",SMARTINBOX_PROCESS_LIST:"#active-smartinbox-list",VIEW_TYPE:"detailView",FILTERS_RESTRICTED_COLUMNS:["currentfullname","currentlocation","currentusername","baworkflowpath"]},{init:function(e,t,a){var i=this;this._super(e,t,a),i.setDefaultData(),i.configureTriggers(),i.leftPanelBehavior()},setDefaultData:function(){var e=this;e.processListEnabled=bizagi.util.validateFeatureSupport("processListEnabled");var t={sort:[{field:"orderValue",dir:"asc"}]};e.activeProcessDataSource=new kendo.data.DataSource(t),e.maxColumnsAllowedOnView=0,e.sortEnabled=bizagi.util.validateFeatureSupport("sortEnabled"),e.sortDataSource=new kendo.data.DataSource,e.sortDirectionAsc="asc",e.sortDirectionDesc="desc",e.filterableColumnsDataSource=[],e.filterDataSource=new kendo.data.DataSource({schema:{model:{id:"id",index:-1}}}),e.possibleOperators=[{id:"is-empty",name:bizagi.localization.getResource("workportal-widget-smartinbox-filters-is-empty-label","is empty"),control:"none",requireValue:!1,appliesTo:["boolean","int","bigint","smallint","tinyint","decimal","numeric","money","float","real","varchar","char","text","nchar","nvarchar","ntext","datetime","smalldatetime","entity"]},{id:"is-not-empty",name:bizagi.localization.getResource("workportal-widget-smartinbox-filters-is-not-empty-label","is not empty"),control:"none",requireValue:!1,appliesTo:["boolean","int","bigint","smallint","tinyint","decimal","numeric","money","float","real","varchar","char","text","nchar","nvarchar","ntext","datetime","smalldatetime","entity"]},{id:"equals",name:bizagi.localization.getResource("workportal-widget-smartinbox-filters-equals-label","equals"),control:"simple",requireValue:!0,appliesTo:["boolean","int","bigint","smallint","tinyint","decimal","numeric","money","float","real","varchar","char","text","nchar","nvarchar","ntext","entity"]},{id:"not-equals",name:bizagi.localization.getResource("workportal-widget-smartinbox-filters-not-equals-label","not equals"),control:"simple",requireValue:!0,appliesTo:["boolean","int","bigint","smallint","tinyint","decimal","numeric","money","float","real","varchar","char","text","nchar","nvarchar","ntext","entity"]},{id:"starts-with",name:bizagi.localization.getResource("workportal-widget-smartinbox-filters-starts-with-label","starts with"),control:"compound-array",requireValue:!0,appliesTo:["varchar","char","text","nchar","nvarchar","ntext","entity"]},{id:"not-starts-with",name:bizagi.localization.getResource("workportal-widget-smartinbox-filters-not-starts-with-label","not starts with"),control:"simple",requireValue:!0,appliesTo:["varchar","char","text","nchar","nvarchar","ntext","entity"]},{id:"ends-with",name:bizagi.localization.getResource("workportal-widget-smartinbox-filters-ends-with-label","ends with"),control:"compound-array",requireValue:!0,appliesTo:["varchar","char","text","nchar","nvarchar","ntext","entity"]},{id:"not-ends-with",name:bizagi.localization.getResource("workportal-widget-smartinbox-filters-not-ends-with-label","not ends with"),control:"simple",requireValue:!0,appliesTo:["varchar","char","text","nchar","nvarchar","ntext","entity"]},{id:"contains",name:bizagi.localization.getResource("workportal-widget-smartinbox-filters-contains-label","contains"),control:"compound-array",requireValue:!0,appliesTo:["varchar","char","text","nchar","nvarchar","ntext","entity"]},{id:"not-contains",name:bizagi.localization.getResource("workportal-widget-smartinbox-filters-not-contains-label","not contains"),control:"simple",requireValue:!0,appliesTo:["varchar","char","text","nchar","nvarchar","ntext","entity"]},{id:"greater-than",name:bizagi.localization.getResource("workportal-widget-smartinbox-filters-greater-than-label","greater than"),control:"simple",requireValue:!0,appliesTo:["int","bigint","smallint","tinyint","decimal","numeric","money","float","real","datetime"]},{id:"greater-than-or-equals",name:bizagi.localization.getResource("workportal-widget-smartinbox-filters-greater-than-or-equals-label","greater than or equals"),control:"simple",requireValue:!0,appliesTo:["int","bigint","smallint","tinyint","decimal","numeric","money","float","real","datetime"]},{id:"less-than",name:bizagi.localization.getResource("workportal-widget-smartinbox-filters-less-than-label","less than"),control:"simple",requireValue:!0,appliesTo:["int","bigint","smallint","tinyint","decimal","numeric","money","float","real","datetime"]},{id:"less-than-or-equals",name:bizagi.localization.getResource("workportal-widget-smartinbox-filters-less-than-or-equals-label","less than or equals"),control:"simple",requireValue:!0,appliesTo:["int","bigint","smallint","tinyint","decimal","numeric","money","float","real","datetime"]},{id:"on",name:bizagi.localization.getResource("workportal-widget-smartinbox-filters-on-label","on"),control:"on-date",requireValue:!0,appliesTo:["datetime"]},{id:"between",name:bizagi.localization.getResource("workportal-widget-smartinbox-filters-between-label","between"),control:"compound",requireValue:!0,appliesTo:["datetime","int","smallint","tinyint","decimal","numeric","money","float","real","bigint"]},{id:"in",name:bizagi.localization.getResource("workportal-widget-smartinbox-filters-in-label","in"),control:"compound-array",requireValue:!0,appliesTo:["varchar","char","text","nchar","int","bigint","smallint","tinyint","decimal","numeric","money","float","real","entity"]},{id:"not-in",name:bizagi.localization.getResource("workportal-widget-smartinbox-filters-not-in-label","not in"),control:"compound-array",requireValue:!0,appliesTo:["varchar","char","text","nchar","int","bigint","smallint","tinyint","decimal","numeric","money","float","real","entity"]}],e.defaultInboxEnabled=bizagi.util.validateFeatureSupport("defaultInboxEnabled")},renderContent:function(e){var t=this,a=$.Deferred();return bizagi.util.isMobileDevice()?(t.hasOfflineForm=bizagi.util.hasOfflineFormsEnabled(),t.modeInbox=bizagi.util.getLastProcessInboxInputTray()):(BIZAGI_ENABLE_OFFLINE_FORMS=!1,t.hasOfflineForm=BIZAGI_ENABLE_OFFLINE_FORMS),t.isOfflineErrorsViewSupported=bizagi.util.isOfflineErrorsViewSupported(),t.content=t.homePortalFramework.loadComponentTemplate(t.Class.TEMPLATE_CONTENT_NAME,"homePortal",{hasOfflineForm:t.hasOfflineForm,sortEnabled:t.sortEnabled,showSyncErrorsView:t.isOfflineErrorsViewSupported}),t.content=t.adjustTemplateElements(t.content),t.activeProcessesListContainer=$(t.Class.BZ_WP_HOME_PROCESSES_LIST,t.content),a.resolve(t.content),a.promise()},smartInboxShare:function(){self=this;var e=bizagi.util.getQueryString(),t=bizagi.util.getQueryString(document.referrer),a=self.workportalFacade.getTemplate(self.Class.SMARTINBOX_SHARE);(e.widget&&"smartinbox"==e.widget&&e.action&&"create"==e.action||t.widget&&"smartinbox"==t.widget&&t.action&&"create"==t.action)&&$(a).dialog({title:bizagi.localization.getResource("workportal-general-word-error-message"),width:"400px",modal:!0})},adjustTemplateElements:function(e){return e},postRender:function(e){var t=this;return t.homePortalFramework.loadComponents("homePortal",t.content).done(function(){t.processListEnabled&&t.renderProcessList(),t.sortEnabled&&t.renderSortList(),void 0!==bizagi.util.getLastProcessInboxSmartInboxId()&&null!=bizagi.util.getLastProcessInboxSmartInboxId()?t.createFilterDataSource(bizagi.util.getLiveFiltersFromStorage(bizagi.util.getLastProcessInboxSmartInboxId())):t.createFilterDataSource(bizagi.util.getLiveFiltersFromStorage(bizagi.util.getLastProcessInbox().processInfo.idWorkflow)),t.smartInboxShare()})},configureHandlers:function(){},configureTriggers:function(){$(document).off("cleanLastOpenInbox.homePortal"),$(document).on("cleanLastOpenInbox.homePortal",function(){bizagi.util.removeLastProcessInbox()})},setStatusDescription:function(e){var t=this;t.setStatusType("updating-counter"),t.statusDescription.html(e)},retryDownloadCases:function(){$(document).trigger("retry-download-offline-forms")},updateSyncState:function(e){var t=this;if(e=e||{},"download-started"===e.type)t.setStatusType("calculating");else if("up-to-date"===e.type)bizagi.util.storeSyncTimeStamp(new Date),t.setStatusType("up-to-date");else if("update-total-downloads"===e.type)t.formsDownloaded=0,t.formsFailed=0,t.formsTotal=0,e.argument>0&&(t.formsTotal=e.argument,t.setStatusType("downloading"));else if("form-finished"===e.type&&t.formsTotal>0){"success"===e.argument?t.formsDownloaded++:t.formsFailed++;var a=Math.ceil(100*t.formsDownloaded/t.formsTotal);t.setStatusDescription(a+"%")}else"download-finished"===e.type?(bizagi.util.storeSyncTimeStamp(new Date),t.setStatusType("download-successful"),t.formsDownloaded=0,t.formsFailed=0,t.formsTotal=0):"download-error"===e.type&&(t.formsDownloaded=0,t.formsFailed=0,t.formsTotal=0,t.setStatusType("download-error"))},updateSyncErrorsState:function(e){if(e=e||{},void 0!=this.syncErrorsIcon&&this.isOfflineErrorsViewSupported){var t=e.errors>0?"#sync-failed-24x":"#sync-cases";this.syncErrorsIcon.attr("xlink:href",t)}},setOfflineNotificationStatusClass:function(e){var t=this;show=!e,_getClass=function(e){return e?"online":"offline"},t.offlineStatusContainer.removeClass(_getClass(show)).addClass(_getClass(e))},offlineNotificationAnimate:function(e){this.setOfflineNotificationStatusClass(e)},isOnline:function(){return this.dataService.online},setStatusType:function(e){var t=this,a="online"===e;if(_show=!a,t.actionsContainer.hide(),t.offlineNotificationAnimate(a),_show)switch(e){case"offline":t.statusIcon.attr("xlink:href","#icon-offline"),t.statusIcon.css("fill","#9E9E9E"),t.statusTitle.text(t.getResource("workportal-offline-mode","Currently working in offline mode")),t.setOfflineDescriptionUpdater();break;case"calculating":t.statusIcon.attr("xlink:href","#icon-retrieve-offline"),t.statusIcon.css("fill","#9E9E9E"),t.statusTitle.text(t.getResource("wokrportal-offline-retrieving-offline-work-message","Retrieving offline work")),t.setStatusDescription("");break;case"downloading":t.statusIcon.attr("xlink:href","#icon-download"),t.statusIcon.css("fill","#9E9E9E"),t.statusTitle.text(t.getResource("wokrportal-offline-retrieving-offline-work-message","Retrieving offline work")),t.setStatusDescription("0%");break;case"download-successful":t.formsTotal>0&&(t.statusIcon.attr("xlink:href","#icon-check-mark"),t.statusIcon.css("fill","#2D8631"),t.statusTitle.text(t.getResource("workportal-offline-download-success-title","Download successful")),t.setStatusDescription("100%")),setTimeout(function(){t.setStatusType("online")},2e3);break;case"download-error":if(t.statusIcon.attr("xlink:href","#icon-warning"),t.statusIcon.css("fill","#DA3B3B"),t.statusTitle.text(t.getResource("workportal-offline-download-error-title","Download error")),void 0!==t.formsFailed&&t.formsFailed>0){var i=t.getResource("workportal-offline-download-error-count","Forms failed: {0}");t.setStatusDescription(i.replace("{0}",t.formsFailed))}else t.setStatusDescription("");t.actionsContainer.show();break;case"up-to-date":t.statusIcon.attr("xlink:href","#icon-check-mark"),t.statusIcon.css("fill","#2D8631"),t.statusTitle.text(t.getResource("workportal-offline-up-to-date-message","Your offline work is up to date")),t.setStatusDescription("")}},setOfflineDescriptionUpdater:function(){var e=this;if(!e.isOnline()){var t=e.generateSyncTimeHTML();e.setStatusDescription(t),setTimeout(e.setOfflineDescriptionUpdater.bind(e),6e4)}},generateSyncTimeHTML:function(){var e=this;if(bizagi.util.getSyncTimeStamp()){return"<p>"+e.getResource("workportal-offline-synchronized","Synchronized {0}").replace("{0}",bizagi.util.dateFormatter.getRelativeTime(bizagi.util.getSyncTimeStamp()))+"</p>"}return""},changeStatusConnection:function(){var e=this;if(e.dataService.online)e.setStatusType("online"),e.hasOfflineForm||(bizagi.webpart.publish("bz-summary-item-clear"),e.publish("bz-update-list-cases",{updateDataList:!0}));else{e.setStatusType("offline");try{$(e.Class.ACTIVE_PROCESS_LIST,e.content).data("kendoMobileListView").scroller().scrollTo(0,0)}catch(e){}e.hasOfflineForm||(e.hasStakeholders?$("[data-menu-action='taskfeed']",".bz-wp-menu-list").click():(bizagi.webpart.publish("bz-summary-item-clear"),e.publish("bz-update-list-cases",{updateDataList:!0})),setTimeout(function(){bizagi.showMessageBox(e.getResource("workportal-general-error-connection"))},100))}},configureProcessMenuHandler:function(){var e=this,t=$(e.Class.DIV_LAST_PROCESS,e.content);t&&t.on("touchend",function(t){t.preventDefault(),e.getActiveProcessesHandler()}),e.setLastOpenInbox(),e.defaultInboxEnabled&&$.when(e.dataService.getLastProcessInboxWorkflow()).then(function(t){e.setLastOpenInbox(t.processInfoName)}).fail(function(){e.setLastOpenInbox()})},changeVisibility:function(e){var t=this,a=$(t.Class.DIV_LAST_PROCESS,t.content);e?a.show():a.hide()},getActiveProcessesHandler:function(){var e=this,t=$(e.Class.ACTIVE_PROCESS_LIST,e.content);t&&("none"==t.css("display")?(e.toggleLastOpenInboxIcon(!0),e.refreshProcessList()):(e.toggleLastOpenInboxIcon(!1),e.toggleProcessList(!1)))},toggleLastOpenInboxIcon:function(e){var t=this,a=$(t.Class.LAST_PROCESS_ICON,t.content),i=a.find(".km-icon.km-arrow-down.km-notext"),n=a.find(".km-icon.km-arrow-up.km-notext");a&&(!0===e?(a.attr("data-icon","arrow-up"),i.removeClass("km-arrow-down").addClass("km-arrow-up")):(a.attr("data-icon","arrow-down"),n.removeClass("km-arrow-up").addClass("km-arrow-down")))},renderProcessList:function(){var e=this,t=$(e.Class.BZ_WP_HOME_PROCESSES_LIST,e.content),a=$(e.Class.ACTIVE_PROCESS_LIST,e.content);t.kendoMobileScroller(),a.kendoMobileListView({dataSource:e.activeProcessDataSource,template:e.workportalFacade.getTemplate("active-process-list-item"),click:e.onClickProcessList.bind(e)})},onClickProcessList:function(e){var t=this;if(!e.target.data("disabled")){var a=e.target.parent(),i=a.data();bizagi.util.isEmpty(i)||(t.filterableColumnsDataSource=[],bizagi.util.removeLastProcessLiveFilters(),e.preventDefault(),t.cleanSort(),bizagi.util.setLastProcessInbox(i.name,i.idworkflow,i.id),t.setLastOpenInbox(i.name),"processes"==i.type?(t.publish("bz-update-list-cases",{updateDataList:!0,resetScrollAfterLoad:!0,inboxType:"process"}),t.createFilterDataSource(bizagi.util.getLiveFiltersFromStorage(i.idworkflow))):(t.publish("bz-update-list-cases",{updateDataList:!0,resetScrollAfterLoad:!0,smartInboxId:i.id,inboxType:"smartinbox"}),t.createFilterDataSource(bizagi.util.getLiveFiltersFromStorage(i.id))))}},createFilterDataSource:function(e){var t=this;$.each(e,function(e,a){var i=t.getOperatorById(a.selectedOperator.id);void 0!==i&&(a.selectedOperator=i)}),t.filterDataSource=new kendo.data.DataSource({schema:{model:{id:"id",index:-1}}}),t.filterDataSource.data(e)},cleanSort:function(){bizagi.util.removeLastProcessInboxSort()},refreshProcessList:function(){var e=this;$.when(e.dataService.getAllProcesses({taskState:"all",onlyFavorites:!1,inputtray:"inbox",skipAggrupate:!0,mobileDevice:!0}),e.dataService.getAllSmartInbox()).done(function(t,a){e.setCheckedProcessSelected(t.workflows.workflow),e.activeProcessDataSource.data([{isOffline:!e.isOnline(),workflows:t.workflows.workflow,smartInbox:a}]),e.toggleProcessList(!0)})},setCheckedProcessSelected:function(e){if(e){var t=bizagi.util.getLastProcessInboxProcessInfo();e.forEach(function(e){e.idworkflow&&(e.idworkflow==t.idWorkflow?e.isSelected=!0:e.isSelected=!1)})}return e},toggleProcessList:function(e){var t=this,a=$(t.Class.ACTIVE_PROCESS_LIST,t.content);a&&(e?a.show():a.hide())},setLastOpenInbox:function(e){var t,a=this;if(void 0!=e&&e.length>0)t=e;else{t=bizagi.util.getLastProcessInboxProcessInfo().processInfoName}$(a.Class.LAST_PROCESS_NAME,a.content).html(t),a.toggleLastOpenInboxIcon(!1),a.toggleProcessList(!1)},configureSortMenuHandler:function(){var e=this,t=$(".bz-header-sort-btn",e.content);t&&t.on("touchend",function(t){t.preventDefault(),e.toggleSortMenuHandler()});var a=bizagi.util.getLastProcessInboxSort();e.setSortColumnAndDirection(a,!1)},initSortDataSource:function(){var e=this;return e.dataService.getLastSelectionCustomColumns().then(function(t){var a=e.selectAvailableColumnsFromHeader(t);a=e.addDefaultColumn(a);var i=e.setCheckedColumnHeader(a);e.sortDataSource.data(i)})},initFilterDataSource:function(){var e=this;return e.dataService.getLastSelectionCustomColumns().then(function(t){e.filterableColumnsDataSource=e.selectAvailableColumnsFromHeader(t)})},addDefaultColumn:function(e){return e},toggleSortMenuHandler:function(){var e=this;e.initSortDataSource().then(function(){var t=$(".bz-wp-home-sort-menu-container",e.canvas);console.log("toggleSortMenuHandler : webpart.homeportal.js : touchend"),"none"===t.css("display")?(t.show(),e.changeVisibility(!1),e.toggleProcessList(!1),e.hideOfflineMenu()):e.hideSortMenu()})},hideOfflineMenu:function(){var e=this;if("none"!=$(".bz-wp-home-offline-menu-container",e.canvas).css("display")){var t=$(".bz-header-offline-btn");t&&t.click()}},hideSortMenu:function(){var e=this;$(".bz-wp-home-sort-menu-container",e.canvas).hide(),e.changeVisibility(!0),e.toggleProcessList(!1),e.toggleLastOpenInboxIcon(!1)},renderSortList:function(){var e=this,t=$(".bz-wp-home-sort-menu-container",e.content),a=$("#sort-columns-list",e.content);t.kendoMobileScroller(),a.kendoMobileListView({dataSource:e.sortDataSource,template:e.workportalFacade.getTemplate("active-sort-list-item"),click:function(t){var a={sortFieldName:t.dataItem.fieldName,order:t.dataItem.order};e.setSortColumnAndDirection(a,!0),e.publish("bz-update-list-cases",{updateDataList:!0}),e.hideSortMenu()}})},setCheckedColumnHeader:function(e){if(e){var t=bizagi.util.getLastProcessInboxSort();e.forEach(function(e){e.fieldName&&(e.fieldName===t.sortFieldName?(e.isSelected=!0,e.sortDirection=t.sortDirection):(e.isSelected=!1,e.sortDirection=""))})}return e},setSortColumnAndDirection:function(e,t){var a=this,i=bizagi.util.getLastProcessInboxSort();e?(i.sortDirection=i.sortDirection==a.sortDirectionAsc?a.sortDirectionDesc:a.sortDirectionAsc,i.sortFieldName=e.sortFieldName,t&&e.sortFieldName&&bizagi.util.setLastProcessInboxSort(e.sortFieldName,i.sortDirection,e.order)):bizagi.util.removeLastProcessInboxSort()},selectAvailableColumnsFromHeader:function(e){var t=this,a=0,i=[];bizagi.util.getLastProcessInboxSmartInboxId();for(var n=bizagi.util.getLastProcessInboxProcessInfo(),r=void 0!==n.smartInboxId&&null!==n.smartInboxId,o=0;o<e.length;o++){const s=e[o];if(!(t.Class.FILTERS_RESTRICTED_COLUMNS.indexOf(s.fieldName)>-1)&&(s&&s.fieldName)){var l=!1;if(t.dataService.isInboxSystemHeaderSortable(s,n,t.Class.VIEW_TYPE))l=!0,(s.isSmartInbox||s.isCustomColumn)&&(a+=1);else{if(r&&!s.isSmartInbox)continue;var c=t.dataService.validateCustomColumn(s,t.maxColumnsAllowedOnView,a);l=c.isValid,a=c.selectedColumnsCount}l&&i.push(s)}}return i.sort(function(e,t){return e.displayName<t.displayName?-1:e.displayName>t.displayName?1:0})},leftPanelBehavior:function(){bizagi.webpart.subscribe("bz-left-panel-hide",function(){$("#left-pane").hide()}),bizagi.webpart.subscribe("bz-left-panel-show",function(){$("#left-pane").show()})},generateUUID:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})},getOperatorsByDatatype:function(e){var t=this,a=[];if(e){e=e.toLowerCase();var i=$.grep(t.possibleOperators,function(t){return t.appliesTo.indexOf(e)>=0});Array.prototype.push.apply(a,i)}return a},getOperatorById:function(e){var t=this
;return void 0!==e?t.possibleOperators.find(function(t){return t.id==e}):void 0},isBooleanDataType:function(e){return"boolean"==(e=e.toLowerCase())},isTextDataType:function(e){var t=["varchar","char","text","nchar","nvarchar","ntext"];return e=e.toLowerCase(),t.indexOf(e)>-1},isIntDataType:function(e){var t=["int","bigint","smallint","tinyint"];return e=e.toLowerCase(),t.indexOf(e)>-1},isRealDataType:function(e){var t=["decimal","numeric","money","float","real"];return e=e.toLowerCase(),t.indexOf(e)>-1},isDateTimeDataType:function(e){var t=["datetime","smalldatetime"];return e=e.toLowerCase(),t.indexOf(e)>-1},isEntityDataType:function(e){return"entity"==(e=e.toLowerCase())},getIconByType:function(e){e=e.toLowerCase();var t=["int","bigint","smallint","tinyint"],a=["decimal","numeric","money","float","real"],i=["datetime","smalldatetime"];return"boolean"==e?"icon-datatype-boolean":i.indexOf(e)>-1?"icon-datatype-datetime":"entity"==e?"icon-datatype-entity":t.indexOf(e)>-1?"icon-datatype-int":a.indexOf(e)>-1?"icon-datatype-real":"icon-datatype-text"}}),bizagi.workportal.webparts.homePortal.extend("bizagi.workportal.webparts.homePortal",{},{init:function(e,t,a){this._super(e,t,a)},postRender:function(e){var t=this;return t.hasStakeholders=bizagi.currentUser.associatedStakeholders&&bizagi.currentUser.associatedStakeholders.length>0,t._super(e).done(function(){t.hasOfflineForm&&t.renderMenuOptions(),t.configureHandlers(),t.updateSyncErrorsState()})},configureHandlers:function(){var e=this,t=e.getContent();e.offlineStatusContainer=$(".bz-wp-status-container",t),e.statusIcon=$("#bz-wp-status-icon-use",e.offlineStatusContainer),e.statusTitle=$("span.bz-wp-status-title",e.offlineStatusContainer),e.statusDescription=$("span.bz-wp-status-description",e.offlineStatusContainer),e.actionsContainer=$(".bz-wp-status-actions",e.offlineStatusContainer),e.dataService.online||e.updateNetworkState(),e.syncErrorsIcon=$("#bz-wp-sync-errors-button-icon",t),$(document).off("online.inbox"),$(document).on("online.inbox",function(){e.dataService.online=!0,e.hasOfflineForm?(e.updateNetworkState(),e.changeTaskFeedState()):e.updateNetworkState()}),$(document).off("offline.inbox"),$(document).on("offline.inbox",function(){e.dataService.online=!1,e.hasOfflineForm?(e.updateNetworkState(),e.changeTaskFeedState()):e.updateNetworkState()}),$("#select-outbox-type").delegate(".bz-header-outbox-new-btn","click",function(){e.inputTrayManager("outbox"),e.publish("bz-update-list-cases",{updateDataList:!0})}),$("#select-outbox-type").delegate(".bz-header-outbox-finished-btn","click",function(){e.inputTrayManager("outbox"),e.publish("bz-update-list-cases",{updateDataList:!0})}),$(document).off("offline.sync"),$(document).on("offline.sync",function(t,a){void 0!==a&&e.updateSyncState(a)}),$(".bz-wp-status-button-dismiss",e.offlineStatusContainer).bind("click",function(){e.setStatusType("online")}),$(".bz-wp-status-button-retry",e.offlineStatusContainer).bind("click",function(){e.retryDownloadCases()}),$(document).off("update-sync-errors-icon"),$(document).on("update-sync-errors-icon",function(t,a){e.updateSyncErrorsState(a)})},renderMenuOptions:function(){var e=this,t=kendo.template(e.getTemplate("menu-offline-tmpl"),{useWithBlock:!1});$(".bz-wp-home-offline-menu-container ul",e.content).remove(),$(".bz-wp-home-offline-menu-container",e.content).append(t({online:e.dataService.online})),e.menuOffline=$(".bz-wp-home-offline-menu-list",e.content).kendoMobileListView({click:function(t){var a=t.item,i=$(a).data("tray");t.preventDefault(),e.inputTrayManager(i),e.publish("bz-update-list-cases",{updateDataList:!0,mode:i}),$("#taskFeed",e.content).find(".bz-header-offline-btn").click()}}),e.inputTrayManager("inbox")},inputTrayManager:function(e){var t=this,a=t.modeInbox,i=bizagi.localization.getResource("workportal-taskfeed-title"),n=!1;switch(e){case"outbox":a="outbox-new",i=bizagi.localization.getResource("workportal-menu-outbox"),n=!0;break;case"drafts":a="drafts",i=bizagi.localization.getResource("workportal-general-word-drafts"),n=!1;break;case"inbox":a="inbox",i=bizagi.localization.getResource("workportal-taskfeed-title"),n=!1}var r=$("#taskFeed",t.content).data("kendoMobileView");if(void 0!==r){$(".km-navbar",r.header).data("kendoMobileNavBar").title(i),r.options.title=r.title=i}var o=$("#select-outbox-type",t.content);if(o)if(n){o.removeClass("otherbox"),o.addClass("outbox");var s=$(".outbox-tab-list",o).kendoMobileButtonGroup(),l=s.data("kendoMobileButtonGroup").current().index();a=0==l?"outbox-new":"outbox-cases"}else o.removeClass("outbox"),o.addClass("otherbox");$(".bz-offline-selected",t.content).removeClass("bz-offline-selected"),t.menuOffline.find("[data-tray="+e+"]").addClass("bz-offline-selected"),bizagi.util.setLastProcessInboxInputTray(a)},updateNetworkState:function(){var e=this;e.publish("menu-refresh"),e.publish("newcase-refresh"),e.changeStatusConnection(),e.homePortalFramework&&"syncErrors"===e.homePortalFramework.destination&&e.publish("bz-network-sync-errors-status")},changeTaskFeedState:function(){var e=this;e.dataService.online||e.homePortalFramework&&"syncErrors"!=e.homePortalFramework.destination&&(e.workportalFacade.hasStakeholders()&&$("[data-menu-action='taskfeed']",".bz-wp-menu-list").click(),e.dataService.showTaskFeed())}}),bizagi.workportal.webparts.webpart.extend("bizagi.workportal.webparts.loadForm",{},{init:function(e,t,a){this._super(e,t,a)},renderContent:function(e){var t=this;return kendo.template(t.getTemplate("main-loadForm-kendo-tmpl"),{useWithBlock:!1})()},postRender:function(e){var t=this;t.canvas.bind("view-initialized",$.proxy(t.onAfterViewInitialized,t))},renderSearchForm:function(e,t){var a=this,i=a.view.contentElement();return a.params=$.extend(a.params,t),i.empty(),$.when(a.workportalFacade.modules[a.workportalFacade.Class.render_module]).then(function(){var e=bizagi.util.isTabletDevice()?bizagi.rendering.tablet.form:bizagi.rendering.smartphone.form,t=e.extend({createRenderElement:function(e){var t=this,a=e.render.properties;a.rangeQuery&&"none"!=a.rangeQuery&&(a.xpath=a.xpath+"@"+a.rangeQuery),t._super(e)}}),n=bizagi.rendering.facade.extend({processForm:function(e,a,i){var n=$.extend(i,{renderFactory:a,dataService:i.dataService||this.dataService,data:e}),r=new t(n);return r.render(),r}}),r=new n({device:a.workportalFacade.device||bizagi.util.detectDevice()}),o={h_action:"QUERYFORM",h_contexttype:"entity",h_idForm:a.params.form,dataType:"text"};return a.dataService.getQueryForm(o).then(function(e){var t=/\"type\"\s*:\s*\"([':.,-\[\]\w\s]*)\"/g,n=/\"includedInResult\"\s*:\s*(true)/g,o=e.replace(t,function(e,t,a,i){return e.replace(t,t.replace(/query/i,"").toLowerCase())});o=o.replace(n,'"includedInResult":false');var s=JSON.parse(o);s.form.buttons=[],s.form.contextType=s.form.contextType||"metadata";var l={canvas:i,navigation:new bizagi.workportal.action.navigation(a),data:s,displayName:e.displayName,originalParams:{}};return r.execute(l).then(function(e){a.form=e,$(".ui-bizagi-button-container :button",a.form.container).remove(),$(".ui-bizagi-button-container",a.form.container).append('<div ordinal="0" id="formButton0" class="action-button ui-bizagi-form-button">'+bizagi.localization.getResource("render-form-dialog-box-search")+"</div>").delegate('div[ordinal="0"]',"click",function(){a.performSearch()}),a.form.triggerHandler("ondomincluded")})})})},performSearch:function(){var e=this;if(e.form&&e.form.validateForm()){var t=[],a=[];e.form.collectRenderValues(t);for(name in t)if("function"!=typeof t[name]){var i=e.form.getRender(name);i.value&&e.dataService.defineFilterObject({properties:i.properties,value:i.value},a)}var n={guidSearch:e.params.id,filters:a,page:1,pageSize:10,calculateFilters:!0};e.publish("homeportalShow",{what:"stuffTemplates",title:e.params.displayName,params:n})}}}),bizagi.workportal.webparts.loadForm.extend("bizagi.workportal.webparts.loadForm",{},{postRender:function(e){var t=this;t._super(e),t.configureContentHandlers()},onAfterViewInitialized:function(e,t){var a=this;a.view=t,$(".btn-close",t.header).click(function(){a.homePortalFramework._back()}),$(".btn-actions",t.header).actionSheet({actions:[{guid:"search-from-query-form",displayName:bizagi.localization.getResource("render-form-dialog-box-search")}],actionClicked:function(e){a.performSearch()}})},configureContentHandlers:function(){var e=this;e.subscribe("homeportalShow-loadForm",function(t,a){bizagi.util.smartphone.startLoading(),$.when(e.renderSearchForm(t,a)).always(function(){bizagi.util.smartphone.stopLoading()})})}}),bizagi.workportal.webparts.webpart.extend("bizagi.workportal.webparts.menu",{DEVICE_SMARTPHONE_ANDROID:"smartphone_android",authCurrentUserAdministration:!1,authAnalysisReports:!1,authAdmin:!1,enableLogOut:!bizagi.util.isCordovaSupported(),enableHome:!0,enableTaskfeed:!0,authInbox:!1,enableSettings:!1,enableNativeAppLauncher:bizagi.util.isNativeAppLauncherSupported()&&bizagi.util.isCordovaSupported()},{init:function(e,t,a){this._super(e,t,a)},renderContent:function(e){var t=this,a=new $.Deferred;return $.when(t.getSecurityMenu()).done(function(e){t.security=e,a.resolve("")}),a.promise()},postRender:function(e){var t=this;t.configureMenu(),bizagi.webpart.subscribe("menu-refresh",function(){$(".search-container",t.canvas).remove(),$(".bz-menu.component-menu",t.canvas).remove(),bizagi.menuSecurity&&t.dataService.online&&delete bizagi.menuSecurity,t.configureMenu()})},configureMenu:function(e){var t=this,a=bizagi.detectDevice();t.security.authCurrentUserAdministration=t.Class.authCurrentUserAdministration,t.security.authAnalysisReports=t.Class.authAnalysisReports,t.security.authAdmin=t.Class.authAdmin,t.security.enableLogOut=!bizagi.util.isCordovaSupported()&&t.Class.enableLogOut,t.security.enableHome=t.Class.enableHome,t.security.enableTaskfeed=t.Class.enableTaskfeed,t.security.authInbox=t.Class.authInbox,t.dataService.online?(t.security.authAssociatedStakeholders=bizagi.currentUser.associatedStakeholders&&bizagi.currentUser.associatedStakeholders.length>0,t.security.enableNativeAppLauncher=t.Class.enableNativeAppLauncher):(t.security.authAssociatedStakeholders=!1,t.security.enableNativeAppLauncher=!1);var i=a===t.Class.DEVICE_SMARTPHONE_ANDROID&&bizagi.util.isCordovaSupported();t.security.enableSettings=i||t.Class.enableSettings;var n=kendo.template(t.getTemplate("menu-tmpl"),{useWithBlock:!1});t.contentInternal=n($.extend(t.security,bizagi.currentUser)),$("#content-menu-drawer .km-scroll-container",t.canvas).append(t.contentInternal),$(".component-menu, .menu-items",t.canvas).kendoMobileListView({appendOnRefresh:!1,pullToRefresh:!1}),$(".bz-wp-mu-button-search").hide(),$(".component-menu",t.canvas).delegate(".new-case","click",function(e){e.preventDefault(),bizagi.webpart.publish("homeportalShow",{what:"newCase"})}).delegate(".logout","click",function(e){e.preventDefault(),t.logOutAction()}).delegate(".home","click",function(e){e.preventDefault(),bizagi.webpart.publish("homeportalShow",{what:"menuHome"})}).delegate(".task-feed","click",function(e){e.preventDefault(),bizagi.webpart.publish("homeportalShow",{what:"taskFeed"})}).delegate(".nativeAppsLauncher","click",function(e){e.preventDefault(),t.Class.enableNativeAppLauncher&&bizagi.util.isNativePluginSupported()&&bizagiapp.showNativeAppLauncherActivity()}).delegate(".settings","click",function(e){e.preventDefault(),i&&($("#menu-drawer").data("kendoMobileDrawer").scroller.reset(),bizagi.util.isNativePluginSupported()?bizagiapp.showSettingsActivity():window.Bizagi.showSettingsActivity())})},logOutAction:function(){var e=this,t=new $.Deferred;if(bizagi.webpart.publish("bz-logout"),e.dataService.online)$.when(e.dataService.logoutMobile()).always(function(){e.defaultLogout(),t.resolve()});else{var a=e.resources.getResource("confirmation-savebox-message3");$.when(bizagi.showConfirmationBox(a,"Bizagi","info")).done(function(){e.defaultLogout(!0),t.resolve()})}return t.promise()},defaultLogout:function(e){bizagi.util.isCordovaSupported()?window.location=bizagi.services.ajax.logoutPage:e&&window.location.replace("")},getSecurityMenu:function(){var e=this,t={},a=new $.Deferred;return e.security={},e.jsonSecurityList={},e.security=new bizagi.workportal.command.security(e.dataService),bizagi.menuSecurityPromise=$.when(e.security.getSecurity()).done(function(i){e.convertSecurityData(i),e.jsonSecurityList=i,t.authNewCase=e.security.NewCase||!1,t.authAnalysisReports=e.checkRootCategory(i,"AnalysisReports"),t.authAdmin=e.checkRootCategory(i,"Admin"),t.authCurrentUserAdministration=e.security.CurrentUser,$.each(e.security,function(e,a){t[e]=a}),a.resolve(t)}),a.promise()},convertSecurityData:function(e){var t=this;e=e||{};for(var a in e)"object"==typeof e[a]?t.convertSecurityData(e[a]):void 0!=e[a]&&(t.security[e[a]]=!0)},checkRootCategory:function(e,t){if(void 0!=e.permissions)for(var a=0;a<e.permissions.length;a++)if(void 0!=e.permissions[a][t])return!0;return!1}}),bizagi.workportal.webparts.menu.extend("bizagi.workportal.webparts.menu",{PAGE_SIZE:30,SEARCH_DELAY:700},{postRender:function(e){var t=this;t._super(e);var a=t.getTemplate("item-search-menu-tmpl");t.commandSearch=new bizagi.workportal.command.search(t.dataService);var i=$(".bz-menu-search",t.canvas).kendoMobileListView({dataSource:new kendo.data.DataSource,template:a,selectable:"single",click:function(e){t.renderCase(e)}});t.listViewSearch=i.data("kendoMobileListView"),t.configureHandlers()},search:function(e){var t=this;(e.query!==t.lastProcessedValue||e.force)&&(t.lastProcessedValue=e.query,bizagi.loading.start(),$.when(t.commandSearch.searchList(e)).done(function(e){t.listViewSearch.dataSource.data(e.elements),bizagi.loading.stop()}).fail(function(e){e=e||{},e&&void 0===e.elements&&(e={elements:[],page:1,totalPages:1},e.elements.push({noResults:!0,message:bizagi.localization.getResource("workportal-menu-search-found-no-cases")})),t.listViewSearch.dataSource.data(e.elements),bizagi.loading.stop()}))},renderCase:function(e){var t=this,a=t.commandSearch.getCaseData(e);bizagi.util.isEmpty(a)||($(".bz-wp-mu-button-search",t.canvas).click(),t.publish("changeCase",a))},configureHandlers:function(){var e=this,t=$("#menu-drawer",e.canvas),a=t.data("kendoMobileDrawer");$("#content-menu-drawer input.bz-wp-mu-input-search-menu",e.canvas).on("click",function(t){void 0===e.originalWidth&&(e.originalWidth=a.getSize().width),void 0===e.searchWidth&&(e.searchWidth=$("#content-menu-drawer input.bz-wp-mu-input-search-menu",e.canvas).width()),a.element.width(window.innerWidth),a.show(),$("#content-menu-drawer input.bz-wp-mu-input-search-menu",e.canvas).animate({width:"75%"}),$(".bz-menu",e.canvas).fadeOut(void 0,void 0,function(){$(".bz-menu-search",e.canvas).fadeIn(),$(".bz-wp-mu-button-search").show()})}).keyup(function(t){if(13===t.which)return void e.search({query:this.value,force:!0});var a=this;return void setTimeout(function(t){e.search({query:a.value})},e.Class.SEARCH_DELAY)}),$(".bz-wp-mu-button-search",e.canvas).on("click",function(t){e.lastProcessedValue=null,e.listViewSearch.dataSource.data([]),$("#content-menu-drawer input.bz-wp-mu-input-search-menu",e.canvas).val(""),a.element.width(e.originalWidth),a.hide(),setTimeout(function(){$(".bz-menu",e.canvas).show(),$(".bz-menu-search",e.canvas).hide(),$(".bz-wp-mu-button-search").hide(),$("#content-menu-drawer input.bz-wp-mu-input-search-menu",e.canvas).animate({width:e.searchWidth})},500)})}}),$.Class("bizagi.workportal.command.security",{},{init:function(e){var t=this;t.dataService=e,t.rawData={}},getSecurity:function(){var e=this,t=new $.Deferred,a={};return e.jsonSecurityList={},bizagi.menuSecurity&&void 0!==bizagi.menuSecurity.authAnalysisReports?t.resolve(bizagi.menuSecurity):$.when(e.dataService.getMenuAuthorization()).done(function(i){e.rawData=i,bizagi.menuSecurity=e.convertSecurityData(i),e.jsonSecurityList=i,a.authNewCase=bizagi.menuSecurity.NewCase||!1,a.authAnalysisReports=e.checkRootCategory(i,"AnalysisReports")||!1,a.authAdmin=e.checkRootCategory(i,"Admin")||!1,a.authCurrentUserAdministration=bizagi.menuSecurity.CurrentUser||!1,t.resolve($.extend(bizagi.menuSecurity,a))}).fail(function(i){e.rawData={},bizagi.menuSecurity={},e.jsonSecurityList={},a.authNewCase=!1,a.authAnalysisReports=!1,a.authAdmin=!1,a.authCurrentUserAdministration=!1,t.resolve($.extend(bizagi.menuSecurity,a))}),t.promise()},convertSecurityData:function(e){var t={},a=function(e){$.each(e,function(e,i){"object"==typeof i?("number"!=typeof e&&(t[e]=!0),a(i)):t[i]=!0})};return a(e.permissions),t},getRawData:function(){return this.rawData},checkRootCategory:function(e,t){if(void 0!=e.permissions)for(var a=0,i=e.permissions.length;a<i;a++)if(void 0!=e.permissions[a][t])return!0;return!1}}),bizagi.workportal.webparts.webpart.extend("bizagi.workportal.webparts.menuHome",{},{init:function(e,t,a){var i=this;i._super(e,t,a),i.homePortalFramework=i.getHomeportalFrameworkIntance()},renderContent:function(e){var t=this,a=$.Deferred();return t.content=t.homePortalFramework.loadComponentTemplate("menuHome-tmpl","menuHome",{}),a.resolve(t.content),a.promise()},postRender:function(e){var t=this;return t.canvas.bind("view-initialized",$.proxy(t.onAfterViewInitialized,t)),t.homePortalFramework.loadComponents("menuHome",t.content).done(function(){t.configureHandlers()})},configureHandlers:function(){}}),bizagi.workportal.webparts.menuHome.extend("bizagi.workportal.webparts.menuHome",{},{init:function(e,t,a){this._super(e,t,a)},onAfterViewInitialized:function(e,t){function a(e){var t="translateX("+(100*e.index*-1).toString()+"%)",a=l.get(0).style;a.webkitTransform=t,a.MozTransform=t,a.msTransform=t,a.OTransform=t,a.transform=t,o=e.index}function i(e){r=n.scrollPosition-e.scrollTop,n.scrollPosition=e.scrollTop;var t=r<=0?"up":"down";t!==n.scrollDirection&&("down"===t?(n.scrollDirection="down",n.view.header.removeClass("scroll-up")):(n.scrollDirection="up",n.view.header.addClass("scroll-up")),s.contentResized())}var n=this;n.view=t,n.configureHeaderViewHandlers(),n.scrollPosition=0,n.scrollDirection="down";var r=0,o=0,s=n.view.scroller,l=n.view.element.find(".bz-menu-carousel"),c=n.view.element.find(".bz-menu-carousel-seat"),d=$("#select-category",n.view.header).kendoMobileButtonGroup({select:function(e){a(e)},index:0}),u=d.data("kendoMobileButtonGroup");n.view.element.find(".km-scroll-wrapper").kendoTouch({enableSwipe:!0,swipe:function(e){if(o<c.length-1&&"left"===e.direction||o>0&&"right"===e.direction){var t="left"===e.direction?o+1:o-1;u.select(t),a({index:t})}}}),s.bind("scroll",i),n.view.element.find(".bz-menu-home-content").data("kendoMobileScroller").disable()},configureHeaderViewHandlers:function(){var e=this;$(".km-leftitem .km-button.btn-menu",e.view.header).bind("click",function(){e.publish("homeportalShow",{what:"menu"})}),$(".km-rightitem",e.view.header).bind("click",function(){e.publish("homeportalShow",{what:"newCase"})})}}),bizagi.workportal.webparts.rendermanager.extend("bizagi.workportal.webparts.overviewPlan",{},{init:function(e,t,a){var i=this;i._super(e,t,a),i.PENDING_PLAN="PENDING_PLAN",i.EXECUTING_PLAN="EXECUTING_PLAN",i.CONTEXT_PLANACTIVITIES="PLANACTIVITIES",i.CONTEXT_PLANOVERVIEW="PLANOVERVIEW",i.CONTEXT_PLANCREATE="PLANCREATE",i.plugins={},i.fromIndexEnabledSortingActivities=0,i.dataService=t,i._statePlan=i.PENDING_PLAN,i.userPictures=[],i.templateMain=kendo.template(i.getTemplate("overviewplan-view"),{useWithBlock:!1}),bizagi.util.mobility.overviewViewInit=$.proxy(i.renderViewInit,i),i.planActivitiesItems=kendo.template(i.getTemplate("overview-plan-activities-item"),{useWithBlock:!1}),i.dataPlan=new bizagi.workportal.webparts.overviewPlan.dataPlan(e,t,a)},renderContent:function(){return""},renderViewInit:function(e){var t=this;t.content=$(t.templateMain({})),e.view.contentElement().append(t.content),t.pane=$("#paneRender").data("kendoMobilePane")},postRender:function(){var e=this;bizagi.webpart.subscribe("bz-rnd-overviewplan",function(t,a){bizagi.loading.start(),e.params=a,$.when(e.dataPlan.getPlanData(e.params)).then(function(t){e.params.plan=t;var a=JSON.parse(bizagi.util.getItemLocalStorage("newChanges"));if(a&&a.hasChanges){var i=e.params.plan.activities.filter(function(e){return e.id===a.idActivity});i[0].items=a.items,i[0].numResolvedItems=a.itemsResolved,i[0].numTotalItems=a.items.length,i[0].progress=a.progress,bizagi.util.setItemLocalStorage("newChanges",JSON.stringify({hasChanges:!1}))}e.initOverviewPlan()}).always(function(){})})},onNotifySummaryProgressPlan:function(){var e=this;e._statePlan=e.params.plan.currentState+"_PLAN"},initOverviewPlan:function(){var e=this;e.onNotifySummaryProgressPlan(),$.when(e.overviewPlan()).always(function(){bizagi.loading.stop()}).fail(function(){bizagi.loading.stop()})},overviewPlan:function(){var e=this;$("#overview-plan .render-content",e.canvas).empty();var t=kendo.template(e.getTemplate("overview-plan-tmpl-main"),{useWithBlock:!1}),a=e.enableEventsOnActivitiesByCurrentContext(e.params.showContextByMenuDashboard),i=e.params.plan.activities?e.params.plan.activities.filter(function(e){return e.finishDate}).length:0,n={statePlan:e._statePlan,statePendingPlan:e.PENDING_PLAN,stateExecutingPlan:e.EXECUTING_PLAN,contextPlanActivities:e.CONTEXT_PLANACTIVITIES,plan:e.params.plan,showFormAddActivityByNotFinishedAllActivities:0!==i&&i!==e.params.plan.activities.length},r=t(n);$("#overview-plan .render-content",e.canvas).append(r),e._statePlan!=e.PENDING_PLAN&&e._statePlan!=e.EXECUTING_PLAN||!a||(e.plugins.sortablelist=e.initializeSortableList()),e.plugins.notifier=e.initializeNotifier(),e.renderActivities(),e.configureOverviewHeaderHandlers()},renderActivities:function(e){var t=this,a=$(".project-plan-activity-list",t.content),i=e||t.params.plan.activities,n={statePlan:t._statePlan,statePendingPlan:t.PENDING_PLAN,stateExecutingPlan:t.EXECUTING_PLAN,activities:e||t.params.plan.activities};t._statePlan==t.EXECUTING_PLAN&&i.forEach(function(e){e.startDate?e.classEnabledActionActivities="disabled":e.classEnabledActionActivities=t.params.showContextByMenuDashboard===t.CONTEXT_PLANACTIVITIES?"enabled":"disabled"}),a.append(t.planActivitiesItems(n)),t.loadAndShowImagesUsers(t.params.plan.activities)},loadAndShowImagesUsers:function(e){var t=this,a=$.map(e,function(e){return e.userAssigned}),i=function(e){for(var t={},a=[],i=e.length,n=0,r=0;r<i;r+=1){var o=e[r];1!==t[o]&&(t[o]=1,a[n+=1]=o)}return a}(a.concat(bizagi.currentUser.idUser)).join(",");t.getDataUsers(i).then(function(){t.renderUserProfilesAndImages()})},enableEventsOnActivitiesByCurrentContext:function(e){return e===this.CONTEXT_PLANACTIVITIES},initializeSortableList:function(){var e=this;return $(".project-plan-activity-list",e.content).kendoSortable({hint:function(e){var t=e.clone().width(e.width());return $("<ol class='project-plan-activity-list ui-bizagi-wp-nolist'></ol>").append(t)},change:$.proxy(e.onChangePosition,e),disabled:".disabled",end:function(t){t.newIndex<e.fromIndexEnabledSortingActivities&&t.preventDefault()}}).data("kendoSortable")},initializeNotifier:function(){},configureOverviewHeaderHandlers:function(){var e=this;$("#overview-plan .bz-overview-back",e.canvas).off("click").on("click",function(t){t.stopImmediatePropagation(),e.navigator.goHome()}),$(".project-plan-activity-list li",e.content).off("click").on("click",function(t){e.onClickActivity(t)}),$(".summary-plan-section",e.canvas).off("click").on("click",function(t){e.showSummary()})},onClickActivity:function(e){var t=this,a=$(e.currentTarget),i=a.data("name"),n=a.index();t.pane.navigate("#overview-plan");var r=a.data("id");t.params.showContextByMenuDashboard===t.CONTEXT_PLANACTIVITIES&&(t.params.plan.idActivitySelected=r),a.addClass("selected").siblings().removeClass("selected"),t.initViewActivity({name:i}),t.renderEdition(n)},initViewActivity:function(e){var t=this;t.slideFormParams={preview:bizagi.localization.getResource("workportal-project-casedashboard-activity")},t.slideForm=$($.kendoTmpl(t.getTemplate("activity-view"),t.slideFormParams)),$("#paneRender").append(t.slideForm),t.view=new kendo.mobile.ui.View(t.slideForm,{useNativeScrolling:!0}),t.pane=$("#paneRender").data("kendoMobilePane"),t.pane.navigate(t.view.id),t.view.attachedElement=e,t.scrollContent=$("#render-content",t.view.contentElement()),t.configureViewHandlers()},renderEdition:function(e){var t=this;t.params.plan.contextualizedPLan=void 0===t.params.plan.contextualizedPLan||t.params.plan.contextualizedPLan,t.inputEdition=kendo.template(t.getTemplate("activity-preview-tmpl"),{useWithBlock:!1}),t.params.plan.usersMap={},$.when(t.setDataUsers(t.params.plan)).done(function(a){$("#render-content",t.view.content).html(t.inputEdition({plan:t.params.plan,index:e,users:a.assignees})),t.params.plan.activities[e].progress<=33?$(".percent-complete-activity",t.view.content).css({color:"#F5645A"}):t.params.plan.activities[e].progress<=66?$(".percent-complete-activity",t.view.content).css({color:"rgb(238, 184, 104)"}):$(".percent-complete-activity",t.view.content).css({color:"#37B464"})})},setDataUsers:function(e){var t=this,a=[],i=[],n=e.idUserCreator,r=new $.Deferred;i.push({idUser:n,userType:["owner"]}),e.usersMap["-"+n+"-"]={picture:"",id:n,name:"",userType:["owner"]},a.push(n),$.each(e.activities,function(t,r){var o=r.userAssigned;o===n?-1===$.inArray("Assigned",i[0].userType)&&(i[0].userType.push("Assigned"),e.usersMap["-"+n+"-"].userType.push("Assigned")):(e.usersMap["-"+o+"-"]={picture:"",id:o,name:"",userType:["Assigned"]},0===i.filter(function(e){return e.idUser==o}).length&&(i.push({idUser:o,userType:["Assigned"]}),a.push(o)))});var o,s=[],l={},c={},d={userIds:a.join(),width:50,height:50};return $.when(t.dataService.getUsersData(d)).always(function(e){for(var t=0,n=e.length;t<n;t+=1)c[e[t].id]=e[t].name;$.each(i,function(e,t){$.each(t.userType,function(e,t){o?o.types.indexOf(t)<0&&(o.types+=", "+t):o={types:t}});var a={};l[t.idUser]||(l[t.idUser]=!0,a.idUser=t.idUser,a.name=c[t.idUser],s.push(a)),o=void 0}),r.resolve({assignees:s,cvsUsers:a})}),r.promise()},getDataUsers:function(e){var t=this,a=$.Deferred(),i={userIds:e,width:50,height:50};return t.dataService.getUsersData(i).always(function(e){t.userPictures=function(e){for(var t=e.concat(),a=0;a<t.length;++a)for(var i=a+1;i<t.length;++i)t[a]===t[i]&&t.splice(i-=1,1);return t}(t.userPictures.concat(e)),a.resolve()}),a.promise()},renderUserProfilesAndImages:function(){for(var e=this,t=0,a=e.userPictures.length;t<a;t++)$("div[data-iduser='"+e.userPictures[t].id+"'] > label").html(e.userPictures[t].name),e.userPictures[t].picture&&$("div[data-iduser='"+e.userPictures[t].id+"'] img").attr("src","data:image/png;base64,"+e.userPictures[t].picture)},configureViewHandlers:function(){var e=this;$(".bz-render-back",e.slideForm).bind("click",function(){e.goBack()})},goBack:function(){var e=this;e.pane.navigate("#:back"),e.view.destroy(),e.view.element.remove()}}),bizagi.workportal.webparts.overviewPlan.extend("bizagi.workportal.webparts.overviewPlan",{},{showSummary:function(){this.publish("show-plan-summary")}}),$.Class.extend("bizagi.workportal.webparts.overviewPlan.dataPlan",{},{init:function(e,t,a){var i=this;i.canvas=a.canvas,i.dataService=t,i.workportalFacade=e,i.differenceMillisecondsServer=a.differenceMillisecondsServer,i.tools={arrayUnique:function(e){for(var t=e.concat(),a=0;a<t.length;++a)for(var i=a+1;i<t.length;++i)t[a]===t[i]&&t.splice(i--,1);return t}}},getPlanData:function(e){var t=this,a=new $.Deferred;t.data=e,t.data.caseDetails.plan={};var i={idPlan:t.data.caseDetails.idPlan};return $.when(t.callGetPlan(i)).then(function(e){$.extend(t.data.caseDetails.plan,e,{activities:[],users:[]});var i={idPlan:t.data.caseDetails.idPlan};$.when(t.callGetFirstParent(i)).then(function(e){t.data.caseDetails.plan.firstParent=e;var i={idPlan:t.data.caseDetails.idPlan},n={idPlan:t.data.caseDetails.idPlan},r={idPlan:t.data.caseDetails.idPlan};$.when(t.callGetActivitiesPlan(i),t.callGetWorkitemsPlan(n),t.callGetTransitionsByPlan(r)).then(function(e,i,n){var r=e||[];t.mergePropertiesActivitiesWithWorkitems(r,i),t.data.caseDetails.plan.activities=t.calculateActivityStatus(r),r=t.orderActivitiesByTransitions(r,n),t.data.caseDetails.plan.activities=r,a.resolve(t.data.caseDetails.plan)})}).fail(function(){a.reject()})}).fail(function(){a.reject()}),a.promise()},calculateActivityStatus:function(e){var t,a=this;return a.data.currentState&&a.data.currentState.length>0&&(t=a.data.currentState[0].entryDateWorkItem),$.each(e,function(e,i){if(i.status="nodisplay",i.starDate=t,i.estimatedFinishDate){var n=a.getDateServer(),r=i.estimatedFinishDate-i.startDate,o=i.startDate+.33*r,s=i.startDate+.66*r;i.estimatedFinishDate;n<o?i.status="ontime":o<=n&&n<s?i.status="delayed":s<=n&&(i.status="atrisk")}if(i.items){var l=i.items.filter(function(e){return!0===e.resolved});i.numResolvedItems=l.length,i.numTotalItems=i.items.length,i.numTotalItems>0&&(i.progress=Math.floor(i.numResolvedItems/i.numTotalItems*100))}else i.items=[]}),e},orderActivitiesByTransitions:function(e,t){var a=this,i=[];if(0===t.length)i=e,e.length>1&&e.filter(function(e){e.parallel=!0});else{var n=a.orderTransitionsByFromAndTo(t,e);if(activityGuidsInOrder=n.activitiesInOrder,parallelActivitiesHash=n.parallelActivitiesHash,0===activityGuidsInOrder.length)return e;for(var r=0,o=activityGuidsInOrder.length;r<o;r+=1)i=i.concat(e.filter(function(e){return e.id==activityGuidsInOrder[r]&&parallelActivitiesHash[e.id]&&(e.parallel=!0),e.id==activityGuidsInOrder[r]}))}return i},orderTransitionsByFromAndTo:function(e){function t(n){var r=[],o=[],s=!1;if(n.forEach(function(t){var n=a.getTransitionsByFrom(e,t),l=n.length;l>0&&(s=!0,n.forEach(function(e){r.push(e.idActivityFrom),o.push(e.idActivityTo)}),l>1&&o.forEach(function(e){i[e]=!0}))}),s){var c=a.tools.arrayUnique(r.concat(o));l=a.tools.arrayUnique(l.concat(c)),t(o)}}for(var a=this,i={},n=e.map(function(e){return e.idActivityFrom}),r=e.map(function(e){return e.idActivityTo}),o=[],s=0;s<n.length;s+=1)-1===r.indexOf(n[s])&&(o=a.tools.arrayUnique(o.concat([n[s]])));if(0===o.length&&1===activities.length)return{activitiesInOrder:[activities[0].id],parallelActivitiesHash:[]};o.length>1&&o.forEach(function(e){i[e]=!0});var l=[];return t(o),{activitiesInOrder:l,parallelActivitiesHash:i}},getTransitionsByFrom:function(e,t){return e.filter(function(e){return e.idActivityFrom===t})},callGetItemsByActivity:function(e){var t=this,a=$.Deferred();return t.dataService.getItemsByActivity(e).always(function(e,t,i){200===i.status?a.resolve(e):a.reject()}),a.promise()},callGetWorkitemsPlan:function(e){var t=this,a=$.Deferred();return t.dataService.getWorkitemsPlan(e).always(function(e,t,i){200===i.status?a.resolve(e):a.reject()}),a.promise()},callGetPlan:function(e){var t=this,a=$.Deferred();return t.dataService.getPlan(e).always(function(e){200===e.status||201===e.status||void 0===e.status?a.resolve(e):a.reject()}),a.promise()},callGetActivitiesPlan:function(e){var t=this,a=$.Deferred();return t.dataService.getActivities(e).always(function(e,t,i){200===i.status?a.resolve(e):a.reject()}),a.promise()},callGetTransitionsByPlan:function(e){var t=this,a=$.Deferred();return t.dataService.getTransitionsByPlan(e).always(function(e,t,i){200===i.status?a.resolve(e):a.reject()}),a.promise()},getDateServer:function(){return(new Date).getTime()+this.differenceMillisecondsServer},mergePropertiesActivitiesWithWorkitems:function(e,t){e.forEach(function(e){var a=t.filter(function(t){return t.guidActivity==e.id});a.length>0&&$.extend(e,{startDate:a[0].wiEntryDate||null,finishDate:a[0].wiSolutionDate||null,idWorkItem:a[0].idWorkItem,workItemState:a[0].workItemState,idCase:a[0].idCase,estimatedFinishDate:a[0].wiEstimatedSolutionDate||e.estimatedFinishDate})})},callGetFirstParent:function(e){var t=this,a=$.Deferred();return t.dataService.getFirstParentPlan(e).done(function(e){a.resolve(e)}),a.promise()}}),bizagi.workportal.webparts.webpart.extend("bizagi.workportal.webparts.render",{BIZAGI_WORKPORTAL_ACTION_ROUTING:"rounting"},{
init:function(e,t,a){var i=this;i.renderingStarted=new $.Deferred,i.navigation=a.navigation,i._super(e,t,a),i.routing=new bizagi.workportal.action.routing(i),i.async=new bizagi.workportal.widget.async(i),i.navigation={},i.isOfflineFormsV2Supported=bizagi.util.isMobileDevice()&&bizagi.util.isOfflineFormsV2Supported(),this.subscribe("showDialog",function(e,t){i.showDialog(t)}),this.subscribe("executeRoutingAction",function(e,t){i.routing.executeRouting(t)})},renderContent:function(e){var t=this,a=$.Deferred(),i=kendo.template(t.getTemplate("render-tmpl"),{useWithBlock:!1});return t.content=$(i({})),t.canvas.append(t.content),t.navigator=new bizagi.workportal.action.navigator,a.resolve(t.content),a.promise()},getGoToInboxOnExitPreference:function(){return!1},isNextButton:function(e){return-1!==["nextWithoutValidations","next"].indexOf(e)},renderForm:function(e){var t=this,a=t.view,i=a.contentElement(),n={},r=t.getGoToInboxOnExitPreference(),o=r&&t.isNextButton(e.buttonPropertiesAction),s=!o||!e.withOutGlobalForm;if(e.allowProperties=bizagi.util.isVersionSupported()&&!(bizagi.util.isTabletDevice()&&e.isOfflineForm),t.rfParams=e,i.empty(),a&&a.footer&&a.footer.empty(),e.withOutGlobalForm)t.validateSendUser2WorkDone(o,e);else{if(void 0===t.rendering){var l=void 0!==t.dataService.serviceLocator.proxyPrefix?t.dataService.serviceLocator.proxyPrefix:"",c={proxyPrefix:l,device:bizagi.util.detectDevice()};bizagi.util.isMobileDevice()&&(c.database=void 0!==t.dataService.database?t.dataService.database:""),t.rendering=new bizagi.rendering.facade(c),t.rendering.subscribe("renderActionButton",function(e,a){t.publish("renderActionButton",{actions:a.actions})}),this.rendering.subscribe("dataNavigation",function(e,t){bizagi.util.isNativePluginSupported()&&!bizagi.util.isiOSTabletDevice()?bizagiapp.dataNavigation({what:"stuffTemplates",displayName:t.data.displayName,params:t}):bizagi.webpart.publish("homeportalShow",{what:"stuffTemplates",title:t.data.displayName,params:t})})}e.mobileAccess=void 0==e.mobileAccess||e.mobileAccess,n=$.extend({},e,{canvas:i,navigation:t.navigation}),(n.hasWorkItems||n.isEvent)&&e.mobileAccess||delete n.idWorkitem,e.hasGlobalForm||e.summaryForm||e.mobileAccess?$.when(t.rendering.execute(n)).then(function(a){if(0===a.buttons.length&&0===a.children.length)t.validateSendUser2WorkDone(o,e);else if(!e.mobileAccess&&!e.summaryForm){var i=bizagi.localization.getResource("render-without-mobileaccess","Accessing this activity is disabled on this device. You can work on it using your desktop");bizagi.showMessageBox(i)}}).fail(function(e){t.publish("error",e)}).always(function(){bizagi.loading.stop()}):(e.messageForm=bizagi.localization.getResource("render-without-mobileaccess","Accessing this activity is disabled on this device. You can work on it using your desktop"),t.showWorkDoneMessage(e))}if(s){var d=$(".km-navbar",t.view.header).data("kendoMobileNavBar");if($(t.view.header).removeClass("sync-error"),e.syncError&&e.isOfflineErrorMode){$(document).off("edit-offline-case-action"),$(document).on("edit-offline-case-action",function(){t.editSyncButtonHandler().bind(t)}),$(document).off("edit-offline-case-action-whitout-confirmation"),$(document).on("edit-offline-case-action-whitout-confirmation",function(e,a){t.editSyncButtonAction().bind(t)}),$(t.view.header).addClass("sync-error"),$(".sync-error-btn-edit",t.view.header).off("click"),$(".sync-error-btn-edit",t.view.header).on("click",function(){t.editSyncButtonHandler().bind(t)}),$(".sync-error-btn-again",t.view.header).off("click"),$(".sync-error-btn-again",t.view.header).on("click",function(){t.retrySyncButtonHandler()});var u="business"==e.syncError.type?"workportal-offline-business-sync-error":"workportal-offline-technical-sync-error";$(".nav-subtitle",t.view.header).text(bizagi.localization.getResource(u)),t.unsubscribe("retry-sync-single-offline-case"),t.subscribe("retry-sync-single-offline-case",function(){t.retrySyncButtonHandler()})}var p;p=void 0!==e.displayName&&null!==e.displayName?e.displayName:e.radNumber||e.idCase,d.title(p),"#renderSplitView"!==bizagi.kendoMobileApplication.view().id&&bizagi.kendoMobileApplication.navigate("#renderSplitView"),t.initCaseFolder({element:d.element,params:e}),$("#paneRender",t.content).data("kendoMobilePane").navigate("#render","slide:left"),t.view.scroller&&t.view.scroller.reset()}},initCaseFolder:function(e){this.publish("case-properties-init",e)},postRender:function(){var e=this;e.view=new kendo.mobile.ui.View($("#render",e.content),{useNativeScrolling:!0}),e.navigation=new bizagi.workportal.action.navigation(e);e.workportalFacade.executeWebpart({webpart:"startForm",canvas:$("#startForm",e.content)});e.configureHandlers(),e.setButtonsHandler()},validateSendUser2WorkDone:function(e,t){var a=this;e?a.goHomePortal():a.showWorkDoneMessage(t)},showWorkDoneMessage:function(e){var t=this,a=t.view.contentElement(),i=t.getTemplate("info-message-go-to-inbox"),n=e.messageForm||t.resources.getResource("render-without-globalform"),r=!1;if(void 0!==e&&(r=void 0!==e.isOfflineForm&&bizagi.util.parseBoolean(e.isOfflineForm)),r){var o=e.idWorkitem&&!Array.isArray(e.idWorkitem)?"next":null;n=bizagi.util.getMessageFromNetworkState(t.dataService.online,o)}var s=$.kendoTmpls(i,{message:n});a.html(s),$(".ui-bizagi-info-message-button-go-to-inbox",a).click(function(){t.goHomePortal()})},configureHandlers:function(){var e=this,t=e.view.contentElement(),a=$.Deferred();e.subscribe("render-case",function(t,i){return bizagi.loading.start(),$.when(e.workportalFacade.modules[e.workportalFacade.Class.render_module]).then(function(){if(e.navigation.resetParams(),bizagi.util.isEmpty(i.idCase))return console.warn("Se requiere el id del caso 'idCase' para poder renderizar la forma"),null;if(bizagi.util.isEmpty(i.idWorkitem))return e.routing.executeRouting({action:"routing",buttonPropertiesAction:i.buttonPropertiesAction,idCase:i.idCase,hasStartForm:i.hasStartForm||!1}),null;if(i.online=e.dataService.online,e.isOfflineFormsV2Supported&&i.forceOffline&&bizagi.util.isOfflineExecutionSupportedInCurrentEnvironment()&&e.dataService.online){i.isOfflineForm=!0,i.isOpen=!0,i.offlineType="task";var t=i.idCase+"-"+i.idWorkitem;return $.when(e.dataService.database.validateLocalDataForTaskExists(t)).then(function(t){t&&(i.isEdited=!0);var a=$.extend({executeOfflineEntryPipeline:!0},i);return $.when(e.dataService.downloadActivityOnDemand(a))}).then(function(t){return i.alreadyMarkedAsActive=!0,$.when(e.renderForm(i)).then(function(){if(t.hasEntryPipeline&&!1===t.wasPipelineExecuted){var a=bizagi.localization.getResource("workportal-force-offline-pipeline-error-message","This form has not been updated due to an error executing an automatic action while it was opening. You can continue working normally on the latest downloaded version of the form, or try to open it again from the Inbox"),i=[{label:bizagi.localization.getResource("workportal-general-word-continue"),action:"resolve"},{label:bizagi.localization.getResource("workportal-go-to-inbox"),action:"reject"}];setTimeout(function(){$.when(bizagi.showConfirmationBox(a,"Bizagi","",i)).fail(function(){e.goBack()})},100)}})}).fail(function(t){return console.error("FORCE OFFLINE => downloadActivityOnDemandError",t),e.renderForm(i)})}return e.renderForm(i)}).then(function(){a.resolve()}).fail(function(){a.reject()}).always(function(){bizagi.loading.stop()}),a.promise()}),$(".bz-render-back",e.view.header).bind(e.Class.BIZAGI_TAP_EVENT,function(){e.goBack()}),t.bind("routing",function(t,a){var i={idCase:e.rfParams.idCase,fromTask:e.rfParams.fromTask||e.rfParams.idTask,fromWorkItemId:e.rfParams.fromWorkItemId||e.rfParams.idWorkitem,isOfflineForm:e.rfParams.isOfflineForm||!1,formsRenderVersion:e.rfParams.formsRenderVersion};i=$.extend(i,a),e.refreshTemplate(),e.routing.executeRouting(i),e.publish("bz-update-list-cases",{updateDataList:!0})}),t.bind("errorform",function(t){e.publish("error",t)})},goHomePortal:function(){var e=this;bizagi.kendoMobileApplication.navigate("homePortal"),e.publish("bz-update-list-cases",{updateDataList:!0}),e.homePortalFramework&&"syncErrors"===e.homePortalFramework.destination&&e.publish("bz-update-list-sync-errors-cases")},refreshTemplate:function(){var e=this;if(e.homePortalFramework.accumulatedContext.length>0){var t=e.homePortalFramework.accumulatedContext.length-1,a=e.homePortalFramework.accumulatedContext[t],i={data:a,calculateFilters:a.calculateFilters||!1,filters:[],eventType:"DATA-NAVIGATION"};bizagi.webpart.publish("homeportalShow",{what:"stuffTemplates",title:i.data.displayName||"",params:i,preventNavigate:!0})}},goBack:function(){var e=this;$.when(bizagi.util.autoSave()).done(function(){$(document).data("auto-save","")}).always(function(){e.refreshTemplate(),bizagi.kendoMobileApplication.replace("#homePortal","slide:right"),e.homePortalFramework&&"syncErrors"===e.homePortalFramework.destination&&e.publish("bz-update-list-sync-errors-cases"),e.dataService.showTaskFeed(),$(document).trigger("disposeForm"),$(document).off("online.form"),$(document).off("offline.form"),$(document).off("offline-notify-form-sync-event"),$(".sync-error-btn-edit",e.view.header).off("click"),$(".sync-error-btn-again",e.view.header).off("click")})},showDialog:function(e){var t=this,a=new bizagi.workportal.widget.dialog(t);return a.renderDialog(e),a},setButtonsHandler:function(){},editSyncButtonHandler:function(){var e=this,t=bizagi.localization.getResource("workportal-offline-sync-error-edit-case-title"),a=bizagi.localization.getResource("workportal-offline-sync-error-edit-case-explanation");bizagi.util.isMobileDevice()&&bizagi.util.isCordovaSupported()?bizagi.showSimpleConfirmationBox(a,t,[bizagi.localization.getResource("confirmation-savebox-cancel"),t]).then(function(t){2==t&&e.editSyncButtonAction()}):bizagi.showConfirmationBox(a,t,"",[{label:bizagi.localization.getResource("confirmation-savebox-cancel"),action:"reject"},{label:t,action:"resolve"}]).then(e.editSyncButtonAction.bind(e))},editSyncButtonAction:function(){var e=$.extend({},this.rfParams);e.isOfflineErrorMode=!1,e.isOpen=!0,e.isEdited=!0,e.removeSyncErrorOnSubmit=!0,e.showToastOnSuccessSync=!0,this.renderForm(e)},retrySyncButtonHandler:function(){var e=this;if(!e.dataService.online)return void bizagi.util.showMobileToast({type:"error",message:bizagi.localization.getResource("workportal-offline-sync-failed-no-internet")});var t=$.Deferred(),a=$.extend({deferred:t},e.rfParams);bizagi.loading.start(),$(document).trigger("retrySyncCase.offline",a),t.then(function(){bizagi.util.showMobileToast({type:"success",message:bizagi.localization.getResource("workportal-offline-sync-success")}),e.goBack()}).fail(function(t){if("string"==typeof t)try{t=JSON.parse(t)}catch(e){console.error("Parsing error",t)}var a=t._internalSyncError||{};bizagi.util.isEmpty(a)&&(a.type="technical");var i=$.extend({},e.rfParams);i.hasSyncError=!0,i.syncError=t._internalSyncError||t,void 0!=i.syncError&&"business"!=i.syncError.type&&(delete i.syncError.message,bizagi.util.showMobileToast({type:"error",message:bizagi.localization.getResource("workportal-offline-sync-failed")})),e.renderForm(i)}).always(bizagi.loading.stop)}}),bizagi.workportal.webparts.render.extend("bizagi.workportal.webparts.render",{},{postRender:function(e){var t=this;return $.when(t._super(e)).then(function(){return t.workportalFacade.executeWebpart({webpart:"caseProperties",canvas:$("#paneRender",t.content),navigator:t.navigator}),t.workportalFacade.executeWebpart({webpart:"discussionCase",canvas:$("#paneRender",t.content),navigator:t.navigator}),t.workportalFacade.executeWebpart({webpart:"files",canvas:$("#paneRender",t.content),navigator:t.navigator}),t.workportalFacade.executeWebpart({webpart:"overviewPlan",canvas:$("#paneRender",t.content),navigator:t.navigator})})},setButtonsHandler:function(){}}),$.Class.extend("bizagi.workportal.action.routing",{},{init:function(e){var t=this;t.dataService=e.dataService,t.resources=e.resources,t.getResource=e.getResource,t.controller=e,t.controller.subscribe("changeCase",function(e,a){t.executeRouting(a)})},executeRouting:function(e){var t=this,a=$.Deferred();return bizagi.loading.start(),t.params=e||{},void 0!==e.hasStartForm&&e.hasStartForm?$.when(t.controller.publish("render-case",e)).done(function(){a.resolve()}).fail(function(){a.reject()}).always(function(){bizagi.loading.stop()}):$.when(t.dataService.routing.getRoute(e)).then(function(e){switch(e=e||{},void 0!==t.params.isOfflineForm&&t.params.isOfflineForm?e.moduleParams=$.extend(e.moduleParams,{formsRenderVersion:t.params.formsRenderVersion,isOfflineForm:t.params.isOfflineForm,idCase:t.params.idCase,idWorkitem:t.params.idWorkitem,isEdited:t.params.isEdited,isOpen:t.params.isOpen,offlineType:t.params.offlineType})||{}:e.moduleParams=e.moduleParams||{},""!==e.moduleParams.displayName&&void 0!==e.moduleParams.displayName||!(t.params.workItems&&t.params.workItems.length>0||t.params.displayName)||(e.moduleParams=$.extend(e.moduleParams,{displayName:t.params.displayName||t.params.workItems[0].displayName})),e.module){case bizagi.workportal.webparts.webpart.BIZAGI_WORKPORTAL_WEBPART_RENDER:var a=bizagi.clone(e.moduleParams);return a.buttonPropertiesAction=t.params.buttonPropertiesAction,$.when(t.controller.publish("render-case",a));case bizagi.workportal.webparts.webpart.BIZAGI_WORKPORTAL_WEBPART_ASYNC:return $.when(t.controller.publish("render-async",e.moduleParams));case bizagi.workportal.webparts.webpart.BIZAGI_WORKPORTAL_WEBPART_ROUTING:var i={title:t.getResource("workportal-widget-routing-window-selector"),width:670,height:400,onClose:e.moduleParams.onClose,isSummaryModal:t.params.isSummaryModal};t.controller.publish("showDialog",{widgetName:bizagi.workportal.webparts.webpart.BIZAGI_WORKPORTAL_WEBPART_ROUTING,data:e.moduleParams.data,modalParameters:i,onClose:i.onClose})}}).done(function(){a.resolve()}).fail(function(){a.reject()}).always(function(){bizagi.loading.stop()}),a.promise()}}),$.Class.extend("bizagi.workportal.action.navigator",{},{init:function(){var e=this;e._pivot="_",bizagi.util.mobility.renderSplitViewInit=$.proxy(e.renderSplitViewInit,e)},renderSplitViewInit:function(e){var t=this;t.splitView=e.view,t.pane=$("#paneRender",e.view.element).data("kendoMobilePane")},navigate:function(e,t){var a=this,t=t||{};void 0===a.start_page&&(a.start_page=a.pane.history[a.pane.history.length-1]),t.reset&&(a.reset(),a.start_page=e),a.pane.navigate(e)},goBack:function(){var e=this;e.pane=e.pane?e.pane:$("#paneRender").data("kendoMobilePane"),e.pane.navigate("#:back")},goHome:function(){var e=this;e.reset(),e.pane.navigate(e.start_page)},reset:function(){var e=this;e.pane.history.splice(1,e.pane.history.length-1)}}),$.Class.extend("bizagi.workportal.action.navigation",{PRIORITY_UNDEFINED:-1,PRIORITY_PRIMARY:1,PRIORITY_SECONDARY:2,PRIORITY_LIST:["next","save","validate","nextWithoutValidations","createnewcase","search","select","add",""]},{_useFloatingButtons:!1,_useFormButtons:!1,_containers:{},_forms:{},init:function(e){var t=this,a=bizagi.util.isCordovaSupported()&&bizagi.util.isAndroidDevice()&&bizagi.util.getAndroidVersion()<4.4;t.controller=e,t.view=t.controller.view,t.$pane=t.view.wrapper.closest("[data-role='pane']"),t.navBar=$(".km-navbar",t.view.header).data("kendoMobileNavBar"),t.start_page="#render",t._useFloatingButtons=bizagi.override.enableMfb&&!a,t._useFormButtons=bizagi.override.enableFormButtons},resetParams:function(){this.navBar.title(""),$(".bz-render-dynamic",this.navBar.element).hide()},createRenderContainer:function(e){var t=this;e=e||{},e.view=e.view||{},e.view.zoom=!!e.view.zoom,e.view.useNativeScrolling=void 0===e.view.useNativeScrolling||e.view.useNativeScrolling,e.view.useNativeScrolling=!e.view.zoom&&e.view.useNativeScrolling;var a=$.now(),i="render-edition-"+a,n=$.kendoTmpls(t.controller.getTemplate("renderEdition-tmpl"),{viewId:i,title:e.title||"",zoom:e.view.zoom});t.setContainerParams(e),t.$pane.append(n);var r=new kendo.mobile.ui.View(n,{zoom:e.view.zoom,useNative:e.view.useNativeScrolling,useNativeScrolling:e.view.useNativeScrolling});r._destroy=r.destroy,r.destroy=function(){this._destroy();var e,a=t._containers[i];if(a){if(void 0!==a.previousViewId){var n=t.$pane.data("kendoMobilePane"),r=a.animation||"slide";n.replace(a.previousViewId,r+" reverse");var o=a.previousViewId.replace("#","");if(void 0!==t._containers[o]?(t.setContainerParams(t._containers[o].originalParams),t.setNavigationButtons(t._containers[o].form,t._containers[o].id),e=t._containers[o].form):(t.setNavigationButtons(t.form),e=t.form),r)var s=this.element,l=setTimeout(function(){s.remove(),clearTimeout(l)},1e3);else this.element.remove()}var c=e.getParams()||{},d=$.extend([],c.selectedSection);e.setParam("selectedSection",[]),d.forEach(function(t){var a=e.getRenderById(t);void 0!==a&&a.triggerHandler("reopenSection")}),delete t._containers[i]}};var o={id:i,element:r.contentElement(),originalParams:e,destroy:function(){r.destroy()},setNavigationButtons:function(e){t.setNavigationButtons(e,this.id)}};return t._containers[i]=$.extend(o,{view:r}),$(".bz-render-back",r.header).bind("click",function(){var e=jQuery.Event("close",{});o.element.trigger(e),e.isDefaultPrevented()||r.destroy()}),o},setContainerParams:function(e){},navigate:function(e,t){var a=this._containers[e];if(a){var i=this.$pane.data("kendoMobilePane");"#"+e!==i.view().id&&(a.previousViewId=i.view().id,a.animation=t||"slide",i.replace(a.id,a.animation))}},getView:function(e){return this._containers&&this._containers[e]?this._containers[e]:void 0},goToStartPage:function(e){var t=this;t.$pane.data("kendoMobilePane").navigate(t.start_page,"slide:reverse"),t.form&&t.form.failHandler(e),(Object.keys(t._containers)||[]).reverse().forEach(function(e){t.getView(e).destroy(),delete t._containers[e];var a=$("#"+e);a&&a.length&&a.remove()})},setNavigationButtons:function(e,t){var a=this,i={};if(!(e&&e.originalProperties&&e.originalProperties.uniqueId))throw new Error("This method always requires a form as param");if(void 0!==t?a._containers[t].form=e:a.form=e,a.changeButtonVisibilityByContainer(e),e.properties&&e.properties.editable&&!e.properties.displayAsReadOnly&&e.buttons&&e.buttons.length>0){i=e.properties;var n=e.buttons&&e.buttons.length?e.buttons:i.buttons||[],r=void 0!==t?a.getView(t).view:a.view;n.length>0&&a.isFormButtonsEnabled()?a.initFormButton(e,n,r):n.length>0&&a.isFloatingButtonsEnabled()?a.initFloatingButton(e,n):a.initActionSheet(e,n)}},initActionSheet:function(e,t){var a=this;$(".bz-render-dynamic",a.navBar.element).show().actionSheet({setDataToShow:function(){for(var e=[],a=0,i=t.length;a<i;a++)t[a].guid=t[a].ordinal,t[a].displayName=t[a].caption,t[a].visible=!1!==bizagi.util.parseBoolean(t[a].visible),t[a].visible&&e.push(t[a]);return e},actionClicked:function(t){a.processButton(t.guid,e)}})},initFloatingButton:function(e,t){for(var a=this,i=[],n={save:"mo-icon bz-save-thin",add:"mo-icon bz-plus",search:"mo-icon bz-search",select:"mo-icon bz-checked",next:"mo-icon bz-arrow-right-thin",validate:"mo-icon bz-test",createnewcase:"mo-icon bz-save-thin","default-icon":"mo-icon bz-process"},r=0,o=t.length;r<o;r++){var s={};s.id=t[r].id,s.label=t[r].caption,s.link=t[r].ordinal,s.icon=n[t[r].action]?n[t[r].action]:n["default-icon"],s.slideType="",s.visible=!1!==bizagi.util.parseBoolean(t[r].visible),"back"!==t[r].action&&"cancel"!==t[r].action&&s.visible&&i.push(s)}i.length>0&&$(e.container).mfb({restingIcon:i.length>=1?"mo-icon bz-show-actions":"mo-icon "+i[0].icon.replace(/-thin$/,"-bold"),activeIcon:"mo-icon bz-cancel",activePrincipalButton:1,buttons:i,click:function(t,n){setTimeout(function(){n.principal&&1===i.length?a.processButton(i[0].link,e):a.processButton(n.link,e)},400)}})},processButton:function(e,t){if(t.allowOnlineActions()){var a=t.buttons.find(function(t){return t.ordinal===e});a.callback?a.callback():t.processButton(a)}else{var i=bizagi.localization.getResource("workportal-login-network-error","The internet connection appears to be offline. Please verify and try again.");bizagi.showMessageBox(i,"info",!1)}},modalViewDidAppear:function(){},modalViewDidDisappear:function(){},changeButtonVisibilityByContainer:function(e){e&&e.container&&($(".ui-bizagi-container-children-form",e.container).addClass("ui-bizagi-form-no-buttons"),$(".ui-bizagi-button-container, .ui-bizagi-container-button-edit",e.container).hide())},isFloatingButtonsEnabled:function(){return this._useFloatingButtons},isFormButtonsEnabled:function(){return this._useFormButtons},initFormButton:function(e,t,a){var i=this,n=t.filter(function(e){return!["back","cancel"].includes(e.action)&&!1!==bizagi.util.parseBoolean(e.visible)}).map(function(e){return{id:e.id,action:e.action,quickAction:!0===bizagi.util.parseBoolean(e.quickAction),additional:!1,label:e.caption,ordinal:e.ordinal,priority:i.Class.PRIORITY_SECONDARY,visible:!1!==bizagi.util.parseBoolean(e.visible),ranked:!1}}),r=a.footer;n.length>0?r&&r.formButtons({buttons:i.getListWithPriority(n),click:function(t,a){i.processButton(a.ordinal,e)}}):r.has(".bz-form-buttons")&&r&&r.formButtons({})},getListWithPriority:function(e){var t=this,a=bizagi.clone(e),i=0,n=t.findPriorityAction(a,0);if(n!==t.Class.PRIORITY_UNDEFINED&&(a[n].priority=t.Class.PRIORITY_PRIMARY,a[n].ranked=!0,i++),1===a.length)return a;var r=t.findButtonPositionByAction(a,"save");return r!==t.Class.PRIORITY_UNDEFINED&&(a[r].priority=t.Class.PRIORITY_SECONDARY,a[r].ranked=!0,i++),a.forEach(function(e){e.ranked||(e.priority=++i,e.ranked=!0,e.additional=a&&a.length>2)}),bizagi.util.sortJSON(a,"priority","desc"),a},findPriorityAction:function(e,t){var a=this.Class.PRIORITY_LIST,i=e.findIndex(function(e){return e.action===a[t]&&!e.ranked&&!e.quickAction});return i!==this.Class.PRIORITY_UNDEFINED?i:this.findPriorityAction(e,++t)},findButtonPositionByAction:function(e,t){this.Class.PRIORITY_UNDEFINED;return e.findIndex(function(e){return e.action===t&&!e.ranked&&!e.quickAction})}}),$.Class.extend("bizagi.workportal.widget.dialog",{},{init:function(e){this.webpart=e},renderDialog:function(e){var t=this,a=new $.Deferred,i=new bizagi.workportal.widget.routing(t.webpart);i.renderContent(e);var n=kendo.template(t.webpart.getTemplate("dialog-tmpl"),{useWithBlock:!1}),r=n({content:i.getContent()});return t.modal=new kendo.mobile.ui.ModalView(r,{close:function(){this.destroy(),this.element.remove(),a.resolve()},modal:!0}),i.configureHandlers(a,t.modal),t.modal.open(),a.promise()}}),$.Class.extend("bizagi.workportal.widget.routing",{},{init:function(e){var t=this;t.webpart=e,t.content=""},renderContent:function(e){var t=this,a=t.webpart.workportalFacade.getTemplate("routing-tmpl"),i=kendo.template(a,{useWithBlock:!1}),n=i(e);return t.setContent(n),t.getContent()},configureHandlers:function(e,t){var a=this,i=t.contentElement();$("tr:nth-child(even)",i).addClass("event"),$("#ui-bizagi-wp-app-routing-activity-wf .bz-wp-routing-action",i).on("click",function(){var i=$(this).closest(".bz-wp-routing-item").data("item"),n={idCase:i.idCase||0,idWorkitem:i.idWorkItem||0,idTask:i.idTask||0,taskName:i.displayName||"",displayName:i.displayName,radNumber:i.radNumber||0,hasWorkItems:!bizagi.util.isEmpty(i.idWorkItem),mobileAccess:!!bizagi.util.isEmpty(i.mobileAccess)||i.mobileAccess,hasGlobalForm:!0===bizagi.util.parseBoolean(i.hasGlobalForm),forceOffline:!0===i.forceOffline};bizagi.util.isEmpty(i.idWfClass)||(n.idWfClass=i.idWfClass),a.showWorkitem(n),t.close(),e.resolve()}),$(".wp-routing-container-footer button",i).one("click",function(){t.close(),$(this).hasClass("summary-modal")||a.goHomeportal(),e.resolve()})},goHomeportal:function(){bizagi.kendoMobileApplication.navigate("homePortal"),self.publish("bz-update-list-cases",{updateDataList:!0})},showWorkitem:function(e){var t=this,a={idCase:e.idCase,idWorkitem:e.idWorkitem,idTask:e.idTask,taskName:e.taskName,displayName:e.displayName,radNumber:e.radNumber,hasWorkItems:e.hasWorkItems,mobileAccess:e.mobileAccess,hasGlobalForm:e.hasGlobalForm,forceOffline:e.forceOffline};bizagi.util.isEmpty(e.idWfClass)||(a.idWfClass=e.idWfClass),this.getOfflineTaskSyncError(a).then(function(e){e&&t.includeSyncErrorIntoRenderCaseparams(a,e)}).always(function(){bizagi.webpart.publish("render-case",a)})},getContent:function(){return this.content},setContent:function(e){this.content=e},getOfflineTaskSyncError:function(e){if(!bizagi.util.isOfflineErrorsViewSupported())return $.Deferred().resolve(void 0).promise();var t=$.Deferred(),a=$.extend({deferred:t},e);return bizagi.webpart.publish("routing-get-offline-task-sync-error",a),t},includeSyncErrorIntoRenderCaseparams:function(e,t){e.hasSyncError=!0,e.syncError=t,e.offlineType="task",e.idEdited=!0,e.isOfflineForm=!0,e.isOfflineErrorMode=!0}}),$.Class.extend("bizagi.workportal.widget.async",{ASYNC_CHECK_TIMER:3e3},{init:function(e){var t=this;t.webpart=e,t.configureHandlers()},configureHandlers:function(){var e=this.webpart,t=this;e.subscribe("render-async",function(a,i){t.executeAsync(i).done(function(){e.publish("changeCase",{action:bizagi.workportal.webparts.webpart.BIZAGI_WORKPORTAL_WEBPART_ROUTING,idCase:i.idCase})})})},executeAsync:function(e){var t=this,a=new $.Deferred,i=kendo.template(t.webpart.getTemplate("async-tmpl"),{useWithBlock:!1}),n=i(e);return t.modal=new kendo.mobile.ui.ModalView(n,{close:function(){this.destroy(),this.element.remove()},modal:!0}),$(".ui-bizagi-async-close",t.modal.element).bind("click",function(){t.modal.close(),bizagi.util.isNativePluginSupported()&&bizagi.util.isiOSDevice()&&bizagi.util.isSmartphoneDevice()&&bizagiapp.workPortalBack()}),t.modal.open(),t.checkAsycnExecutionState(a,e),a.promise()},checkAsycnExecutionState:function(e,t){var a=this.webpart,i=this;$.when(a.dataService.getAsynchExecutionState({idCase:t.idCase})).done(function(a){"Error"==a.state&&void 0!==a.errorMessage&&($("#modalview-async-message",i.modal.element).height(130),$(".ui-bizagi-wp-async-error",i.modal.element).show(),$(".ui-bizagi-wp-waiting-message",i.modal.element).hide(),$(".ui-bizagi-wp-async-error-txt",i.modal.element).html(a.errorMessage||bizagi.localization.getResource("render-async-error"))),"Processing"==a.state?0===a.errorMessage.length&&setTimeout(function(){i.checkAsycnExecutionState(e,t)},bizagi.workportal.widget.async.ASYNC_CHECK_TIMER):"Finished"==a.state&&(i.modal.close(),e.resolve())})}}),bizagi.workportal.webparts.webpart.extend("bizagi.workportal.webparts.renderTemplates",{PAGE_SIZE:10},{init:function(e,t,a){var i=this;i._super(e,t,a),i.actionsEvents=new bizagi.actionsEvents(t,"Entities",{homePortalFramework:i.homePortalFramework}),i.renderTemplatesGrid=kendo.template(i.getTemplate("render-templates-list"),{useWithBlock:!1}),i.renderTemplatesItem=kendo.template(i.getTemplate("render-templates-item"),{useWithBlock:!1}),i.renderTemplatesActions=kendo.template(i.getTemplate("render-templates-actions"),{useWithBlock:!1}),i.currentPage=1,i.totalPages=0,i.selectedItems=[],i.entityCollection=[],i.tEnginePromise,i.updated=!1},renderContent:function(){return this.renderTemplatesGrid({})},postRender:function(){var e=this;e.subscribe("homeportalShow-stuffTemplates",$.proxy(e.onTriggerTemplate,e)),e.subscribe("update-Templates",function(t,a){e.updated&&e.updateData.bind(e)(t,a||{})}),e.canvas.bind("view-initialized",$.proxy(e.onAfterViewInitialized,e)),e.configureHandler()},onTriggerTemplate:function(e,t){var a=this;t.refresh&&t.surrogateKey?a.refreshRegister(e,t):(t.guidSearch||t.data&&!t.data.reference||a.homePortalFramework.navigateFromRender?a.setActionButton(!1,[]):a.getProcessAddAction(t),$.when(a.renderSortBar(t)).done(function(){$.extend(t,{page:1}),a.updateData(e,t)}))},configureHandler:function(){var e=this;bizagi.webpart.subscribe("newData",function(){e.actionsEvents.processAddAction(e.action)})},updateData:function(e,t){var a,i,n=this;n.updated=!0,n.removeGroupingBar();var r=n.canvas.data("kendoMobileView");if(r){var o=n.canvas.data("kendoMobileView").contentElement();if(n._referrer=n.getReferrer(t),n._totalRecords=t.totalRecords,n._filters=t.filters||n._filters,n._guidSearch=t.guidSearch||n._guidSearch,void 0===t.calculateFilters||t.calculateFilters?(a=-1,i=-1,n._page=t.page||n._page):(a=t.pageSize*n._page,i=1),void 0!==t.data){var s=t.data;n._dataNavigation=s||n._dataNavigation,n._reference=s.reference||n._reference,n._surrogateKey=s.surrogateKey||n._surrogateKey,n._referenceType=s.referenceType||n._referenceType,n._xpath=s.xpath||n._xpath,n._guidEntityCurrent=s.guidEntityCurrent||n._guidEntityCurrent,n._guidSearch=s.guidSearch||n._guidSearch}return $("#tmpl-list",o).empty(),r.scroller.reset(),n.showNoItems(!1),$(".bz-render-templates-header",o).text(t.text),$.when(n.tEnginePromise).then(function(){var e={guidSearch:n._guidSearch,data:t.data,reference:n._reference,surrogateKey:n._surrogateKey,referenceType:n._referenceType,page:i>0?i:n._page,pageSize:a>0?a:t.pageSize||n.Class.PAGE_SIZE,filters:n._filters,filtersAppliedCounter:t.filtersAppliedCounter,totalRecords:n._totalRecords,calculateFilters:t.calculateFilters||!1,defaultFilterApplied:void 0===t.defaultFilterApplied||t.defaultFilterApplied,xpath:n._xpath,guidEntityCurrent:n._guidEntityCurrent};return $.when(n.getEntityData(e)).done(function(){n.showGroupingBar()}).fail(function(e){var t=bizagi.localization.getResource("workportal-widget-sortbar-execute-error-message").replace("%s","error");$.notifier.add({title:"Error",text:t,class_name:"error",sticky:!1})})})}},getData:function(e){var t=this,a=e.filters,i=e.filtersAppliedCounter,n=e.calculateFilters;return t.showNoItems(!1),t.showLoadMore(!1),"search"===t._referrer?t.dataService.getSearchData(e).then(function(e){return e.totalRecords>0?t.homePortalFramework.extendCurrentContext({entityGuid:e.rows[0].guidEntity,calculateFilters:n}):t.showNoItems(!0),t.setFiltersData(e.filters,a,i,e.totalRecords,n,null),e}):t.dataService.getCollectionEntityData(e).then(function(r){var o=r.totalRecords;if(o>0&&r.rows.length>0){var s=e.referenceType;t.homePortalFramework.extendCurrentContext({entityGuid:r.rows[0].guidEntity,calculateFilters:n}),"FACT"===s?t.dataService.getFiltersEntityData(e,r).then(function(r){t.processFiltersData(r,a,i,o,n,e.defaultFilterApplied)}).fail(function(){t.hideSortBar()}):t.hideSortBar()}else i>0?t.setFiltersData([],a,i,o,!1,null):(t.hideSortBar(),t.showNoItems(!0));return r})},processFiltersData:function(e,t,a,i,n,r){var o=this;if(r){for(var s,l={properties:{xpath:"",type:"entity",typeSearch:"exact"},value:[]},c=-1,d=0;s=e[++c];){var u=s.data;if("Entity"===s.type)for(var p,m=-1;p=u.defaultValues[++m];)p.applied&&(l.properties.xpath=s.attribute,l.value.push({id:p.id}),d++)}d>0&&t.push(l),a=void 0!==a?a+d:d,o.setFiltersData(e,t,a,i,n,r)}else o.setFiltersData(e,[],a,i,n,null)},setFiltersData:function(e,t,a,i,n,r){var o=this,s={filters:e||[],filtersApplied:t||[],filtersAppliedCounter:a||0,totalRecords:i||0,calculateFilters:n||!1};r&&(s.defaultFilterApplied=r),o.content.trigger("setFiltersData",s)},getEntityData:function(e){var t=this;return $.when(t.getData(e)).then(function(e){return t.currentPage=e.currentPage,t.totalPages=e.totalPages,t.entityCollection=t.entityCollection.concat(e.entities),t.getEntityTemplates(e)})},getProcessAddAction:function(e){var t=this,a=e.data||{};a.reference&&"ENTITY"!==a.referenceType?t.dataService.getProcessAddAction({reference:a.reference,surrogateKey:a.surrogateKey}).done(function(e){t.setActionButton(e)}):t.setActionButton({})},setActionButton:function(){},refreshEntityData:function(e,t){var a=this,i={operator:"",filters:[{key:"id",value:e}]};return $.when(a.getData({page:a._page,filters:i})).done(function(e){var i=$.map(e.entities,function(e){return $.when(a.engine.render(e)).done(function(i){var n=a.renderTemplatesItem({tmpl:i.get(0).outerHTML,surrogateKey:e.surrogateKey});if(t.length>0)$(n).insertAfter(t);else{var r=$("#tmpl-list",a.content);$(n).prependTo(r)}a.paintHeaderFooterButtons(e)})});return $.when.apply($,i)})},paintHeaderFooterButtons:function(e){var t=this
;t.actionsEvents.getEvents(e).done(function(){t.actionsEvents.getActions(e).done(function(){for(var a,i=-1;a=e[++i];)t.paintButtons(a,a.actions,a.events),t.entityCollection.find(function(e){e.surrogateKey===a.surrogateKey&&(e.entityActions=a.actions)})})})},getSelectedItems:function(){return this.selectedItems},addSelectedItem:function(e){this.selectedItems.push(e)},deleteSelectedItem:function(e){this.selectedItems.splice(this.selectedItems.indexOf(e),1)},findDataItem:function(e){return this.entityCollection.find(function(t){return t.surrogateKey==e})},handleDataNavigation:function(){var e=this;e.engine.subscribe("onLoadDataNavigation",function(t,a){a.filters=[],a.calculateFilters=a.calculateFilters||!0,e.homePortalFramework.extendCurrentContext({surrogateKeyToMapping:a.data.surrogateKey}),e.homePortalFramework.addContext(a.data),e.publish("homeportalShow",{what:"stuffTemplates",title:a.data.displayName,params:a,preventNavigate:!1})})}}),bizagi.workportal.webparts.renderTemplates.extend("bizagi.workportal.webparts.renderTemplates",{MAX_BUTTONS:2},{postRender:function(e){var t=this;t._super(e),t.tEnginePromise=$.when(t.workportalFacade.modules[t.workportalFacade.Class.render_module]).then(function(){var a=e.proxyPrefix||t.dataService.serviceLocator.proxyPrefix,i=new bizagi.render.services.service({proxyPrefix:a}),n=new bizagi.rendering.smartphone.factory(i);return $.when(n.initAsyncStuff()).then(function(){t.engine=new bizagi.templateEngine({renderFactory:n,cache:!0,forcePersonalizedColumns:!1}),t.handleDataNavigation()})})},configureHandler:function(){var e=this;e._super(),$(".bz-render-templates-footer",e.content).unbind().bind("click",function(){e.getEntityData({calculateFilters:!1,data:e._dataNavigation,filters:e._filters,guidSearch:e._guidSearch,page:++e._page,pageSize:e.Class.PAGE_SIZE,reference:e._reference,referenceType:e._referenceType,surrogateKey:e._surrogateKey,xpath:e._xpath,guidEntityCurrent:e._guidEntityCurrent})}),$("#tmpl-list",e.content).on("click","div.wp-action-item-check",function(){var t=this.classList.contains("selected"),a=e.findDataItem($(this).data("surrogatekey"));t?($(this).removeClass("selected"),e.deleteSelectedItem(a)):($(this).addClass("selected"),e.addSelectedItem(a)),e.selectedItems.length>0?($(".wp-ly-secondary-header",e.canvas).show(),$(".wp-ly-principal-header",e.canvas).hide()):($(".wp-ly-secondary-header",e.canvas).hide(),$(".wp-ly-principal-header",e.canvas).show())})},onAfterViewInitialized:function(e,t){var a=this;a.data=t,$(".bz-header-btn5",t.header).actionSheet({setDataToShow:function(){var e=a.actionsEvents.getCommomActions(a.getSelectedItems());if(0===e.length){var t=bizagi.localization.getResource("workportal-widget-no-actions-found");bizagi.showConfirmationBox(t,"Bizagi",!0,[{label:"Ok",action:"resolve"}])}return e},actionClicked:function(e){a.actionsEvents.executeActionMultipleData(e,a.entityCollection[0],a.getSelectedItems())}}),$(".wp-ly-secondary-header .bz-header-back-btn",t.header.context).bind("click",function(){a.removeGroupingBar()})},updateData:function(e,t){return bizagi.loading.start(),$.when(this._super(e,t)).always(function(){bizagi.loading.stop()})},setActionButton:function(e){var t=this;e&&"object"==typeof e&&Object.getOwnPropertyNames(e).length>0?(t.action=e,$(".bz-wp-render-new-data",t.canvas).show()):$(".bz-wp-render-new-data",t.canvas).hide()},renderSortBar:function(e){var t=this;if(void 0!=t.data)return $(".bz-wp-sortbar-container",t.data.scroller.fixedContainer).remove(),$(t.content).css({"margin-top":"60px"}),t.workportalFacade.executeWebpart({webpart:"sortBar",canvas:t.data.scroller.fixedContainer,container:t.content,filters:e.filters})},hideSortBar:function(){var e=this,t=$(".bz-wp-sortbar-container",e.data.scroller.fixedContainer);t&&t.remove(),$(e.content).css({"margin-top":"10px"})},showLoadMore:function(e){var t=this;e?t.currentPage===t.totalPages||0===t.totalPages?$(".bz-render-templates-footer",t.content).hide():$(".bz-render-templates-footer",t.content).show():$(".bz-render-templates-footer",t.content).hide()},showNoItems:function(e){var t=this;e?$(".bz-render-templates-no-content",t.content).show():$(".bz-render-templates-no-content",t.content).hide()},showGroupingBar:function(){var e=this,t=$("#tmpl-list",e.content);e.homePortalFramework.navigateFromRender?$(".wp-action-item-check",t).hide():$(".wp-action-item-check",t).show()},removeGroupingBar:function(){var e=this;e.selectedItems=[],$("div.wp-action-item-check",e.content).removeClass("selected"),$(".wp-ly-secondary-header",e.canvas).hide(),$(".wp-ly-principal-header",e.canvas).show()},refreshRegister:function(e,t){var a=this;if("search"==a._referrer)a.updateData(e,$.extend(t,{calculateFilters:!1}));else{var i=a.canvas.data("kendoMobileView").contentElement(),n=$("li.wp-tender-template-item[data-surrogateKey='"+t.surrogateKey+"']",i);t.insertAfterElement=n.prev(),n.remove(),a.refreshEntityData(t.surrogateKey,t.insertAfterElement)}},getEntityTemplates:function(e){var t=this,a=$("#tmpl-list",t.content),i="ENTITY"===t._referenceType?"Content":"List",n=[],r=$.map(e.entities,function(r){return n.push({surrogateKey:r.surrogateKey,entityId:r.guid}),t.engine.render($.extend(r,{isDefaultTemplate:null===r.guidTemplate,templateType:i,columnsXPaths:t._matchHeaderWithColumns(e)})).then(function(e){var i=$(t.renderTemplatesItem({surrogateKey:r.surrogateKey}));i.find("#wp-item-container").append(e),r.item=i.appendTo(a)})});return $.when.apply($,r).then(function(){t.dataService.getIdCasesOfProcessEntities(n).then(function(t){for(var a,i=-1;a=t[++i];){var n=a.caseId;if(void 0!==n&&n>0){var r=e.entities.find(function(e){return e.surrogateKey===a.surrogateKey});void 0!==r&&$.extend(r,{idCase:n})}}}).always(function(){t.homePortalFramework.navigateFromRender||t.paintHeaderFooterButtons(e.entities),t.showLoadMore(!0)})})},getReferrer:function(e){var t=this;return void 0!==e.guidSearch?"search":void 0!==e.data?"searches"===e.data.entityType?"search":"dataNavigation":void 0!==t._referrer?t._referrer:"dataNavigation"},paintButtons:function(e,t,a){var i,n=this,r=n.renderTemplatesActions,o=$("li.wp-tender-template-item[data-surrogatekey='"+e.surrogateKey+"']",n.content),s=$(".actions-section",o),l=[],c=-1;for(t=t||[],a=a||[],-1!==e.surrogateKey&&0!==t.length||$(".wp-action-item-check",o).hide();i=t[++c];)0!==i.multiplicity&&1!==i.multiplicity||l.push(i);for(var d,u=-1;d=a[++u];)l.push(d);var p={more:!1,buttons:l};void 0!==e.idCase&&e.idCase>0&&(p.isProcessEntity=!0,p.caseAction={idCase:e.idCase,type:"WorkOnIt"}),p.buttons.length>n.Class.MAX_BUTTONS&&(p.more=!0),s.html(r(p)),n.configureActionHandlers(s,p.buttons,e)},configureActionHandlers:function(e,t,a){var i=this;$(".wp-action-more",e).actionSheet({setDataToShow:function(){return t},actionClicked:function(e){i.removeGroupingBar(),i.actionsEvents.executeActionSingleData(e,a)}}),$(e).on("click",".wp-action",function(){i.removeGroupingBar(),i.actionsEvents.executeActionSingleData($(this).data("action"),a)})},_matchHeaderWithColumns:function(e){var t=function(e,t){return console.error("_matchHeaderWithColumns: property "+e+" does not exist"),t},a=bizagi.util.tryCatch(function(){return e.cells[0].columns},t.bind(null,"data.cells[0].columns",[])),i=bizagi.util.tryCatch(function(){return e.cells[0].headerMapper},t.bind(null,"data.cells[0].headerMapper",a));return a.reduce(function(e,t,a){return e[t]=void 0==i?t:i[a],e},{})}}),bizagi.workportal.webparts.webpart.extend("bizagi.workportal.webparts.searchesList",{},{init:function(e,t,a){var i=this;a.authorizationRole="Search",i._super(e,t,a)},renderContent:function(e){var t=this;return kendo.template(t.getTemplate("main-searchesList-kendo-tmpl"),{useWithBlock:!1})()}}),bizagi.workportal.webparts.searchesList.extend("bizagi.workportal.webparts.searchesList",{},{postRender:function(e){var t=this;return bizagi.loading.startInnerLoader("#"+e.webpart),$(t.content).find(".bz-wp-searches-list").kendoMobileListView({filterable:!1,template:t.getTemplate("searches-item-tmpl"),click:function(e){t.homePortalFramework._cleanContext(),t.homePortalFramework.addContext({entityGuid:e.dataItem.entity,surrogateKey:[],entityType:"searches",guidSearch:e.dataItem.id}),t._showSearchForm(e)}}),$.when(t.dataService.getSearchLists()).then(function(e){$(t.content).find(".bz-wp-searches-list").data("kendoMobileListView").setDataSource(e)}).always(function(t){bizagi.loading.stopInnerLoader("#"+e.webpart)})},_showSearchForm:function(e){this.publish("homeportalShow",{what:"loadForm",params:e.dataItem,transition:"fade:up"})}}),bizagi.workportal.webparts.webpart.extend("bizagi.workportal.webparts.shortCut",{},{init:function(e,t,a){this._super(e,t,a)},renderContent:function(){var e=this,t=$.Deferred(),a=e.homePortalFramework.loadComponentTemplate("shortCut-tmpl","shortCut",{});return t.resolve(a),t.promise()},postRender:function(e){var t=this;return t.homePortalFramework.loadComponents("shortCut",t.content).done(function(){t.list=$('<ul class="bz-wp-shortCut-list"></ul>'),t.list.kendoMobileListView({filterable:!1,template:t.getTemplate("shortCut-tmpl-item"),click:bizagi.util.debounce(function(e){t._executeShortcut(e)},500),headerTemplate:"<h2>${value}</h2>"}),t.content.prepend(t.list)}),bizagi.loading.startInnerLoader("#"+e.webpart),t.dataService.getShortCuts({icon:!0}).then(function(e){return t.processShortcuts(e)}).then(function(a){if(a.length>0){var i=kendo.data.DataSource.create({data:a,group:"classification.displayName"});t.list.data("kendoMobileListView").setDataSource(i),$(".km-content:visible").data("kendoMobileScroller")&&$(".km-content:visible").data("kendoMobileScroller").reset(),t.configureHandler(),bizagi.loading.stopInnerLoader("#"+e.webpart)}else bizagi.loading.stopInnerLoader("#"+e.webpart)}).fail(function(e){return e})},configureHandler:function(){},processShortcuts:function(e){for(var t,a=-1;t=e[++a];)t.icon=t.icon?t.icon:null,t.image=t.image?t.image:null;return e},_executeShortcut:function(e){var t=this,a=e.dataItem;return $.when(t.dataService.validateHasStartForm({processId:a.idProcess})).done(function(e){return $.when(bizagi.webpart.publish("createNewCase",{showConfirmation:a.showConfirmation,notification:!0,type:"Process",isMultiInstance:!1,title:a.displayName,isShortcut:!0,guidProcess:a.idProcess,hasStartForm:e.startForm,parentCaseId:0}))}).fail(function(e){t._showErrorMessage(a.displayName,e)}).always(function(){bizagi.util.smartphone.stopLoading()})},_showErrorMessage:function(e,t){var a=bizagi.localization.getResource("workportal-widget-sortbar-execute-error-message").replace("%s",e);$.notifier.add({title:"Error",text:a,class_name:"error",sticky:!0})}}),bizagi.workportal.webparts.shortCut.extend("bizagi.workportal.webparts.shortCut",{},{init:function(e,t,a){this._super(e,t,a)}}),bizagi.workportal.webparts.webpart.extend("bizagi.workportal.webparts.sortBar",{},{init:function(e,t,a){this._super(e,t,a)},renderContent:function(e){var t=this;return kendo.template(t.getTemplate("wp-sortBar"))({})}}),bizagi.workportal.webparts.sortBar.extend("bizagi.workportal.webparts.sortBar",{},{postRender:function(e){var t=this;return t.configureHandlers(),t.sortSelection={},t.workportalFacade.executeWebpart({webpart:"filterBar",canvas:$(".bz-wp-filterbar-container",t.content),container:t.container,filters:e.filters}).then(function(e){t.filterBar=e})},configureHandlers:function(){var e=this;e.unsubscribe("setFiltersData.sortBar"),e.subscribe("setFiltersData.sortBar",function(t,a){if(e.filtersAppliedCounter=a.filtersAppliedCounter||0,e.filters=a.calculateFilters?a.filters:e.filters,a.calculateFilters){if(0==$(".bz-wp-sortBar",e.content).children().length){var i=kendo.template(e.getTemplate("wp-sortBar-RigthMenu"));$(".bz-wp-sortBar",e.content).empty().append(i({})),$(".bz-wp-sortBar",e.content).show(),e.configureAfterPaintHandlers()}for(var n,r=-1,o=0,s=0;n=e.filters[++r];)"Text"!=n.type&&"Link"!==n.type&&n.data&&(n.data.defaultValues&&n.data.defaultValues.length>0||n.data.min&&n.data.max)&&o++,""!==n.display&&s++;a.totalRecords>0?(o>0?e.showFilterButton():e.hideFilterButton(),s>0?e.showSortButtons():e.hideSortButtons()):0===e.filtersAppliedCounter&&(e.hideFilterButton(),e.hideSortButtons())}e.updateCounter(e.filtersAppliedCounter)})},showFilterButton:function(){var e=this,t=$(".wp-actions-filter",e.getContent());t.show(),e.filtersAppliedCounter>0?(t.addClass("full"),$(".wp-webp-icon",t).addClass("bz-filter-full")):$(".wp-webp-icon",t).removeClass("bz-filter-full").addClass("bz-filter-empty"),$(".bz-wp-filterbar-container",e.content).is(":visible")&&(t.removeClass("full").addClass("active"),$(".wp-webp-icon",t).removeClass("bz-filter-full").addClass("bz-filter-empty"))},hideFilterButton:function(){var e=this;$(".wp-actions-filter",e.getContent()).hide()},showSortButtons:function(){var e=this;$(".wp-actions-sort",e.getContent()).show(),$(".wp-actions-sort-az",e.getContent()).show()},hideSortButtons:function(){var e=this;$(".wp-actions-sort",e.getContent()).hide(),$(".wp-actions-sort-az",e.getContent()).hide()},configureAfterPaintHandlers:function(){var e=this;$(".wp-actions-filter",e.content).unbind().bind("click",function(){if($(".bz-wp-filterbar-container",e.content).is(":visible"))e.filterBar&&(e.filterBar.getFilters().length>0||e.filtersAppliedCounter>0)?($(".wp-actions-filter",e.content).addClass("full"),$(".wp-actions-filter .wp-webp-icon",e.content).removeClass("bz-filter-empty").addClass("bz-filter-full")):($(".wp-actions-filter",e.content).removeClass("full"),$(".wp-actions-filter .wp-webp-icon",e.content).removeClass("bz-filter-full").addClass("bz-filter-empty")),$(".wp-actions-filter",e.content).removeClass("active"),$(".bz-wp-filterbar-container",e.content).slideUp(200,"swing",function(){$(e.container).animate({marginTop:"60px"},200,"swing")});else{var t=$(".bz-wp-filterbar-container",e.content).height()+60;$(".wp-actions-filter",e.content).addClass("active"),$(".wp-actions-filter .wp-webp-icon",e.content).removeClass("bz-filter-full").addClass("bz-filter-empty"),$(".bz-wp-filterbar-container",e.content).slideDown(200,"swing",function(){$(e.container).animate({marginTop:t+"px"},200,"swing")})}}),$(".wp-actions-sort-az",e.content).unbind().bind("click",function(){if(e.sortSelection.attribute){$(".wp-webp-icon",this).hasClass("bz-unordered")&&$(".wp-webp-icon",this).removeClass("bz-unordered"),"asc"==e._sortType?(e._sortType="desc",$(this).removeClass("asc").addClass("desc"),$(".wp-webp-icon",this).removeClass("bz-ordered-up").addClass("bz-ordered-down")):(e._sortType="asc",$(this).removeClass("desc").addClass("asc"),$(".wp-webp-icon",this).removeClass("bz-ordered-down").addClass("bz-ordered-up"));var t={properties:{xpath:e.sortSelection.attribute,orderType:e._sortType,typeSearch:"none"}};e.publish("setOrderBy",t)}}),$(".wp-actions-sort",e.content).unbind().bind("click",function(){e.buildSortModalView(),e.adjustModalViewHeigth()})},updateCounter:function(e){var t=this,a=t.getContent(),i=$(".wp-webp-filter-counter",a);e>0?(i.html(e),i.show()):i.hide()},buildSortModalView:function(){var e=this,t=kendo.template(e.getTemplate("wp-sortbarModalView"));e.$modalViewTemplate=$(t({filters:e.filters})),e.$modalViewTemplate.kendoMobileModalView({close:function(){this.destroy(),this.element.remove()}}),$(".ui-bizagi-sort-item",e.$modalViewTemplate).unbind().click(function(){var t=$(this).data("index"),a=e.filters[t];if(e.sortSelection!=a){e.sortSelection=a,e._sortType="asc",$(".wp-actions-sort label",e.content).text(e.sortSelection.display),$(".wp-actions-sort-az",e.content).removeClass("desc").addClass("asc"),$(".wp-actions-sort-az .wp-webp-icon",e.content).hasClass("bz-unordered")&&$(".wp-actions-sort-az .wp-webp-icon",e.content).removeClass("bz-unordered"),$(".wp-actions-sort-az .wp-webp-icon",e.content).removeClass("bz-ordered-down").addClass("bz-ordered-up");var i={properties:{xpath:a.attribute,orderType:e._sortType,typeSearch:"none"}};e.publish("setOrderBy",i)}e.$modalViewTemplate.kendoMobileModalView("close")}),$("#ui-bizagi-cancel-sortbar",e.$modalViewTemplate).unbind().click(function(){e.$modalViewTemplate.kendoMobileModalView("close")}),e.$modalViewTemplate.kendoMobileModalView("open")},adjustModalViewHeigth:function(){var e=this,t=e.$modalViewTemplate;if(t){var a=t.find("div.km-header").outerHeight(!0),i=0;$.each(t.find("div.km-scroll-container > *"),function(e,t){var a=$(t);a.is(":visible")&&(i+=a.outerHeight(!0))});var n=t.find("div.km-footer").outerHeight(!0),r=a+i+n;$(t.parent().parent()).css("max-height",t.css("max-height")),$(document).height()>r&&(t.height(r),t.parent().parent().height(r))}}}),bizagi.workportal.webparts.webpart.extend("bizagi.workportal.webparts.stakeHolder",{},{init:function(e,t,a){this._super(e,t,a)},renderContent:function(e){var t=this,a=$.Deferred();return t.content=t.homePortalFramework.loadComponentTemplate("stakeHolder-tmpl","stakeHolder",bizagi.currentUser),a.resolve(""),a.promise()},postRender:function(e){var t=this;t.canvas.bind("view-initialized",$.proxy(t.onAfterViewInitialized,t))},configureHandler:function(){var e=this;$(".wp-sh-container",e.content).bind("click",function(){e.publish("homeportalShow",{what:"dashBoard"})})},onAfterViewInitialized:function(e,t){var a=bizagi.currentUser;t.header.find(".bz-wp-title").html(a.userFullName);for(var i,n=[],r=-1;i=a.associatedStakeholders[++r];)n.push(i.displayName);if(t.header.find(".bz-wp-subtitle").html(n.join(",")),a.userPicture){t.header.find(".btn-menu").removeClass("bz-login-user").removeClass("bz-mo-icon").html('<img class="wp-sh-image" src="data:image/png;base64,'+a.userPicture+'">')}}}),bizagi.workportal.webparts.webpart.extend("bizagi.workportal.webparts.startForm",{},{_useFloatingButtons:!1,init:function(e,t,a){var i=this;i._super(e,t,a),i.navigation={},i._useFloatingButtons=bizagi.override.enableMfb&&!(bizagi.util.isAndroidDevice()&&bizagi.util.isCordovaSupported()&&bizagi.util.getAndroidVersion()<4.4)},initNavigation:function(){var e=this;return e.navigation=new bizagi.workportal.action.navigation(e),e.navigation},renderContent:function(){var e=this,t=$.Deferred();return e.content=e.homePortalFramework.loadComponentTemplate("startForm-tmpl","startForm",{useWithBlock:!1}),t.resolve(e.content),t.promise()},renderForm:function(e){var t=this;t.content.empty(),void 0===t.view&&(t.view=new kendo.mobile.ui.View(t.canvas,{useNativeScrolling:!0}),t.initNavigation());var a=e.displayName||e.title||"";if($(".km-navbar",t.view.header).data("kendoMobileNavBar").title(a),t.original_params=e,t._type=e.type,t._navigateProcess=void 0!==e.showProcess&&e.showProcess,t._origin=e.origin,"Process"===e.type){if(t._renderParams={h_action:e.hasStartForm?"LOADSTARTFORM":"LOADFORM"},void 0!==e.idParentCase&&(t._renderParams.h_idParentCase=e.idParentCase),void 0!==e.guidProcess?(t._renderParams.h_guidprocess=e.guidProcess,void 0===e.mapping&&e.isShortcut&&(t._renderParams.h_mappingstakeholders=!0)):t._renderParams.h_idProcess=e.idProcess,e.mapping)for(var i=0;i<e.mapping.length;i++){var n=e.mapping[i];n.surrogateKey&&(t._renderParams[n.xpath]=JSON.stringify(n.surrogateKey))}}else"Form"===e.type&&(t._renderParams={h_action:"LOADENTITYFORM",h_contexttype:"entity",h_guidEntity:e.entityGuid,h_guidForm:e.formGuid,h_showDisabled:!1,h_readonlyform:e.readonlyform},null!==e.entitySurrogateKey&&(t._renderParams.h_surrogateKey=e.entitySurrogateKey),void 0!==e.mapping&&null!==e.mapping&&(t._renderParams.h_mapping=JSON.stringify(e.mapping)));if(void 0===t.rendering){var r=e.proxyPrefix||t.dataService.serviceLocator.proxyPrefix;bizagi.rendering.facade.extend("bizagi.rendering.startFormFacade",{},{process:function(e){return this._super(e).then(function(a){return t._form=a,t._changeButtons(e.origin),a})}}),t.rendering=new bizagi.rendering.startFormFacade({proxyPrefix:r,device:bizagi.util.detectDevice()})}return bizagi.util.setContext({idCase:e.idCase||null,displayName:e.displayName||e.taskName,caseNumber:e.caseNumber||null}),"#renderSplitView"!==bizagi.kendoMobileApplication.view().id&&bizagi.kendoMobileApplication.navigate("#renderSplitView"),$("#paneRender").data("kendoMobilePane").navigate("#startForm","slide:right"),$.when(t.dataService.getForm(t._renderParams)).then(function(a){return a.form.properties.editionForm=!0,t.rendering.execute({data:a,navigation:t.navigation,originalParams:e,postRenderEdit:t.postRenderEdit.bind(t),getTemplate:t.getTemplate,canvas:t.content,pane:$("#right-pane").data("kendoMobilePane"),type:""})}).done(function(e){t.view.scroller.reset()})},postRender:function(){this.configureHandlers()},postRenderEdit:function(){},configureHandlers:function(){var e=this;$(".bz-render-back",e.canvas).bind(e.Class.BIZAGI_TAP_EVENT,function(){e._back()}),e.subscribe("render-start-form",function(t,a){return e.startRendering(a.params)}),e.subscribe("homeportalShow-startForm",function(t,a){return e.startRendering(a)}),e.content.bind("routing",function(t,a){if(a.notification){var i=printf(bizagi.localization.getResource("workportal-widget-templateengine-message-summary-create-cases-singular"),1),n=bizagi.localization.getResource("workportal-widget-templateengine-action-process-notification"),r=n.replace("{0}",a.caseNumber);$.notifier.add({title:e.original_params.displayName||"",text:i+"<br>"+r}),e._back()}else if(void 0!==a.idCase){var o={action:"routing",idCase:a.idCase};bizagi.loading.start(),e.dataService.getCaseAssignees(a).then(function(t){var i=t.assignees;if(e._navigateProcess=!1,void 0!==i&&i.length>0){var n=bizagi.currentUser.idUser;void 0!==i.find(function(e){return e.idUser==n})&&(e._navigateProcess=!0)}if(e.publish("bz-update-list-cases",{updateDataList:!0}),e._navigateProcess||e.original_params.fromNewCase)e.openRenderCase(o);else{var r=printf(bizagi.localization.getResource("workportal-widget-templateengine-message-summary-create-cases-singular"),1),s=bizagi.localization.getResource("workportal-widget-templateengine-action-process-notification"),l=s.replace("{0}",a.caseNumber),c=e.original_params.displayName||"",d=r+"<br><span class='message_id_case'>"+l+"</span>";if(e._refreshTemplate(),bizagi.util.isNativeHeaderEnabled())bizagiapp.notifyAction(c,d,!0);else{var u=$.notifier.add({title:c,text:d,sticky:!0});$("#notifier-item-"+u+" .message_id_case").bind("click",function(t){e.openRenderCase(o),$.notifier.remove(u)})}}}).always(function(){bizagi.loading.stop()})}})},startRendering:function(e){var t=this,a=$.Deferred();return bizagi.loading.start(),$.when(t.workportalFacade.modules[t.workportalFacade.Class.render_module]).then(function(){return t.renderForm(e)}).done(function(){a.resolve()}).fail(function(){a.reject()}).always(function(){bizagi.loading.stop()}),a.promise()},openRenderCase:function(e){var t=this;bizagi.loading.start(),$.when(t.publish("render-case",e)).done(function(){bizagi.loading.stop()})},_changeButtons:function(){var e=this,t=e._form,a=t.processButton;t&&(t.processButton=function(i){var n=$.Deferred();return"cancel"===i.action?(t.endLoading(),e._back(),n.resolve()):(bizagi.loading.start(),void 0!==e._renderParams.h_surrogateKey&&(t.properties.surrogateKey=e._renderParams.h_surrogateKey),t.properties.contextType=e._renderParams.h_contexttype,t.validateForm()?$.when(a.apply(t,arguments)).then(function(){void 0===e._renderParams.h_surrogateKey&&void 0===e._renderParams.h_mapping||e._refreshTemplate(),n.resolve()}).always(function(){bizagi.loading.stop()}).fail(function(){n.reject()}):(bizagi.loading.stop(),n.reject())),n.promise()},"Form"===e._type&&t.bind("refresh",function(){bizagi.loading.stop()}))},_refreshTemplate:function(){var e=this;if(void 0!==e._origin){var t=e.homePortalFramework.accumulatedContext,a={data:t[t.length-1],filters:[],eventType:"DATA-NAVIGATION",calculateFilters:!0};e._back(),e.publish("homeportalShow",{what:e._origin,title:void 0!==a.data?a.data.displayName:"",params:a,preventNavigate:!0})}else e._back()},_back:function(){bizagi.util.autoSave().then(function(){bizagi.kendoMobileApplication.navigate("homePortal","slide:right")})}}),bizagi.workportal.webparts.webpart.extend("bizagi.workportal.webparts.stuff",{},{init:function(e,t,a){this._super(e,t,a)},postRender:function(){this.configureHandler()},configureHandler:function(){},stuffSelected:function(e){var t=this;t.homePortalFramework._cleanContext(),t.homePortalFramework.addContext(e.data),t.publish("homeportalShow",{what:"stuffTemplates",title:e.data.displayName,params:e,transition:"overlay:left"})},processMyStuff:function(e){return $.map(e,function(e){e.icon=e.icon?e.icon:null,e.image=e.image?e.image:null}),e}}),bizagi.workportal.webparts.stuff.extend("bizagi.workportal.webparts.stuff",{},{init:function(e,t,a){this._super(e,t,a)},renderContent:function(){var e=this,t=$.Deferred(),a=e.homePortalFramework.loadComponentTemplate("stuff-tmpl","stuff");return $(e.canvas).html(a),e.content=$(".bz-wp-stuff-list",e.canvas),e.content.kendoMobileListView({filterable:!1,template:e.getTemplate("stuff-item-tmpl"),click:function(t){var a=t.dataItem,i={action:a.action||null,calculateFilters:!0,data:{displayName:a.displayName,guidEntityCurrent:a.entityId,reference:a.reference,referenceType:a.referenceType,surrogateKey:a.surrogateKey,xpath:a.xpath},filters:[]};e.stuffSelected(i)}}),t.resolve(e.content),t.promise()},postRender:function(){var e=this;return e._super(),e.dataService.getMyStuff({icon:!0}).then(function(t){return e.processMyStuff(t)}).done(function(t){e.content.data("kendoMobileListView").setDataSource(t),e.configureHandler(),$(".km-content:visible").data("kendoMobileScroller")&&$(".km-content:visible").data("kendoMobileScroller").reset()})},configureHandler:function(){this._super()}}),bizagi.workportal.webparts.rendermanager.extend("bizagi.workportal.webparts.summaryActivity",{},{init:function(e,t,a){var i=this;this._super(e,t,a),i.drawerTemplate=kendo.template(i.getTemplate("summary-activity-main"),{useWithBlock:!1}),i.caseProperties={}},renderContent:function(){var e=this,t=$.Deferred();e.drawer=$("#bz-summary-activity",e.canvas).data("kendoMobileDrawer");var a=$(e.drawerTemplate({}));return e.drawer.contentElement().html(a),t.resolve(""),t.promise()},postRender:function(){this.configureHandlers()},configureHandlers:function(){var e=this;e.subscribe("show-activity-summary",function(t,a){e.drawer.show()}),e.drawer.bind("hide",function(){})}}),bizagi.workportal.webparts.summaryActivity.extend("bizagi.workportal.webparts.summaryActivity",{},{init:function(e,t,a){this._super(e,t,a)},configureHandlers:function(){var e=this;e._super(),$(".bz-menu-li",e.drawer.contentElement()).bind("click",function(t){var a=$(this).data("link");switch(a){case"overview":case"activity":console.log(a,e.caseProperties);break;case"discussion":e.navigator.navigate("#discussion-list",!0),e.publish("bz-rnd-discussion",{globalParent:e.caseProperties.idCase}),e.drawer.hide();break;case"files":e.navigator.navigate("#files-list",!0),e.publish("bz-rnd-files",{globalParent:e.caseProperties.idCase}),e.drawer.hide();break;case"plan":case"people":case"log":console.log(a,e.caseProperties);break;default:console.log("agrega el controlador para este evento")}})}}),bizagi.workportal.webparts.webpart.extend("bizagi.workportal.webparts.summaryCase",{COMMENT_SIZE:5,ADVANCED_SEARCH_ID:-1,ADVANCED_ADDITION_ID:-2,SEARCH_MIN_LENGTH:3,SEARCH_DELAY:700},{init:function(e,t,a){var i=this;i._super(e,t,a),i.initializeTemplates(),i.caseSummary=new bizagi.workportal.webparts.summaryCase.caseSummary(e,t,a),i.activitySummary=new bizagi.workportal.webparts.summaryCase.activitySummary(e,t,a),i.parentSummary=new bizagi.workportal.webparts.summaryCase.parentSummary(e,t,a),i.eventsSummary=new bizagi.workportal.webparts.summaryCase.eventsSummary(e,t,a),i.subprocessSummary=new bizagi.workportal.webparts.summaryCase.subprocessSummary(e,t,a),i.assigneesSummary=new bizagi.workportal.webparts.summaryCase.assigneesSummary(e,t,a),i.actionSummary=new bizagi.workportal.webparts.summaryCase.actionsSummary(e,t,a),i.activityPlanStateSummary=new bizagi.workportal.webparts.summaryActivityPlan.stateActivity(e,t,a),i.activityPlanProgressSummary=new bizagi.workportal.webparts.summaryActivityPlan.progressActivity(e,t,a),i.activityPlanParentSummary=new bizagi.workportal.webparts.summaryActivityPlan.parentActivity(e,t,a),i.activityPlanAssigneesSummary=new bizagi.workportal.webparts.summaryActivityPlan.assigneesActivity(e,t,a),i.planProgressSummary=new bizagi.workportal.webparts.summaryPlan.progressPlan(e,t,a),i.planTimeSummary=new bizagi.workportal.webparts.summaryPlan.timePlan(e,t,a),i.CLOSED_PLAN="CLOSED",i.dataPlan=new bizagi.workportal.webparts.summaryActivityPlan.dataPlan(e,t,a),i.templateMain=kendo.template(i.getTemplate("summary-view"),{useWithBlock:!1})},initializeTemplates:function(){var e=this,t={useWithBlock:!1};e.summaryCaseTemplateBasic=kendo.template(e.getTemplate("summary-case-basic"),t),e.summaryCaseTemplate=kendo.template(e.getTemplate("summary-case-main"),t),e.summaryCaseTemplateCaseState=kendo.template(e.getTemplate("summary-case-state"),t),e.summaryCaseTemplateAction=kendo.template(e.getTemplate("summary-case-actions"),t),e.summaryCaseTemplateActivities=kendo.template(e.getTemplate("summary-case-activities"),t),e.summaryCaseTemplateParent=kendo.template(e.getTemplate("summary-case-parent"),t),e.summaryCaseTemplateEvents=kendo.template(e.getTemplate("summary-case-events"),t),e.summaryCaseTemplateSubprocess=kendo.template(e.getTemplate("summary-case-subprocess"),t),e.summaryCaseTemplateAssigness=kendo.template(e.getTemplate("summary-case-assignees"),t),e.summaryCaseTemplateActivityPlanState=kendo.template(e.getTemplate("summary-plan-state-activity"),t),e.summaryCaseTemplateActivityPlanProgress=kendo.template(e.getTemplate("summary-plan-progress-activity"),t),e.summaryCaseTemplateActivityPlanParent=kendo.template(e.getTemplate("summary-plan-parent-activity"),t),e.summaryPlanTemplatePlanState=kendo.template(e.getTemplate("project-plan-state"),t),e.summaryPlanTemplatePlanProgress=kendo.template(e.getTemplate("project-plan-progress"),t),e.summaryPlanTemplatePlanTime=kendo.template(e.getTemplate("project-plan-time"),t),e.summaryPlanTemplatePlanParent=kendo.template(e.getTemplate("project-plan-parent"),t)},postRender:function(e){this.configureHandlers()},configureHandlers:function(){var e=this;bizagi.webpart.subscribe("bz-summary-case",function(t,a){return e.renderSummary(a)}),bizagi.webpart.subscribe("onLoadDataItemsFromFormActivityPlan",function(t,a){var i=e.calculateActivityProgressColorBar(a.activityWork);a.dataActivityProgress={progress:{canEdit:0===a.items.length,progress:a.activityWork},valuePercentBarComplete:a.activityWork,colorBar:i},e.updateActivityProgress(a)})},release:function(e){var t=this,a=new $.Deferred,i=[{label:t.getResource("workportal-widget-dialog-box-release-ok"),action:"resolve"},{label:t.getResource("workportal-widget-dialog-box-release-cancel")}];return $.when(bizagi.showConfirmationBox(t.getResource("workportal-widget-dialog-box-release"),t.getResource("render-actions-release"),"",i)).done(function(){bizagi.loading.start(),$.when(t.dataService.releaseActivity({idCase:e.idCase,idWorkItem:e.idWorkitem})).done(function(i){switch(i&&i.status?i.status:"Error"){case"Success":bizagi.util.isNativePluginSupported()&&bizagi.util.isiOSSmartphoneDevice()?bizagiapp.showHomePortal():bizagi.kendoMobileApplication.navigate("homePortal");break;case"ConfigurationError":bizagi.showMessageBox(t.getResource("workportal-widget-dialog-box-release-configuration-error-message").replace("{0}",e.idWorkitem),t.getResource("workportal-widget-dialog-box-release-error"),"error",!1);break;case"Error":default:bizagi.showMessageBox(t.getResource("workportal-widget-dialog-box-release-error-message").replace("{0}",e.idWorkitem),t.getResource("workportal-widget-dialog-box-release-error"),"error",!1)}bizagi.loading.stop(),a.resolve()}).fail(function(){var i=t.getResource("workportal-widget-dialog-box-release-error-message").replace("{0}",e.idWorkitem)
;bizagi.showMessageBox(i,t.getResource("workportal-widget-dialog-box-release-error"),"error",!1),bizagi.loading.stop(),a.reject()})}),a.promise()},renderBasicSummaryCase:function(e){var t=this,a=$(bizagi.util.trim(t.summaryCaseTemplateBasic(e)));t.data.isOfflineForm||e.countEvents>0&&$.when(t.loadCaseEvents()).done(function(e){$("#summaryCaseBasic .summary-basic-events",t.content).append(e)}).fail(function(){t.hideSummaryElement("#summaryCaseBasic .summary-basic-events")}),$(".widget-right-sidebar",t.content).css("display","none"),$("#summaryCaseBasic",t.content).append(a)},renderSummaryCase:function(){var e=this,t="";e.data=e.data||{},e.data.caseDetails.plan?(e.data.caseDetails.isActivitySummary?e.showActivityPlanSummary():e.showPlanSummary(),$.when(e.activityPlanAssigneesSummary.getActivityAssignees(e.data)).done(function(a){e.assignees=a.assignees,t=$(bizagi.util.trim(e.summaryCaseTemplateAssigness(e.assignees))),e.showSummaryElement("#assigneesContent",t),e.callGetDataUsers(a.cvsUsers).then(function(){e.renderUserProfilesAndImages()})}).fail(function(){e.hideSummaryElement("#assigneesContent")}),e.hideSummaryElement("#eventsContent"),e.hideSummaryElement("#subProcessContent")):e.showCaseSummary()},showActivityPlanSummary:function(){var e=this,t="";$.when(e.activityPlanStateSummary.getActivityPlanStateData(e.data)).done(function(t){e.data.dataActivityPlanState=t,e.updateActivityState(e.data)}).fail(function(){e.hideSummaryElement("#caseStateContent")}),$.when(e.activityPlanProgressSummary.getActivityProgress(e.data)).done(function(t){e.data.dataActivityProgress=t,e.updateActivityProgress(e.data)}).fail(function(){e.hideSummaryElement("#activityStateContent")}),$.when(e.activityPlanParentSummary.getActivityParent(e.data)).done(function(a){e.data.dataActivityParent=a,t=$(bizagi.util.trim(e.summaryCaseTemplateActivityPlanParent(e.data))),e.showSummaryElement("#parentProcessContent",t)}).fail(function(){e.hideSummaryElement("#parentProcessContent")}),$.when(e.actionSummary.getActionsData(e.data)).done(function(a){t=$(bizagi.util.trim(e.summaryCaseTemplateAction(a))),e.configureEditAcitivyHandler(t),e.showSummaryElement("#actionsContent",t)}).fail(function(){e.hideSummaryElement("#actionsContent")}),e.hideSummaryElement("#planProgressContent"),e.hideSummaryElement("#planTimeContent"),e.hideSummaryElement("#planParentContent"),e.hideSummaryElement("#planStateContent")},showPlanSummary:function(){var e=this,t="";e.showPlanState(),$.when(e.planProgressSummary.getPlanProgressData(e.data)).done(function(a){e.data.dataPlanProgress=a,t=$(bizagi.util.trim(e.summaryPlanTemplatePlanProgress(e.data))),e.showSummaryElement("#planProgressContent",t)}).fail(function(){e.hideSummaryElement("#planProgressContent")}),$.when(e.planTimeSummary.getPlanTimeData(e.data)).done(function(a){"thereArentDueDate"===a?e.hideSummaryElement("#planTimeContent"):(e.data.dataPlanTime=a,t=$(bizagi.util.trim(e.summaryPlanTemplatePlanTime(e.data))),e.showSummaryElement("#planTimeContent",t))}).fail(function(){e.hideSummaryElement("#planTimeContent")}),e.getPlanParentData(e.data).done(function(a){a?(e.data.dataPlanParent=a,t=$(bizagi.util.trim(e.summaryPlanTemplatePlanParent(e.data))),e.showSummaryElement("#planParentContent",t)):e.hideSummaryElement("#planParentContent")}).fail(function(){e.hideSummaryElement("#planParentContent")}),e.hideSummaryElement("#caseStateContent"),e.hideSummaryElement("#activityStateContent"),e.hideSummaryElement("#parentProcessContent"),e.hideSummaryElement("#actionsContent")},showCaseSummary:function(){var e=this,t="";e.hideSummaryElement("#actionsContent"),e.hideSummaryElement("#planParentContent"),e.hideSummaryElement("#planStateContent"),e.hideSummaryElement("#planTimeContent"),e.hideSummaryElement("#planProgressContent"),$.when(e.caseSummary.getCaseData(e.data)).done(function(a){e.data.dataCaseState=a,t=$(bizagi.util.trim(e.summaryCaseTemplateCaseState(e.data))),e.setActivitiesHandler(t),e.showSummaryElement("#caseStateContent",t)}).fail(function(){e.hideSummaryElement("#caseStateContent")}),!0!==e.data.isEvent&&$.when(e.activitySummary.getActivitiesData(e.data)).then(function(a){e.data.dataActivityState=a,t=$(bizagi.util.trim(e.summaryCaseTemplateActivities(e.data))),e.showSummaryElement("#activityStateContent",t)}).fail(function(){e.hideSummaryElement("#activityStateContent")}),$.when(e.parentSummary.getParentData(e.data)).done(function(a){t=$(bizagi.util.trim(e.summaryCaseTemplateParent(e.data))),e.showSummaryElement("#parentProcessContent",t)}).fail(function(){e.hideSummaryElement("#parentProcessContent")}),$.when(e.loadCaseEvents()).done(function(t){e.showSummaryElement("#eventsContent",t)}).fail(function(){e.hideSummaryElement("#eventsContent")}),$.when(e.subprocessSummary.getSubprocessData(e.data)).done(function(a){e.data.dataSubProcess=a,t=$(bizagi.util.trim(e.summaryCaseTemplateSubprocess(e.data))),e.showSummaryElement("#subProcessContent",t)}).fail(function(){e.hideSummaryElement("#subProcessContent")}),$.when(e.assigneesSummary.getAssigneesData(e.data)).done(function(a){e.assignees=e.data.caseDetails.assigneesUsers,t=$(bizagi.util.trim(e.summaryCaseTemplateAssigness(e.assignees))),e.showSummaryElement("#assigneesContent",t),e.callGetDataUsers(a).then(function(){e.renderUserProfilesAndImages()})}).fail(function(){e.hideSummaryElement("#assigneesContent")})},loadCaseEvents:function(){var e=this,t=new $.Deferred,a="";return bizagi.loading.start(),$.when(e.eventsSummary.getEventsData(e.data)).done(function(i){e.data.dataEvents=i,a=$(bizagi.util.trim(e.summaryCaseTemplateEvents(e.data))),t.resolve(a)}).fail(function(){t.reject()}).always(function(){bizagi.loading.stop()}),t.promise()},hideSummaryElement:function(e){var t=this;$(e,t.content).hide()},showSummaryElement:function(e,t){var a=this;$(e,a.content).empty(),t.length>0?$(e,a.content).append(t):a.hideSummaryElement(e)},configureSummaryHeaderHandlers:function(e){var t=this;$(".bz-summary-back",e.element).bind("click",function(e){e.stopImmediatePropagation(),t.pane.navigate("#:back")})},updateActivityState:function(e){var t=this,a=$(bizagi.util.trim(t.summaryCaseTemplateActivityPlanState(e)));t.updateProgressActivityState(a),t.showSummaryElement("#caseStateContent",a)},updateActivityProgress:function(e){var t=this,a=$(bizagi.util.trim(t.summaryCaseTemplateActivityPlanProgress(e)));t.updateProgressUI(e.dataActivityProgress.valuePercentBarComplete,a),t.configureActivityProgressHandlers(a),t.showSummaryElement("#activityStateContent",a)},configureActivityProgressHandlers:function(e){var t=this;$(".edit-activity-progress",e).bind("click",function(e){var a=t.getTemplate("progress-bar-kendo-tmpl"),i=kendo.template(a,{useWithBlock:!1});t.modalView=$(i({})),t.modalView.kendoMobileModalView({close:function(e){this.destroy(),this.element.remove()}}),t.configureModalViewHandlers(),t.modalView.kendoMobileModalView("open")})},configureModalViewHandlers:function(){var e=this;$("#modalview-filter","body").delegate(".ui-bizagi-cancel-new-progress","click",function(e){$("#modalview-filter","body").data("kendoMobileModalView").close()}),$("#modalview-filter","body").delegate(".ui-bizagi-apply-new-progress","click",function(t){var a=parseInt($(".ui-bizagi-wp-project-plan-manual-progress-activity-wrapper .output-input-manual-progress").text().slice(0,-1));$.when(e.activityPlanProgressSummary.onSubmitFormChangeProgress(t,e.data,a)).done(function(t){var i=e.calculateActivityProgressColorBar(a);t.dataActivityProgress={progress:{canEdit:0===t.items.length,progress:a},valuePercentBarComplete:a,colorBar:i},e.updateActivityProgress(t),bizagi.util.setItemLocalStorage("newChanges",JSON.stringify({hasChanges:!0,idActivity:t.id,itemsResolved:0,items:t.items,progress:a})),$("#modalview-filter","body").data("kendoMobileModalView").close()})}),$(".manual-progress-input-range","body").bind("change",function(e){$(".ui-bizagi-wp-project-plan-manual-progress-activity-wrapper .output-input-manual-progress").text(this.value+"%")});var t=$("#activityStateContent .days","body")[0].textContent;$(".ui-bizagi-wp-project-plan-manual-progress-activity-wrapper .output-input-manual-progress").text(t+"%"),$("input.manual-progress-input-range","body").attr({value:t})},calculateActivityProgressColorBar:function(e){return e<=33?"Red":e<=66?"Yellow":"Green"},setActivitiesHandler:function(e){var t=this;$(".bz-wp-summary-release",e).bind("click",function(e){var a={};t.data&&t.data.idCase?a.idCase=t.data.idCase:t.data.caseDetails&&t.data.caseDetails.idCase&&(a.idCase=t.data.caseDetails.idCase),t.data&&t.data.idWorkitem?a.idWorkitem=t.data.idWorkitem:t.data.caseDetails&&t.data.caseDetails.idWorkitem&&(a.idWorkitem=t.data.caseDetails.idWorkitem),t.release(a)}),$(".case-summary-favorite",e).bind("click",function(e){t.onClickFavorite(e)})},onClickFavorite:function(e){e.preventDefault();var t=this,a=t.data||t.data.params,i={};$(e.target).hasClass("bz-favorites")?(i={idObject:a.caseDetails.idCase,favoriteType:"CASES"},$.when(t.dataService.addFavorite(i)).done(function(a){t.data.caseDetails.guidFavorite=a.idFavorites,$(e.target).removeClass("bz-favorites"),$(e.target).addClass("bz-favorites-full")})):(i={idObject:a.caseDetails.guidFavorite,favoriteType:"CASES"},$.when(t.dataService.delFavorite(i)).done(function(){$(e.target).removeClass("bz-favorites-full"),$(e.target).addClass("bz-favorites")}))},getPlanParentData:function(e){var t=this,a=new $.Deferred;return $.when(t.dataService.getPlanParent({idPlan:e.plan.id})).done(function(t){if(e.plan.parent=t,e.plan.parent){var i={idParent:e.plan.parent.radNumber,nameParent:e.plan.parent.displayName,idCase:e.plan.parent.idCase,idWorkflow:e.plan.parent.idWorkflow,idWorkItem:e.plan.parent.idWorkItem,idTask:e.plan.parent.idTask};a.resolve(i)}else a.resolve(void 0)}).fail(function(e){a.reject()}),a.promise()},showPlanState:function(e){var t=this;t.data.dataShowPlanState=!0;var a=$(bizagi.util.trim(t.summaryPlanTemplatePlanState(t.data)));t.showSummaryElement("#planStateContent",a)},configureEditAcitivyHandler:function(e){var t=this;$(".edit-activity-button",e).bind("click",function(e){$(".project-popupform-edit-activity-wrapper",t.canvas).length,t.showEditActivityForm(e),t.hideSummaryDrawer()})},showEditActivityForm:function(e){var t=this;t.initViewFile(),t.renderEdition()},initViewFile:function(){var e=this;if(e.params={title:bizagi.localization.getResource("workportal-project-plan-title-activity-properties")},e.editionView)$("#render-content",e.editionView.content).empty();else{var t=$($.kendoTmpl(e.getTemplate("edit-activity-view"),e.params));$("#paneRender").append(t),e.editionView=new kendo.mobile.ui.View(t,{useNativeScrolling:!0})}e.pane=e.pane||$("#paneRender").data("kendoMobilePane"),e.view&&e.view.element.hide("slide",{direction:"left"},300),e.editionView.element.hide(0).show("slide",{direction:"right"},300,function(){$(this).css("display","block"),e.pane.navigate(e.editionView.id),e.configureEditViewHandlers()})},renderEdition:function(){var e=this;e.inputEdition=kendo.template(e.getTemplate("edit-activity-preview-tmpl"),{useWithBlock:!1});var t=e.data.caseDetails.currentState[0].idActivity,a=e.data.caseDetails.plan.activities.filter(function(e){return e.id===t})[0],i={finishDate:a.estimatedFinishDate||null,duration:a.duration||null},n=e.inputEdition(i);$("#render-content",e.editionView.content).append(n),e.configureView(e.editionView.content,i),e.configureEditFormHandlers()},configureView:function(e,t){var a=this;t.duration?($(".edit-activity-clear-button.clear-end-date",e).hide(),$(".edit-activity-clear-button.clear-duration",e).show(),$("input.bz-rn-text-edit-activity.bz-rn-finish-date",e).prop("disabled",!0),$("input.bz-rn-text-edit-activity.bz-rn-numeric",e).prop("disabled",!1),$("input.bz-rn-text-edit-activity.bz-rn-numeric",e).val(t.duration)):t.finishDate?($(".edit-activity-clear-button.clear-duration",e).hide(),$(".edit-activity-clear-button.clear-end-date",e).show(),$("input.bz-rn-text-edit-activity.bz-rn-finish-date",e).prop("disabled",!1),$("input.bz-rn-text-edit-activity.bz-rn-numeric",e).prop("disabled",!0),a.setDisplayValue(new Date(t.finishDate),e),a.configureMobiscrollPlugin(e,t)):($(".edit-activity-clear-button.clear-duration",e).hide(),$(".edit-activity-clear-button.clear-end-date",e).hide(),$("input.bz-rn-text-edit-activity.bz-rn-finish-date",e).prop("disabled",!1),$("input.bz-rn-text-edit-activity.bz-rn-numeric",e).prop("disabled",!1),$("input.bz-rn-text-edit-activity.bz-rn-numeric",e).val(""),$("input.bz-rn-text-edit-activity.bz-rn-finish-date",e).val(""),a.configureMobiscrollPlugin(e,t))},configureMobiscrollPlugin:function(e,t){var a=this,i=t.finishDate?new Date(t.finishDate):new Date;$("input.bz-rn-text-edit-activity.bz-rn-finish-date",e).mobiscroll().calendar({mode:"mixed",display:"bottom",controls:["calendar"],defaultValue:i,lang:bizagi.util.languages[BIZAGI_LANGUAGE]||"en",dateFormat:"MM-dd-yyyy",buttons:["set",{text:bizagi.localization.getResource("render-plugin-search-users-clear-button-name"),handler:function(e,t){a.onChangeHandler(!0),t.hide()}},"cancel"],onSet:function(e,t){a.date=e.valueText,a.onChangeHandler(!1)}})},onChangeHandler:function(e){var t=this;if(e){$("input.bz-rn-text-edit-activity.bz-rn-finish-date",t.editionView.content).val("");var a={finishDate:null,duration:null};t.configureView(t.editionView.content,a)}else{var i=t.date.split("-");$("input.bz-rn-text-edit-activity.bz-rn-finish-date",t.editionView.content).val(i[1]+"/"+i[0]+"/"+i[2])}},configureEditFormHandlers:function(){var e=this;$("#activity-form-assignee",e.editionView.content).bind("click",function(t){e.initAutoCompletePlugin(t)}),$(".ui-bizagi-wp-project-popupform-action-update",e.editionView.content).bind("click",function(t){var a=$("input.bz-rn-text-edit-activity.bz-rn-numeric",e.editionView.content).val(),i=$("input.bz-rn-text-edit-activity.bz-rn-finish-date",e.editionView.content).val();""===a&&""===i||e.updateActivityPlan(a,e.date,t)}),$(".edit-activity-clear-button.clear-end-date",e.editionView.content).bind("click",function(t){e.configureView(e.editionView.content,{duration:void 0,finishDate:void 0})}),$("input.bz-rn-text-edit-activity.bz-rn-finish-date",e.editionView.content).change(function(){var t=$(this).val();""!==t?e.configureView(e.editionView.content,{duration:void 0,finishDate:t}):e.configureView(e.editionView.content,{duration:void 0,finishDate:void 0})}),$(".edit-activity-clear-button.clear-duration",e.editionView.content).bind("click",function(t){e.configureView(e.editionView.content,{duration:void 0,finishDate:void 0})}),$("input.bz-rn-text-edit-activity.bz-rn-numeric",e.editionView.content).keyup(function(){var t=$(this).val();""!==t?e.configureView(e.editionView.content,{duration:t,finishDate:void 0}):e.configureView(e.editionView.content,{duration:void 0,finishDate:void 0})})},setDisplayValue:function(e,t){var a=this,i=a.properties||{};i.dateFormat="dd/MMMM/yyyy";var n=bizagi.util.dateFormatter.formatDate(e,i.dateFormat);$("input.bz-rn-text-edit-activity.bz-rn-finish-date",t).prop("min",n),$("input.bz-rn-text-edit-activity.bz-rn-finish-date",t).val(n)},initAutoCompletePlugin:function(){return this.onSelectAssignee()},onSelectAssignee:function(e){this.formEditActivity.assignee.element.data("id",1)},updateActivityPlan:function(e,t,a){var i=this,n=i.data.caseDetails.currentState[0].idActivity,r=i.data.caseDetails.plan.activities.filter(function(e){return e.id===n})[0],o=bizagi.currentUser.idUser,s=t?new Date(t):void 0,l={progress:r.progress,id:r.id,startDate:r.startDate,duration:e?parseInt(e):void 0,userAssigned:o,allowEdition:r.allowEdition,description:r.description,name:r.name,idPlan:r.idPlan,estimatedFinishDate:s?s.getTime():void 0,finishDate:r.finishDate},c={items:r.items,activity:l};$.when(i.callUpdateActivity(c)).done(function(){r=$.extend(r,l),$.when(i.dataPlan.getPlanData(i.data)).then(function(e){i.data.caseDetails.plan=e,$.when(i.activityPlanStateSummary.getActivityPlanStateData(i.data)).done(function(e){i.data.dataActivityPlanState=e,i.updateActivityState(i.data),i.goBack(),i.posNavigate()})})})},callUpdateActivity:function(e){var t=this,a=new $.Deferred;return $.when(t.dataService.editActivityPlan(e)).done(function(){a.resolve()}).always(function(e,t,a){a.status}),a.promise()},configureEditViewHandlers:function(){var e=this;$(".bz-render-back",e.editionView.element).off(e.Class.BIZAGI_TAP_EVENT).on(e.Class.BIZAGI_TAP_EVENT,function(){e.goBack(),e.posNavigate()})},posNavigate:function(){var e=this;e.editionView.element.show(0).hide("slide",{direction:"right"},300),e.view&&e.view.element.hide(0).show("slide",{direction:"left"},300,function(){$(this).css("display","block")})},goBack:function(){this.pane.navigate("#:back")},routingExecute:function(e){var t=this,a=new $.Deferred;if(e){var i=e.data("case")||t.params.idCase,n=e.data("workitem")||"",r=e.data("task")||"",o=e.data("displayname")||t.params.displayName,s=bizagi.util.parseBoolean(e.data("eventastasks"));t.hideSummaryDrawer(),setTimeout(function(){t.publish("changeCase",{idCase:i,idWorkitem:n,idTask:r,displayName:o,isSummaryModal:!0,isEvent:s}),a.resolve(!0)},500)}else a.resolve(!1);return a.promise()},callGetDataUsers:function(e){var t=this,a=$.Deferred(),i={userIds:e,width:50,height:50};return t.dataService.getUsersData(i).always(function(e){for(var i=t.assignees,n=0,r=i.length;n<r;n++)for(var o=0,s=e.length;o<s;o++)i[n].idUser==e[o].id&&(i[n].picture=e[o].picture?"data:image/png;base64,"+e[o].picture:void 0);a.resolve()}),a.promise()},renderUserProfilesAndImages:function(){for(var e=this,t=e.assignees,a=0,i=t.length;a<i;a++)t[a].picture&&$("li[data-iduser='"+t[a].idUser+"'] img",e.content).attr("src",t[a].picture)},updateProgressUI:function(e,t){$(".remaining-days .days",t).text(e);$(".remaining-days .time-remaining",t);$(".remaining-days .bar-completed",t).css("width",e.toString()+"%")},updateProgressActivityState:function(e){var t=this;$(".remaining-days .time-remaining",e).css("padding-left","1px"),$(".remaining-days .bar-completed",e).css("width",t.data.dataActivityPlanState.percentBar+"%")},callUpdatePlan:function(e){var t=this;return $.when(t.dataService.updatePlan(e)).done(function(){$.extend(t.params.plan,e)})}}),bizagi.workportal.webparts.summaryCase.extend("bizagi.workportal.webparts.summaryCase",{},{init:function(e,t,a){this._super(e,t,a)},hideSummaryDrawer:function(){},renderSummary:function(e){var t=this,a=new $.Deferred;t.params=e||{},t.cache={};var i=e.isOfflineForm||!bizagi.util.isVersionSupported(),n=void 0!==t.params.caseDetails.estimatedSolutionDate?t.params.caseDetails.estimatedSolutionDate:t.params.caseDetails.solutionDate;if(i&&(n=n||t.params.caseDetails.creationDate),e.isOfflineForm){var r=t.params.caseDetails.radNumber;t.params.caseDetails.caseNumber=r||t.params.idCase,void 0===t.params.caseDetails.params&&(t.params.caseDetails.params={displayName:e.displayName})}t.data=t.params;var o=t.summaryCaseTemplate(t.data);if(t.createSummaryView(o),i){var s=new Date(t.data.caseDetails.creationDate),l=t.getResource("dateFormat")+" "+t.getResource("timeFormat"),c=bizagi.util.dateFormatter.formatDate(s,l),d=$.extend({},t.data.caseDetails);d.creationDate=c,$("#summary-case").addClass("basic-summary"),t.renderBasicSummaryCase(d)}else $("#summaryCaseBasic",t.content).hide(),bizagi.util.isEmpty(t.data.caseDetails.idPlan)?(t.renderSummaryCase(),a.resolve()):$.when(t.dataPlan.getPlanData(t.data)).then(function(e){t.data.caseDetails.plan=e,t.renderSummaryCase()}).always(function(){a.resolve()});return t.data.currentState&&t.data.currentState.length>0&&void 0!==t.data.currentState[0].allowReleaseActivity&&t.data.currentState[0].allowReleaseActivity&&$(".bz-wp-summary-release",t.content).bind("click",function(){t.release(e)}),a.promise()},createSummaryView:function(e){var t=this;if(t.params={title:t.getResource("workportal-taskfeed-summary")},t.view)$("#render-content",t.view.content).empty();else{var a=$($.kendoTmpl(t.getTemplate("summary-view"),t.params));$("#paneRender").append(a),t.view=new kendo.mobile.ui.View(a,{useNativeScrolling:!0})}t.pane=t.pane||$("#paneRender").data("kendoMobilePane"),t.view.element.hide(0).show("slide",{direction:"right"},300,function(){$(this).css("display","block"),t.pane.navigate(t.view.id),t.configureViewHandlers()}),$("#render-content",t.view.content).append(e)},configureViewHandlers:function(){var e=this;$(".bz-render-back",e.view.element).off(e.Class.BIZAGI_TAP_EVENT).on(e.Class.BIZAGI_TAP_EVENT,function(){e.goBack(),e.view.element.show(0).hide("slide",{direction:"right"},300)}),e.view.element.off("click").on("click",".summaryLink",function(t){t.preventDefault(),e.routingExecute($(this)),e.cache={}})}}),function(e){e.fn.bztabs=function(t){function a(){t.tabNumber<l?(e(".bz-wp-tabs-arrow-container",r).first().addClass("show-pluss"),c.addClass("show-pluss"),m.trigger("click",{origin:"popUp"})):(e(".bz-wp-tabs-arrow-container",r).first().removeClass("show-pluss"),c.removeClass("show-pluss"),c.find("> .bz-wp-tabs-ui:last").addClass("bz-wp-no-border"))}function i(e){var t=c.find(".bz-wp-tabs-ui"),a=!0;t.each(function(t,i){e!==i.getAttribute("data-reference-tab")&&a?(c.remove("[data-reference-tab='"+e+"']"),c.append(i)):a=!1})}function n(t,a){if(a=a||{},a.origin=a.origin||"header",t.stopPropagation(),t.preventDefault(),!e(this).hasClass("tabSelected")||"popUp"===a.origin){var n=t.currentTarget.getAttribute("data-reference-tab"),l=e(n,r);m=e(t.currentTarget),r.find(">div.childrenActive").removeClass("childrenActive"),l.addClass("childrenActive"),c.find(">div.tabSelected").removeClass("tabSelected").css("width",u+"%"),"block"===s.css("display")&&s.toggle(),a.origin&&"popUp"===a.origin&&(m=e("[data-reference-tab='"+n+"']",c),i(n)),m.addClass("tabSelected").css("width",f+"%"),o(t,a)}}var r=e(this);t=t||{},t.activeTab=t.activeTab||0,t.tabNumber=t.tabNumber||1;var o=t.activate&&"function"==typeof t.activate?t.activate:function(){},s=(t.beforeActivate&&"function"==typeof t.beforeActivate&&t.beforeActivate,r.find(">div.bz-bizagi-container-tap-popup").hide()),l=s.children().length,c=e("<div class='bz-header_select'></div>"),d=t.tabNumber>l?l:t.tabNumber,u=Math.floor(100/Number(d));s.children().each(function(e,t){c.append("<div class='bz-wp-tabs-ui bz-wp-tabs-item' data-index='"+e+"' data-reference-tab='"+t.getAttribute("data-reference-tab")+"'><span>"+t.textContent+"</span></div>")}),c.find("> .bz-wp-tabs-ui").css("width",u+"%"),c.append("<div class='bz-wp-tabs-arrow-container'><div class='bz-cm-icon bz-mo-icon bz-plus'></div></div>"),r.prepend(c);var p=r.find("> .bz-bizagi-container-tap-popup > .bz-container-items-tabs").eq(t.activeTab);e(e(p).data("reference-tab"),r).addClass("childrenActive"),p.addClass("tabSelected");var m=e(".bz-wp-tabs-ui:nth-child("+(t.activeTab+1)+")",c).addClass("tabSelected"),f=u+(100-u*d);m.css("width",f+"%"),void 0!==t.domIncluded?e.when(t.domIncluded).done(function(){a()}):a(),r.find(".bz-wp-tabs-arrow-container").first().bind("click",function(t){var a=c.innerWidth()-29,i=0;e(".bz-container-items-tabs",s).removeClass("show"),c.find(".bz-wp-tabs-ui").each(function(t,n){(i+=e(":first-child",n).outerWidth())>a&&s.children().each(function(t,a){if(a.textContent===n.textContent)return e(a).addClass("show"),e(".cell.bz-container-items-tabs").css("border-bottom",""),void e(".cell.bz-container-items-tabs.show").last().css("border-bottom","none")})}),t.stopPropagation(),t.preventDefault(),s.toggle()}),e(">div.cell",s).bind("click",function(e){n(e,{origin:"popUp"})}),e(".bz-wp-tabs-ui",c).bind("click",n),c.bind("resizeHeader",function(){a()})}}(jQuery),$.Class.extend("bizagi.workportal.webparts.summaryCase.activitySummary",{},{init:function(e,t,a){var i=this;i.canvas=a.canvas,i.dataService=t,i.workportalFacade=e,i.datePickerRegional=bizagi.localization.getResource("datePickerRegional")},getActivitiesData:function(e){var t=new $.Deferred,a=this,i=e;a.data=e,a.params=i;var n={},r=i.caseDetails.currentState.filter(function(e){return e.idWorkItem==a.params.idWorkitem})[0];if(r){n.activityName=r.state,n.activityIsEvent=bizagi.util.parseBoolean(r.isEvent);var o=bizagi.util.dateFormatter.getDateFromFormat(r.entryDateWorkItem,"MM/dd/yyyy H:mm");o.getTime&&(n.initDateFormat=a.getFormattedDate(o));var s=new Date,l=bizagi.util.dateFormatter.getDateFromFormat(r.estimatedSolutionDate,"MM/dd/yyyy H:mm");n.estimatedSolutionDateFormat="",o.getTime&&l.getTime&&r?$.when(a.calculateDataForActivityState(r,n,o,s,l)).done(function(){t.resolve(n)}):t.resolve(n)}else t.resolve("No WorkItems");return t.promise()},calculateDataForActivityState:function(e,t,a,i,n){var r=new $.Deferred,o=this,s=(new Date(Date.now()-a.getTime()),i.getTime()-n.getTime()),l=a.getTime()-n.getTime(),c={idUser:bizagi.currentUser.idUser,fromDate:a.getTime(),toDate:Date.now()},d=!1,u={idUser:bizagi.currentUser.idUser,fromDate:i.getTime(),toDate:n.getTime()},p={};return s>0?(u.fromDate=n.getTime(),u.toDate=i.getTime(),d=!0):(p.idUser=bizagi.currentUser.idUser,p.fromDate=a.getTime(),p.toDate=n.getTime()),$.when(o.callGetEffectiveDuration(c),o.callGetEffectiveDuration(u),o.callGetEffectiveDuration(p)).done(function(a,i,s){var c=bizagi.util.dateFormatter.getRelativeTime(new Date(Date.now()-6e4*a.minutes),null,!0);if(t.colorState=e.colorState,t.relativeTimeState=bizagi.localization.getResource("workportal-project-activity-state-opened").replace("%s",c),t.percentCompleteBar=100,0===l)t.showEstimatedSolutionDate=!1;else if(t.showEstimatedSolutionDate=!0,!1===d){var u=o.getPercentBar(s.minutes,i.minutes);t.percentCompleteBar=u.percent}e&&(t.isEvent=bizagi.util.parseBoolean(e.isEvent)),t.estimatedSolutionDateFormat=o.getFormattedDate(n),r.resolve()}),r.promise()},getFormattedDate:function(e){return this.datePickerRegional.monthNames[e.getMonth()]+" "+kendo.toString(e,"dd")},callGetEffectiveDuration:function(e){var t=this,a=$.Deferred();return e.fromDate?$.when(t.dataService.getEffectiveDuration(e)).done(function(e){a.resolve(e)}):a.resolve(null),a.promise()},getPercentBar:function(e,t){var a={};return a.percent=Math.round(100*(1-t/e)),a}}),$.Class.extend("bizagi.workportal.webparts.summaryCase.assigneesSummary",{},{init:function(e,t,a){var i=this;i.canvas=a.canvas,i.dataService=t,i.workportalFacade=e},getAssigneesData:function(e){var t=this,a=e,i=new $.Deferred;return t.data=e,t.params=a,$.when(t.getDataUsersAssignedAndOwner(a)).done(function(e){var n=$.map(e,function(e){return e.idUser}),r=n.join(",");t.users=e;var o,s={},l=[];$.each(e,function(e,a){$.each(t.users,function(e,t){t.idUser==a.idUser&&(o?o.types.indexOf(t.typeUser)<0&&(o.types+=", "+t.typeUser):o={types:a.typeUser})}),s[a.idUser]||(s[a.idUser]=!0,a.types=o.types,l.push(a)),o=void 0}),a.caseDetails.assigneesUsers=l,i.resolve(r)}).fail(function(){i.reject()}),i.promise()},getDataUsersAssignedAndOwner:function(e){var t=this,a=$.Deferred();return $.when(t.getDataUsersAssigned(e),t.getDataUserOwner(e)).done(function(e,t){e.splice(0,0,t),a.resolve(e)}),a.promise()},getDataUsersAssigned:function(e){var t=this,a=$.Deferred(),i=[];return e.caseDetails.countAssigness>0?$.when(t.callGetCaseAssignees(e.caseDetails.idCase)).done(function(e){if(e.assignees)for(var t=0;t<e.assignees.length;t++)i.push({idUser:e.assignees[t].idUser||-1,name:e.assignees[t].Name,isEvent:e.assignees[t].isEvent,typeUser:bizagi.localization.getResource("workportal-project-user-assigned"),taskName:e.assignees[t].taskName});a.resolve(i)}):a.resolve(i),a.promise()},getDataUserOwner:function(e){var t=$.Deferred();return t.resolve({idUser:e.caseDetails.createdBy.userId||-1,name:e.caseDetails.createdBy.Name,typeUser:bizagi.localization.getResource("workportal-project-user-owner")}),t.promise()},callGetCaseAssignees:function(e){var t=this,a=$.Deferred();return $.when(t.dataService.getCaseAssignees({idCase:e})).done(function(e){a.resolve(e)}),a.promise()}}),$.Class.extend("bizagi.workportal.webparts.summaryCase.caseSummary",{},{init:function(e,t,a){var i=this;i.canvas=a.canvas,i.dataService=t,i.workportalFacade=e,i.datePickerRegional=bizagi.localization.getResource("datePickerRegional")},getCaseData:function(e){var t=this,a=new $.Deferred;t.data=e;var i=e,n={};n.isFavoriteCase="off",n.currentState=e.caseDetails.currentState,JSON.parse(i.caseDetails.isFavorite)?n.isFavoriteCase="bz-favorites-full":n.isFavoriteCase="bz-favorites";var r=bizagi.util.dateFormatter.getDateFromFormat(i.caseDetails.creationDate,"MM/dd/yyyy H:mm");n.creationDateFormat=t.getFormattedDate(r);var o=bizagi.util.dateFormatter.getDateFromFormat(i.caseDetails.solutionDate,"MM/dd/yyyy H:mm");n.solutionDateFormat=t.getFormattedDate(o);var s=new Date,l=!(!t.data||!t.data.caseDetails)&&t.data.caseDetails.isOpen;return $.when(t.calculateDataForCaseState(n,r,s,o,l)).done(function(i){if(bizagi.util.isCaseSummaryTaskOptionsSupported()&&void 0!=e.idWorkitem&&e.idWorkitem>0)return $.when(t.callGetSummaryCaseTaskOptions(e)).done(function(e){i.allowReleaseEnabled=e.allowRelease||!1}).always(function(){a.resolve(i)});a.resolve(i)}).fail(function(e){a.reject(e)}),a.promise()},getFormattedDate:function(e){return this.datePickerRegional.monthNames[e.getMonth()]+" "+kendo.toString(e,"dd")},calculateDataForCaseState:function(e,t,a,i,n){var r=this,o=new $.Deferred,s=e;n=bizagi.util.parseBoolean(n)||!1;var l={};return l.idUser=bizagi.currentUser.idUser,n?(l.fromDate=t.getTime(),l.toDate=a.getTime()):(l.fromDate=i.getTime(),l.toDate=a.getTime()),$.when(r.callGetEffectiveDuration(l)).done(function(e){var t=bizagi.util.dateFormatter.getRelativeTime(new Date(Date.now()-6e4*e.minutes),null,!1);if(n?(s.relativeTimeState=bizagi.localization.getResource("workportal-project-case-state-opened").replace("%s",t),s.colorStateCase="Opened"):(s.relativeTimeState=bizagi.localization.getResource("workportal-project-case-state-closed").replace("%s",t),s.colorStateCase="Closed"),s.percentCompleteBar=100,s.isOpen=n,s.allowReleaseEnabled=!1,s.currentState&&s.currentState.length>0){var a=r.data?s.currentState.find(function(e){return e.idWorkItem==r.data.idWorkitem}):s.currentState[0];s.allowReleaseEnabled=a&&void 0!==a.allowReleaseActivity&&a.allowReleaseActivity}o.resolve(s)}).fail(function(e){o.reject(e)}),o.promise()},callGetEffectiveDuration:function(e){var t=this,a=$.Deferred();return e.fromDate?$.when(t.dataService.getEffectiveDuration(e)).done(function(e){a.resolve(e)}):a.resolve(null),a.promise()},callGetSummaryCaseTaskOptions:function(e){var t=this,a=$.Deferred();return $.when(t.dataService.getSummaryCaseTaskOptions(e)).then(function(e){a.resolve(e)}).fail(function(e){a.reject(e)}),a.promise()}}),$.Class.extend("bizagi.workportal.webparts.summaryCase.eventsSummary",{},{init:function(e,t,a){var i=this;i.canvas=a.canvas,i.dataService=t,i.workportalFacade=e},getEventsData:function(e){var t=this,a=e,i=$.Deferred();return t.data=e,t.params=a,$.when(t.dataService.summaryCaseEvents({idCase:e.idCase})).done(function(e){i.resolve(e)}).fail(function(){i.reject()}),i.promise()}}),$.Class.extend("bizagi.workportal.webparts.summaryCase.parentSummary",{},{init:function(e,t,a){var i=this;i.canvas=a.canvas,i.dataService=t,i.workportalFacade=e},getParentData:function(e){var t=this,a=e,i=new $.Deferred;t.data=e,t.params=a;var n={};return n.showParentProcess=a.idParentCase>=1,n.parentProcess={displayName:a.parentDisplayName,idCase:a.idParentCase},$.when(t.dataService.getWorkitems({idCase:t.params.idCase})).done(function(e){a.dataParentProcess=n,a.dataParentProcess.WorkItem=e.workItems[0],i.resolve(e)}),i.promise()}}),$.Class.extend("bizagi.workportal.webparts.summaryCase.subprocessSummary",{},{init:function(e,t,a){var i=this;i.canvas=a.canvas,i.dataService=t,i.workportalFacade=e},getSubprocessData:function(e){var t=this,a=e,i=$.Deferred();return t.data=e,t.params=a,$.when(t.dataService.summarySubProcess({idCase:e.idCase})).done(function(e){i.resolve(e)}).fail(function(){i.reject()}),i.promise()}}),$.Class.extend("bizagi.workportal.webparts.summaryCase.actionsSummary",{},{init:function(e,t,a){var i=this;i.canvas=a.canvas,
i.dataService=t,i.workportalFacade=e},getActionsData:function(e){var t=this,a=new $.Deferred;t.data=e;var i=t.data.caseDetails.plan.activities.filter(function(e){return e.id==t.data.caseDetails.currentState[0].idActivity})[0];return a.resolve(i),a.resolve()}}),$.Class.extend("bizagi.workportal.webparts.summaryActivityPlan.stateActivity",{},{init:function(e,t,a){var i=this;i.canvas=a.canvas,i.dataService=t,i.workportalFacade=e,i.EXECUTING_ACTIVITY="EXECUTING",i.FINISHED_ACTIVITY="FINISHED",i.datePickerRegional=bizagi.localization.getResource("datePickerRegional"),i.dataPlan=new bizagi.workportal.webparts.summaryActivityPlan.dataPlan(e,t,a)},getActivityPlanStateData:function(e){var t=this,a=new $.Deferred;t.data=e;var i=t.data.caseDetails.plan.activities.filter(function(e){return e.idWorkItem==t.data.idWorkitem})[0];if(i.startDate){t.getStateActivity(i);var n={time:{fromDate:t.getFormattedDate(new Date(t.getFirstDate(i)))}},r=t.getDataByScenarios(i);$.when(r.unitTime).done(function(e){r=$.extend(r,{unitTime:e});var i=t.updateDataWidget($.extend(n.time,r));a.resolve(i)})}return a.promise()},updateDataWidget:function(e){var t=bizagi.util.dateFormatter.getRelativeTime(new Date(Date.now()-60*e.unitTime.minutes*1e3),null,!1),a=bizagi.localization.getResource("workportal-project-activity-state-"+e.keywordResource);return e.messageTime=a.replace("%s",t),e},getStateActivity:function(e){var t=this;return e.finishDate?(e.currentState=t.FINISHED_ACTIVITY,t.FINISHED_ACTIVITY):(e.currentState=t.EXECUTING_ACTIVITY,t.EXECUTING_ACTIVITY)},getFirstDate:function(e){var t=this;return e.currentState===t.EXECUTING_ACTIVITY?e.startDate:e.finishDate},getDataByScenarios:function(e){var t=this,a={colorBar:null,percentBar:100,keywordResource:null,unitTime:null},i={};switch(e.currentState){case t.EXECUTING_ACTIVITY:a.keywordResource="opened",a.colorBar=t.getColorByCreatedAndEstimatedDate(e),i={idUser:bizagi.currentUser.idUser,fromDate:e.startDate,toDate:Date.now()},a.unitTime=t.callGetEffectiveDuration(i);break;case t.FINISHED_ACTIVITY:a.colorBar="Gray",a.keywordResource="closed",i={idUser:bizagi.currentUser.idUser,fromDate:e.finishDate,toDate:Date.now()},a.unitTime=t.callGetEffectiveDuration(i)}return a},getColorBar:function(e){return this.getDataByScenarios(e).colorBar},getPercentBar:function(e){return this.getDataByScenarios(e).percentBar},getKeywordResourceDescriptionBar:function(e){return this.getDataByScenarios(e).keywordResource},getUnitTime:function(e){return this.getDataByScenarios(e).unitTime},getColorByCreatedAndEstimatedDate:function(e){var t="Red";if(e.estimatedFinishDate&&Date.now()<e.estimatedFinishDate){t=(new Date).getUTCDate()===new Date(e.estimatedFinishDate).getUTCDate()?"Yellow":"Green"}return t},getFormattedDate:function(e){return this.datePickerRegional.monthNames[e.getMonth()]+" "+bizagi.util.dateFormatter.formatDate(e,"dd hh:ss tt",bizagi.localization.getResource("datePickerRegional"))},callGetEffectiveDuration:function(e){var t=this,a=$.Deferred();return $.when(t.dataService.getEffectiveDuration(e)).done(function(e){a.resolve(e)}),a.promise()}}),$.Class.extend("bizagi.workportal.webparts.summaryActivityPlan.dataPlan",{},{init:function(e,t,a){var i=this;i.canvas=a.canvas,i.dataService=t,i.workportalFacade=e,i.differenceMillisecondsServer=a.differenceMillisecondsServer,i.tools={arrayUnique:function(e){for(var t=e.concat(),a=0;a<t.length;++a)for(var i=a+1;i<t.length;++i)t[a]===t[i]&&t.splice(i--,1);return t}}},getPlanData:function(e){var t=this,a=new $.Deferred;t.data=e,t.data.caseDetails.plan={};var i={idPlan:t.data.caseDetails.idPlan};return $.when(t.callGetPlan(i)).then(function(e){$.extend(t.data.caseDetails.plan,e,{activities:[],users:[]});var i={idPlan:t.data.caseDetails.idPlan};$.when(t.callGetFirstParent(i)).then(function(e){t.data.caseDetails.plan.firstParent=e;var i={idPlan:t.data.caseDetails.idPlan},n={idPlan:t.data.caseDetails.idPlan},r={idPlan:t.data.caseDetails.idPlan};$.when(t.callGetActivitiesPlan(i),t.callGetWorkitemsPlan(n),t.callGetTransitionsByPlan(r)).then(function(e,i,n){var r=e||[];t.mergePropertiesActivitiesWithWorkitems(r,i),t.data.caseDetails.plan.activities=t.calculateActivityStatus(r),r=t.orderActivitiesByTransitions(r,n),t.data.caseDetails.plan.activities=r,a.resolve(t.data.caseDetails.plan)})}).fail(function(){a.reject()})}).fail(function(){a.reject()}),a.promise()},calculateActivityStatus:function(e){var t,a=this;return a.data.currentState&&a.data.currentState.length>0&&(t=a.data.currentState[0].entryDateWorkItem),$.each(e,function(e,i){if(i.status="nodisplay",i.starDate=t,i.estimatedFinishDate){var n=a.getDateServer(),r=i.estimatedFinishDate-i.startDate,o=i.startDate+.33*r,s=i.startDate+.66*r;i.estimatedFinishDate;n<o?i.status="ontime":o<=n&&n<s?i.status="delayed":s<=n&&(i.status="atrisk")}if(i.items){var l=i.items.filter(function(e){return!0===e.resolved});i.numResolvedItems=l.length,i.numTotalItems=i.items.length,i.numTotalItems>0&&(i.progress=Math.floor(i.numResolvedItems/i.numTotalItems*100))}else i.items=[]}),e},orderActivitiesByTransitions:function(e,t){var a=this,i=[];if(0===t.length)i=e,e.length>1&&e.filter(function(e){e.parallel=!0});else{var n=a.orderTransitionsByFromAndTo(t,e);if(activityGuidsInOrder=n.activitiesInOrder,parallelActivitiesHash=n.parallelActivitiesHash,0===activityGuidsInOrder.length)return e;for(var r=0,o=activityGuidsInOrder.length;r<o;r+=1)i=i.concat(e.filter(function(e){return e.id==activityGuidsInOrder[r]&&parallelActivitiesHash[e.id]&&(e.parallel=!0),e.id==activityGuidsInOrder[r]}))}return i},orderTransitionsByFromAndTo:function(e){function t(n){var r=[],o=[],s=!1;if(n.forEach(function(t){var n=a.getTransitionsByFrom(e,t),l=n.length;l>0&&(s=!0,n.forEach(function(e){r.push(e.idActivityFrom),o.push(e.idActivityTo)}),l>1&&o.forEach(function(e){i[e]=!0}))}),s){var c=a.tools.arrayUnique(r.concat(o));l=a.tools.arrayUnique(l.concat(c)),t(o)}}for(var a=this,i={},n=e.map(function(e){return e.idActivityFrom}),r=e.map(function(e){return e.idActivityTo}),o=[],s=0;s<n.length;s+=1)-1===r.indexOf(n[s])&&(o=a.tools.arrayUnique(o.concat([n[s]])));if(0===o.length&&1===activities.length)return{activitiesInOrder:[activities[0].id],parallelActivitiesHash:[]};o.length>1&&o.forEach(function(e){i[e]=!0});var l=[];return t(o),{activitiesInOrder:l,parallelActivitiesHash:i}},getTransitionsByFrom:function(e,t){return e.filter(function(e){return e.idActivityFrom===t})},callGetItemsByActivity:function(e){var t=this,a=$.Deferred();return t.dataService.getItemsByActivity(e).always(function(e,t,i){200===i.status?a.resolve(e):a.reject()}),a.promise()},callGetWorkitemsPlan:function(e){var t=this,a=$.Deferred();return t.dataService.getWorkitemsPlan(e).always(function(e,t,i){200===i.status?a.resolve(e):a.reject()}),a.promise()},callGetPlan:function(e){var t=this,a=$.Deferred();return t.dataService.getPlan(e).always(function(e){200===e.status||201===e.status||void 0===e.status?a.resolve(e):a.reject()}),a.promise()},callGetActivitiesPlan:function(e){var t=this,a=$.Deferred();return t.dataService.getActivities(e).always(function(e,t,i){200===i.status?a.resolve(e):a.reject()}),a.promise()},callGetTransitionsByPlan:function(e){var t=this,a=$.Deferred();return t.dataService.getTransitionsByPlan(e).always(function(e,t,i){200===i.status?a.resolve(e):a.reject()}),a.promise()},getDateServer:function(){return(new Date).getTime()+this.differenceMillisecondsServer},mergePropertiesActivitiesWithWorkitems:function(e,t){e.forEach(function(e){var a=t.filter(function(t){return t.guidActivity==e.id});a.length>0&&$.extend(e,{startDate:a[0].wiEntryDate||null,finishDate:a[0].wiSolutionDate||null,idWorkItem:a[0].idWorkItem,workItemState:a[0].workItemState,idCase:a[0].idCase,estimatedFinishDate:a[0].wiEstimatedSolutionDate||e.estimatedFinishDate})})},callGetFirstParent:function(e){var t=this,a=$.Deferred();return t.dataService.getFirstParentPlan(e).done(function(e){a.resolve(e)}),a.promise()}}),$.Class.extend("bizagi.workportal.webparts.summaryActivityPlan.progressActivity",{},{init:function(e,t,a){var i=this;i.canvas=a.canvas,i.dataService=t,i.workportalFacade=e,i.plugins={},i.dataPlan=new bizagi.workportal.webparts.summaryActivityPlan.dataPlan(e,t,a)},getActivityProgress:function(e){var t=this,a=new $.Deferred;t.data=e;var i=t.data.caseDetails.plan.activities.filter(function(e){return e.idWorkItem==t.data.idWorkitem})[0],n={};return n.valuePercentBarComplete=0,n.progress={progress:i.progress,canEdit:0===i.items.length},n.progress.progress&&(n.valuePercentBarComplete=n.progress.progress),n.progress.progress<=33?n.colorBar="Red":n.progress.progress<=66?n.colorBar="Yellow":n.colorBar="Green",a.resolve(n),a.promise()},resizeSliderProgressActivity:function(){var e=this;e.formEditProgress.sliderProgress.wrapper.css("width","399px"),e.formEditProgress.sliderProgress.resize()},onSubmitFormChangeProgress:function(e,t,a){e.preventDefault();var i=this,n=$.Deferred();i.data=t;var r=i.data.caseDetails.plan.activities.filter(function(e){return e.id==i.data.caseDetails.currentState[0].idActivity})[0],t=$.extend(r,{progress:a});return i.responseOnSubmitFormChangeProgress=t,$.when(i.callEditActivity(t)).then(function(){n.resolve(i.responseOnSubmitFormChangeProgress)}),n.promise()},callEditActivity:function(e){var t=this,a=$.Deferred();return t.dataService.editActivityPlan(e).always(function(e,t,i){200===i.status?a.resolve(e):a.reject()}),a.promise()},clean:function(){var e=this;e.plugins&&e.cleanWidgets(e.plugins.popupEditProgress),e.formEditProgress&&(e.cleanWidgets(e.formEditProgress.sliderProgress),e.cleanWidgets(e.formEditProgress.numericTextBoxPlugin))},cleanWidgets:function(e){e&&kendo.destroy(e)}}),$.Class.extend("bizagi.workportal.webparts.summaryActivityPlan.parentActivity",{},{init:function(e,t,a){var i=this;i.canvas=a.canvas,i.dataService=t,i.workportalFacade=e,i.dataPlan=new bizagi.workportal.webparts.summaryActivityPlan.dataPlan(e,t,a)},getActivityParent:function(e){var t=this,a=new $.Deferred;return t.data=e,$.when(t.dataService.getPlanParent({idPlan:t.data.caseDetails.plan.id})).done(function(e){var t={};t.parent={idParent:e.radNumber,nameParent:e.displayName,idCase:e.idCase,idWorkflow:e.idWorkflow,idWorkItem:e.idWorkItem,idTask:e.idTask},a.resolve(t)}).fail(function(e){a.reject()}),a.promise()}}),$.Class.extend("bizagi.workportal.webparts.summaryActivityPlan.assigneesActivity",{},{init:function(e,t,a){var i=this;i.canvas=a.canvas,i.dataService=t,i.workportalFacade=e,i.usersMap={},i.dataPlan=new bizagi.workportal.webparts.summaryActivityPlan.dataPlan(e,t,a)},getActivityAssignees:function(e){var t=this,a=[],i=[],n=new $.Deferred;t.data=e;var r=t.data.caseDetails.plan.idUserCreator;i.push({idUser:r,userType:["owner"]}),t.usersMap["-"+r+"-"]={picture:"",id:r,name:"",userType:["owner"]},a.push(r),$.each(t.data.caseDetails.plan.activities,function(e,n){var o=n.userAssigned;o===r?-1===$.inArray("Assigned",i[0].userType)&&(i[0].userType.push("Assigned"),t.usersMap["-"+r+"-"].userType.push("Assigned")):(t.usersMap["-"+o+"-"]={picture:"",id:o,name:"",userType:["Assigned"]},0===i.filter(function(e){return e.idUser==o}).length&&(i.push({idUser:o,userType:["Assigned"]}),a.push(o)))});var o,s=[],l={},c={},e={userIds:a.join(),width:50,height:50};return $.when(t.dataService.getUsersData(e)).always(function(e){for(var t=0,r=e.length;t<r;t+=1)c[e[t].id]=e[t].name;$.each(i,function(e,t){$.each(t.userType,function(e,t){o?o.types.indexOf(t)<0&&(o.types+=", "+t):o={types:t}}),l[t.idUser]||(l[t.idUser]=!0,t.types=o.types,t.name=c[t.idUser],s.push(t)),o=void 0}),n.resolve({assignees:s,cvsUsers:a.join()})}),n.promise()}}),$.Class.extend("bizagi.workportal.webparts.summaryPlan.progressPlan",{},{init:function(e,t,a){var i=this;i.canvas=a.canvas,i.dataService=t,i.workportalFacade=e},getPlanProgressData:function(e){var t=this,a=new $.Deferred;t.data=e;var i=t.calculateProgress(),n={};return n.progress=i,n.progress<33?n.colorBar="Red":n.progress<66?n.colorBar="Yellow":n.colorBar="Green",a.resolve(n),a.promise()},calculateProgress:function(){var e=this,t=0,a=e.data.caseDetails.plan.activities.length,i=0;return 0!==a&&(e.data.caseDetails.plan.activities.forEach(function(e){e.finishDate&&t++}),i=Math.round(t/a*100)),i}}),$.Class.extend("bizagi.workportal.webparts.summaryPlan.timePlan",{},{init:function(e,t,a){var i=this;i.canvas=a.canvas,i.dataService=t,i.workportalFacade=e,i.PENDING_PLAN="PENDING",i.EXECUTING_PLAN="EXECUTING",i.CLOSED_PLAN="CLOSED",i.datePickerRegional=bizagi.localization.getResource("datePickerRegional")},getPlanTimeData:function(e){var t=this,a=new $.Deferred;t.data=e;var i;return t.data.caseDetails.plan.dueDate?t.data.caseDetails.plan.currentState===t.PENDING_PLAN||t.data.plan.currentState===t.EXECUTING_PLAN?$.when(t.updateWidget(t.data)).done(function(e){a.resolve(e)}):(i="ok1",a.resolve(i)):(i="thereArentDueDate",a.resolve(i)),a.promise()},updateWidget:function(e){var t=this;t.data=e;var a=new $.Deferred;return t.data.caseDetails.plan.currentState===t.CLOSED_PLAN?a.resolve(t.getClosedDatePlan(t.data.caseDetails.plan)):($.when(t.getIntervalOnMinutes(t.data.caseDetails.plan)).done(function(e){var i=bizagi.util.dateFormatter.getRelativeTime(new Date(Date.now()-60*e*1e3),null,!0),n=i.replace(/\d/g,""),r=t.getKeywordDifferenceDates(t.data.caseDetails.plan),o=bizagi.localization.getResource("workportal-project-plan-state-"+r);o=o.replace("%s",n);var s=i.replace(/\D/g,""),l=t.getSecondDate(t.data.caseDetails.plan),c=t.getWidthBar(t.data.caseDetails.plan),d=t.getColorBarByPercent(c),u={fromDate:t.getFormattedDate(new Date(t.getFirstDate(t.data.caseDetails.plan))),toDate:l?t.getFormattedDate(new Date(l)):null,valueOfTimeCalculated:s,messageDescripionDifference:o,percentBar:c,colorBar:d};return a.resolve(u)}),a.promise())},getFirstDate:function(e){var t=this;switch(e.currentState){case t.PENDING_PLAN:return e.dueDate?e.dueDate:e.creationDate;case t.EXECUTING_PLAN:case t.CLOSED_PLAN:return e.startDate}},getSecondDate:function(e){var t=this;switch(e.currentState){case t.PENDING_PLAN:return null;case t.EXECUTING_PLAN:return e.dueDate;case t.CLOSED_PLAN:return e.closedDate}},getLastActivity:function(e){return JSON.parse(JSON.stringify(e)).sort(function(e,t){return e.finishDate<t.finishDate?1:-1})[0]},getClosedDatePlan:function(e){var t=this;return e.closedDate=t.getLastActivity(e.activities).finishDate,e.closedDate},getDifferenceBetweenDates:function(e,t){var a=this,i=$.Deferred(),n={idUser:bizagi.currentUser.idUser,fromDate:e,toDate:t};return $.when(a.callGetEffectiveDuration(n)).done(function(e){i.resolve(e.minutes)}),i.promise()},getIntervalOnMinutes:function(e){var t=this,a=$.Deferred();switch(e.currentState){case t.PENDING_PLAN:e.dueDate>Date.now()?$.when(t.getDifferenceBetweenDates(Date.now(),e.dueDate)).done(function(e){a.resolve(e)}):$.when(t.getDifferenceBetweenDates(e.dueDate,Date.now())).done(function(e){a.resolve(e)});break;case t.EXECUTING_PLAN:e.dueDate?e.dueDate>Date.now()?$.when(t.getDifferenceBetweenDates(Date.now(),e.dueDate)).done(function(e){a.resolve(e)}):$.when(t.getDifferenceBetweenDates(e.dueDate,Date.now())).done(function(e){a.resolve(e)}):$.when(t.getDifferenceBetweenDates(e.startDate,Date.now())).done(function(e){a.resolve(e)});break;case t.CLOSED_PLAN:$.when(t.getDifferenceBetweenDates(e.startDate,e.closedDate)).done(function(e){a.resolve(e)})}return a.promise()},getKeywordDifferenceDates:function(e){var t=this;switch(e.currentState){case t.PENDING_PLAN:return e.dueDate>Date.now()?"remaining":"exceeded";case t.EXECUTING_PLAN:return e.dueDate?e.dueDate>Date.now()?"remaining":"exceeded":"opened";case t.CLOSED_PLAN:return"executed"}},getRelativeTime:function(e){return bizagi.util.dateFormatter.getRelativeTime(e,null,!1)},getWidthBar:function(e){var t=this;switch(e.currentState){case t.PENDING_PLAN:if(e.dueDate){if(e.dueDate<Date.now())return 100;var a=e.dueDate-e.creationDate,i=Date.now()-e.creationDate;return Math.ceil(100*i/a)}return 100;case t.EXECUTING_PLAN:if(e.dueDate){if(e.dueDate>Date.now()){var n=e.dueDate-e.startDate,r=Date.now()-e.startDate;return Math.ceil(100*r/n)}return 100}return 100;case t.CLOSED_PLAN:if(e.closedDate>Date.now()){var o=e.closedDate-e.startDate,r=Date.now()-e.startDate;return Math.ceil(100*r/o)}return 100}},getColorBarByPercent:function(e){return e<33?"Red":e<66?"Yellow":"Green"},callGetEffectiveDuration:function(e){var t=this,a=$.Deferred();return $.when(t.dataService.getEffectiveDuration(e)).done(function(e){a.resolve(e)}),a.promise()},getFormattedDate:function(e){return this.datePickerRegional.monthNames[e.getMonth()]+" "+bizagi.util.dateFormatter.formatDate(e,"dd hh:ss tt",bizagi.localization.getResource("datePickerRegional"))}}),bizagi.workportal.webparts.webpart.extend("bizagi.workportal.webparts.syncErrors",{TEMPLATE_HEADER:"main-syncErrors-kendo-tmpl",TEMPLATE_OFFLINE_CONTENT:"#bz-syncErrors-offline-notification-container",TEMPLATE_NAVBAR_HEADER:".bz-div-syncErrors-navbar-header",SYNC_ERROR_RETRY_BUTTON:".bz-syncError-item-retry",SYNC_DESCRIPTION_OFFLINE_MESSAGE:".bz-wp-status-description",SYNC_HEADER_HOMEPORTAL_DESCRIPTION_OFFLINE_MESSAGE:"span.bz-wp-status-description",ACTIONS:{LONGCLICK:"longClick"},DESIGN:{HEADER_HEIGHT:"bz-div-syncErrors-navbar-header-height"},ITEM_ELEMENTS:{RETRY:"retryButton",CARD:"card"}},{init:function(e,t,a){var i=this;i._super(e,t,a),i.initSyncErrors=!0,i.properties={},i.properties.data=[],i.properties.scrollOffset=0,i.subscribe("bz-update-list-sync-errors-cases",function(e,t){i.view&&i.updateDataList(),i.changeNetworkStatus(i.dataService.online)}),bizagi.webpart.subscribe("homeportalShow-syncErrors",function(e,t){i.updateDataList(),i.configureHandlers(),i.changeNetworkStatus(i.dataService.online)}),i.canvas.unbind("view-initialized"),i.canvas.bind("view-initialized",function(e,t){i.view=t,i.initSyncErrorsKendoView(),i.initSyncErrros||(i.updateDataList(),i.configureHandlers())}),i.subscribe("bz-network-sync-errors-status",function(){i.changeNetworkStatus(i.dataService.online)})},renderContent:function(){var e=kendo.template(this.getTemplate(this.Class.TEMPLATE_HEADER),{useWithBlock:!1});return this.content=e({}),this.content},postRender:function(){this.dataSource=new kendo.data.DataSource({})},loadDataList:function(){var e=this,t=new $.Deferred;return bizagi.loading.start(),e.dataService.getSyncErrorsList().then(function(a){a.forEach(function(t){t.isOnline=e.dataService.online});var i={transport:{read:function(e){e.success(a)}},sort:[{field:"synctimestamp",dir:"desc"}]};e.dataSourceNew=new kendo.data.DataSource(i),t.resolve(e.dataSourceNew),e.changeListState(a.length)}).fail(function(e){bizagi.logError(e.responseText),t.reject("")}).always(function(){bizagi.loading.stop()}),t.promise()},updateDataList:function(){var e=this;$.when(e.loadDataList()).then(function(t){var a=t,i=$("#items-content-syncError",e.content).data("kendoMobileListView");a&&void 0!==i&&i.setDataSource(a),e.options&&e.options.resetScrollAfterLoad&&$("#items-content-syncError",e.content).data("kendoMobileListView").scroller().scrollTo(0,0)}).fail(function(e){bizagi.loading.stop(),bizagi.logError(e.responseText)}).always(function(){bizagi.loading.stop()})},configureHandlers:function(){},clickOnSyncErrorItem:function(e){var t=this;switch(t.whichItemElement(e)){case t.Class.ITEM_ELEMENTS.RETRY:t.onClickOnRetry(e);break;case t.Class.ITEM_ELEMENTS.CARD:default:t.onClickOnCard(e)}},whichItemElement:function(e){var t=this,a=t.Class.ITEM_ELEMENTS.CARD;return t.validateSelector(e,t.Class.SELECTOR_ITEM_ELEMENTS.RETRY)&&(a=t.Class.ITEM_ELEMENTS.RETRY),a},validateSelector:function(e,t){var a=$(e.target);return a.hasClass(t)||1===a.closest(t).length},onClickOnRetry:function(e){var t=this;if(t.dataService.online&&e&&e.dataItem){var a=t.resolveRetryCaseParameters(e.dataItem);bizagi.loading.start(),t.dataService.syncSingleOfflineCase(a).then(function(){bizagi.util.showMobileToast({type:"success",message:bizagi.localization.getResource("workportal-offline-sync-success")})}).fail(function(e){bizagi.util.showMobileToast({type:"error",message:bizagi.localization.getResource("workportal-offline-sync-failed")})}).always(function(){setTimeout(function(){t.updateDataList(),bizagi.loading.stop()},100)})}},resolveRetryCaseParameters:function(e){return{offlineType:e.offlinetype,idCase:e.idcase,idWorkitem:e.idworkitem,isSingleSync:!0,isRetry:!0}},onClickOnCard:function(e){var t=this;e.preventDefault(),t.setCurrentScrollerOfset(),void 0!==e.dataItem&&($(".bz-wp-item-maindata-container",e.item).data(t.Class.ACTIONS.LONGCLICK)||t.openOnClickCard(e))},setCurrentScrollerOfset:function(){this.properties.scrollOffset=$("#items-content-syncError",this.content).data("kendoMobileListView").scroller().scrollTop,this.properties.scrollOffset=this.properties.scrollOffset<0?-1:this.properties.scrollOffset},openOnClickCard:function(e){this.changeCase(e.dataItem)},changeCase:function(e){bizagi.webpart.publish("changeCase",{idCase:e.idcase,idWorkitem:e.idworkitem,displayName:"start"==e.offlinetype?e.process:e.activity,radNumber:e.radnumber,isOfflineForm:!0,formsRenderVersion:2,isEdited:!0,syncError:e.syncerror,hasSyncError:!0,offlineType:e.offlinetype})},initSyncErrorsKendoView:function(){var e=this;if(e.initSyncErrors&&void 0!==$(e.canvas).data("kendoMobileView")){e.initSyncErrors=!1;var t=e.getTemplate("item-syncErrors-kendo-tmpl"),a=e.getTemplate("pull-loader"),i=e.getTemplate("refresh-loader");$("#items-content-syncError",e.content).kendoMobileListView({dataSource:e.dataSource,template:t,selectable:"single",pullToRefresh:!0,messages:{pullTemplate:a,refreshTemplate:i,releaseTemplate:i},pullParameters:function(){return e.updateDataList()},click:e.clickOnSyncErrorItem.bind(e),dataBound:function(){}}),e.configureHandlers()}},changeNetworkStatus:function(e){var t=this;e?$(t.Class.TEMPLATE_OFFLINE_CONTENT).hide():$(t.Class.TEMPLATE_OFFLINE_CONTENT).show(),setTimeout(function(){t.toggleBehaviorEnabled(e)},250),t.updateDataList()},changeListState:function(e){var t=this;$(t.content).prop("class",e<1?"empty":"")},toggleBehaviorEnabled:function(e){var t=this;e?$(t.Class.TEMPLATE_NAVBAR_HEADER).removeClass(t.Class.DESIGN.HEADER_HEIGHT):($(t.Class.TEMPLATE_NAVBAR_HEADER).addClass(t.Class.DESIGN.HEADER_HEIGHT),$(t.Class.SYNC_DESCRIPTION_OFFLINE_MESSAGE).html($(t.Class.SYNC_HEADER_HOMEPORTAL_DESCRIPTION_OFFLINE_MESSAGE).html()))}}),bizagi.workportal.webparts.syncErrors.extend("bizagi.workportal.webparts.syncErrors",{SELECTOR_ITEM_ELEMENTS:{RETRY:".bz-syncError-item-retry"}},{init:function(e,t,a){this._super(e,t,a)},renderContent:function(e){return this._super(e)},postRender:function(e){var t=this;t._super(e),t.dataSource=new kendo.data.DataSource({group:{field:"group"}})},configureHandlers:function(){this._super()}}),bizagi.workportal.webparts.webpart.extend("bizagi.workportal.webparts.taskFeed",{PAGE_SIZE:10,PAGINATOR_MAX_SIZE:40,NUMBER_OF_FIELDS:-1,BUTTON_OFFLINE_DROPDOWN:".bz-header-offline-btn",TEMPLATE_HEADER:"main-taskFeed-kendo-tmpl",INPUT_TRY_MODE:{DRAFTS:"drafts"},ME_DESTINATION:"dashBoard"},{init:function(e,t,a){var i=this;i._super(e,t,a),i.initTaskfeed=!0,i.properties={},i.properties.page=1,i.properties.pageSize=i.Class.PAGE_SIZE,i.properties.totalPages=0,i.properties.elementPages=i.Class.PAGE_SIZE,i.properties.numberOfFields=i.Class.NUMBER_OF_FIELDS,i.properties.idWfClass=-1,i.properties.data=[],i.properties.scrollOffset=0,i.properties.smartInboxId,i.properties.smartInboxFilter=[],i.routingCalled=!0,i.cacheFavorites={},i.isPaginatorActive=!1,i.isTabletDevice=bizagi.util.isTabletDevice(),i.enableOfflineForm=bizagi.util.hasOfflineFormsEnabled(),i.online=i.dataService.online,i.activitySearch=new bizagi.workportal.activity.search(i.workportalFacade,i.dataService,i),i.subscribe("bz-update-list-cases",function(e,t){t=t||{},i.online=i.dataService.online,i.routingCalled=!0,i.options&&t.page&&t.page>0&&(i.options.page=t.page,i.properties.page=t.page),i.options&&t.resetScrollAfterLoad&&(i.options.resetScrollAfterLoad=t.resetScrollAfterLoad),i.homePortalFramework&&"syncErrors"===i.homePortalFramework.destination&&(t.updateDataList=!1),void 0===t.inboxType&&void 0!==i.properties.inboxType&&(t.inboxType=i.properties.inboxType,t.smartInboxId=t.smartInboxId||i.properties.smartInboxId),t.updateDataList&&i.view&&(void 0!==t.smartInboxId?($("#items-content-taskFeed",i.content).data("kendoMobileListView").scroller().scrollTo(0,0),i.properties.smartInboxId=t.smartInboxId,i.properties.inboxType="smartinbox",i.updateDataList()):void 0===t.mode?($("#items-content-taskFeed",i.content).data("kendoMobileListView").scroller().scrollTo(0,0),i.properties.smartInboxId=void 0,i.properties.inboxType="process",i.updateDataList()):"inbox"==t.mode?i.totalPages&&i.totalPages>4?($("#items-content-taskFeed",i.content).data("kendoMobileListView").scroller().scrollTo(0,0),i.updateDataList()):($("#items-content-taskFeed",i.content).data("kendoMobileListView").scroller().reset(),i.navigateToPage(i.properties.page,i.Class.PAGE_SIZE,!0,null)):($("#items-content-taskFeed",i.content).data("kendoMobileListView").scroller().reset(),i.navigateToPage(1,i.properties.page*i.Class.PAGE_SIZE,!0,null)))}),i.canvas.unbind().bind("view-initialized",function(e,t){i.view=t;var a=i.getTitleTaskFeed();bizagi.util.setKendoViewTitle(t,a),i.initTaskFeedKendoView(),i.initTaskfeed||i.updateDataList(),$(t.content).mfb({click:function(){i.workportalFacade.homePortalFramework.showDrawer("newCase")}})}),i.subscribe("taskfeed-favorites-update",function(e,t){t=t||{},i.setFavorite(t)})},getTitleTaskFeed:function(){var e=this,t=bizagi.util.getLastProcessInboxInputTray(),a=t||"inbox",i=bizagi.localization.getResource("workportal-taskfeed-title");switch(a){case"outbox":case"outbox-new":case"outbox-finished":i=bizagi.localization.getResource("workportal-menu-outbox");break;case e.Class.INPUT_TRY_MODE.DRAFTS:i=bizagi.localization.getResource("workportal-general-word-drafts");break;case"inbox":i=bizagi.localization.getResource("workportal-taskfeed-title")}return i},renderContent:function(){var e=this,t=$.Deferred(),a=kendo.template(e.getTemplate(e.Class.TEMPLATE_HEADER),{useWithBlock:!1});return e.content=a({}),t.resolve(e.content),t.promise()},postRender:function(){this.dataSource=new kendo.data.DataSource({group:{field:"group"}})},setViewStyles:function(){$("#items-content-taskFeed").removeClass("grid-view")},onClickOnCard:function(e){var t=this;e.preventDefault(),t.setCurrentScrollerOfset(),void 0!==e.dataItem&&($(".bz-wp-item-maindata-container",e.item).data("longClick")||(t.isTabletDevice?t.openOnClickCard(e):$(e.target).closest(".bz-wp-item-delete").length?t.deleteDraft(e.dataItem):t.openOnClickCard(e)))},openOnClickCard:function(e){this.changeCase(e.dataItem)},initTaskFeedKendoView:function(){var e=this;if(e.initTaskfeed&&void 0!==$(e.canvas).data("kendoMobileView")){e.initTaskfeed=!1;var t=e.viewType&&"cardView"==e.viewType?e.getTemplate("item-taskFeed-card-kendo-tmpl"):e.getTemplate("item-taskFeed-kendo-tmpl"),a=e.getTemplate("pull-loader"),i=e.getTemplate("refresh-loader");e.isFirstElement=!0,e.setViewStyles(),$("#items-content-taskFeed",e.content).kendoMobileListView({dataSource:e.dataSource,headerTemplate:"#=(value.split('|'))[1]#",fixedHeaders:!0,template:t,selectable:"single",pullToRefresh:!0,messages:{pullTemplate:a,refreshTemplate:i,releaseTemplate:i},pullParameters:function(){if(bizagi.util.isSmartphoneDevice()||e.taskFeedSearch&&"on"!==e.taskFeedSearch.getSearchMode())return e.updateDataListByPullRefresh(e.options)},click:e.clickOnTaskFeedItem.bind(e),dataBound:function(){$(".km-list li",this.element).each(function(){var e=this;$(".bz-wp-item-container",e).data("has-error")&&bizagi.util.isOfflineErrorsViewSupported()&&$(e).addClass("sync-error")}),$(".km-list li:first-child",this.element).each(function(){var t=this;e.firstChild=t;var a=$(e.firstChild).data("status");if($(t).addClass(a).attr("data-status",a),e.isTabletDevice&&$("#items-content-taskFeed").data("kendoMobileListView")&&$("#items-content-taskFeed").data("kendoMobileListView").dataSource){var i={};i.dataItem=$("#items-content-taskFeed").data("kendoMobileListView").dataSource.data()[0],i.dataItem&&e.isFirstElement&&(e.isFirstElement=!1,i.item=$(e.firstChild),e.selectFirstElement())}}),e.isTabletDevice?$(".km-list .bz-wp-item-maindata-container",this.element).longTouchs({}).on("longTouch",function(t){var a=$(t.target).closest("li"),i=a.data("uid"),n=this.dataSource.getByUid(i);e.changeCase(n)}.bind(this)):$(".km-list .bz-wp-item-maindata-container",this.element).longTouchs({}).on("longTouch",function(t){var a=$(t.target).closest("li"),i=a.data("uid"),n=this.dataSource.getByUid(i);void 0!==n&&e.showSummary({dataItem:n,item:a})}.bind(this))}}),e.configureHandlers()}},clickOnTaskFeedItem:function(e){this.onClickOnCard(e)},changeCase:function(e){var t=e.radNumber;void 0==t&&e[6]&&e[6][0]&&e[6][0][1]&&(t="DateTime"!==e[6][0][2]?e[6][0][1]:null),bizagi.webpart.publish("changeCase",{idCase:e[0],idWorkitem:e[1],idTask:e[2],displayName:e[5],radNumber:t,isOfflineForm:e[7]&&!0===e[7]||!1,formsRenderVersion:e[7]&&!0===e[7]?2:0,isEdited:e.isEdited,isOpen:"failed"!==e.syncStatus&&e[8],offlineType:e.offlineType,isEvent:!!e.isEvent&&e.isEvent})},deleteDraft:function(e){var t=this,a=bizagi.localization.getResource("workportal-widget-inbox-delete-case-title");$.when(bizagi.showConfirmationBox(a,"Bizagi","warning")).done(function(){$.when(t.dataService.deleteCase({idCase:e[0]})).done(function(){t.publish("bz-update-list-cases",{updateDataList:!0}),bizagi.webpart.publish("bz-summary-item-clear")}).fail(function(e){bizagi.log(e)})})},setPageParamsOnPullRefresh:function(e,t){var a=this,i=t?a.Class.PAGE_SIZE:e.page*e.pageSize;return t&&a.pageProperties(1),$.extend(e,{page:1,pageSize:i})},pageProperties:function(e){var t=this;return void 0!==e&&(t.properties.page=e),t.properties.page},updateDataListByPullRefresh:function(e){var t=this,a=new $.Deferred,i=t.setPageParamsOnPullRefresh(e,t.isPaginatorActive);t.isPaginatorActive||t.setCurrentScrollerOfset(),i.inputtray=bizagi.util.inputTray(t.online),i.enableOfflineForm=t.enableOfflineForm||!1,i.includeSyncErrors=bizagi.util.isOfflineErrorsViewSupported();var n=t.getActivitiesServiceByView(t.dataService);return $.when(n.call(t.dataService,bizagi.clone(i))).done(function(e){t.viewType&&"cardView"==t.viewType&&(e=t.dataService.adapterDataOfActivitiesToTemplate(t.dataService.adapterServerResponseTemplateBindingObject(e))),t.online?(t.totalPages=e.totalPages,$(".bz-wp-taskfeed-paginator-pages span").html(t.getResource("render-grid-page")+" "+e.page+" "+t.getResource("render-grid-conector")+" "+e.totalPages),t.shouldShowPagination(e)):$(".bz-wp-taskfeed-paginator-container").css("display","none"),a.resolve(e),e.elements&&0===e.elements.length?t.setNoPendingCases():t.setHasPendingCasesStyles(),t.cacheFavorites={},t.selectFirstElement()}).fail(function(e){bizagi.debug(e.responseText),0===$("#items-content-taskFeed li",t.content).length?t.setNoPendingCases():t.setHasPendingCasesStyles(),$("#items-content-taskFeed",t.content).data("kendoMobileListView").scroller().scrollTo(0,-t.properties.scrollOffset),a.reject("")}),bizagi.util.isOfflineErrorsViewSupported()&&t.dataService.updateSyncErrorsStatus(),a.promise()},loadDataList:function(e){var t=this,a=new $.Deferred;e=e||{},t.options=t.options||{},t.options.numberOfFields=t.properties.numberOfFields,t.options.page=e.page||t.properties.page,t.options.idWfClass=t.properties.idWfClass;var i=bizagi.util.getLastProcessInboxProcessInfo(),n=i.idWorkflow,r=null;t.options.idWfClass=r=n?parseInt(n):t.options.idWfClass,t.options.enableOfflineForm=t.enableOfflineForm||!1,t.isPaginatorActive?t.options.pageSize=t.Class.PAGE_SIZE:t.options.pageSize=e.pageSize||t.properties.pageSize,t.options.inputtray=bizagi.util.inputTray(t.online),"inbox"!==t.options.inputtray&&(t.isPaginatorActive=!1),t.options.includeSyncErrors=bizagi.util.isOfflineErrorsViewSupported(),e.inboxType=e.inboxType||t.properties.inboxType,
"smartinbox"==e.inboxType?(bizagi.util.isEmpty(e.smartInboxId)&&!bizagi.util.isEmpty(t.options.smartInboxId)&&(e.smartInboxId=t.options.smartInboxId),e.smartInboxId?t.options.smartInboxId=r=e.smartInboxId:t.options.smartInboxId=void 0):t.options.smartInboxId=void 0,bizagi.loading.start(),t.options.sortData=bizagi.util.getLastProcessInboxSort(),t.dataService.online&&(t.options.liveFilterData=t.prepareLiveFilterData(r));var o=t.getActivitiesServiceByView(t.dataService),s=bizagi.clone(t.options);return $.when(o.call(t.dataService,s)).then(function(i){if(bizagi.util.isEmpty(t.options.smartInboxId)||t.dataService.markSmartInboxAsAvailableOffline(t.options.smartInboxId),t.viewType&&"cardView"==t.viewType&&(i=t.dataService.adapterDataOfActivitiesToTemplate(t.dataService.adapterServerResponseTemplateBindingObject(i))),t.online&&t.isPaginatorActive&&(i.elements.length<=0||t.totalPages<e.pageSize/t.Class.PAGE_SIZE))return t.properties.scrollOffset=0,void t.navigateToPage(1,t.Class.PAGE_SIZE,!0,null);if(t.activeAdvanceSearch(i.advanceSearch),e.pageSize&&e.pageSize>t.Class.PAGE_SIZE&&(t.properties.page=e.pageSize/t.Class.PAGE_SIZE),(!t.isTabletDevice||t.isTabletDevice&&t.online)&&(t.totalPages=i.totalPages,$(".bz-wp-taskfeed-paginator-pages span").html(t.getResource("render-grid-page")+" "+i.page+" "+t.getResource("render-grid-conector")+" "+i.totalPages),t.isPaginatorActive&&i.elements.length*i.totalPages>t.Class.PAGINATOR_MAX_SIZE&&(t.options.pageSize=10)),t.shouldShowPagination(i),e.more){var n=t.prepareData(i,t.options.idWfClass,t.options.smartInboxId);t.dataSourceNew.pushCreate(n),$("div.bz-wp-item-new",t.content).each(function(){$(this).parent().addClass("bz-wp-item-new")}),a.resolve()}else{var r={transport:{read:function(e){bizagi.util.isSmartphoneDevice()||t.taskFeedSearch&&"on"!==t.taskFeedSearch.getSearchMode()?$.when(e.data).then(function(a){var n=a.elements?a:i,r=t.prepareData(n,t.options.idWfClass,t.options.smartInboxId);e.success(r),$("div.bz-wp-item-new",t.content).each(function(){$(this).parent().addClass("bz-wp-item-new")})}).fail(function(){e.success([]),bizagi.showMessageBox(t.getResource("workportal-general-error-connection")),bizagi.webpart.publish("bz-summary-item-clear")}):e.success([])}}};t.options.sortData&&t.options.sortData.sortFieldName||(r.sort=[{field:"endDate",dir:"asc"},{field:"idworkitem",dir:"asc"}],r.group={field:"group"}),t.dataSourceNew=new kendo.data.DataSource(r),a.resolve(t.dataSourceNew)}0===$("#items-content-taskFeed li",t.content).length?t.setNoPendingCases():t.setHasPendingCasesStyles()}).fail(function(e){bizagi.logError(e.responseText),t.configureLoadMore(!1),0===$("#items-content-taskFeed li",t.content).length?t.setNoPendingCases():t.setHasPendingCasesStyles(),a.reject("")}).always(function(){bizagi.loading.stop()}),a.promise()},prepareLiveFilterData:function(e){var t=[];return bizagi.util.getLiveFiltersFromStorage(e)&&$.each(bizagi.util.getLiveFiltersFromStorage(e),function(e,a){var i={};i.column=a.selectedColumn.fieldFilterName,i.operator=a.selectedOperator.id,i.type=a.selectedColumn.fieldFilterDataType,"between"==i.operator?"datetime"==i.type.toLowerCase()?(i.from=a.value.From.value,i.to=a.value.To.value):(i.from=a.value.From,i.to=a.value.To):"equals"==i.operator||"not-equals"==i.operator||"not-starts-with"==i.operator||"not-ends-with"==i.operator||"not-contains"==i.operator||"greater-than"==i.operator||"greater-than-or-equals"==i.operator||"less-than"==i.operator||"less-than-or-equals"==i.operator||"on"==i.operator?"datetime"==i.type.toLowerCase()&&"on"!=i.operator?i.value=a.value.value:i.value=a.value:"in"==i.operator||"not-in"==i.operator?(i.value=[],"entity"==i.type.toLowerCase()?$.each(a.value,function(e,t){i.value.push({id:t.guid,displayName:t.tag})}):"IdTask"==i.column||"Activity"==i.column?$.each(a.value,function(e,t){i.value.push({id:t.guid,displayName:t.tag,internalId:t.internalId,processName:t.processName})}):$.each(a.value,function(e,t){i.value.push(t.tag)})):"starts-with"!=i.operator&&"ends-with"!=i.operator&&"contains"!=i.operator||(i.value=[],$.each(a.value,function(e,t){i.value.push(t.tag)})),t.push(i)}),t},prepareData:function(e,t,a){return e.elements},getActivitiesServiceByView:function(e){return e.getCasesListBeta},updateDataList:function(){var e=this;if(e.routingCalled){var t;t=e.isPaginatorActive?{page:e.options?e.options.page:e.properties.page,pageSize:e.options?e.options.pageSize:e.properties.pageSize}:{page:1,pageSize:e.options?e.options.page*e.options.pageSize:e.properties.page*e.properties.pageSize},e.properties.smartInboxId&&(t.smartInboxId=e.properties.smartInboxId),t.inboxType=e.properties.inboxType||"process",bizagi.loading.start(),$.when(e.loadDataList(t)).done(function(t){var a=t,i=$("#items-content-taskFeed",e.content).data("kendoMobileListView");a&&void 0!==i&&i.setDataSource(a),$("div.bz-wp-item-new",e.content).each(function(){$(this).parent().addClass("bz-wp-item-new")}),e.selectFirstElement(),e.options&&e.options.resetScrollAfterLoad&&$("#items-content-taskFeed",e.content).data("kendoMobileListView").scroller().scrollTo(0,0)}).fail(function(e){bizagi.logError(e.responseText)}).always(function(){bizagi.loading.stop()}),e.routingCalled=!1}bizagi.util.isOfflineErrorsViewSupported()&&e.dataService.updateSyncErrorsStatus()},selectFirstElement:function(){var e=this;if($("#items-content-taskFeed li",e.content).length>0&&e.isTabletDevice&&$("#items-content-taskFeed").data("kendoMobileListView")&&$("#items-content-taskFeed").data("kendoMobileListView").dataSource&&e.homePortalFramework.destination!=e.Class.ME_DESTINATION){var t={},a=$("#items-content-taskFeed").data("kendoMobileListView").dataSource.view();a&&a[0]&&(a[0].items?t.dataItem=a[0].items[0]:t.dataItem=a[0]),t.dataItem&&(t.item=$(e.firstChild),e.showSummary(t))}},setNoPendingCases:function(){var e=this,t=e.getResource("workportal-taskfeed-process-no-cases","You have no pending cases"),a=$("<li>",{class:"bz-wp-taskfeed-no-records"}).append(t);$("#items-content-taskFeed",e.content).html(a),$(".bz-wp-group-container",e.content).addClass("bz-wp-taskfeed-no-records-container"),bizagi.webpart.publish("bz-summary-item-clear")},setHasPendingCasesStyles:function(){var e=this;$(".bz-wp-group-container",e.content).removeClass("bz-wp-taskfeed-no-records-container")},configureLoadMore:function(e){var t=$("#loadMoreTaskFeed",self.content);e?t.show():t.hide()},pagesShowPagination:function(e,t){var a=this;return e>4||t>a.Class.PAGINATOR_MAX_SIZE},shouldShowPagination:function(e){var t=this,a=!(e.page>=e.totalPages);t.configureLoadMore(a),t.online&&(!t.isTabletDevice||t.isTabletDevice&&"inbox"===t.options.inputtray)&&t.pagesShowPagination(e.totalPages,e.elements.length)?($(".bz-wp-taskfeed-paginator-container",t.content).css("display","block"),$(".bz-wp-taskfeed-paginator-container",t.content).data("paginator",!0),t.configureLoadMore(!1),t.isPaginatorActive=!0,t.options.pageSize>t.Class.PAGE_SIZE&&$("#items-content-taskFeed",t.content).data("kendoMobileListView").dataSource.data().splice(10,10)):!t.isTabletDevice||t.online&&"inbox"===t.options.inputtray?($(".bz-wp-taskfeed-paginator-container",t.content).css("display","none"),$(".bz-wp-taskfeed-paginator-container",t.content).data("paginator",!1),$("#items-content-taskFeed",t.content).data("kendoMobileListView").scroller().scrollTo(0,-t.properties.scrollOffset),t.isPaginatorActive=!1):($(".bz-wp-taskfeed-paginator-container",t.content).css("display","none"),$(".bz-wp-taskfeed-paginator-container",t.content).data("paginator",!1),t.isPaginatorActive=!1)},configureHandlers:function(){var e=this;$("#taskfeedPaginatorFirst",e.content).on("click",function(t,a){e.isFirstElement=!0,e.navigateToPage(1,null,!0,a)}),$("#taskfeedPaginatorBack",e.content).on("click",function(t,a){e.totalPages&&e.properties.page>1&&(e.isFirstElement=!0,e.navigateToPage(e.properties.page-1,null,!0,a))}),$("#taskfeedPaginatorNext",e.content).on("click",function(t,a){e.totalPages&&e.totalPages>e.properties.page&&(e.isFirstElement=!0,e.navigateToPage(e.properties.page+1,null,!0,a))}),$("#taskfeedPaginatorLast",e.content).on("click",function(t,a){e.totalPages&&(e.isFirstElement=!0,e.navigateToPage(e.totalPages,null,!0,a))}),$("#loadMoreTaskFeed",e.content).on("click",function(t,a){e.setCurrentScrollerOfset(),e.navigateToPage(e.properties.page+1,null,!1,a)})},navigateToPage:function(e,t,a,i){var n=this,r={more:!0};n.properties.page=e||n.properties.page,a&&$("#items-content-taskFeed",n.content).data("kendoMobileListView").dataSource.data([]),t&&(r.pageSize=t),bizagi.loading.start(),$.when(n.loadDataList(r)).done(function(e){i&&i()}).always(function(){bizagi.loading.stop()})},setCurrentScrollerOfset:function(){this.properties.scrollOffset=$("#items-content-taskFeed",this.content).data("kendoMobileListView").scroller().scrollTop,this.properties.scrollOffset=this.properties.scrollOffset<0?-1:this.properties.scrollOffset},showSummary:function(e){},setFavorite:function(e){var t,a,i=this,n=$(e.context),r=e.idCase,o=n.attr("data-id-object"),s=$("#items-content-taskFeed",i.content).data("kendoMobileListView");i.selectedItem&&(t=i.selectedItem.dataItem,a=i.selectedItem.item),bizagi.util.isEmpty(o)?$.when(i.dataService.addFavorite({idObject:r,favoriteType:"CASES"})).done(function(e){n=i.changeFavoriteIcon("active",n),void 0!==t&&void 0!==a&&(t=i.changeFavoriteValues(t,!0,e.idFavorites),s.setDataItem(a,t),i.selectedItem.dataItem=t,i.selectedItem.item=$("li [data-uid="+t.uid+"]",s.element)),n.attr("data-id-object",e.idFavorites),i.cacheFavorites[r]={add:!0,idFavorites:e.idFavorites}}):$.when(i.dataService.delFavorite({idObject:o,favoriteType:"CASES"})).done(function(e){bizagi.util.parseBoolean(e.deleted)&&(n=i.changeFavoriteIcon("inactive",n),void 0!==t&&void 0!==a&&(t=i.changeFavoriteValues(t,!1,""),s.setDataItem(a,t),i.selectedItem.dataItem=t,i.selectedItem.item=$("li [data-uid="+t.uid+"]",s.element)),n.attr("data-id-object",""),i.cacheFavorites[r]={add:!1,idFavorites:""})})},changeFavoriteIcon:function(e,t){return"active"==e?t.removeClass("bz-star").addClass("bz-star-full"):t.removeClass("bz-star-full").addClass("bz-star"),t},changeFavoriteValues:function(e,t,a){return e[9]=t,e[8]=a,e},toggleOfflineMenuIcon:function(e){var t=this,a=t.getContainerHeader(),i=a.find(t.Class.BUTTON_OFFLINE_DROPDOWN),n=a.find(".km-icon.km-arrow-right.km-notext"),r=a.find(".km-icon.km-arrow-left.km-notext");i&&n&&r&&(!0===e?(i.attr("data-icon","arrow-left"),n.removeClass("km-arrow-right").addClass("km-arrow-left")):(i.attr("data-icon","arrow-right"),r.removeClass("km-arrow-left").addClass("km-arrow-right")))},configureOfflineMenuHandler:function(){var e=this;if(bizagi.util.hasOfflineFormsEnabled()){var t=$(e.Class.BUTTON_OFFLINE_DROPDOWN),a=$(".bz-header-menu-title");t&&t.on("click",e.menuOfflineToggleHandler.bind(e)),a&&a.on("click",e.menuOfflineToggleHandler.bind(e))}},menuOfflineToggleHandler:function(){var e=this,t=$(".bz-wp-home-offline-menu-container",e.canvas);"none"===t.css("display")?(e.toggleOfflineMenuIcon(!0),e.hideSortList(),e.hideProcessList(),t.fadeIn()):(e.toggleOfflineMenuIcon(!1),t.fadeOut())},hideSortList:function(){var e=this;if("none"!=$(".bz-wp-home-sort-menu-container",e.canvas).css("display")){var t=$(".bz-header-sort-btn");t&&t.click()}},hideProcessList:function(){var e=this;if("none"!=$("#active-process-list",e.canvas).css("display")){var t=$("#div-last-open-inbox-item");t&&t.click()}}}),$.Class.extend("bizagi.workportal.activity.search",{SEARCH_PAGE_SIZE:40,SEARCH_PAGE_FIRST:1,SEARCH_PROCESS_SIZE:2,DELAY_FOCUS_INPUT:850,PROCESS_CONTEXT_ENABLED:!1},{init:function(e,t,a){var i=this;i.workportalFacade=e,i.dataService=t,i.controller=a,i.activeAdvancedSearch=bizagi.util.validateFeatureSupport("advancedSearch"),i.activeTaskColorState=bizagi.util.validateFeatureSupport("taskColorState")},render:function(){var e=this;$.when(e.renderContent()).then(function(){e.postRender()})},renderContent:function(){},postRender:function(){},getFiltersApplied:function(){var e=this,t=[];if(void 0!==e.filters.radNumber&&""!==e.filters.radNumber&&t.push({field:"radNumber",value:e.filters.radNumber}),void 0!==e.filters.favorites&&e.filters.favorites&&t.push({field:"isFavorite",value:e.filters.favorites}),void 0!==e.filters.idwfclass&&t.push({field:"idwfclass",value:e.filters.idwfclass}),void 0!==e.filters.state){var a=new Date;switch(e.filters.state){case"upcoming":if(e.activeTaskColorState)t.push({field:"taskStateColor",value:"green"});else{var i=new Date(a.getFullYear(),a.getMonth(),a.getDate()+1,0,0,0,0);t.push({field:"expirationDateMin",value:i.toISOStringHM()})}break;case"ontime":if(e.activeTaskColorState)t.push({field:"taskStateColor",value:"yellow"});else{var n=new Date(a.setSeconds(a.getSeconds()+1));t.push({field:"expirationDateMin",value:n.toISOStringHM()});var r=new Date(a.getFullYear(),a.getMonth(),a.getDate(),23,59,59,0);t.push({field:"expirationDateMax",value:r.toISOStringHM()})}break;case"overdue":default:e.activeTaskColorState?t.push({field:"taskStateColor",value:"red"}):t.push({field:"expirationDateMax",value:a.toISOStringHM()})}}else void 0!==e.filters.custom&&(t.push({field:"expirationDateMin",value:e.filters.custom.startDate.toISOStringHM()}),t.push({field:"expirationDateMax",value:e.filters.custom.endDate.toISOStringHM()}));return t},configureFiltersHandler:function(){var e=this,t=e.modalView.element.find(".ui-bz-wp-activity-search-header input");t.focus(function(){var a=e.$activityList.data("kendoMobileListView");a?a.scroller().one("scroll",function(){t.blur()}):e.modalView.close()}),e.modalView.element.on("click",".km-content",function(){$(this).hasClass("solid-background")||e.modalView.close()}),e.modalView.element.find(".ui-bz-wp-activity-search-filters .ui-bz-wp-as-favorites").bind("click",function(){e.filters.favorites=void 0===e.filters.favorites||!e.filters.favorites,e.filters.favorites?$(this).addClass("active"):$(this).removeClass("active"),e.resetProcessesFilter(),e.applyFilters()}),e.modalView.element.find(".ui-bz-wp-activity-search-filters .date-filter.status").bind("click",function(){var t=$(this).data("state");e.modalView.element.find(".ui-bz-wp-activity-search-filters .date-filter").removeClass("active"),void 0!==e.filters.state&&e.filters.state===t?(e.filters.state=void 0,$(this).removeClass("active")):(e.filters.state=t,e.filters.custom=void 0,$(this).addClass("active")),e.resetProcessesFilter(),e.applyFilters()});e.modalView.element.find(".ui-bz-wp-activity-search-filters .ui-bz-wp-as-calendar").mobiscroll().calendar({lang:bizagi.util.languages[BIZAGI_LANGUAGE]||"en",display:"bottom",outerMonthChange:!1,endYear:(new Date).getFullYear()+10,controls:["calendar","time"],buttons:["cancel",{text:e.controller.getResource("render-plugin-search-users-clear-button-name"),handler:function(t,a){e.filters.custom=void 0,e.modalView.element.find(".ui-bz-wp-activity-search-filters .ui-bz-wp-as-calendar").removeClass("active"),e.applyFilters(),a.cancel()}},"set"],onBeforeShow:function(t,a){var i=void 0!==e.filters.custom?e.filters.custom.startDate:new Date;a.rCurrent="start",a.rStartDate=i,a.setVal(a.rStartDate),a.rToDate=void 0!==e.filters.custom?e.filters.custom.endDate:new Date(a.rStartDate.getTime()+86403600),a.setRange=function(e){var t=this;"start"===t.rCurrent?(t.rStartDate=e.date,t.rStartDate>t.rToDate&&(t.rToDate=new Date(t.rStartDate.getTime()+86403600),$(".mbsc-range-btn-v-end",t.headerTemp).text(bizagi.util.dateFormatter.formatDate(t.rToDate,"dd/MM/yyyy hh:mm tt"))),$(".mbsc-range-btn-v-start",t.headerTemp).text(bizagi.util.dateFormatter.formatDate(t.rStartDate,"dd/MM/yyyy hh:mm tt"))):(t.rToDate=e.date,t.rToDate<t.rStartDate&&(t.rStartDate=new Date(t.rToDate.getTime()-86403600),$(".mbsc-range-btn-v-start",t.headerTemp).text(bizagi.util.dateFormatter.formatDate(t.rStartDate,"dd/MM/yyyy hh:mm tt"))),$(".mbsc-range-btn-v-end",t.headerTemp).text(bizagi.util.dateFormatter.formatDate(t.rToDate,"dd/MM/yyyy hh:mm tt")));var a=new Date(t.rStartDate.getFullYear(),t.rStartDate.getMonth(),t.rStartDate.getDate(),0,0,0,0),i=new Date(t.rToDate.getFullYear(),t.rToDate.getMonth(),t.rToDate.getDate(),0,0,0,0),n=$(".mbsc-cal-day[data-full]",t._markup);n.removeClass("selected_in_range"),n.each(function(e,t){var n=$(t).data("full").split("-"),r=new Date(n[0],n[1],n[2],0,0,0,0);a<=r&&r<=i&&$(t).addClass("selected_in_range")}),t.isValidRange=t.rStartDate<=t.rToDate}},onChange:function(e,t){t.setRange({date:t.selectedTime})},onDayChange:function(e,t){t.setRange({date:e.date})},onValueTap:function(e,t){t.setRange({date:"start"==t.rCurrent?t.rStartDate:t.rToDate})},onTabChange:function(e,t){t.setRange({date:"start"==t.rCurrent?t.rStartDate:t.rToDate})},onMonthLoaded:function(e,t){t.setRange({date:"start"==t.rCurrent?t.rStartDate:t.rToDate})},onMarkupReady:function(e,t){t.headerTemp=$.kendoTmpls('<div class="mbsc-range-btn-t" role="radiogroup">   <div class="mbsc-range-btn-c mbsc-range-btn-start mbsc-range-btn-sel" aria-checked="true" data-range="start">       <div role="radio" class="mbsc-fr-btn-e mbsc-fr-btn-nhl mbsc-range-btn">          #: data.startText #<div class="mbsc-range-btn-v mbsc-range-btn-v-start">#: data.rStartDate #</div>       </div>   </div>   <div class="mbsc-range-btn-c mbsc-range-btn-end" data-range="end">       <div role="radio" class="mbsc-fr-btn-e mbsc-fr-btn-nhl mbsc-range-btn">           #: data.toText#<div class="mbsc-range-btn-v mbsc-range-btn-v-end">#: data.rToDate #</div>       </div>   </div></div>',{startText:t.settings.fromText,toText:t.settings.toText,rStartDate:bizagi.util.dateFormatter.formatDate(t.rStartDate,"dd/MM/yyyy hh:mm tt"),rToDate:bizagi.util.dateFormatter.formatDate(t.rToDate,"dd/MM/yyyy hh:mm tt")}),$(".mbsc-range-btn-c",t.headerTemp).bind("click",function(){$(".mbsc-range-btn-c",t.headerTemp).removeClass("mbsc-range-btn-sel"),$(this).addClass("mbsc-range-btn-sel");var e="start"==$(this).data("range")?t.rStartDate:t.rToDate;t.rCurrent=$(this).data("range"),t.navigate(e),t.setVal(e,!0),t.setRange({date:e})}),$(".mbsc-cal-tabs",e.target).before(t.headerTemp),t.setRange({date:t.rStartDate})},onSet:function(t,a){if(a.isValidRange)e.modalView.element.find(".ui-bz-wp-activity-search-filters .date-filter").removeClass("active"),$(this).addClass("active"),e.filters.state=void 0,e.filters.custom={},e.filters.custom.startDate=a.rStartDate,e.filters.custom.endDate=new Date(a.rToDate.getFullYear(),a.rToDate.getMonth(),a.rToDate.getDate(),a.rToDate.getHours(),a.rToDate.getMinutes(),59,0),e.resetProcessesFilter(),e.applyFilters();else{var i=e.controller.getResource("workportal-widget-templateengine-action-rule-error"),n=e.controller.getResource("workportal-widget-comments-filter");$.notifier.add({title:n,text:printf(i,n),class_name:"error"})}},onSetDate:function(e,t){t.selectedTime=e.date}});var a=bizagi.util.debounce(function(){var t=this.value;e._search_value=t,e.filters.radNumber=t,e.filters.radNumber||e.resetProcessesFilter(),e.applyFilters()},250);t.bind("keyup",a),setTimeout(function(){t.focus()},e.Class.DELAY_FOCUS_INPUT)},setContentBackgroundColor:function(e){var t=this;"white"===e?(t.modalView.header.find(".activity-empty-list").hide(),t.modalView.content.addClass("solid-background")):(t.modalView.header.find(".activity-empty-list").show(),t.modalView.content.removeClass("solid-background"))},applyFilters:function(){var e=this,t=e.getFiltersApplied();t&&t.length>0?e.activityDataSource.filter(t):(e.activityDataSource.data([]),e.processDataSource.data([]),e.modalView.header.find(".activity-empty-list").hide(),e.modalView.content.removeClass("solid-background")),e.modalView.scroller.reset()},resetProcessesFilter:function(){var e=this;void 0!==e.filters.idwfclass&&e._process_filter&&!e._context_process&&(e.filters.idwfclass=void 0,e._process_filter=!1)},openCase:function(e){var t=this;void 0!==e&&t.controller.publish("changeCase",{idCase:e.idcase,idWorkitem:e.idworkitem,idTask:e.taskid,displayName:e.currenttask,radNumber:e.radnumber,isEvent:e.isevent||e.isEvent||!1})},setLastProcessInboxFilter:function(){var e=this,t=bizagi.util.getLastProcessInboxProcessInfo(),a=t.idWorkflow;-1!=a&&(e._process_filter=!0,e._context_process=!0,e.filters.idwfclass=a,e.processDataSource.data([{processname:t.processInfoName,idwfclass:a,active:"active"}]))}}),bizagi.workportal.webparts.taskFeed.extend("bizagi.workportal.webparts.taskFeed",{},{init:function(e,t,a){var i=this;i._super(e,t,a),bizagi.webpart.subscribe("homeportalShow-taskFeed",function(e,t){i.initTaskFeedKendoView(),i.updateDataList()})},renderContent:function(e){return this._super(e)},postRender:function(e){var t=this;t._super(e),t.configureOfflineMenuHandler()},configureHandlers:function(){var e=this;e.getContent().find(".km-rightitem").click(function(){bizagi.webpart.publish("bz-new-case")}),e._super()},activeAdvanceSearch:function(e){var t=this;void 0!==t.view&&(e?(t.view.header.find(".km-rightitem .bz-search-icon").show(),t.view.header.find(".km-rightitem .bz-search-icon").unbind().click(function(){t.activitySearch.render()})):t.view.header.find(".km-rightitem .bz-search-icon").hide())},configureModalViewHandlers:function(){var e=this;$(".km-modalview-root").off("click").click(function(e){e.target===e.currentTarget&&$("#modalview-summary").data("kendoMobileModalView").close()}),$("#modalview-summary").delegate(".bz-wp-modal-newcase-footer .km-rightitem","click",function(t){var a=$("#WorkOnItModalView").data("item");e.changeCase(a)}),$("#modalview-summary").delegate(".bz-favorite-case","click",function(t){var a=this,i=$(".bz-wp-modal-content",$(a).parents("#modalview-summary")).data("case");e.setFavorite({context:a,idCase:i})})},showSummary:function(e){var t=this,a=e.dataItem,i=e.dataItem[0];t.selectedItem={item:e.item,dataItem:e.dataItem};var n={mobileDevice:!0,idWorkflow:e.dataItem.idwfclass||""};bizagi.util.isNumeric(i)?n.idCase=i:n.radNumber=i,bizagi.loading.start(),$.when(t.dataService.getCasesByWorkflow(n)).done(function(e){for(var i,n=-1;i=e.rows[++n];)if(i.id===a[0]){a[6]=[],i.radnumber&&i.casenumberdisplayname&&a[6].push([i.casenumberdisplayname,i.radnumber]);for(var r,o=-1;r=i.fields[++o];){var s;if("object"==typeof r.Value){for(var l,c=-1;l=r.Value[++c];)if(""!==l){s=[r.DisplayName,l,r.DataType],a[6].push(s);break}}else s=[r.DisplayName,r.Value,r.DataType],a[6].push(s)}break}var d=t.getTemplate("summary-taskFeed-kendo-tmpl"),u=kendo.template(d,{useWithBlock:!1,useNativeScrolling:!0});$(u(a)).kendoMobileModalView({close:function(e){this.destroy(),this.close(),this.element.remove()}}),t.configureModalViewHandlers(),$("#WorkOnItModalView").data("item",a);var p=t.cacheFavorites[a[0]]?t.cacheFavorites[a[0]].idFavorites:a[8];$(".bz-favorite-case","#modalview-summary").attr("data-id-object",p);var m=$("#modalview-summary").data("kendoMobileModalView");m.open(),m.adjustSize=function(){var e=$(".bz-wp-modal-content",this.element).height(),t=0,a=window.innerHeight,i=$(".km-header",this.wrapper).height()+$(".km-footer",this.wrapper).height();t=e+i>=a?a-20:e+i+10;var n=(a-t)/2;this.wrapper.parent().css("top",n),this.wrapper.parent().css("height",t)},m.adjustSize(),window.addEventListener("orientationchange",function(){setTimeout(function(){m.adjustSize()},250)},!1)}).fail(function(e){bizagi.log(e.responseText)}).always(function(){bizagi.loading.stop()})},getContainerHeader:function(){return $("#taskFeed")}}),bizagi.workportal.activity.search.extend("bizagi.workportal.activity.search",{},{renderContent:function(){var e=this;e.filters={},e._process_filter=!1;var t=$.kendoTmpls(e.workportalFacade.getTemplate("activity-search-view"),{showFilters:e.activeAdvancedSearch});e.modalView=new kendo.mobile.ui.ModalView(t,{close:function(e,t){this.destroy(e,t),this.element.remove()}}),e.activityDataSource=new kendo.data.DataSource({transport:{read:{url:e.activeAdvancedSearch?e.dataService.serviceLocator.getUrl("case-handler-getActivityList"):e.dataService.serviceLocator.getUrl("process-handler-getCustomizedColumnsDataInfo")},parameterMap:function(t){bizagi.loading.startInnerLoader(e.modalView.content);var a={page:t.page||e.Class.SEARCH_PAGE_START,pageSize:t.pageSize||e.Class.SEARCH_PAGE_SIZE};if(t.filter)for(var i,n=-1;i=t.filter.filters[++n];)a[i.field]=i.value;return a}},schema:{parse:function(t){var a=e.dataService.processActivitiesResponse(t,e._search_value,e._process_filter);return e.processDataSource.data(a.processes.length>e.Class.SEARCH_PROCESS_SIZE?a.processes.slice(0,e.Class.SEARCH_PROCESS_SIZE):a.processes),e.setContentBackgroundColor(a.elements.length>0?"white":"transparent"),bizagi.loading.stopInnerLoader(e.modalView.content),a},data:"elements",total:"totalRecords"},serverFiltering:!0,serverPaging:!0,page:e.Class.SEARCH_PAGE_START,pageSize:e.Class.SEARCH_PAGE_SIZE});var a=e.workportalFacade.getTemplate("pull-loader"),i=e.workportalFacade.getTemplate("refresh-loader");e.$activityList=e.modalView.element.find("#activity-list").kendoMobileListView({autoBind:!1,loadMore:!0,messages:{loadMoreText:e.controller.getResource("workportal-widget-inbox-load-more"),pullTemplate:a,refreshTemplate:i,releaseTemplate:i},dataSource:e.activityDataSource,template:e.workportalFacade.getTemplate("activity-search-activity-item"),click:function(t){e.openCase(t.dataItem)}}),e.processDataSource=new kendo.data.DataSource,e.modalView.element.find("#process-list").kendoMobileListView({dataSource:e.processDataSource,template:e.workportalFacade.getTemplate("activity-search-process-item"),click:function(t){($(t.target).hasClass("bz-cancel")||void 0===e.filters.idwfclass)&&(void 0!==e.filters.idwfclass&&e.filters.idwfclass===t.dataItem.idwfclass?(e.filters.idwfclass=void 0,e._process_filter=!1):(e._process_filter=!0,e.filters.idwfclass=t.dataItem.idwfclass),e.applyFilters())}})},postRender:function(){var e=this;e.modalView.open(),e.modalView.element.find(".ui-bz-wp-activity-search-header .bz-cancel").bind("click",function(){e.modalView.close()}),e.configureFiltersHandler()}});
//# sourceMappingURL=webpart.smartphoneandroid.production.js.map