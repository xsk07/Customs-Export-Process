bizagi.workportal.widgets.project.base.extend("bizagi.workportal.widgets.project.plan.activity.sidebar",{},{init:function(e,t,i,a){this._super(e,t,a),this.serviceloadDataPlan=i,this.loadTemplates({"project-plan-activity-sidebar":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.activity.sidebar").concat("#project-plan-activity-sidebar")})},renderContent:function(){var e=this.getTemplate("project-plan-activity-sidebar");return this.content=e.render({}),this.content},postRender:function(){this.sub("LOAD_INFO_PLAN",$.proxy(this.onNotifyLoadInfoPlan,this))},onNotifyLoadInfoPlan:function(e,t){if(this.params.plan.idActivitySelected){var i={idPlan:this.params.plan.id};this.serviceloadDataPlan.loadData(i,this.getDateServer,this.params),this.serviceloadDataPlan.subscribe("loadedWithDataActivities",$.proxy(this.loadedWithDataActivities,this)),this.serviceloadDataPlan.subscribe("loadedWithDataFirstParent",$.proxy(this.loadedWithDataFirstParent,this))}},loadedWithDataActivities:function(){this.pub("notify",{type:"LOADED_ACTIVITIES_PLAN",args:this.params}),this.pub("notify",{type:"LOAD_INFO_SUMMARY_PROGRESS_PLAN",args:this.params}),this.pub("notify",{type:"LOAD_INFO_ACTIVITY_SUMMARY",args:this.params}),this.pub("notify",{type:"LOAD_INFO_ACTIVITIES_PLAN",args:this.params})},loadedWithDataFirstParent:function(){this.pub("notify",{type:"LOAD_INFO_SUMMARY_PLAN",args:this.params})},clean:function(){this.serviceloadDataPlan&&(this.serviceloadDataPlan.unsubscribe("loadedWithDataActivities",$.proxy(this.loadedWithDataActivities,this)),this.serviceloadDataPlan.unsubscribe("loadedWithDataFirstParent",$.proxy(this.loadedWithDataFirstParent,this)))}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.activity.sidebar",["workportalFacade","dataService","bizagi.workportal.services.behaviors.loadDataPlan",bizagi.workportal.widgets.project.plan.activity.sidebar],!0),bizagi.workportal.widgets.project.base.extend("bizagi.workportal.widgets.project.plan.activity.action",{},{init:function(e,t,i,a){this._super(e,t,a),this.dateFormat=bizagi.localization.getResource("dateFormat"),this.timeFormat=bizagi.localization.getResource("timeFormat"),this.estimatedFinishDateTime,this.beforeUserAssignedActivity="",this.notifier=i,this.loadTemplates({"activity-action-main":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.activity.action").concat("#project-plan-activity-action"),"activity-action-editionpopup":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.activity.action").concat("#project-plan-activity-action-editionpopup")}),this.dialogBox={}},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){this.sub("LOAD_INFO_ACTIVITY_SUMMARY",$.proxy(this.onNotifyLoadInfoActivityExecution,this)),this.sub("EXPANDED_RIGHT_SIDEBAR",$.proxy(this.onNotifyExpandedRightSidebar,this))},onNotifyLoadInfoActivityExecution:function(e,t){var i=this;i.params=$.extend(i.params,t.args);var a=i.getContent().empty(),r={};if(i.params.plan.idActivitySelected&&(r=i.params.plan.activities.filter((function(e){return e.id.toUpperCase()===i.params.plan.idActivitySelected.toUpperCase()}))[0]),i.params.plan.idUserCreator===bizagi.currentUser.idUser||r.userAssigned==bizagi.currentUser.idUser){var o={};o.currentActivityName=r.name,o.showEditAction=!0,i.params.plan.idUserCreator!==bizagi.currentUser.idUser&&(o.showEditAction=!1);var s=i.getTemplate("activity-action-main");a.append(s.render(o)),o.showEditAction&&(i.initilizeActionMenu(),i.beforeUserAssignedActivity=r.userAssigned,i.content.append(a),i.initializeTempleteAndEvents())}},initializeTempleteAndEvents:function(){this.plugins={},this.plugins.activityEdition=this.initPluginPopupEdition(),this.formEditActivity={assignee:$("#activity-form-assignee",this.plugins.activityEdition),date:$("#activity-form-date",this.plugins.activityEdition),duration:$("#activity-form-duration",this.plugins.activityEdition),buttonCancel:$("#ui-bizagi-wp-project-popupform-action-cancel",this.plugins.activityEdition),buttonUpdate:$("#ui-bizagi-wp-project-popupform-action-update",this.plugins.activityEdition)},this.formEditActivity.buttonCancel.on("click",$.proxy(this.onClickPopupButtonCancel,this)),this.formEditActivity.buttonUpdate.on("click",$.proxy(this.onClickPopupButtonUpdate,this)),this.formEditActivity.date.on("keydown",$.proxy(this.onDeleteDate,this)),this.formEditActivity.duration.on("keyup",$.proxy(this.onTypeDuration,this))},onNotifyExpandedRightSidebar:function(){this.initilizeActionMenu()},initilizeActionMenu:function(){$("#ui-bizagi-wp-project-plan-activity-action .menu",this.content).menu({select:$.proxy(this.onSelectMenu,this)}).removeClass("ui-widget-content")},initPluginPopupEdition:function(){var e=this.getTemplate("activity-action-editionpopup");return this.dialogBox.formContent=e.render({}),this.dialogBox.formContent},initializeAutoComplete:function(e){var t=this,i=t.dataService.serviceLocator.getUrl("admin-getUsersList");e.autocomplete({minLength:2,source:function(e,t){$.ajax({url:i,data:{domain:"",userName:"",fullName:e.term,organization:"",pag:1,pagSize:100,orderField:"fullName"},success:function(e){t($.map(e.users,(function(e){return{label:e.user,value:e.idUser}})))}})},select:function(i,a){var r=a.item.label;return e.val(r),t.formEditActivity.IdAssignee=a.item.value,!1},focus:function(){return!1},change:function(e,i){return null===i.item&&(t.formEditActivity.IdAssignee=null,t.formEditActivity.assignee.val("")),!1}})},initializeDatePicker:function(e){var t=this;e.datepicker({onSelect:function(){t.formEditActivity.duration.val(""),t.estimatedFinishDateTime=t.formEditActivity.date.datepicker("getDate")?t.formEditActivity.date.datepicker("getDate").getTime():void 0}}),e.datepicker("option","dateFormat",bizagi.util.dateFormatter.getDateFormatByDatePickerJqueryUI())},initializeSpiner:function(e){var t=this;function i(e,i){var a=i||$(e.target).val();bizagi.util.isNumeric(a)&&parseInt(a,10)>0?(t.formEditActivity.date.val(""),t.estimatedFinishDateTime=void 0):$(e.target).val("")}e.spinner({min:1,max:1e3,placeHolder:bizagi.localization.getResource("workportal-hours"),change:function(e){i(e)},spin:function(e,t){i(e,t.value)}})},onDeleteDate:function(e){8===e.keyCode&&($(e.target).val(""),this.fieldDurationActive(!0))},onTypeDuration:function(e){""!==$(e.target).val()?this.estimatedFinishDateTime=void 0:this.activateElement(this.form.date)},onSelectMenu:function(e,t){if(0===$(e.currentTarget).find("i").length)switch($(t.item).data("item")){case"edit":this.onClickOpenPopupEdition()}},onClickOpenPopupEdition:function(){this.initializeTempleteAndEvents(),this.dialogBox.formContent.dialog({resizable:!1,draggable:!1,height:"auto",width:"600px",modal:!0,title:bizagi.localization.getResource("workportal-project-plan-title-activity-properties"),maximize:!0,open:$.proxy(this.onOpenPopupEdition,this),close:$.proxy(this.onClosePopupEdition,this)})},onOpenPopupEdition:function(){var e=this,t=e.params.plan.activities.filter((function(t){return t.id.toUpperCase()===e.params.plan.idActivitySelected.toUpperCase()}))[0],i=t&&!bizagi.util.isEmpty(t.estimatedFinishDate)?t.estimatedFinishDate:"";isNaN(i)||(i=bizagi.util.dateFormatter.formatInvariant(new Date(i)));var a=i?bizagi.util.dateFormatter.getDateFromInvariant(i):"",r=a instanceof Date&&a.getTime()<e.getDateServer();e.initializeAutoComplete(e.formEditActivity.assignee),e.initializeDatePicker(e.formEditActivity.date),e.initializeSpiner(e.formEditActivity.duration),t.userAssigned&&e.setUserAssignedById(t.userAssigned),e.formEditActivity.date.datepicker("option","minDate",new Date(e.getDateServer())),t.estimatedFinishDate&&r&&e.formEditActivity.date.datepicker("option","minDate",a),t.estimatedFinishDate&&(a&&e.formEditActivity.date.datepicker("setDate",a),e.estimatedFinishDateTime=t.estimatedFinishDate),t.duration&&e.formEditActivity.duration.val(parseInt(t.duration,10))},onClosePopupEdition:function(){this.removePopupWidgets()},setUserAssignedById:function(e){var t=this;t.callGetDataUsers(e).then((function(e){t.formEditActivity.assignee.val(e[0].name)})),t.formEditActivity.IdAssignee=e},onClickPopupButtonCancel:function(e){e.preventDefault(),this.removePopupWidgets()},removePopupWidgets:function(){this.formEditActivity.assignee.next().find("span").html(""),this.dialogBox.formContent.remove(),$("#ui-datepicker-div").remove()},onClickPopupButtonUpdate:function(){var e=this;if(e.validateParamsOfFormEditActivity()){var t=e.params.plan.activities.filter((function(t){return t.id.toUpperCase()===e.params.plan.idActivitySelected.toUpperCase()}))[0],i=e.formEditActivity.IdAssignee||bizagi.currentUser.idUser;""!=e.formEditActivity.duration.val()&&(e.params.plan.activities.filter((function(t){return t.id.toUpperCase()===e.params.plan.idActivitySelected.toUpperCase()}))[0].estimatedFinishDate="");var a={progress:t.progress,id:t.id,startDate:t.startDate,duration:e.formEditActivity.duration.val(),userAssigned:i,allowEdition:t.allowEdition,description:t.description,name:t.name,idPlan:t.idPlan,estimatedFinishDate:e.estimatedFinishDateTime,finishDate:t.finishDate,items:t.items};$.when(e.dataService.editActivityPlan(a)).done((function(){t=$.extend(t,a),e.removePopupWidgets(),e.beforeUserAssignedActivity!==e.formEditActivity.IdAssignee?e.pub("notify",{type:"ACTIVITYPLANCOMMENTS",args:$.extend(e.params,{refreshAllWidgets:!0})}):e.pub("notify",{type:e.params.showContextByMenuDashboard,args:e.params}),e.removePopupWidgets(),e.notifier.showSucessMessage(bizagi.localization.getResource("workportal-project-plan-activity-update-message"))}))}},onClickFavorite:function(e){e.preventDefault();var t=this,i={};$(e.target).hasClass("bz-icon-star-outline")?(i={idObject:t.params.idCase,favoriteType:"CASES"},$.when(t.dataService.addFavorite(i)).done((function(i){t.params.guidFavorite=i.idFavorites,$(e.target).removeClass("bz-icon-star-outline"),$(e.target).addClass("bz-icon-star")}))):(i={idObject:t.params.guidFavorite,favoriteType:"CASES"},$.when(t.dataService.delFavorite(i)).done((function(){$(e.target).addClass("bz-icon-star-outline"),$(e.target).removeClass("bz-icon-star")})))},clean:function(){this.unsub("LOAD_INFO_ACTIVITY_SUMMARY",$.proxy(this.onNotifyLoadInfoActivityExecution,this)),this.unsub("EXPANDED_RIGHT_SIDEBAR",$.proxy(this.onNotifyExpandedRightSidebar,this))},validateParamsOfFormEditActivity:function(){var e=this.formEditActivity.assignee;if(e.val()&&""!==e.val()&&this.formEditActivity.IdAssignee)return!0;var t=bizagi.localization.getResource("workportal-general-error-field-required");return t=t.replace("{0}",bizagi.localization.getResource("workportal-project-plan-assignee").toLowerCase()),e.next().find("span").html(t),!1},callGetDataUsers:function(e){var t=$.Deferred(),i={userIds:e,width:50,height:50};return this.dataService.getUsersData(i).always((function(e){t.resolve(e)})),t.promise()}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.activity.action",["workportalFacade","dataService","notifier",bizagi.workportal.widgets.project.plan.activity.action]),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.plan.activity.time",{},{init:function(e,t,i){this._super(e,t,i),this.EXECUTING_ACTIVITY="EXECUTING",this.FINISHED_ACTIVITY="FINISHED",this.datePickerRegional=bizagi.localization.getResource("datePickerRegional"),this.loadTemplates({"plan-time-main":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.activity.time").concat("#project-plan-activity-time")})},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){this.sub("LOAD_INFO_ACTIVITY_SUMMARY",$.proxy(this.onNotifyLoadInfoActivitySummary,this))},onNotifyLoadInfoActivitySummary:function(e,t){var i=this;i.params=$.extend(i.params,t.args),i.getContent().empty();var a=i.params.plan.activities.filter((function(e){return e.id===i.params.plan.idActivitySelected}))[0];if(a.startDate){i.getStateActivity(a);var r={time:{fromDate:i.getFormattedDate(new Date(i.getFirstDate(a)))}},o=i.getDataByScenarios(a,!0);$.when(o.unitTime).done((function(e){o=$.extend(o,{unitTime:e}),i.updateWidget($.extend(r.time,o))}))}},updateWidget:function(e){var t=this.getContent().empty(),i=this.getTemplate("plan-time-main"),a=bizagi.util.dateFormatter.getRelativeTime(new Date(Date.now()-60*e.unitTime.minutes*1e3),null,!1),r=bizagi.localization.getResource("workportal-project-activity-state-"+e.keywordResource);e.messageTime=r.replace("%s",a),i.render(e).appendTo(t);var o=$(".remaining-days .time-remaining",t),s=$(".remaining-days .days",t).width();o.css("padding-left",(s+7).toString()+"px"),$(".remaining-days .bar-completed",t).css("width",e.percentBar+"%")},getStateActivity:function(e){return e.finishDate?(e.currentState=this.FINISHED_ACTIVITY,this.FINISHED_ACTIVITY):(e.currentState=this.EXECUTING_ACTIVITY,this.EXECUTING_ACTIVITY)},getFirstDate:function(e){return e.currentState===this.EXECUTING_ACTIVITY?e.startDate:e.finishDate},getDataByScenarios:function(e){var t={colorBar:null,percentBar:100,keywordResource:null,unitTime:null},i={};switch(e.currentState){case this.EXECUTING_ACTIVITY:t.keywordResource="opened",t.colorBar=this.getColorByCreatedAndEstimatedDate(e),i={idUser:bizagi.currentUser.idUser,fromDate:e.startDate,toDate:Date.now()},t.unitTime=this.callGetEffectiveDuration(i);break;case this.FINISHED_ACTIVITY:t.colorBar="Gray",t.keywordResource="closed",i={idUser:bizagi.currentUser.idUser,fromDate:e.finishDate,toDate:Date.now()},t.unitTime=this.callGetEffectiveDuration(i)}return t},getColorBar:function(e){return this.getDataByScenarios(e).colorBar},getPercentBar:function(e){return this.getDataByScenarios(e).percentBar},getKeywordResourceDescriptionBar:function(e){return this.getDataByScenarios(e).keywordResource},getUnitTime:function(e){return this.getDataByScenarios(e).unitTime},getColorByCreatedAndEstimatedDate:function(e){var t="Red";e.estimatedFinishDate&&(Date.now()<e.estimatedFinishDate&&(t=(new Date).getUTCDate()===new Date(e.estimatedFinishDate).getUTCDate()?"Yellow":"Green"));return t},getFormattedDate:function(e){return this.datePickerRegional.monthNames[e.getMonth()]+" "+bizagi.util.dateFormatter.formatDate(e,"dd hh:mm tt",bizagi.localization.getResource("datePickerRegional"))},callGetEffectiveDuration:function(e){var t=$.Deferred();return $.when(this.dataService.getEffectiveDuration(e)).done((function(e){t.resolve(e)})),t.promise()}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.activity.time",["workportalFacade","dataService",bizagi.workportal.widgets.project.plan.activity.time],!0),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.plan.activity.progress",{},{init:function(e,t,i){this._super(e,t,i),this.plugins={},this.dialogBox={},this.loadTemplates({"plan-progress-main":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.activity.progress").concat("#project-plan-activity-progress"),"plan-progress-popup-edit":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.activity.progress").concat("#project-plan-activity-edit-progress")})},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){this.sub("LOAD_INFO_ACTIVITY_SUMMARY",$.proxy(this.onNotifyLoadInfoActivityExecution,this)),this.sub("UPDATE_ITEMS_FROM_FORMRENDER",$.proxy(this.onNotifyUpdateItemFromRender,this))},onNotifyLoadInfoActivityExecution:function(e,t){var i=this;i.params=$.extend(i.params,t.args);var a=i.getContent().empty(),r=i.params.plan.activities.filter((function(e){return e.id.toUpperCase()==i.params.plan.idActivitySelected.toUpperCase()}))[0],o={valuePercentBarComplete:0};o.progress={progress:r.progress,canEdit:0===r.items.length},o.progress.progress&&(o.valuePercentBarComplete=o.progress.progress),i.getTemplate("plan-progress-main").render(o).appendTo(a),i.plugins.popupEditProgress=i.initPluginPopupEditProgress();var s=i.plugins.popupEditProgress;i.formEditProgress={sliderProgress:$("#sliderProgress",s).slider({orientation:"horizontal",range:"min",max:100,width:100,from:5,to:50,step:1,value:o.valuePercentBarComplete,slide:$.proxy(i.onChangesliderProgress,i),change:$.proxy(i.onChangesliderProgress,i)}).each((function(){for(var e=$(this).slider("option","max")-$(this).slider("option","min"),t=0;t<=e;t+=10){var i=$("<label class='step'>"+t+"</label>").css("left",t/e*100+"%");$(this).append(i)}})),numericTextBoxPlugin:$("#inputProgressNumericTextBox",s).spinner({format:"n0",min:0,max:100,spin:$.proxy(i.onChangeNumericTextBoxProgress,i),change:$.proxy(i.onChangeNumericTextBoxProgress,i),value:o.valuePercentBarComplete,decimals:0}),buttonChangeProgress:$("#button-accept-change-progress",s),buttonCancel:$("#button-cancel-change-progress",s)},$(".action-open-popup-edit-progress",a).on("click",$.proxy(i.onShowPopupEditProgress,i)),i.formEditProgress.buttonCancel.on("click",$.proxy(i.onClickCancel,i)),i.formEditProgress.buttonChangeProgress.on("click",$.proxy(i.onSubmitFormChangeProgress,i)),i.updateProgressUI(o.valuePercentBarComplete),i.formEditProgress.numericTextBoxPlugin.spinner("value",o.valuePercentBarComplete)},onNotifyUpdateItemFromRender:function(e,t){var i=t.args.items,a=t.args.activityWork;i.length>0?$(".action-open-popup-edit-progress",this.content).hide():$(".action-open-popup-edit-progress",this.content).show(),$(".bz-wp-timestamp span",this.content).text(a),$(".bz-wp-progress-bar",this.content).css("width",a+"%")},updateProgressUI:function(e){var t=this.getContent();$(".bz-wp-timestamp span",t).text(e);var i=$(".remaining-days .time-remaining",t),a=$(".remaining-days .days",t).width();i.css("padding-left",(a+7).toString()+"px"),$(".remaining-days .bar-completed",t).css("width",e.toString()+"%")},initPluginPopupEditProgress:function(){var e=this.getTemplate("plan-progress-popup-edit");return this.dialogBox.formContent=e.render(),this.dialogBox.formContent},onShowPopupEditProgress:function(){var e=this;e.dialogBox.formContent.dialog({resizable:!1,draggable:!1,height:"auto",width:"600px",modal:!0,title:bizagi.localization.getResource("workportal-project-plan-progress-title"),maximize:!0,open:$.proxy(e.onOpenPopupPlan,e),close:function(){e.dialogBox.formContent.dialog("destroy"),e.dialogBox.formContent.detach()}}),e.previusValueProgress=e.formEditProgress.sliderProgress.slider("value")},onChangeNumericTextBoxProgress:function(e){var t=this.formEditProgress.numericTextBoxPlugin.spinner("value");this.formEditProgress.sliderProgress.slider("value",t)},onChangesliderProgress:function(e){var t=this.formEditProgress.sliderProgress.slider("value");this.formEditProgress.numericTextBoxPlugin.spinner("value",t)},onClickCancel:function(e){e.preventDefault();this.dialogBox.formContent.dialog("destroy"),this.dialogBox.formContent.detach(),this.formEditProgress.sliderProgress.slider("value",this.previusValueProgress),this.formEditProgress.numericTextBoxPlugin.spinner("value",this.previusValueProgress)},onSubmitFormChangeProgress:function(e){e.preventDefault();var t=this;t.formEditProgress.buttonChangeProgress.prop("disabled",!0);var i=t.params.plan.activities.filter((function(e){return e.id==t.params.plan.idActivitySelected}))[0],a=$.extend(i,{progress:t.formEditProgress.numericTextBoxPlugin.spinner("value"),idPlan:t.params.plan.id});$.when(t.dataService.editActivityPlan(a)).done((function(){t.formEditProgress.buttonChangeProgress.prop("disabled",!1),i.progress=t.formEditProgress.numericTextBoxPlugin.spinner("value"),t.updateProgressUI(i.progress),t.dialogBox.formContent.dialog("destroy"),t.dialogBox.formContent.detach()}))}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.activity.progress",["workportalFacade","dataService",bizagi.workportal.widgets.project.plan.activity.progress],!0),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.plan.activity.subprocesses",{},{init:function(e,t,i){this._super(e,t,i),this.loadTemplates({"project-subprocesses":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.activity.subprocesses").concat("#project-plan-activity-plan-subprocesses-wrapper"),"project-subprocesses-tootip-custom-properties":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.activity.subprocesses").concat("#project-activity-plan-subprocesses-tooltip-custom-properties-wrapper")})},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.activity.subprocesses",["workportalFacade","dataService",bizagi.workportal.widgets.project.plan.activity.subprocesses]),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.plan.activity.parent",{},{init:function(e,t,i){this._super(e,t,i),this.loadTemplates({"plan-parent-main":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.activity.parent").concat("#project-plan-activity-parent")})},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){this.sub("LOAD_INFO_ACTIVITY_SUMMARY",$.proxy(this.onNotifyLoadInfoActivityExecution,this))},onNotifyLoadInfoActivityExecution:function(e,t){var i=this;i.params=$.extend(i.params,t.args);var a=i.getContent().empty();$.when(i.dataService.getPlanParent({idPlan:i.params.plan.id})).done((function(e){if(i.params.plan.parent=e,i.params.plan.parent){var t={};t.parent={idParent:i.params.plan.parent.radNumber,nameParent:i.params.plan.parent.displayName,idCase:i.params.plan.parent.idCase,idWorkflow:i.params.plan.parent.idWorkflow,idWorkItem:i.params.plan.parent.idWorkItem,idTask:i.params.plan.parent.idTask},i.getTemplate("plan-parent-main").render(t).appendTo(a),$("#go-to-parent-case",a).on("click",$.proxy(i.onClickGoToParentCase,i))}}))},onClickGoToParentCase:function(e){e.preventDefault();this.routingExecute($(e.target).closest("#go-to-parent-case"))}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.activity.parent",["workportalFacade","dataService",bizagi.workportal.widgets.project.plan.activity.parent],!0),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.plan.activity.users",{},{init:function(e,t,i){this.usersMap={},this.plugins={},this.usersInformation=[],this.globalHandlersService=bizagi.injector.get("globalHandlersService"),this.usersAssignees=[],this._super(e,t,i),this.loadTemplates({"plan-users-main":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.users").concat("#project-plan-users")})},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){this.sub("LOAD_INFO_ACTIVITY_SUMMARY",$.proxy(this.onNotifyLoadInfoActivityExecution,this))},activityRunning:function(e){return null!==e.startDate&&null===e.finishDate},onNotifyLoadInfoActivityExecution:function(e,t){var i=this,a=[],r=[],o=i.getContent().empty();i.params=$.extend(i.params,t.args);var s=i.params.plan.idUserCreator,n=i.params.plan.idUserCreator;r.push({idUser:s,guidUser:n,userType:["owner"]}),i.usersMap["-"+s+"-"]={picture:"",id:s,guid:n,name:"",userType:["owner"]},a.push(n),$.each(i.params.plan.activities,(function(e,t){if(i.activityRunning(t)){var o=t.userAssigned,n=t.userAssignedGuid;if(o===s)-1===$.inArray("Assigned",r[0].userType)&&(r[0].userType.push("Assigned"),i.usersMap["-"+s+"-"].userType.push("Assigned"));else if(i.usersMap["-"+o+"-"]={picture:"",id:o,name:"",userType:["Assigned"]},0===r.filter((function(e){return e.idUser==o})).length){var l=n||o;r.push({idUser:l,userGuid:l,userType:["Assigned"]}),a.push(l)}}})),i.activitiesUsers=r,i.getTemplate("plan-users-main").render({assignee:i.justAssignees(r),label:bizagi.localization.getResource("workportal-project-plan-assignee")}).appendTo(o),i.addEventHandlersModal(),$.when(i.callGetDataUsers(a)).then((function(){i.showCreatorInformation(s),i.renderUserProfilesAndImages()}))},justAssignees:function(e){var t=[];return e.map((function(e){var i=-1!==e.userType.indexOf("owner"),a=-1!==e.userType.indexOf("Assigned");t.push(usersAdapter.createJsonUserInfo(e.idUser,"","","","","",a,i,[],[]))})),usersAdapter.justAssignees(t)},showCreatorInformation:function(e){var t=this.usersMap["-"+e+"-"],i=usersAdapter.createJsonUserInfo(t.id,t.name,t.username,t.picture?t.picture:void 0,t.email,t.name.getInitials(),!1,!0,[],[]);this.content.find(".ui-bizagi-wp-project-plan-users .ui-bizagi-wp-project-users-creator-info").userinformation(this,{user:i})},renderUserProfilesAndImages:function(){var e=this;$.each(e.usersMap,(function(t,i){var a=$(".ui-bizagi-wp-userlist li[data-iduser="+i.id+"]",e.content);""!==i.picture?a.find("img").prop("src",i.picture):(a.find("img").hide(),void 0!==i.name?a.find("span").html(i.name.getInitials()):console.log("obj.name is undefined"))})),$(".ui-bizagi-wp-userlist li",e.content).not(".moreUsers").on("mouseenter",(function(t){var i,a=$(t.target),r=$(this).data("iduser");$.each(e.usersMap,(function(e,t){t.id===r&&(i=t)}));var o=e.usersAssignees.find((function(e){return e.userAssigned===i.id})),s=[];o&&o.activities.map((function(e){s.push(e.name)}));var n=usersAdapter.createJsonUserInfo(i.id,i.name,i.username,i.picture,i.email,i.name.getInitials(),e.getIsAssignee(i),e.getIsOwner(i),s,void 0);a.parent().usertooltip(e,{target:a,user:n})}))},getIsAssignee:function(e){return e.userType.indexOf("Assigned")>-1},getIsOwner:function(e){return e.userType.indexOf("owner")>-1},callGetDataUsers:function(e){var t,i=this,a=$.Deferred();return t={usersGuids:e.join(),width:50,height:50},$.when(i.dataService.getUsersData(t)).always((function(e){i.usersInformation=e;for(var t=0,r=e.length;t<r;t+=1)void 0===e[t].name?bizagi.log(e[t]+" Id Not Found",e,"error"):i.usersMap["-"+e[t].id+"-"]?(i.usersMap["-"+e[t].id+"-"].picture+=e[t].picture?"data:image/png;base64,"+e[t].picture:"",i.usersMap["-"+e[t].id+"-"].name=e[t].name||"",i.usersMap["-"+e[t].id+"-"].username=e[t].username||"",i.usersMap["-"+e[t].id+"-"].email=e[t].email||""):console.log("The object is undefined");i.getUsersAssignees(),a.resolve()})),a.promise()},getUsersAssignees:function(){for(var e=0;e<this.usersInformation.length;e++)this.usersAssignees.push(this.getUserAssignee(this.usersInformation[e]))},getUserAssignee:function(e){var t=this,i=[];$.each(t.params.plan.activities,(function(a,r){r.userAssigned===e.id&&t.activityRunning(r)&&i.push({name:r.name})})),e.tasks=i;var a=t.activitiesUsers.find((function(t){return t.idUser==e.id}));return e.userType=a.userType,usersAdapter.createJsonUserInfo(e.id,e.name,e.username,e.picture?"data:image/png;base64,"+e.picture:void 0,e.email,e.name.getInitials(),t.getIsAssignee(e),t.getIsOwner(e),e.tasks,[])},addEventHandlersModal:function(){var e=this;$(".moreUsers").click((function(t){t.preventDefault(),t.stopPropagation();var i=e.usersAssignees||[];e.globalHandlersService.publish("showDialogWidget",{widgetName:bizagi.workportal.widgets.widget.BIZAGI_WORKPORTAL_WIDGET_USERS_MODAL,closeVisible:!0,data:i,maximize:!0,modalParameters:{title:bizagi.localization.getResource("workportal-project-users-title")+" ("+i.length+")",width:790,height:526,refreshInbox:!1}})}))}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.activity.users",["workportalFacade","dataService",bizagi.workportal.widgets.project.plan.activity.users],!0),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.dashboard.menu",{},{onDiscussionsMenuStatusChange:function(e,t){this.updateDiscussionsIcons(t.hasDiscussionsOrComment)},updateDiscussionsIcons:function(e){this.sub("UPDATE_DISCUSSIONS_MENU_STATUS",$.proxy(this.onDiscussionsMenuStatusChange,this)),$(".bz-icon-discussion-comment").toggle(e),$(".bz-icon-discussion-no-comment").toggle(!e),this.params.hasDiscussionsOrComment=e},clean:function(){this.unsub("UPDATE_DISCUSSIONS_MENU_STATUS",$.proxy(this.onDiscussionsMenuStatusChange,this))}}),bizagi.injector.register("bizagi.workportal.widgets.project.dashboard.menu",["workportalFacade","dataService",bizagi.workportal.widgets.project.dashboard.menu],!0),bizagi.workportal.widgets.project.dashboard.menu.extend("bizagi.workportal.widgets.project.dashboard.menu.activity.plan",{},{init:function(e,t,i){this.params=i||{},this._super(e,t,i),this.loadTemplates({"project-dashboard-menu":bizagi.getTemplate("bizagi.workportal.desktop.widgets.project.dashboard.menu.activity.plan").concat("#project-dashboard-menu2")})},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){var e=this;e._super(),e.params.contextsLeftSidebarCaseDashboard.forEach((function(t){e.sub(t,$.proxy(e.updateView,e))}))},updateView:function(e,t){var i=this;i.params=$.extend(i.params,t.args),i.clean();var a=i.getContent().empty(),r={showFormOverview:i.params.menuDashboard.showFormOverview,showFormActivity:i.params.menuDashboard.showFormActivity,showCommentsOptionMenu:i.params.menuDashboard.showCommentsOptionMenu,showFilesOptionMenu:i.params.menuDashboard.showFilesOptionMenu,showTimeLineOptionMenu:i.params.menuDashboard.showTimeLineOptionMenu,showPlanOptionMenu:i.params.menuDashboard.showPlanOptionMenu,contextPlanOptionMenu:i.params.menuDashboard.contextPlanOptionMenu,contextFormActivityOptionMenu:i.params.menuDashboard.contextFormActivityOptionMenu,contextualized:i.params.plan.contextualized};i.getTemplate("project-dashboard-menu").render(r).appendTo(a),i.params.showContextByMenuDashboard&&$("li[data-context='"+e.type.toUpperCase()+"']",i.content).addClass("active").siblings().removeClass("active"),i.updateDiscussionsIcons(i.params.hasDiscussionsOrComment),i.handlerEvents();var o={idPlan:i.params.plan.id};$.when(i.callGetPlan(o)).then((function(e){$.extend(i.params.plan,e),i.pub("notify",{type:"LOAD_INFO_PLAN",args:i.params})}))},loadContentById:function(e){var t=this;e.preventDefault();var i=$(e.target).closest("li");i.hasClass("active")||$.when(bizagi.util.autoSave()).done((function(){$(document).data("auto-save","");var e=i.data("context");if(e){var a=t.pub("notify",{type:"NAVIGATOR_GETLEVEL"}),r=parseInt(a[0]);t.params.refreshLastItemBreadcrumb=!1,t.pub("notify",{type:e.toUpperCase(),args:$.extend(t.params,{showContextByMenuDashboard:e,histName:"",level:r})}),$("li[data-context='"+t.params.showContextByMenuDashboard.toUpperCase()+"']",t.content).addClass("active").siblings().removeClass("active")}}))},callGetPlan:function(e){var t=$.Deferred();return this.dataService.getPlan(e).always((function(e){200===e.status||201===e.status||void 0===e.status?t.resolve(e):t.reject()})),t.promise()},subMenuHandler:function(){var e=this.getContent(),t=$("[data-context='ACTIVITYPLANCOMMENTS']",e),i=$("[data-context='ACTIVITYPLANFILES']",e),a=$("[data-context='ACTIVITYPLANTIMELINE']",e);$(".ui-bizagi-wp-project-tab-submenu a",e).on("click",(function(){t.toggle(),i.toggle(),a.toggle()}))},handlerEvents:function(){var e=this.getContent();this.subMenuHandler(),$(".ui-bizagi-wp-project-tab-links a",e).on("click",$.proxy(this.loadContentById,this))},clean:function(){var e=this,t=e.getContent();e._super(),e.params&&e.params.contextsLeftSidebarCaseDashboard&&e.params.contextsLeftSidebarCaseDashboard.forEach((function(t){e.unsub(t,$.proxy(e.updateView,e))})),$(".ui-bizagi-wp-project-tab-links a",t).off()}}),bizagi.injector.register("bizagi.workportal.widgets.project.dashboard.menu.activity.plan",["workportalFacade","dataService",bizagi.workportal.widgets.project.dashboard.menu.activity.plan],!0),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.content.dashboard",{},{init:function(e,t,i){this._super(e,t,i),this.loadTemplates({"project-content-dashboard":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.content.dashboard").concat("#project-plan-content-dashboard")})},renderContent:function(){var e=this.getTemplate("project-content-dashboard");return this.content=e.render({}),this.content},postRender:function(){setTimeout((function(){$(window).trigger("resize")}),1e3)}}),bizagi.injector.register("bizagi.workportal.widgets.project.content.dashboard",["workportalFacade","dataService",bizagi.workportal.widgets.project.content.dashboard],!0),function(e){var t=window.kendo.ui,i=t.Widget,a=i.extend({init:function(e,t){i.fn.init.call(this,e,t),this._maxFilesSize=t.maxSize,this._fileList=[],this._onlyValidateServerFileExtension=t.onlyValidateServerFileExtension||!0,this._supportFileExt=t.extensions,this._uploadMaxFilesSize=t.maxSize,this.upload=this._initUpload(),this.loadNotifier=this._initLoadNotifier(),this.notification=this._initNotification(),this._eventsHandler(),this._initLocalization(this.options.localization)},options:{name:"ProjectAttachments",wrapper:e('<div class="project-attachments"></div>'),multiple:!0,dropZone:!0,maxFilesSize:bizagi.currentUser?bizagi.currentUser.uploadMaxFileSize:25e3,enabled:!0,localization:{}},_initUpload:function(){var e=this,t=e.options,i=t.localization||{},a=0;return e._initLocalization(i),this.element.kendoUpload({async:{saveUrl:t.saveUrl+"?xsrf="+bizagi.getXSRFToken(),autoUpload:!0},select:function(t){e._filterMaxFilesSize(t),a=0},complete:function(){var t=setInterval((function(){0===e.loadNotifier.wrapper.find("li.k-file-progress").length&&(e._showNotificationCompleteUpload(e.loadNotifier.wrapper,a),clearInterval(t))}),300)},upload:t.upload,progress:function(t){e._onProgressFile(t)},success:function(i){e._fileList.push(i.files[0]),a+=1,t.success(i)},error:function(t){e.onErrorFile(t)},localization:{select:i.selectFiles,dropFilesHere:i.dropFilesHere},multiple:t.multiple,enabled:t.enabled,dropZone:t.dropZone,showFileList:!1}).data("kendoUpload")},_initNotification:function(){return e("<div></div>").kendoNotification({position:{pinned:!0}}).data("kendoNotification")},_initLoadNotifier:function(){var e=this.options.localization;return this.options.wrapper.kendoWindow({title:e.notifierTitle,actions:["Close"],animation:{open:{duration:100},close:{duration:100}},open:function(){this.wrapper.addClass("project-attachments-wrapper-window")},visible:!1,resizable:!1,draggable:!1,maxHeight:"300px",minWidth:"430px"}).data("kendoWindow")},_initLocalization:function(t){var i={selectFiles:bizagi.localization.getResource("workportal-project-attachments-addfiles"),notifierTitle:bizagi.localization.getResource("workportal-project-attachments-notifiertitle"),errorUpload:bizagi.localization.getResource("workportal-project-attachments-file-error"),errorSecurity:bizagi.localization.getResource("workportal-project-attachments-blockedext"),errorSize:bizagi.localization.getResource("workportal-project-attachments-blockedsize"),errorMaxFilesSize:bizagi.localization.getResource("workportal-project-discussion-maxfilessize").replace("%s",this._getSize(this._maxFilesSize)),dropFilesHere:bizagi.localization.getResource("workportal-project-attachments-drophere"),cancel:bizagi.localization.getResource("workportal-widget-reports-confirm-cancel"),retry:bizagi.localization.getResource("workportal-project-attachments-retry"),close:bizagi.localization.getResource("workportal-widget-dialog-box-close")};e.extend(t,i)},_getSize:function(e){return Math.round(e/1048576,-1)},_onProgressFile:function(t){var i=this._getFileItemByUID(t.files[0].uid),a=t.percentComplete;e(".k-progress",i).css({width:a+"%"}),e(".k-upload-pct",i).removeClass("k-icon k-loading").text(a+"%"),100===a&&e(".k-upload-action .k-icon",i).hide()},_onShowUploadNotifier:function(e){var t=e.files,i=this.options.template;this.loadNotifier.content(i.render({files:t})),this.loadNotifier.wrapper.css({top:"auto",left:"auto",bottom:"1em",right:"1em"}),this.loadNotifier.open()},_showNotificationCompleteUpload:function(e,t){e.find("li.k-file-success").length===t&&0===e.find("li.k-file-error").length&&this._autoHideMessage(e)},_autoHideMessage:function(e){var t=this;setTimeout((function(){e.fadeOut((function(){t.loadNotifier.close()}))}),2e3)},_onCancelFile:function(e){var t=e.closest("li"),i=this.upload.wrapper,a=t.data("guid");i.find("li[data-uid="+a+"] .k-upload-action").trigger("click"),t.remove()},_onRemoveFile:function(e){e.closest("li").remove()},_onRetryFile:function(t){var i=t.closest("li").data("guid"),a=e.grep(this._fileList,(function(e){return e.uid===i}));this.options.retry(a[0])},onErrorFile:function(e){var t=this.options.localization,i=e.files[0],a=this._isValidFile(i),r=""!==a.message?a.message:t.errorUpload;this.setStatus("ERROR",i.uid,r)},_isValidFile:function(t){var i=this.options.localization,a=!0,r="";return(t.size>this._uploadMaxFilesSize||null==t.size||0==t.size)&&(r=i.errorSize,a=!1),this._onlyValidateServerFileExtension||-1===e.inArray(t.extension,this._supportFileExt)&&(r=i.errorSecurity,a=!1),{valid:a,message:r}},_filterMaxFilesSize:function(e){for(var t=0,i=0,a=e.files.length;i<a;i++)t+=e.files[i].size;t>this._maxFilesSize?(this._notifySizeExceeded(),e.preventDefault()):this._onShowUploadNotifier(e)},_notifySizeExceeded:function(){this.notification.show(this.options.localization.errorMaxFilesSize,"error")},_getFileItemByUID:function(t){return e("li[data-guid="+t+"]",this.loadNotifier.element)},_switchEvents:function(t){var i=e(".k-icon",t.currentTarget);i.hasClass("k-update")||i.hasClass("k-remove")?this._onRemoveFile(i):i.hasClass("k-retry")?this._onRetryFile(i):i.hasClass("k-cancel")&&this._onCancelFile(i)},_eventsHandler:function(){var e=this;e.loadNotifier.element.on("click","button.k-upload-action",(function(t){e._switchEvents(t)}))},cancelFilesUpload:function(){this.upload.wrapper.find("li .k-upload-action").trigger("click"),this.close()},close:function(){this.loadNotifier.close()},destroy:function(){this.loadNotifier.destroy(),this.upload.destroy()},setStatus:function(t,i,a){var r=this._getFileItemByUID(i),o=this.options.localization;switch(t){case"SUCCESS":r.removeClass("k-file-progress k-file-error").addClass("k-file-success"),e(".k-upload-action .k-icon",r).removeClass("k-cancel k-i-refresh k-retry").addClass("k-update").prop("title",o.close).show(),e(".k-errormsg",r).text("");break;case"ERROR":r.removeClass("k-file-progress").addClass("k-file-error"),e(".k-upload-action .k-icon",r).removeClass("k-i-refresh k-retry").addClass("k-remove").show(),e(".k-upload-status .k-upload-pct",r).removeClass("k-upload-pct k-loading").addClass("k-icon k-warning"),e(".k-errormsg",r).text(a).prop("title",a);break;case"RETRY":r.removeClass("k-file-progress").addClass("k-file-error"),e(".k-upload-status .k-upload-pct",r).removeClass("k-upload-pct k-loading").addClass("k-warning").text(""),e(".k-upload-action .k-icon",r).removeClass("k-cancel k-remove").addClass("k-i-refresh k-retry").prop("title",o.retry).show(),e(".k-errormsg",r).text(o.errorUpload).prop("title",o.errorUploadiis)}}});t.plugin(a)}(jQuery),bizagi.workportal.widgets.project.base.extend("bizagi.workportal.widgets.project.files",{},{init:function(e,t,i){this._super(e,t,i),this.plugins={},this.prefixBase64="data:image/png;base64,",this.usersData={},this.currentFilesList=[],this.fileDateInterval,this.loadTemplates({"project-files":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.files").concat("#project-files-wrapper"),"project-files-uploaditem":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.files").concat("#project-files-uploaditem"),"project-files-list":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.files").concat("#project-files-list"),"project-attachments":bizagi.getTemplate("bizagi.workportal.desktop.widgets.project.attachments").concat("#project-attachments")})},renderContent:function(){var e=this.getTemplate("project-files");return this.content=e.render({isOpen:!bizagi.util.parseBoolean(this.params.isClosedForAllUsers)}),this.content},postRender:function(){var e=this;$.when(e.renderFilesList()).done((function(){e.plugins.uploadFiles=e.initializeUploadFiles(),e.eventsHandler(),e.restrictedEventsHandler()}))},renderFilesList:function(){var e=this,t=$.Deferred(),i=e.currentFilesList.length,a={globalParent:e.radNumber,dateTime:i?e.currentFilesList[i-1].date:e.getDateServer(),count:12};return"FLOW-DECONTEXTUALIZED-PLANS"===e.params.flowContext&&(a.globalParent=e.params.plan.id),$.when(e.dataService.getFilesListByRadNumber(a)).done((function(i){e.currentFilesList=e.currentFilesList.concat(i),e.renderFiles(i),t.resolve()})),t.promise()},renderFiles:function(e){var t=this.getContent(),i=$("#project-files-showmore",t);this.displayFileList(e,"append"),this.updateRelativeTime(),e.length&&this.setAdditionalData(e),this.currentFilesList.length>=12&&(i.show(),e.length<12&&($("button",i).remove(),$("#project-files-nomore",i).show())),this.notifyFilesNumber(!1)},renderNoFiles:function(){var e=this.workportalFacade.getTemplate("info-message"),t=this.resources.getResource("workportal-project-files-noavailable"),i=$.tmpl(e,{message:t});this.content.html(i)},initializeUploadFiles:function(){var e=this.getContent();return $("#project-files-upload",e).kendoProjectAttachments({saveUrl:this.dataService.serviceLocator.getUrl("project-comments-uploadfiles"),template:this.getTemplate("project-attachments"),success:$.proxy(this.onSuccessFile,this),upload:$.proxy(this.addFileData,this),retry:$.proxy(this.onSaveFileData,this),enabled:!0,extensions:this.supportFileExt,maxSize:this.uploadMaxFilesSize}).data("kendoProjectAttachments")},setAdditionalData:function(e){for(var t=[],i=[],a=[],r=0,o=e.length-1;r<=o;r++)i.push(e[r].user),a.push(e[r].user),t.push(e[r].attachment.guid);this.setUserData(a.join()),this.setThumbnails(t.join())},setUserData:function(e){var t=this,i=t.getContent(),a={usersGuids:e,width:50,height:50};$.when(t.dataService.getUsersData(a)).done((function(e){for(var a=0,r=e.length-1;a<=r;a++)e[a].picture&&(e[a].picture=t.prefixBase64+e[a].picture),t.usersData["id"+e[a].id]=e[a],$("#project-files-list .ui-bizagi-wp-project-files-user[data-userId="+e[a].id+"]",i).text(e[a].name)}))},getFileInfoByGuid:function(e){for(var t,i=0,a=this.currentFilesList.length;i<a;i++)e===this.currentFilesList[i].guid&&(t=this.currentFilesList[i],i=a);return t},setThumbnails:function(e){var t=this,i=t.getContent(),a={guids:e,width:480,height:150,globalParent:t.params.radNumber};$.when(t.dataService.getFilesThumbnails(a)).done((function(e){var a,r,o;$.each(e,(function(e,s){e=e.toLowerCase(),a=t.prefixBase64+s,r=$("#project-files-list .ui-bizagi-wp-project-files-wrapitem[data-attchGuid="+e+"]",i),(o=$(".ui-bizagi-wp-project-files-thumbnail",r)).prop("src",a),$(".ui-bizagi-wp-project-files-icon",r).remove(),o.css("display","block")}))}))},setFilePreview:function(e,t,i){var a=this,r="",o={guids:[t].join(),width:500,height:500,globalParent:a.params.radNumber};$.when(a.dataService.getFilesThumbnails(o)).done((function(t){var o=e.find(".ui-bizagi-wp-project-files-user").data("userid");$.each(t,(function(e,t){r=a.prefixBase64+t})),a.pub("notify",{type:"FILEPREVIEW",args:{radNumber:a.radNumber,fileData:a.getFileInfoByGuid(i),userData:a.usersData["id"+o],isOpen:!bizagi.util.parseBoolean(a.params.isClosedForAllUsers),img:r}}),a.pub("notify",{type:"OPEN_RIGHT_SIDEBAR"})}))},onSuccessFile:function(e){(e.XMLHttpRequest.response?JSON.parse(e.XMLHttpRequest.response):{}).error?this.plugins.uploadFiles.onErrorFile(e):this.onSaveFileData(e.files[0])},onSaveFileData:function(e){var t=this;$.when(t.saveFileData(e)).done((function(){t.notifyFilesNumber(),t.plugins.uploadFiles.setStatus("SUCCESS",e.uid)})).fail((function(){t.plugins.uploadFiles.setStatus("RETRY",e.uid)}))},onRetryFile:function(e){var t=e.closest("li"),i=t.data("guid"),a=$.grep(this.currentFilesList,(function(e){return e.uid===i}));this.onSaveFileData(t,a[0])},addFileData:function(e){e.data={guid:e.files[0].uid}},saveFileData:function(e){var t=this,i=$.Deferred(),a=Math.guid(),r=t.radNumber?t.radNumber.toString():"";"FLOW-DECONTEXTUALIZED-PLANS"===t.params.flowContext&&(r=t.params.plan.id);var o={content:{guid:a,description:"",name:e.name,attachment:{guid:e.uid,name:e.name},date:t.getDateServer(),user:bizagi.currentUser.idUser,globalParent:r},attachmentsToCreate:[e.uid]};return t.currentFilesList.unshift(e),$.when(t.dataService.createProjectFile(o)).always((function(a){200===a.status||201===a.status||void 0===a.status?($.extend(e,{user:bizagi.currentUser.idUser,userName:bizagi.currentUser.userName,date:(new Date).getTime(),attachment:o.content.attachment,guid:o.content.guid,description:o.content.description}),t.usersData["id"+bizagi.currentUser.idUser]={picture:bizagi.currentUser.photo,name:bizagi.currentUser.userName,id:bizagi.currentUser.idUser},t.displayFileList(e,"prepend"),t.updateRelativeTime(),t.setThumbnails(e.uid),i.resolve()):i.reject()})),i},displayFileList:function(e,t){var i=this.getTemplate("project-files-list"),a=(e=e||this.currentFilesList,this.getContent()),r=i.render({files:e});$("#project-files-list",a)[t](r),$.equalizeHeights(".bz-card")},deleteFile:function(e,t){var i=this.getContent();$("div[data-fileguid='"+t.args.guid+"']",i).remove(),this.currentFilesList=this.currentFilesList.filter((function(e){return e.guid!==t.args.guid})),this.notifyFilesNumber(!0)},updateFileData:function(e,t){this.getFileInfoByGuid(t.args.guid).description=t.args.description},updateRelativeTime:function(){this.fileDateInterval&&clearInterval(this.fileDateInterval),this.fileDateInterval=setInterval($.proxy(this.changeRelativeTime,this),"7000")},changeRelativeTime:function(){var e=this.getContent();$("#project-files-list .ui-bizagi-wp-project-files-date",e).each((function(e,t){var i=$(t).data("date"),a=bizagi.util.dateFormatter.getRelativeTime(new Date(i),null,!1);$(t).text(a)}))},onSelectFiles:function(e){for(var t=[],i=e.files,a=i.length-1;a>=0;a--)if(!this.isValidFile(i[a]).valid){var r=i.splice(a,a+1);t.unshift(r[0])}t.length>0&&this.showFilesError(t)},resetWidget:function(){this.plugins.uploadFiles&&this.plugins.uploadFiles.close(),this.currentFilesList=[],clearInterval(this.fileDateInterval)},switchFilesEvents:function(e){e.stopPropagation();var t=$(e.target),i=t.closest(".ui-bizagi-wp-project-files-wrapitem");if(i.length){var a=i.data("attchguid"),r=i.data("fileguid");if(t.hasClass("ui-bizagi-wp-project-files-file")){var o=t.text();this.dataService.getDownloadAttachment(a,o)}else this.setFilePreview(i,a,r)}else"project-files-showmore"===t.parent().prop("id")?this.renderFilesList():"project-files-upload"!==t.prop("id")&&this.notifyFilesNumber(!0)},notifyFilesNumber:function(e){this.pub("notify",{type:"SETFILESNUMBER",args:{filesNumber:this.currentFilesList.length,mandatory:e}})},restrictedEventsHandler:function(){this.content.on("click",$.proxy(this.switchFilesEvents,this))},eventsHandler:function(){var e=this.getContent();this.sub("changeProjectWidget",$.proxy(this.resetWidget,this)),this.sub("UPDATEFILE",$.proxy(this.updateFileData,this)),this.sub("DELETEFILE",$.proxy(this.deleteFile,this)),e.on("click",$.proxy(this.switchFilesEvents,this))},clean:function(){for(var e in this.resetWidget(),this.unsub("changeProjectWidget",$.proxy(this.resetWidget,this)),this.unsub("UPDATEFILE",$.proxy(this.updateFileData,this)),this.unsub("DELETEFILE",$.proxy(this.deleteFile,this)),this.plugins)this.plugins[e]&&this.plugins[e].destroy();clearInterval(this.fileDateInterval),this._super()}}),bizagi.injector.register("bizagi.workportal.widgets.project.files",["workportalFacade","dataService",bizagi.workportal.widgets.project.files],!0),bizagi.workportal.widgets.project.base.extend("bizagi.workportal.widgets.project.filesPreview",{},{init:function(e,t,i,a){this.datePickerRegional=bizagi.localization.getResource("datePickerRegional"),this.dialogBox={},this._super(e,t,a),this.notifier=i,this.loadTemplates({"project-filespreview-wrapper":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.filesPreview").concat("#project-filespreview-wrapper"),"project-filespreview-preview":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.filesPreview").concat("#project-filespreview-preview"),"project-filespreview-popup":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.filesPreview").concat("#project-filespreview-popup"),"project-filespreview-thenumber":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.filesPreview").concat("#project-filespreview-thenumber")})},renderContent:function(){var e=this.getTemplate("project-filespreview-wrapper");return this.content=e.render(),this.sub("SETFILESNUMBER",$.proxy(this.setFilesNumber,this)),this.content},postRender:function(){this.plugins.fileEdition=this.initPluginPopupEdition(),this.form={description:$("#ui-bizagi-wp-project-filespreview-popup-description",this.plugins.fileEdition),image:$(".ui-bizagi-wp-project-popupform-user-image",this.plugins.fileEdition),cancel:$("#ui-bizagi-wp-project-popupform-action-cancel",this.plugins.fileEdition),edit:$("#ui-bizagi-wp-project-popupform-action-editfile",this.plugins.fileEdition)},this.eventsHandler()},setFilesNumber:function(e,t){var i=t.args;if($.isEmptyObject(this.currentFile)||i.mandatory){var a=this.getTemplate("project-filespreview-thenumber").render({filesNumber:i.filesNumber});this.currentFile={},$("#ui-bizagi-wp-project-filespreview-wrapper",this.content).html(a)}},initPluginPopupEdition:function(){var e=this.getTemplate("project-filespreview-popup");return this.dialogBox.formContent=e.render(),this.dialogBox.formContent},showPreview:function(e,t){var i=this.getTemplate("project-filespreview-preview");this.currentFile=t.args;var a=i.render($.extend(t.args,{idCurrentUser:bizagi.currentUser.idUser}));$("#ui-bizagi-wp-project-filespreview-wrapper",this.content).html(a),this.applyMenu()},setEditionData:function(){this.form.description.val(this.currentFile.fileData.description),this.currentFile.userData.picture&&this.form.image.prop("src",this.currentFile.userData.picture)},eventsHandler:function(){this.form.cancel.on("click",$.proxy(this.onResetFileForm,this)),this.form.edit.on("click",$.proxy(this.onSaveEdition,this)),this.sub("FILEPREVIEW",$.proxy(this.showPreview,this))},onSelectMenu:function(e,t){if(0===$(e.currentTarget).find("i").length)switch($(t.item).data("item")){case"edit":this.onOpenEdition();break;case"delete":this.onDeleteFile();break;case"download":this.onDownloadFile()}},onDownloadFile:function(){this.dataService.getDownloadAttachment(this.currentFile.fileData.attachment.guid,this.currentFile.fileData.name)},onOpenEdition:function(){var e=this;e.dialogBox.formContent.dialog({resizable:!1,draggable:!1,height:"auto",width:"650px",modal:!0,title:bizagi.localization.getResource("workportal-project-files-editfile"),maximize:!0,close:function(){e.onResetFileForm()}}),e.setEditionData(),e.form.description.focus()},onDeleteFile:function(){var e=this;$.when(bizagi.showConfirmationBox(bizagi.localization.getResource("workportal-project-file-querydelete"),"","info")).done((function(){var t={content:{guid:e.currentFile.fileData.guid},attachmentsToDelete:[e.currentFile.fileData.attachment.guid]};$.when(e.dataService.deleteFile(t)).always((function(i){200!==i.status&&201!==i.status&&void 0!==i.status||e.pub("notify",{type:"DELETEFILE",args:{guid:t.content.guid}})}))}))},onSaveEdition:function(){var e=this;if(e.validateAddFileDescriptionForm(e.form.description)){e.currentFile.fileData.description=e.form.description.val();var t={content:{guid:e.currentFile.fileData.guid,description:e.currentFile.fileData.description,attachment:e.currentFile.fileData.attachment,name:e.currentFile.fileData.name,date:e.currentFile.fileData.date,user:bizagi.currentUser.idUser,globalParent:e.currentFile.radNumber}};$.when(e.dataService.updateProjectFile(t)).always((function(i){200===i.status||201===i.status||void 0===i.status?($("#ui-bizagi-wp-project-filespreview-description",e.content).text(t.content.description),e.onResetFileForm(),e.notifier.showSucessMessage(printf(bizagi.localization.getResource("workportal-project-files-editionsuccess"),"")),e.pub("notify",{type:"UPDATEFILE",args:{description:t.content.description,guid:t.content.guid}})):(e.onResetFileForm(),e.notifier.showErrorMessage(printf(bizagi.localization.getResource("workportal-general-error-generic"),"")))}))}},validateAddFileDescriptionForm:function(e){var t=!1,i=e;if(""===i.val().trim()){var a=bizagi.localization.getResource("workportal-project-discussion-requireddescription");i.parent().next().find("span").html(a)}else i.parent().next().find("span").empty(),t=!0;return t},onResetFileForm:function(){this.form.description.parent().next().find("span").empty(),this.dialogBox.formContent.dialog("destroy"),this.dialogBox.formContent.detach()},applyMenu:function(){$(".ui-bizagi-wp-project-filespreview-edit",this.content).menu({select:$.proxy(this.onSelectMenu,this)}).removeClass("ui-widget-content")},clean:function(){this.plugins={},this.form={},this.currentFile={},this.filesNumber=0}}),bizagi.injector.register("bizagi.workportal.widgets.project.filesPreview",["workportalFacade","dataService","notifier",bizagi.workportal.widgets.project.filesPreview]),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.file.sidebar",{},{init:function(e,t,i){this._super(e,t,i),(i=i||{}).supportNav=!1,this.loadTemplates({"project-file-sidebar":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.file.sidebar").concat("#project-file-sidebar")})},getWidgetName:function(){return bizagi.workportal.widgets.widget.BIZAGI_WORKPORTAL_WIDGET_PROJECT_FILE_SIDEBAR},renderContent:function(){var e=this.getTemplate("project-file-sidebar");return this.content=e.render({}),this.content}}),bizagi.injector.register("bizagi.workportal.widgets.project.file.sidebar",["workportalFacade","dataService",bizagi.workportal.widgets.project.file.sidebar],!0);
//# sourceMappingURL=../../../../Maps/desktop/activityplanfiles.desktop.production.js.map
