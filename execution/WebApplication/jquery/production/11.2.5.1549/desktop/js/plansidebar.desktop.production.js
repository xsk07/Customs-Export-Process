bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.dashboard.menu",{},{onDiscussionsMenuStatusChange:function(e,t){this.updateDiscussionsIcons(t.hasDiscussionsOrComment)},updateDiscussionsIcons:function(e){this.sub("UPDATE_DISCUSSIONS_MENU_STATUS",$.proxy(this.onDiscussionsMenuStatusChange,this)),$(".bz-icon-discussion-comment").toggle(e),$(".bz-icon-discussion-no-comment").toggle(!e),this.params.hasDiscussionsOrComment=e},clean:function(){this.unsub("UPDATE_DISCUSSIONS_MENU_STATUS",$.proxy(this.onDiscussionsMenuStatusChange,this))}}),bizagi.injector.register("bizagi.workportal.widgets.project.dashboard.menu",["workportalFacade","dataService",bizagi.workportal.widgets.project.dashboard.menu],!0),bizagi.workportal.widgets.project.dashboard.menu.extend("bizagi.workportal.widgets.project.dashboard.menu.plan",{},{init:function(e,t,a,i){this.params=i||{},this.projectDashboard=a,this._super(e,t,i),this.loadTemplates({"project-dashboard-menu":bizagi.getTemplate("bizagi.workportal.desktop.widgets.project.dashboard.menu.plan").concat("#project-dashboard-menu")})},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){var e=this;e._super(),e.params&&e.params.contextsLeftSidebarCaseDashboard&&e.params.contextsLeftSidebarCaseDashboard.forEach((function(t){e.sub(t,$.proxy(e.updateView,e))}))},updateView:function(e,t){this.params=$.extend(this.params,t.args),this.clean();var a=this.getContent().empty(),i=this.getTemplate("project-dashboard-menu");this.params.menuPlanDashboard=this.params.menuPlanDashboard||{},$.extend(this.params.menuPlanDashboard,this.params.menuDashboard),this.planState=this.getPlanState(this.params.plan,this.params.planChild);var n={planState:this.planState,showCommentsOptionMenu:this.params.menuPlanDashboard.showCommentsOptionMenu,showFilesOptionMenu:this.params.menuPlanDashboard.showFilesOptionMenu,showTimeLineOptionMenu:this.params.menuPlanDashboard.showTimeLineOptionMenu&&this.isVisibleShowTimeLine(this.planState)};i.render(n).appendTo(a),$("li[data-context='"+this.params.showContextByMenuDashboard.toUpperCase()+"']",this.content).addClass("active").siblings().removeClass("active"),this.updateDiscussionsIcons(this.params.hasDiscussionsOrComment),this.handlerEvents()},getPlanState:function(e,t){var a;return t&&t.currentState?a=t.currentState:e&&e.currentState&&(a=e.currentState),a},isVisibleShowTimeLine:function(e){var t=!0;return"PENDING"===e&&(t=!1),t},loadContentById:function(e){e.preventDefault();var t=$(e.target).closest("li");if("PLANBACK"===t.data("context"))this.backParentPlan();else if(!t.hasClass("active")){var a=t.data("context");a&&(this.pub("notify",{type:a.toUpperCase(),args:$.extend(this.params,{showContextByMenuDashboard:a})}),$("li[data-context='"+this.params.showContextByMenuDashboard.toUpperCase()+"']",this.content).addClass("active").siblings().removeClass("active"))}},subMenuHandler:function(){var e=this,t=e.getContent(),a=$("[data-context='PLANCOMMENTS']",t),i=$("[data-context='PLANFILES']",t),n=$("[data-context='PLANTIMELINE']",t);$(".ui-bizagi-wp-project-tab-submenu a",t).on("click",(function(){a.toggle(),i.toggle(),e.isVisibleShowTimeLine(e.planState)&&n.toggle()}))},backParentPlan:function(){var e=this.pub("notify",{type:"NAVIGATOR_GETLEVEL"}),t=parseInt(e[0]),a=this.projectDashboard.getParamsByBackFromPlan(this.params,t);this.pub("notify",{type:a.typeContext,args:$.extend(this.params,a.paramsNotify)})},handlerEvents:function(){var e=this.getContent();this.subMenuHandler(),$(".ui-bizagi-wp-project-tab-links a",e).on("click",$.proxy(this.loadContentById,this))},clean:function(){var e=this,t=e.getContent();e._super(),$(".ui-bizagi-wp-project-tab-links a",t).off(),e.params&&e.params.contextsLeftSidebarCaseDashboard&&e.params.contextsLeftSidebarCaseDashboard.forEach((function(t){e.unsub(t,$.proxy(e.updateView,e))}))}}),bizagi.injector.register("bizagi.workportal.widgets.project.dashboard.menu.plan",["workportalFacade","dataService","bizagi.workportal.services.behaviors.projectDashboard",bizagi.workportal.widgets.project.dashboard.menu.plan],!0),bizagi.workportal.widgets.project.base.extend("bizagi.workportal.widgets.project.plan.sidebar",{},{init:function(e,t,a,i){this._super(e,t,i),this.serviceloadDataPlan=a,this.params=i||{},i.supportNav=!1,this.loadTemplates({"project-plan-sidebar":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.plan.sidebar").concat("#project-plan-sidebar")})},renderContent:function(){var e=this,t=e.getTemplate("project-plan-sidebar");return e.content=t.render({}),$.when(e.areTemplatedLoaded()).done((function(){var t={idPlan:e.params.plan.id};e.params.planChild&&e.params.planChild.id&&(t.idPlan=e.params.planChild.id),e.serviceloadDataPlan.loadData(t,e.getDateServer,e.params),e.serviceloadDataPlan.subscribe("loadedWithDataActivities",$.proxy(e.loadedWithDataActivities,e)),e.serviceloadDataPlan.subscribe("loadedWithDataFirstParent",$.proxy(e.loadedWithDataFirstParent,e))})),e.content},loadedWithDataActivities:function(){this.pub("notify",{type:"LOADED_ACTIVITIES_PLAN",args:this.params}),this.pub("notify",{type:"UPDATE_INFO_PLAN",args:this.params}),this.pub("notify",{type:"LOAD_INFO_SUMMARY_PROGRESS_PLAN",args:this.params}),this.pub("notify",{type:"LOAD_INFO_ACTIVITIES_PLAN",args:this.params})},loadedWithDataFirstParent:function(){this.pub("notify",{type:"LOAD_INFO_SUMMARY_PLAN",args:this.params})},clean:function(){this.serviceloadDataPlan&&(this.serviceloadDataPlan.unsubscribe("loadedWithDataActivities",$.proxy(this.loadedWithDataActivities,this)),this.serviceloadDataPlan.unsubscribe("loadedWithDataFirstParent",$.proxy(this.loadedWithDataFirstParent,this)))}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.sidebar",["workportalFacade","dataService","bizagi.workportal.services.behaviors.loadDataPlan",bizagi.workportal.widgets.project.plan.sidebar],!0),bizagi.workportal.widgets.project.base.extend("bizagi.workportal.widgets.project.plan.action",{},{init:function(e,t,a,i,n,s,r){this._super(e,t,r),this.PENDING_PLAN="PENDING",this.EXECUTING_PLAN="EXECUTING",this.CLOSED_PLAN="CLOSED",this.CONTEXT_ACTIVITYPLAN="ACTIVITYPLAN",this.CONTEXT_ACTIVITYPLANOVERVIEW="ACTIVITYPLANOVERVIEW",this.CONTEXT_PLANCREATE="PLANCREATE",this.CONTEXT_ACTIVITYPLANCREATE="ACTIVITYPLANCREATE",this.showActionsPlan=!1,this.projectDashboard=a,this.notifier=i,this.planTemplateCreate=n,this.planPopupEdit=s,this.loadTemplates({"plan-action-main":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.action").concat("#project-plan-action")})},renderContent:function(){var e=this.getTemplate("plan-action-main");return this.showActionsPlan=this.params.showContextByMenuDashboard!==this.CONTEXT_ACTIVITYPLAN&&this.params.showContextByMenuDashboard!==this.CONTEXT_ACTIVITYPLANOVERVIEW,this.plugins={},this.content=e.render({plan:this.params.plan.name,stateClosedPlan:this.CLOSED_PLAN,currentStatePlan:this.params.plan.currentState,showActionsPlan:this.showActionsPlan}),this.showActionsPlan&&(this.params.plan.contextualized=void 0===this.params.plan.contextualized||this.params.plan.contextualized),this.content},postRender:function(){var e=this,t=e.getContent();e.showActionsPlan&&(e.initilizeActionMenu(),$("a#to-close-plan",t).on("click",$.proxy(e.onClosePlan,e))),e.sub("LOAD_INFO_SUMMARY_PLAN",$.proxy(e.onNotifyLoadInfoSummaryPlan,e)),e.clearAlertsOnFocus(),e.planTemplateCreate.sub("planTemplateCreatedSuccess",(function(){e.notifier.showSucessMessage(printf(bizagi.localization.getResource("workportal-project-plan-create-template-success"),""))})),e.planTemplateCreate.sub("planTemplateCreatedFailed",(function(){e.notifier.showErrorMessage(printf(bizagi.localization.getResource("workportal-project-plan-create-template-fail"),""))})),e.planPopupEdit.sub("planEditedSuccess",(function(){e.setNamePlan(e.params.plan.name),e.pub("notify",{type:"UPDATE_INFO_PLAN"}),e.pub("notify",{type:"LOAD_INFO_SUMMARY_PLAN",args:e.params}),e.notifier.showSucessMessage(printf(bizagi.localization.getResource("workportal-project-plan-edit-success"),""))})),e.planPopupEdit.sub("planEditedFailed",(function(){e.notifier.showErrorMessage(printf(bizagi.localization.getResource("workportal-project-plan-edit-fail"),""))})),e.sub("EXPANDED_RIGHT_SIDEBAR",$.proxy(e.onNotifyExpandedRightSidebar,e))},onNotifyExpandedRightSidebar:function(){this.showActionsPlan&&this.initilizeActionMenu()},onNotifyLoadInfoSummaryPlan:function(){this.setStatePlan(this.params.plan.currentState),this.setNamePlan(this.params.plan.name)},setStatePlan:function(e){if(e)switch(e.toUpperCase()){case"PENDING":$(".state-pending-plan",this.content).show().siblings().hide();break;case"EXECUTING":$(".state-executing-plan",this.content).show().siblings().hide();break;case"CLOSED":$(".state-closed-plan",this.content).show().siblings().hide()}},setNamePlan:function(e){$(".ui-bizagi-wp-project-plan-header .bz-wp-section",this.content).text(bizagi.util.decodeHtmlEntities(e))},onSelectMenu:function(e,t){if(0===$(e.currentTarget).find("i").length)switch($(t.item).data("item")){case"edit":this.onClickMenuOpenEdition();break;case"delete":this.onClickMenuDeletePlan();break;case"saveastmpl":this.onClickMenuSaveAsTemplate()}},onClickMenuOpenEdition:function(){var e=this.params.plan;this.planPopupEdit.showPopup(this.params,this.dataService,e)},onClickMenuSaveAsTemplate:function(){this.planTemplateCreate.showPopupAddTemplatePlan(this.params,this.dataService,this.params.plan.contextualized,this.params.plan.id)},onClickMenuDeletePlan:function(){var e=this;$.when(bizagi.showConfirmationBox(bizagi.localization.getResource("workportal-project-plan-action-delete-confirmation"),"","info")).done((function(){var t={id:e.params.plan.id};$.when(e.callDeletePlan(t)).always((function(t){if(200===t.status||void 0===t.status){$.extend(e.params.plan,n),e.notifier.showSucessMessage(printf(bizagi.localization.getResource("workportal-project-plan-delete-success"),""));var a=e.pub("notify",{type:"NAVIGATOR_GETLEVEL"}),i=parseInt(a[0]),n=e.projectDashboard.getParamsByBackFromPlan(e.params,i,!0);e.pub("notify",{type:n.typeContext,args:$.extend(e.params,n.paramsNotify)})}else e.notifier.showErrorMessage(printf(bizagi.localization.getResource("workportal-project-plan-delete-fail"),""))}))}))},onSubmitFormPlan:function(e){e.preventDefault()},initilizeActionMenu:function(){$(".ui-bizagi-wp-project-plan-action-menu",this.content).menu({select:$.proxy(this.onSelectMenu,this)}).removeClass("ui-widget-content")},clearAlertsOnFocus:function(){$(".ui-bizagi-wp-project-container-validator-relative input, .ui-bizagi-wp-project-container-validator-relative textarea").focus((function(){$(this).parent().find(".k-invalid-msg").hide()})).focusout((function(){$(this).val().length<1&&$(this).parent().find(".k-invalid-msg").show()}))},callDeletePlan:function(e){return $.when(this.dataService.deletePlan(e))},clean:function(){this.planTemplateCreate.unsub("planTemplateCreatedSuccess"),this.planTemplateCreate.unsub("planTemplateCreatedFailed"),this.planPopupEdit.unsub("planEditedSuccess"),this.planPopupEdit.unsub("planEditedFailed"),this.unsub("EXPANDED_RIGHT_SIDEBAR",$.proxy(this.onNotifyExpandedRightSidebar,this))}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.action",["workportalFacade","dataService","bizagi.workportal.services.behaviors.projectDashboard","notifier","bizagi.workportal.widgets.project.plan.template.create","bizagi.workportal.widgets.project.plan.edit",bizagi.workportal.widgets.project.plan.action],!0),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.plan.state",{},{init:function(e,t,a){this._super(e,t,a),this.loadTemplates({"plan-state-main":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.state").concat("#project-plan-state")})},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){this.sub("LOAD_INFO_SUMMARY_PLAN",$.proxy(this.onNotifyLoadInfoSummaryPlan,this))},onNotifyLoadInfoSummaryPlan:function(e,t){var a=this.getTemplate("plan-state-main").render({});switch(this.params=$.extend(this.params,t.args),this.params.plan.currentState.toUpperCase()){case"PENDING":$(".state-pending",a).show().siblings().hide();break;case"EXECUTING":$(".state-executing",a).show().siblings().hide();break;case"CLOSED":$(".state-closed",a).show().siblings().hide()}this.content.empty().append(a)}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.state",["workportalFacade","dataService",bizagi.workportal.widgets.project.plan.state],!0),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.plan.progress",{},{init:function(e,t,a){this._super(e,t,a),this.loadTemplates({"plan-progress-main":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.progress").concat("#project-plan-progress")})},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){this.sub("LOAD_INFO_SUMMARY_PROGRESS_PLAN",$.proxy(this.onNotifyLoadInfoSummaryPlan,this))},onNotifyLoadInfoSummaryPlan:function(e,t){this.params=$.extend(this.params,t.args);var a=this.getContent().empty(),i=this.calculateProgress(),n={};n.progress=i,n.progress<33?n.colorBar="Red":n.progress<66?n.colorBar="Yellow":n.colorBar="Green",this.getTemplate("plan-progress-main").render(n).appendTo(a);var s=$(".remaining-days .time-remaining",a),r=$(".remaining-days .days",a).width();s.css("padding-left",(r+7).toString()+"px")},calculateProgress:function(){var e=0,t=this.params.plan.activities.length,a=0;return 0!==t&&(this.params.plan.activities.forEach((function(t){"Completed"===t.workItemState&&e++})),a=Math.round(e/t*100)),a}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.progress",["workportalFacade","dataService",bizagi.workportal.widgets.project.plan.progress],!0),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.plan.time",{},{init:function(e,t,a){this._super(e,t,a),this.PENDING_PLAN="PENDING",this.EXECUTING_PLAN="EXECUTING",this.CLOSED_PLAN="CLOSED",this.datePickerRegional=bizagi.localization.getResource("datePickerRegional"),this.loadTemplates({"plan-time-main":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.time").concat("#project-plan-time")})},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){this.sub("LOAD_INFO_SUMMARY_PLAN",$.proxy(this.onNotifyLoadInfoSummaryPlan,this))},onNotifyLoadInfoSummaryPlan:function(e,t){this.params=$.extend(this.params,t.args),this.params.plan&&(this.params.plan.dueDate?this.params.plan.currentState===this.PENDING_PLAN||this.params.plan.currentState===this.EXECUTING_PLAN?this.updateWidget(e,t):this.sub("LOADED_ACTIVITIES_PLAN",$.proxy(this.updateWidget,this)):this.getContent().empty())},planDatesToStamp:function(e){e.activities&&e.activities.map((function(e){e.estimatedFinishDate&&(e.estimatedFinishDate=new Date(e.estimatedFinishDate).getTime()),e.startDate&&(e.startDate=new Date(e.startDate).getTime()),e.finishDate&&(e.finishDate=new Date(e.finishDate).getTime())})),e.dueDate&&(e.dueDate=new Date(e.dueDate).getTime()),e.creationDate&&(e.creationDate=new Date(e.creationDate).getTime()),e.startDate&&(e.startDate=new Date(e.startDate).getTime()),e.closedDate&&(e.closedDate=new Date(e.closedDate).getTime()),e.finishDate&&(e.finishDate=new Date(e.finishDate).getTime())},updateWidget:function(e,t){var a=this;a.params=$.extend(a.params,t.args),a.planDatesToStamp(a.params.plan);var i=a.getContent().empty();a.params.plan.currentState===a.CLOSED_PLAN&&a.getClosedDatePlan(a.params.plan),$.when(a.getIntervalOnMinutes(a.params.plan)).done((function(e){var t=bizagi.util.dateFormatter.getRelativeTime(new Date(Date.now()-60*e.minutesToShowTime*1e3),null,!0),n=t.replace(/\d/g,""),s=a.getKeywordDifferenceDates(a.params.plan),r=bizagi.localization.getResource("workportal-project-plan-state-"+s);r=r.replace("%s",n);var o=t.replace(/\D/g,""),p=a.getSecondDate(a.params.plan),l=a.getWidthBar(a.params.plan,e),c=a.getColorBarByPercent(l),d={fromDate:a.getFormattedDate(new Date(a.getFirstDate(a.params.plan))),toDate:p?a.getFormattedDate(new Date(p)):null,valueOfTimeCalculated:o,messageDescripionDifference:r,percentBar:l,colorBar:c};a.getTemplate("plan-time-main").render(d).appendTo(i)}))},getFirstDate:function(e){switch(e.currentState){case this.PENDING_PLAN:return e.dueDate?e.dueDate:e.creationDate;case this.EXECUTING_PLAN:case this.CLOSED_PLAN:return e.startDate}},getSecondDate:function(e){switch(e.currentState){case this.PENDING_PLAN:return null;case this.EXECUTING_PLAN:return e.dueDate;case this.CLOSED_PLAN:return e.closedDate}},getLastActivity:function(e){return JSON.parse(JSON.stringify(e)).sort((function(e,t){return e.finishDate<t.finishDate?1:-1}))[0]},getClosedDatePlan:function(e){return e.closedDate=this.getLastActivity(e.activities).finishDate,e.closedDate},getDifferenceBetweenDates:function(e,t){var a=$.Deferred(),i={idUser:bizagi.currentUser.idUser,fromDate:e,toDate:t};return $.when(this.callGetEffectiveDuration(i)).done((function(e){a.resolve(e.minutes)})),a.promise()},getIntervalOnMinutes:function(e){var t=this,a=$.Deferred();switch(e.currentState){case t.PENDING_PLAN:e.dueDate>Date.now()?$.when(t.getDifferenceBetweenDates(Date.now(),e.dueDate)).done((function(i){$.when(t.getDifferenceBetweenDates(e.creationDate,Date.now())).done((function(e){a.resolve({minutesToShowTime:i,minutesCreateToNow:e})}))})):e.dueDate<e.creationDate?$.when(t.getDifferenceBetweenDates(e.dueDate,e.creationDate)).done((function(i){$.when(t.getDifferenceBetweenDates(e.creationDate,Date.now())).done((function(e){a.resolve({minutesToShowTime:i+e,minutesCreateToNow:e})}))})):e.dueDate>e.creationDate&&$.when(t.getDifferenceBetweenDates(e.creationDate,e.dueDate)).done((function(i){$.when(t.getDifferenceBetweenDates(e.dueDate,Date.now())).done((function(e){a.resolve({minutesToShowTime:i+e,minutesCreateToNow:e})}))}));break;case t.EXECUTING_PLAN:e.dueDate?e.dueDate>Date.now()?$.when(t.getDifferenceBetweenDates(Date.now(),e.dueDate)).done((function(i){$.when(t.getDifferenceBetweenDates(e.startDate,Date.now())).done((function(e){a.resolve({minutesToShowTime:i,minutesStartToNow:e})}))})):$.when(t.getDifferenceBetweenDates(e.dueDate,Date.now())).done((function(i){$.when(t.getDifferenceBetweenDates(e.startDate,e.dueDate)).done((function(e){a.resolve({minutesToShowTime:i,minutesStartToDueDate:e})}))})):$.when(t.getDifferenceBetweenDates(e.startDate,Date.now())).done((function(e){a.resolve({minutesToShowTime:e})}));break;case t.CLOSED_PLAN:$.when(t.getDifferenceBetweenDates(e.startDate,e.closedDate)).done((function(e){a.resolve({minutesToShowTime:e})}))}return a.promise()},getKeywordDifferenceDates:function(e){switch(e.currentState){case this.PENDING_PLAN:return e.dueDate>Date.now()?"remaining":"exceeded";case this.EXECUTING_PLAN:return e.dueDate?e.dueDate>Date.now()?"remaining":"exceeded":"opened";case this.CLOSED_PLAN:return"executed"}},getRelativeTime:function(e){return bizagi.util.dateFormatter.getRelativeTime(e,null,!1)},getWidthBar:function(e,t){var a={};switch(e.currentState){case this.PENDING_PLAN:if(e.dueDate){if(e.dueDate<Date.now())return 0;var i=t.minutesCreateToNow+t.minutesToShowTime;return valuePercentInterval=t.minutesToShowTime,Math.ceil(100*valuePercentInterval/i)}return 0;case this.EXECUTING_PLAN:if(e.dueDate){if(e.dueDate>Date.now()){i=t.minutesStartToNow+t.minutesToShowTime;return valuePercentInterval=t.minutesToShowTime,Math.ceil(100*valuePercentInterval/i)}return 0}return 0;case this.CLOSED_PLAN:if(e.closedDate>Date.now()){var n=e.closedDate-e.startDate;return a=Date.now()-e.startDate,Math.ceil(100*a/n)}return 100}},getColorBarByPercent:function(e){return e<33?"Red":e<66?"Yellow":"Green"},callGetEffectiveDuration:function(e){var t=$.Deferred();return $.when(this.dataService.getEffectiveDuration(e)).done((function(e){t.resolve(e)})),t.promise()},getFormattedDate:function(e){return this.datePickerRegional.monthNames[e.getMonth()]+" "+bizagi.util.dateFormatter.formatDate(e,"dd hh:mm tt",bizagi.localization.getResource("datePickerRegional"))}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.time",["workportalFacade","dataService",bizagi.workportal.widgets.project.plan.time],!0),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.plan.parent",{},{init:function(e,t,a){this._super(e,t,a),this.loadTemplates({"plan-parent-main":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.parent").concat("#project-plan-parent")})},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){this.sub("LOAD_INFO_SUMMARY_PLAN",$.proxy(this.onNotifyLoadInfoSummaryPlan,this))},onNotifyLoadInfoSummaryPlan:function(e,t){var a=this,i=a.getContent().empty();a.params=$.extend(a.params,t.args),a.params.plan.parentWorkItem&&$.when(a.dataService.getPlanParent({idPlan:a.params.plan.id})).done((function(e){if(a.params.plan.parent=e,a.params.plan.parent){var t={idParent:a.params.plan.parent.radNumber,nameParent:a.params.plan.parent.displayName,idCase:a.params.plan.parent.idCase,idWorkflow:a.params.plan.parent.idWorkflow,idWorkItem:a.params.plan.parent.idWorkItem,idTask:a.params.plan.parent.idTask,processName:a.params.process?a.params.process:a.params.plan.parent.planName};if(bizagi.util.isEmpty(a.params.plan.parent.guidActivity))a.goToParentCase(i,t);else{var n={idPlan:a.params.plan.id,idActivity:a.params.plan.parent.guidActivity};$.when(a.dataService.getActivity(n)).done((function(e){a.params.plan.parent.allowEdition=e.allowEdition,a.goToParentCase(i,t)}))}}})).fail((function(e){}))},goToParentCase:function(e,t){e.empty(),this.getTemplate("plan-parent-main").render(t).appendTo(e),$("#go-to-parent-case",e).on("click",$.proxy(this.onClickGoToParentCase,this))},onClickGoToParentCase:function(e){e.preventDefault();this.routingExecute($(e.target).closest("#go-to-parent-case"))}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.parent",["workportalFacade","dataService",bizagi.workportal.widgets.project.plan.parent],!0),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.plan.users",{},{init:function(e,t,a){this.usersMap={},this.plugins={},this.usersInformation=[],this.globalHandlersService=bizagi.injector.get("globalHandlersService"),this.usersAssignees=[],this._super(e,t,a),this.loadTemplates({"plan-users-main":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.users").concat("#project-plan-users")}),this.auxNoRepeatTypesUser={},this.hashTypesUser={assigned:bizagi.localization.getResource("workportal-project-user-assigned"),owner:bizagi.localization.getResource("workportal-project-user-owner")}},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){this.sub("LOAD_INFO_ACTIVITIES_PLAN",$.proxy(this.onNotifyLoadInfoSummaryPlan,this))},onNotifyLoadInfoSummaryPlan:function(e,t){var a=this,i=t.args,n=[],s=[],r=a.getContent().empty(),o=t.args.plan.idUserCreator,p=t.args.plan.idUserCreator;a.params=$.extend(a.params,t.args),s.push({idUser:p,userGuid:o,userType:["owner"]}),a.usersMap["-"+p+"-"]={picture:"",id:p,guid:o,name:"",userType:["owner"]},n.push(p),$.each(a.params.plan.activities,(function(e,t){var i=t.userAssigned,r=t.userAssignedGuid;1==t.isRunning&&(i===p?-1===$.inArray("Assigned",s[0].userType)&&(s[0].userType.push("Assigned"),a.usersMap["-"+p+"-"].userType.push("Assigned")):(a.usersMap["-"+i+"-"]={picture:"",id:i,guid:r,name:"",userType:["Assigned"]},0===s.filter((function(e){return e.idUser==i})).length&&(s.push({idUser:i,guidUser:r,userType:["Assigned"]}),n.push(i))))})),a.activitiesUsers=s,a.params=i,a.getTemplate("plan-users-main").render({assignee:a.justAssignees(s),label:bizagi.localization.getResource("workportal-project-plan-assignee")}).appendTo(r),a.initilizeTooltip(),a.addEventHandlersModal(),$.when(a.callGetDataUsers(n)).then((function(){a.showCreatorInformation(p),a.renderUserProfilesAndImages()}))},justAssignees:function(e){var t=[];return-1==["CLOSED","PENDING"].indexOf(this.params.plan.currentState)&&e.map((function(e){var a=-1!==e.userType.indexOf("owner"),i=-1!==e.userType.indexOf("Assigned");t.push(usersAdapter.createJsonUserInfo(e.idUser,"","","","","",i,a,[],[]))})),usersAdapter.justAssignees(t)},showCreatorInformation:function(e){var t=this.usersInformation.find((function(t){return t.id==e})),a=usersAdapter.createJsonUserInfo(t.id,t.name,t.username,t.picture?"data:image/png;base64,"+t.picture:void 0,t.email,t.name.getInitials(),!1,!0,[],[]);this.content.find(".ui-bizagi-wp-project-plan-users .ui-bizagi-wp-project-users-creator-info").userinformation(this,{user:a})},renderUserProfilesAndImages:function(){var e=this;$.each(e.usersMap,(function(t,a){var i=$(".ui-bizagi-wp-userlist li[data-iduser="+a.id+"]",e.content);""!==a.picture?(i.find("img").prop("src",a.picture),$(".bz-wp-avatar-label",i).hide()):void 0!==a.name?($(".bz-wp-avatar-img",i).hide(),$(".bz-wp-avatar-label",i).html(a.name.getInitials())):console.log("obj.name is undefined")}))},callGetDataUsers:function(e){var t,a=this,i=$.Deferred();return t={usersGuids:e.join(),width:50,height:50},$.when(a.dataService.getUsersData(t)).always((function(e){a.usersInformation=e;for(var t=0,n=e.length;t<n;t+=1)void 0===e[t].name?bizagi.log(e[t]+" Id Not Found",e,"error"):a.usersMap["-"+e[t].id+"-"]?(a.usersMap["-"+e[t].id+"-"].picture+=e[t].picture?"data:image/png;base64,"+e[t].picture:"",a.usersMap["-"+e[t].id+"-"].name=e[t].name||""):console.log("self.usersMap['-' + response[i].id + '-'] is undefined");a.getUsersAssignees(),i.resolve()})),i.promise()},activityRunning:function(e){return null!==e.startDate&&null===e.finishDate},getUsersAssignees:function(){for(var e=0;e<this.usersInformation.length;e++){var t=this.getUserAssignee(this.params.plan.activities,this.usersInformation[e]);!1!==t&&this.usersAssignees.push(t)}},getUserAssignee:function(e,t){var a=this,i=e.filter((function(e){return e.userAssigned===t.id&&a.activityRunning(e)})).map((function(e){return{name:e.name}}));if(0==i.length)return!1;t.tasks=i;var n=a.activitiesUsers.find((function(e){return e.idUser==t.id}));return t.types=void 0===n?[]:n.userType,usersAdapter.createJsonUserInfo(t.id,t.name,t.username,t.picture?"data:image/png;base64,"+t.picture:void 0,t.email,t.name.getInitials(),t.types.indexOf("Assigned")>-1,t.types.indexOf("owner")>-1,t.tasks,[])},initilizeTooltip:function(){var e=this;$(".ui-bizagi-wp-userlist > li",e.content).not(".moreUsers").on("mouseenter","",(function(t){var a=$(t.target),i=a.closest("[data-iduser]").attr("data-iduser"),n=e.usersInformation.find((function(e){return e.id==i})),s=[];n.tasks&&n.tasks.map((function(e){s.push(e.name)}));var r=e.activitiesUsers.find((function(e){return e.idUser==i}));n.types=r.userType,n.owner=n.types.find((function(e){return"owner"==e})),n.isAssignee=n.types.find((function(e){return"Assigned"==e}));var o=usersAdapter.createJsonUserInfo(n.id,n.name,n.username,n.picture?"data:image/png;base64,"+n.picture:void 0,n.email,n.name.getInitials(),n.isAssignee,n.owner,s,[]);a.parent().usertooltip(e,{target:a,user:o})}))},addEventHandlersModal:function(){var e=this;$(".moreUsers").click((function(t){t.preventDefault(),t.stopPropagation();var a=e.usersAssignees||[];e.globalHandlersService.publish("showDialogWidget",{widgetName:bizagi.workportal.widgets.widget.BIZAGI_WORKPORTAL_WIDGET_USERS_MODAL,closeVisible:!0,data:a,maximize:!0,modalParameters:{title:bizagi.localization.getResource("workportal-project-users-title")+" ("+a.length+")",width:790,height:526,refreshInbox:!1}})}))}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.users",["workportalFacade","dataService",bizagi.workportal.widgets.project.plan.users],!0);
//# sourceMappingURL=../../../../Maps/desktop/plansidebar.desktop.production.js.map
