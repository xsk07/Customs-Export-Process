bizagi.workportal.comments={renderComments:function(e){var t=this,a={},o="",n=new $.Deferred,i={},s=-1,r=bizagi.currentUser.idUser,l=e.canvas,c=e.readOnly||!1;t.setStorage("bufferLocalNewComments_"+e.caseNumber,0),t.setStorage("idCase",e.caseNumber),t.comments=t.workportalFacade.getTemplate("comments"),t.commentsList=t.workportalFacade.getTemplate("comments-list"),t.commentsReplies=t.workportalFacade.getTemplate("comments-replies"),t.commentsDropdown=t.workportalFacade.getTemplate("comments-dropdown"),t.commentsConfirm=t.workportalFacade.getTemplate("comments-confirm"),e.showComments=!0;var m=function(a){i=a.comments,t.setStorage("maxIdComment_"+e.caseNumber,a.maxIdComment),t.setStorage("bufferLocalNewComments_"+e.caseNumber,0)};return $.when(t.getComments({idCase:e.caseNumber},m)).done((function(d){var p=d.users||[],g=function(e){var t="";switch(e){case 0:t="orange";break;case 1:t="red";break;case 2:t="yellow";break;case 3:t="blue";break;case 4:t="purple";break;case 5:t="green";break;default:t="disable"}return t},u=function(e){$(e).children("li:not(:last)").slideUp("fast"),$("span.reply-toggler > span",e.parent()).removeClass("expanded")},f=function(e){var t=$(".reply-list li",e)||[],a=$(".reply-toggler",e);t.length>1?a.removeClass("hidden"):a.addClass("hidden")},h=function(e){return $.timeago(new Date(e))},C=function(e){var t="";return $.each(p,(function(a,o){p[a].Id==e&&(t=o.Picture)})),t},b=function(e){var t="";return $.each(p,(function(a,o){p[a].Id==e&&(t=o.DisplayName)})),t},x=function(){$(".comments-text-box").removeClass("comments-reply-box"),$(".comments-text-box li:first-child").data("reply-mode",""),$(".comments-text-box li:first-child").data("id","")},v=function(e,a){return i.totalRecords=d.totalRecords,p=a,w({totalPages:e.totalPages,actualPage:e.actualPage}),$.tmpl(t.commentsList,{comments:e.comments,User:p,CurrentUser:r,RelatedElementId:null,getCategoryColor:g,replaceTextToSmiles:t.replaceTextToSmiles,timeAgo:h,getUserPicture:C,getUserName:b,readOnly:c})},w=function(a,o){var n=a.totalPages||1,i=n>1,r=a.actualPage||1,l=$(".comments-pagination")||o,c={};c.pagination=i,c.totalPages=n,c.pages=[],c.page=r,l.empty(),i?l.show():l.hide();for(var m=5>n?n:5,d=1;d<=m;d++)c.pages.push({pageNumber:d});var p=$.tmpl(t.paginationTemplate,c).html();$(l).append(p),$("ul").bizagiPagination({totalPages:c.totalPages,actualPage:c.page,listElement:$("ul",l),clickCallBack:function(a){$.when(t.getComments({idCase:e.caseNumber,idColorCategory:s,pag:a.page})).done((function(e){y(e,e.users,!0)}))}})},y=function(e,t){return i.totalRecords=e.totalRecords,$("#comment-list").empty(),(o=v(e,t)).appendTo($("#comment-list")),a.subprocess=$("#comment-list"),P(),o};c||bizagi.util.setInterval({name:"comments",params:{idCase:bizagi.context.idCase},singleton:!0,timeout:3e4,killWhenExitContext:!1,context:'(bizagi.context.widget=="'+t.getWidgetName()+'" && bizagi.context.idCase == "'+e.caseNumber+'" && bizagi.context.commentsFocus)',call:function(e){e=e||{};var a=t.getStorage("maxIdComment_"+e.idCase);$.when(t.dataService.getNewComments({idCase:e.idCase,idLastComment:a})).done((function(a){if(a.newComments>0||a.newReplies>0){var o=a.newComments+a.newReplies,n=t.getStorage("bufferLocalNewComments_"+e.idCase)||o,i=$(".comments-update").data("message").replace(/{totalNewComments}/,o-n);o>n&&($(".comments-update").text(i),$(".comments-update").show().click((function(e){e.isPropagationStopped()||(e.stopPropagation(),$("#filterClear").click())})))}}))}}),o=function(a,o){return i.totalRecords=a.totalRecords,p=o,$.tmpl(t.comments,{comments:a.comments,readOnly:c,User:p,idCase:e.caseNumber,CurrentUser:r,RelatedElementId:null,getCategoryColor:g,replaceTextToSmiles:t.replaceTextToSmiles,timeAgo:h,getUserPicture:C,getUserName:b,getCategoryName:function(e){return t.resources.getResource("workportal-widget-comments-"+e)}})}(d,p),$(".comment-frame .button-category",o).tooltip(),$(o).find("*").off("click"),$(".button-refresh",o).click((function(){$(".comments-update").hide(),$.when(t.getComments({idCase:e.caseNumber,idColorCategory:s},m)).done((function(e){var t=e.users||[];$("#comment-list").empty(),(o=y(e,t)).appendTo($("#comment-list")),a.subprocess=$("#comment-list"),P()}))})),$(".make-new-comments",o).click((function(){x(),$(".comments-text-box li:first-child").slideDown("fast"),$(".comment-box",o).focus().fadeIn(),$(this).hide(),$(".action-buttons").show().slideDown("fast"),$(".text-to-reply").hide()})),$(".comment-box",o).blur((function(){0==$(".comments-text-box textarea").val().length&&($(".comments-text-box textarea").val(""),$(".comments-text-box li:first-child").slideUp("fast"),$(".make-new-comments").fadeIn(),$(".action-buttons").hide(),x())})),$(".send-new-comments",o).click((function(){var a=$(".comments-text-box textarea").val();if(0!=a.length){if("true"==$(".comments-text-box li:first-child").data("reply-mode")){var o=$(".comments-text-box li:first-child").data("id"),n=$("li[data-id='"+o+"']");$.when(t.dataService.makeNewReply({idCase:e.caseNumber,idComment:o,comment:a})).done((function(a){t.incrementStorage("bufferLocalNewComments_"+e.caseNumber,1);var o=function(e,a){return i.totalRecords=d.totalRecords,p=a,$.tmpl(t.commentsReplies,{Replies:e.Replies,User:p,CurrentUser:r,RelatedElementId:null,getCategoryColor:g,replaceTextToSmiles:t.replaceTextToSmiles,timeAgo:h,getUserPicture:C,getUserName:b,readOnly:c})}(a,a.users);$(".reply-list",n).append(o),$(".reply-list li:last",n).show("highlight","slow"),u($(".reply-list",n)),f($(n))}))}else $.when(t.dataService.makeNewComment({idCase:e.caseNumber,comment:a})).done((function(a){t.incrementStorage("bufferLocalNewComments_"+e.caseNumber,1);var o=v(a,a.users);$(".reply-toggler",o).addClass("hidden"),$("#comment-list").prepend(o),$("#comment-list li:first").show("highlight","fast")}));$(".comments-text-box li:first-child").slideUp("fast"),$(".make-new-comments").show(),$(".action-buttons").hide(),$(".comments-text-box textarea").val(""),$(".time-ago").timeago(),x()}}));function k(){$(".categories-dropdownmenu").empty(),$(".categories-dropdownmenu").data("visible",!1)}$(o).delegate(".editBox","keypress",(function(e){13==e.keyCode&&$(this).parent().find(".btnSave").click()})),$(o).delegate(".btnSave","click",(function(){var e=$(this).parent(),a=e.attr("data-old-icon"),n=e.attr("data-old-text"),i=$(this).siblings(".editBox").val(),s=e.html(n).find("a span.filter-icon"),r=$("#filterText").attr("class");$("#filterText").hasClass("disable")||a!==r||($("#filterText",o).text(i),$(".filter-dropdown").removeClass("is-visible").addClass("is-hidden")),e.removeAttr("data-old-text").html(n).find("a").empty().append(s,i).removeClass("no-pad"),t.dataService.renameCommentCategory({idColorCategory:e.data("category-id"),colorName:i})})),$(o).delegate(".btnDiscard","click",(function(){for(var e,t,a=$(this).parent(),o=a.length,n=0;n<o;n++)e=a[n],t=$(e).attr("data-old-text"),$(e).removeAttr("data-old-text").html(t).removeClass("no-pad")}));var S=function e(a){var o=$(".categories-dropdownmenu"),n=a.referer||$(),i=a.css||"",s=a.idComment||"",r=a.position||{my:"right top",at:"right top",collision:"fit",of:n.selector||n};o.data("name")!=a.name?(k(),o.data("name",a.name||""),e(a)):o.data("visible")?k():$.when(t.dataService.getCommentsCategories()).done((function(e){o.empty(),o.position(r),function(e){return $.tmpl(t.commentsDropdown,{categories:e.categories,css:e.css,idComment:e.idComment,getCategoryColor:g,readOnly:c})}({categories:e.categories,css:i,idComment:s,referer:n}).appendTo(o),o.data("visible",!0),o.data("name",a.name||"")}))};$("#buttonFilter",o).bind("click",(function(){var e={referer:$("#buttonFilter",o),name:"editCategories",css:"editCategories"};c&&(e.position={my:"left bottom",at:"left bottom",collision:"fit",of:this}),S(e)}));var N=function(){return $(".comment-controls").data("idcase")};$(o).delegate(".close","click",k),$(o).delegate(".btnEdit","click",(function(){var e=$(this),t=e.parent(),a=t.text().replace(/^\s+|\s+$/g,""),o=e.siblings("a").children("span").attr("class").split(" ")[1],n=t.html(),i='<input type="text" class="editBox" value="'+a+'" /> <span class="filter-icon-ctrl btnSave"></span> <span class="filter-icon-ctrl btnDiscard"></span>';t.attr("data-old-icon",o),t.html(i).attr("data-old-text",n).addClass("no-pad"),$(".editBox").select()})),$(o).delegate(".filter-category","click",(function(e){if(!e.isPropagationStopped()){var a=$(this).parent().data("category-id"),o=$(".categories-dropdownmenu").data("name"),n=bizagi.util.trim($(this).text());if("setCategories"==o){var i=$(this).data("idcomment");$.when(t.dataService.setCommentCategory({idCase:N,idColorCategory:a,idComment:i})).done((function(){$("#"+i).removeClass(),$("#"+i).addClass("button-category"),$("#"+i).addClass(g(a)),k()}))}else $.when(t.dataService.getComments({idCase:N,idColorCategory:a})).done((function(e){var t=$(".comment-filter > #buttonFilter");a>=0?(s=a,$(".button-refresh").data("category-id",a),$("#filterName").removeClass("is-hidden"),$("#filterText").text(n)):($("#filterName").addClass("is-hidden"),$("#filterText").text(""),s=-1),$("#comment-list").empty(),$("#comment-list").append(v(e,e.users)),t.removeClass(),t.addClass("button-category "+g(a)),k(),$(".button-refresh").data("category-id",a),P(),$(".button-refresh").click()}));e.stopPropagation()}})),$(o).delegate("#filterClear","click",(function(){$("#filterClear").bind("click",(function(e){e.isPropagationStopped()||(e.stopPropagation(),s=-1,$(".comment-filter > #buttonFilter").removeClass(),$(".comment-filter > #buttonFilter").addClass("button-category "+g()),$(".button-refresh").data("category-id",""),$("#filterName").addClass("is-hidden"),$("#filterText").text(""),$(".button-refresh").click())}))})),c||($(o).on("click",".button-category[data-own='true']",(function(e){if(!c&&!e.isPropagationStopped()){e.stopPropagation();S({referer:this,name:"setCategories",css:"setCategories",idComment:$(this).data("id"),position:{my:"right top",at:"left bottom",collision:"fit",of:this}})}})),$(o).on("click",".button-reply",(function(e){if(!e.isPropagationStopped()){var t=$(this).data("id"),a=$("li[data-id='"+t+"'] .comment-text").first().text();$(".comments-text-box li:first-child").data("reply-mode","true"),$(".comments-text-box li:first-child").data("id",t),$(".text-to-reply").text(a),$(".text-to-reply").show(),$(".comments-text-box textarea").focus(),$(".comments-text-box").addClass("comments-reply-box"),$(".comments-text-box li:first-child").show().slideDown("fast"),$(".make-new-comments").hide(),$(".action-buttons").show().slideDown("fast"),e.stopPropagation()}})),$(o).on("click",".button-delete",(function(e){var a=$(this).parents("li:first"),o=$(this).data("id"),n=a.parent();$.tmpl(t.commentsConfirm).dialog({resizable:!0,modal:!0,title:t.getResource("workportal-widget-comments-title"),buttons:[{text:t.getResource("workportal-widget-comments-delete"),click:function(){if(n.hasClass("reply-list")){var e=a.parents("li:first").data("id");$.when(t.dataService.removeReply({idCase:N,idComment:e,idReply:o}).done((function(e){i(e)})))}else $.when(t.dataService.removeComment({idCase:N,idComment:o}).done((function(e){i(e)})));var i=function(e){e.action?$.when(a.hide("highlight","fast")).done((function(){a.remove(),n.hasClass("reply-list")&&(n.find("li").hide(),n.find("li:last").show(),f(n.parents("li:first")))})):alert(e.message)};$(this).dialog("close"),bizagi.workportal.desktop.popup.closePopupInstance()}},{text:t.getResource("workportal-widget-comments-cancel"),click:function(){$(this).dialog("close")}}]})})));var P=function(){$.each($(".reply-list",o),(function(){var e=$(".reply-toggler",$(this).parents("li:first"));$("li",this).length>1?($(this).children("li:not(:last)").hide(),e.removeClass("hidden")):e.addClass("hidden")}))};$(o).on("click",".reply-toggler",(function(e){var t;e.isPropagationStopped()||(e.stopPropagation(),"hide"!=$(this).data("toggle-action")?(t=$(this).parent().find("ul"),$(t).children("li:not(:last)").slideDown("fast"),$("span",this).addClass("expanded"),$(this).data("toggle-action","hide")):(u($(this).parent().find("ul")),$("span",this).removeClass("expanded"),$(this).data("toggle-action","show")))})),P(),o.appendTo(l),w({totalPages:d.totalPages,actualPage:d.actualPage},$(".comments-pagination")),n.resolve(l)})),n.promise()},getComments:function(e,t){var a=new $.Deferred;return e=e||{},t=t||function(){},$.when(this.dataService.getComments(e)).done((function(e){t(e),a.resolve(e)})),a.promise()},replaceTextToSmiles:function(e){for(var t=e,a="",o={"<br>":"\n","[<]":"&lt;","[>]":"&gt;"};a!=t;)$.each(o,(function(e,o){var n=new RegExp(e,"gm");a=t,t=t.replace(n,o,"gm")}));return $.each({":)":"smiley",":!":"sarcastic",":$":"embarrassed",":(":"sad",":'(":"cry",";)":"wink",":|":"disappointed",":D":"happy",":o":"surprise",":p":"tongue",":s":"confused"," Y ":"yes"," N ":"no"},(function(e,a){var o=e.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),n=new RegExp(o),i="<div class='smiles "+a+"'></div>";t=t.replace(n,i,"g")})),t},setStorage:function(e,t){var a="";return e=e||"",sessionStorage&&(a=sessionStorage.setItem(e,t)),a},incrementStorage:function(e,t){var a=!0;if(sessionStorage){var o=parseInt(this.getStorage(e))+parseInt(t);this.setStorage(e,o)}else a=!1;return a},getStorage:function(e){var t=void 0;return e=e||"",sessionStorage&&(t=sessionStorage.getItem(e)),t}};
//# sourceMappingURL=../../../../Maps/desktop/comments-old.desktop.production.js.map
