bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.dashboard.menu",{},{onDiscussionsMenuStatusChange:function(t,e){this.updateDiscussionsIcons(e.hasDiscussionsOrComment)},updateDiscussionsIcons:function(t){this.sub("UPDATE_DISCUSSIONS_MENU_STATUS",$.proxy(this.onDiscussionsMenuStatusChange,this)),$(".bz-icon-discussion-comment").toggle(t),$(".bz-icon-discussion-no-comment").toggle(!t),this.params.hasDiscussionsOrComment=t},clean:function(){this.unsub("UPDATE_DISCUSSIONS_MENU_STATUS",$.proxy(this.onDiscussionsMenuStatusChange,this))}}),bizagi.injector.register("bizagi.workportal.widgets.project.dashboard.menu",["workportalFacade","dataService",bizagi.workportal.widgets.project.dashboard.menu],!0),bizagi.workportal.widgets.project.dashboard.menu.extend("bizagi.workportal.widgets.project.dashboard.menu.plan",{},{init:function(t,e,i,s){this.params=s||{},this.projectDashboard=i,this._super(t,e,s),this.loadTemplates({"project-dashboard-menu":bizagi.getTemplate("bizagi.workportal.desktop.widgets.project.dashboard.menu.plan").concat("#project-dashboard-menu")})},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){var t=this;t._super(),t.params&&t.params.contextsLeftSidebarCaseDashboard&&t.params.contextsLeftSidebarCaseDashboard.forEach((function(e){t.sub(e,$.proxy(t.updateView,t))}))},updateView:function(t,e){this.params=$.extend(this.params,e.args),this.clean();var i=this.getContent().empty(),s=this.getTemplate("project-dashboard-menu");this.params.menuPlanDashboard=this.params.menuPlanDashboard||{},$.extend(this.params.menuPlanDashboard,this.params.menuDashboard),this.planState=this.getPlanState(this.params.plan,this.params.planChild);var a={planState:this.planState,showCommentsOptionMenu:this.params.menuPlanDashboard.showCommentsOptionMenu,showFilesOptionMenu:this.params.menuPlanDashboard.showFilesOptionMenu,showTimeLineOptionMenu:this.params.menuPlanDashboard.showTimeLineOptionMenu&&this.isVisibleShowTimeLine(this.planState)};s.render(a).appendTo(i),$("li[data-context='"+this.params.showContextByMenuDashboard.toUpperCase()+"']",this.content).addClass("active").siblings().removeClass("active"),this.updateDiscussionsIcons(this.params.hasDiscussionsOrComment),this.handlerEvents()},getPlanState:function(t,e){var i;return e&&e.currentState?i=e.currentState:t&&t.currentState&&(i=t.currentState),i},isVisibleShowTimeLine:function(t){var e=!0;return"PENDING"===t&&(e=!1),e},loadContentById:function(t){t.preventDefault();var e=$(t.target).closest("li");if("PLANBACK"===e.data("context"))this.backParentPlan();else if(!e.hasClass("active")){var i=e.data("context");i&&(this.pub("notify",{type:i.toUpperCase(),args:$.extend(this.params,{showContextByMenuDashboard:i})}),$("li[data-context='"+this.params.showContextByMenuDashboard.toUpperCase()+"']",this.content).addClass("active").siblings().removeClass("active"))}},subMenuHandler:function(){var t=this,e=t.getContent(),i=$("[data-context='PLANCOMMENTS']",e),s=$("[data-context='PLANFILES']",e),a=$("[data-context='PLANTIMELINE']",e);$(".ui-bizagi-wp-project-tab-submenu a",e).on("click",(function(){i.toggle(),s.toggle(),t.isVisibleShowTimeLine(t.planState)&&a.toggle()}))},backParentPlan:function(){var t=this.pub("notify",{type:"NAVIGATOR_GETLEVEL"}),e=parseInt(t[0]),i=this.projectDashboard.getParamsByBackFromPlan(this.params,e);this.pub("notify",{type:i.typeContext,args:$.extend(this.params,i.paramsNotify)})},handlerEvents:function(){var t=this.getContent();this.subMenuHandler(),$(".ui-bizagi-wp-project-tab-links a",t).on("click",$.proxy(this.loadContentById,this))},clean:function(){var t=this,e=t.getContent();t._super(),$(".ui-bizagi-wp-project-tab-links a",e).off(),t.params&&t.params.contextsLeftSidebarCaseDashboard&&t.params.contextsLeftSidebarCaseDashboard.forEach((function(e){t.unsub(e,$.proxy(t.updateView,t))}))}}),bizagi.injector.register("bizagi.workportal.widgets.project.dashboard.menu.plan",["workportalFacade","dataService","bizagi.workportal.services.behaviors.projectDashboard",bizagi.workportal.widgets.project.dashboard.menu.plan],!0),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.content.dashboard",{},{init:function(t,e,i){this._super(t,e,i),this.loadTemplates({"project-content-dashboard":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.content.dashboard").concat("#project-plan-content-dashboard")})},renderContent:function(){var t=this.getTemplate("project-content-dashboard");return this.content=t.render({}),this.content},postRender:function(){setTimeout((function(){$(window).trigger("resize")}),1e3)}}),bizagi.injector.register("bizagi.workportal.widgets.project.content.dashboard",["workportalFacade","dataService",bizagi.workportal.widgets.project.content.dashboard],!0),function(t){var e=window.kendo.ui,i=e.Widget,s=i.extend({init:function(t,e){i.fn.init.call(this,t,e),this._maxFilesSize=e.maxSize,this._fileList=[],this._onlyValidateServerFileExtension=e.onlyValidateServerFileExtension||!0,this._supportFileExt=e.extensions,this._uploadMaxFilesSize=e.maxSize,this.upload=this._initUpload(),this.loadNotifier=this._initLoadNotifier(),this.notification=this._initNotification(),this._eventsHandler(),this._initLocalization(this.options.localization)},options:{name:"ProjectAttachments",wrapper:t('<div class="project-attachments"></div>'),multiple:!0,dropZone:!0,maxFilesSize:bizagi.currentUser?bizagi.currentUser.uploadMaxFileSize:25e3,enabled:!0,localization:{}},_initUpload:function(){var t=this,e=t.options,i=e.localization||{},s=0;return t._initLocalization(i),this.element.kendoUpload({async:{saveUrl:e.saveUrl+"?xsrf="+bizagi.getXSRFToken(),autoUpload:!0},select:function(e){t._filterMaxFilesSize(e),s=0},complete:function(){var e=setInterval((function(){0===t.loadNotifier.wrapper.find("li.k-file-progress").length&&(t._showNotificationCompleteUpload(t.loadNotifier.wrapper,s),clearInterval(e))}),300)},upload:e.upload,progress:function(e){t._onProgressFile(e)},success:function(i){t._fileList.push(i.files[0]),s+=1,e.success(i)},error:function(e){t.onErrorFile(e)},localization:{select:i.selectFiles,dropFilesHere:i.dropFilesHere},multiple:e.multiple,enabled:e.enabled,dropZone:e.dropZone,showFileList:!1}).data("kendoUpload")},_initNotification:function(){return t("<div></div>").kendoNotification({position:{pinned:!0}}).data("kendoNotification")},_initLoadNotifier:function(){var t=this.options.localization;return this.options.wrapper.kendoWindow({title:t.notifierTitle,actions:["Close"],animation:{open:{duration:100},close:{duration:100}},open:function(){this.wrapper.addClass("project-attachments-wrapper-window")},visible:!1,resizable:!1,draggable:!1,maxHeight:"300px",minWidth:"430px"}).data("kendoWindow")},_initLocalization:function(e){var i={selectFiles:bizagi.localization.getResource("workportal-project-attachments-addfiles"),notifierTitle:bizagi.localization.getResource("workportal-project-attachments-notifiertitle"),errorUpload:bizagi.localization.getResource("workportal-project-attachments-file-error"),errorSecurity:bizagi.localization.getResource("workportal-project-attachments-blockedext"),errorSize:bizagi.localization.getResource("workportal-project-attachments-blockedsize"),errorMaxFilesSize:bizagi.localization.getResource("workportal-project-discussion-maxfilessize").replace("%s",this._getSize(this._maxFilesSize)),dropFilesHere:bizagi.localization.getResource("workportal-project-attachments-drophere"),cancel:bizagi.localization.getResource("workportal-widget-reports-confirm-cancel"),retry:bizagi.localization.getResource("workportal-project-attachments-retry"),close:bizagi.localization.getResource("workportal-widget-dialog-box-close")};t.extend(e,i)},_getSize:function(t){return Math.round(t/1048576,-1)},_onProgressFile:function(e){var i=this._getFileItemByUID(e.files[0].uid),s=e.percentComplete;t(".k-progress",i).css({width:s+"%"}),t(".k-upload-pct",i).removeClass("k-icon k-loading").text(s+"%"),100===s&&t(".k-upload-action .k-icon",i).hide()},_onShowUploadNotifier:function(t){var e=t.files,i=this.options.template;this.loadNotifier.content(i.render({files:e})),this.loadNotifier.wrapper.css({top:"auto",left:"auto",bottom:"1em",right:"1em"}),this.loadNotifier.open()},_showNotificationCompleteUpload:function(t,e){t.find("li.k-file-success").length===e&&0===t.find("li.k-file-error").length&&this._autoHideMessage(t)},_autoHideMessage:function(t){var e=this;setTimeout((function(){t.fadeOut((function(){e.loadNotifier.close()}))}),2e3)},_onCancelFile:function(t){var e=t.closest("li"),i=this.upload.wrapper,s=e.data("guid");i.find("li[data-uid="+s+"] .k-upload-action").trigger("click"),e.remove()},_onRemoveFile:function(t){t.closest("li").remove()},_onRetryFile:function(e){var i=e.closest("li").data("guid"),s=t.grep(this._fileList,(function(t){return t.uid===i}));this.options.retry(s[0])},onErrorFile:function(t){var e=this.options.localization,i=t.files[0],s=this._isValidFile(i),a=""!==s.message?s.message:e.errorUpload;this.setStatus("ERROR",i.uid,a)},_isValidFile:function(e){var i=this.options.localization,s=!0,a="";return(e.size>this._uploadMaxFilesSize||null==e.size||0==e.size)&&(a=i.errorSize,s=!1),this._onlyValidateServerFileExtension||-1===t.inArray(e.extension,this._supportFileExt)&&(a=i.errorSecurity,s=!1),{valid:s,message:a}},_filterMaxFilesSize:function(t){for(var e=0,i=0,s=t.files.length;i<s;i++)e+=t.files[i].size;e>this._maxFilesSize?(this._notifySizeExceeded(),t.preventDefault()):this._onShowUploadNotifier(t)},_notifySizeExceeded:function(){this.notification.show(this.options.localization.errorMaxFilesSize,"error")},_getFileItemByUID:function(e){return t("li[data-guid="+e+"]",this.loadNotifier.element)},_switchEvents:function(e){var i=t(".k-icon",e.currentTarget);i.hasClass("k-update")||i.hasClass("k-remove")?this._onRemoveFile(i):i.hasClass("k-retry")?this._onRetryFile(i):i.hasClass("k-cancel")&&this._onCancelFile(i)},_eventsHandler:function(){var t=this;t.loadNotifier.element.on("click","button.k-upload-action",(function(e){t._switchEvents(e)}))},cancelFilesUpload:function(){this.upload.wrapper.find("li .k-upload-action").trigger("click"),this.close()},close:function(){this.loadNotifier.close()},destroy:function(){this.loadNotifier.destroy(),this.upload.destroy()},setStatus:function(e,i,s){var a=this._getFileItemByUID(i),n=this.options.localization;switch(e){case"SUCCESS":a.removeClass("k-file-progress k-file-error").addClass("k-file-success"),t(".k-upload-action .k-icon",a).removeClass("k-cancel k-i-refresh k-retry").addClass("k-update").prop("title",n.close).show(),t(".k-errormsg",a).text("");break;case"ERROR":a.removeClass("k-file-progress").addClass("k-file-error"),t(".k-upload-action .k-icon",a).removeClass("k-i-refresh k-retry").addClass("k-remove").show(),t(".k-upload-status .k-upload-pct",a).removeClass("k-upload-pct k-loading").addClass("k-icon k-warning"),t(".k-errormsg",a).text(s).prop("title",s);break;case"RETRY":a.removeClass("k-file-progress").addClass("k-file-error"),t(".k-upload-status .k-upload-pct",a).removeClass("k-upload-pct k-loading").addClass("k-warning").text(""),t(".k-upload-action .k-icon",a).removeClass("k-cancel k-remove").addClass("k-i-refresh k-retry").prop("title",n.retry).show(),t(".k-errormsg",a).text(n.errorUpload).prop("title",n.errorUploadiis)}}});e.plugin(s)}(jQuery),bizagi.workportal.widgets.project.base.extend("bizagi.workportal.widgets.project.discussions",{},{init:function(t,e,i,s){this.typeResource="DiscussionGuid",this.plugins={},this.dialogBoxDiscussion={},this.attchComments={},this.attchDiscussions={remove:[],addition:[]},this.listDataDiscussion=[],this.userPictures=[],this.commentsList={},this.globalTags=[],this.tempTagsBeforeDelete=[],this.tempTagsToDelete=[],this.keySentenceAddTag=bizagi.localization.getResource("workportal-project-discussion-add-new-tag")+": ",this.notifier=i,this._super(t,e,s),this.loadTemplates({"project-discussions":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.discussions").concat("#project-discussions-wrapper"),"project-discussions-popup":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.discussions").concat("#project-discussions-popup-wrapper"),"project-discussions-list":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.discussions").concat("#project-discussions-list-wrapper"),"project-discussions-comments":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.discussions").concat("#project-discussions-comments-list"),"project-discussions-attachments":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.discussions").concat("#project-discussions-attachments-list"),"project-attachments":bizagi.getTemplate("bizagi.workportal.desktop.widgets.project.attachments").concat("#project-attachments")})},renderContent:function(){var t=this.getTemplate("project-discussions");return this.content=t.render({}),this.content},postRender:function(){var t=this.getContent();this.plugins.popupDiscussion=this.initPluginPopupDiscussion();var e=this.plugins.popupDiscussion;this.form={buttonShowFormNewDiscussion:$(".ui-bizagi-wp-action-new",t),title:$(".ui-bizagi-wp-project-popupform-h4",e),subject:$("#ui-bizagi-wp-project-discussions-popup-subject-input",e),description:$("#ui-bizagi-wp-project-discussions-popup-description-textarea",e),buttonShowPopupDiscussionToAdd:$("#ui-bizagi-wp-project-discussions-button-action-show-popup-to-add",t),buttonAddDiscussion:$("#ui-bizagi-wp-project-discussions-popup-action-add-discussion",e),buttonCancel:$("#ui-bizagi-wp-project-popupform-action-cancel",e),formDiscussion:$(".ui-bizagi-wp-project-discussions-popup",e),attachments:$(".ui-bizagi-wp-project-discussions-attachments-cmnwrapper",e),edition:!1},this.plugins.tagsFilter=this.initPluginTagsFilter(),this.plugins.tagsMultiSelect=this.initPluginTagsMultiSelect(e),this.getDiscussions(),this.eventsHandler(),this.restrictedEventsHandler()},getDiscussions:function(){var t=this;t.getDataDiscussions().done((function(){var e=$.map(t.listDataDiscussion,(function(t){return t.user})),i=$.map(t.commentsList,(function(t){return $.map(t.comments,(function(t){return t.user}))}));var s=function(t){for(var e={},i=[],s=t.length,a=0,n=0;n<s;n++){var o=t[n];1!==e[o]&&(e[o]=1,i[a++]=o)}return i}(e.concat(i).concat(bizagi.currentUser.idUser)).join(",");t.getDataUsers(s).then((function(){t.renderUserProfilesAndImages()})),t.setClassesTagsByDiscussion()}))},onNotifyOpenPopup:function(){this.form.edition=!1,this.showFormAddDiscussion("workportal-project-discussion-adddiscussion"),this.renderUserProfile()},initPluginPopupDiscussion:function(){var t=this.getTemplate("project-discussions-popup");return this.dialogBoxDiscussion.formContent=t.render({attachments:[]}),this.dialogBoxDiscussion.formContent},initPluginTagsMultiSelect:function(t){var e,i=this,s=t.find("#ui-bizagi-wp-project-discussions-options-multiselect-tags"),a=!1,n=!1;return s.kendoMultiSelect({change:function(){var t=this.value().slice(0),e=this.dataSource.data();t.length>0&&-1!==e[0].tag.replace(i.keySentenceAddTag,"").indexOf(t[t.length-1])&&(t[t.length-1]=e[0].tag.replace(i.keySentenceAddTag,"")),t=(t=t.filter(Boolean)).filter((function(t,e,i){return i.indexOf(t)===e}));var s="";if(e.length>0&&-1!==e[0].tag.indexOf(i.keySentenceAddTag)){s=e[0].tag.replace(i.keySentenceAddTag,"");var o={};-1!==t.indexOf(s)?(o=this.dataSource.at(0),a=!0,this.dataSource.remove(o),a=!1,this.refresh(),n=!0):s&&($("li:first",this.list).hasClass("k-state-focused")&&(n=!0,t.push(s)),o=this.dataSource.at(0),a=!0,this.dataSource.remove(o),a=!1)}s&&(n&&(0===this.dataSource.data().filter((function(t){return t.tag===s})).length&&this.dataSource.add({guid:s,tag:s}),n=!1));this.dataSource.filter({}),this.value(t)},dataBound:function(){if((e||this._prev)&&e!==this._prev&&!a){e=this._prev;var t=this.dataSource.data(),s=!1;t.length>0&&-1!==t[0].tag.indexOf(i.keySentenceAddTag)&&(t[0].tag=i.keySentenceAddTag+e,this.refresh(),s=!0,$("li",this.list).removeClass("k-state-focused"),$("li:first",this.list).addClass("k-state-focused")),s||this.dataSource.insert(0,i.createEmptyTag(i.keySentenceAddTag,e)),0==this.dataSource.total()&&(this.search(),this.open(),this.refresh(),$("li",this.list).removeClass("k-state-focused"),$("li:first",this.list).addClass("k-state-focused"))}},dataSource:[],dataTextField:"tag",dataValueField:"guid",filter:"contains",animation:!1}).data("kendoMultiSelect")},createEmptyTag:function(t,e){return{tag:t+e,guid:""}},initPluginTagsFilter:function(){var t=this,e=t.getContent();return $("#ui-bizagi-wp-project-discussions-options-tags-filter",e).kendoMultiSelect({change:function(){t.hideOrShowDiscussionsByFilter()},autoClose:!1,tagMode:"single",dataTextField:"tag",dataValueField:"guid"}).data("kendoMultiSelect")},hideOrShowDiscussionsByFilter:function(){var t=this,e=t.plugins.tagsFilter.value();e.length>0?($(".ui-bizagi-wp-project-discussions-item",t.getContent()).hide(),e.forEach((function(e){$(".ui-bizagi-wp-project-discussions-item."+e,t.getContent()).show()}))):$(".ui-bizagi-wp-project-discussions-item",t.getContent()).show()},validateAddCommentForm:function(t){var e=!1,i=$("textarea",t);if(""===i.val().trim()){var s=bizagi.localization.getResource("workportal-project-discussion-requiredcomment");i.parent().next().find("span").html(s)}else i.parent().next().find("span").empty(),e=!0;return e},validateAddDiscussionForm:function(t){var e=!1,i=$("#ui-bizagi-wp-project-discussions-popup-subject-input",t),s=$("#ui-bizagi-wp-project-discussions-popup-description-textarea",t);if(""!==i.val().trim()&&""!==s.val().trim()&&(e=!0),""===i.val().trim()){var a=bizagi.localization.getResource("workportal-project-discussion-subjectrequired");i.parent().find("span").html(a)}else i.parent().find("span").empty();if(""===s.val().trim()){var n=bizagi.localization.getResource("workportal-project-discussion-requireddescription");s.parent().next().find("span").html(n)}else s.parent().next().find("span").empty();return e},applyFileAttachments:function(t){var e=this,i="DISCUSSIONS"===t?e.plugins.popupDiscussion:e.getContent();return $(".ui-bizagi-wp-project-discussions-attachment-upload",i).kendoProjectAttachments({saveUrl:e.dataService.serviceLocator.getUrl("project-comments-uploadfiles"),template:e.getTemplate("project-attachments"),success:function(i){e.onSuccessFile(i,t)},upload:$.proxy(e.addFileData,e),dropZone:!1,extensions:e.supportFileExt,maxSize:e.uploadMaxFilesSize}).data("kendoProjectAttachments")},addFileData:function(t){var e=t.files[0].uid;t.files[0].guid=e,t.data={guid:e}},getDataDiscussions:function(){var t=this,e=$.Deferred(),i={globalParent:t.radNumber,typeResource:t.typeResource};return"FLOW-DECONTEXTUALIZED-PLANS"===t.params.flowContext&&(i.globalParent=t.params.plan.id),t.dataService.getDiscussionsData(i).pipe((function(e){return t.callForListComments(e)})).done((function(i){t.listDataDiscussion=t.sortDiscussions(i),t.updateTemplateListDiscussion(),e.resolve()})),e.promise()},getDataUsers:function(t){var e=this,i=$.Deferred(),s={usersGuids:t,width:50,height:50};return s.usersGuids?e.dataService.getUsersData(s).always((function(t){e.userPictures=function(t){for(var e=t.concat(),i=0;i<e.length;++i)for(var s=i+1;s<e.length;++s)e[i]===e[s]&&e.splice(s--,1);return e}(e.userPictures.concat(t)),i.resolve()})):i.resolve(),i.promise()},callForListComments:function(t){for(var e=this,i=$.Deferred(),s=[],a=0,n=t.length-1;a<=n;a++){e.addGlobalTags(t[a].tags,!1);var o={idParent:t[a].guid,dateTime:e.getDateServer(),count:6};e.commentsList[o.idParent]={comments:[],count:0,total:0};var r=$.when(e.dataService.getCommentsData(o)).done((function(t){t.length>0&&(e.commentsList[t[0].parent]={comments:t,count:t.length,total:0})}));s.push(r)}return $.when.apply($,s).done((function(){i.resolve(t)})),i.promise()},sortDiscussions:function(t){var e=[];if(t.length&&(e=t.sort((function(t,e){var i=t.date;return e.date-i}))).length>0){for(var i=-1,s=0;s<e.length;s++)if("workportal-project-discussion-generaldiscussion"===e[s].name){i=s;break}i>0&&function(t,e,i){if(i>=t.length)for(var s=i-t.length+1;s--;)t.push(void 0);t.splice(i,0,t.splice(e,1)[0])}(e,i,0)}return e},resetDiscussionAttachments:function(){var t=this.plugins.popupDiscussion;$(".ui-bizagi-wp-project-attachments-list",t).empty(),this.plugins.tagsMultiSelect.value([]),this.attchDiscussions.addition=[],this.attchDiscussions.remove=[],this.getDiscussions()},sendDataUpdateDiscussion:function(t){var e=this,i=e.prepareFilesToSave();e.form.buttonAddDiscussion.prop("disabled",!0);var s=e.getTagsDiscussionBySave(),a=e.getGuidsTagsDiscussionToDelete(),n={content:{name:e.form.subject.val(),description:e.form.description.val(),globalParent:e.radNumber.toString(),user:bizagi.currentUser.idUser,attachments:i.attachments,guid:t,tags:s,typeResource:"DiscussionGuid",general:!1,date:e.getDateServer()},attachmentsToCreate:i.attachmentsToCreate,attachmentsToDelete:i.attachmentsToDelete};e.plugins.attchDiscussions.close(),e.dataService.editDiscussion(n).always((function(i){if(200===i.status||201===i.status||void 0===i.status){e.addGlobalTags(s,!0);var o=e.getDiscussionDataByGUID(t);o.name=n.content.name,o.description=n.content.description,o.attachments=n.content.attachments,o.tags=n.content.tags,e.onClosePopupDiscussion(),e.resetDiscussionAttachments(),e.updateTemplateListDiscussion(),e.removeGlobalTags(a),e.notifier.showSucessMessage(printf(bizagi.localization.getResource("workportal-project-discussion-edited"),""))}else e.form.buttonAddDiscussion.prop("disabled",!1),e.onClosePopupDiscussion(),e.notifier.showErrorMessage(printf(bizagi.localization.getResource("workportal-project-discussion-error-edition"),""));e.renderUserProfilesAndImages(),e.setClassesTagsByDiscussion(),e.hideOrShowDiscussionsByFilter()}))},validateStringIsGuid:function(t){return/^({|()?[0-9a-fA-F]{8}-([0-9a-fA-F]{4}-){3}[0-9a-fA-F]{12}(}|))?$/.test(t)&&!/^({|()?0{8}-(0{4}-){3}0{12}(}|))?$/.test(t)},sendDataInsertDiscussion:function(t){var e=this,i=e.prepareFilesToSave();e.form.buttonAddDiscussion.prop("disabled",!0);var s=e.getTagsDiscussionBySave(),a={content:{name:e.form.subject.val(),description:e.form.description.val(),globalParent:e.radNumber.toString(),user:bizagi.currentUser.idUser,attachments:i.attachments,guid:t,tags:s,typeResource:"DiscussionGuid",general:!1,date:e.getDateServer()},attachmentsToCreate:i.attachmentsToCreate,attachmentsToDelete:i.attachmentsToDelete};e.plugins.attchDiscussions.close(),e.dataService.postDiscussion(a).always((function(t){if(200===t.status||201===t.status||void 0===t.status){e.addGlobalTags(s,!0),e.form.buttonAddDiscussion.prop("disabled",!1);var i={name:a.content.name,description:a.content.description,date:a.content.date,user:a.content.user,attachments:a.content.attachments,radNumber:a.content.globalParent,general:a.content.general,guid:a.content.guid,tags:a.content.tags,typeResource:a.content.typeResource};e.commentsList[a.content.guid]={comments:[],count:0,total:0},0===e.listDataDiscussion.length?e.listDataDiscussion.push(i):e.listDataDiscussion.splice(1,0,i),e.resetDiscussionAttachments(),e.onClosePopupDiscussion(),e.notifier.showSucessMessage(printf(bizagi.localization.getResource("workportal-project-discussion-created"),"")),e.updateTemplateListDiscussion(),e.updateDiscussionsMenu(!0)}else e.form.buttonAddDiscussion.prop("disabled",!1),e.onClosePopupDiscussion(),e.notifier.showErrorMessage(printf(bizagi.localization.getResource("workportal-project-discussion-error-creation"),""));e.renderUserProfilesAndImages(),e.setClassesTagsByDiscussion(),e.hideOrShowDiscussionsByFilter()}))},updateDiscussionsMenu:function(t){this.pub("notify",{type:"UPDATE_DISCUSSIONS_MENU_STATUS",hasDiscussionsOrComment:t})},getTagsDiscussionBySave:function(){var t=this,e=t.plugins.tagsMultiSelect.value(),i=t.plugins.tagsMultiSelect.dataSource.data(),s=[];return e.forEach((function(e){var a,n=t.validateStringIsGuid(e);1===(a=n?i.filter((function(t){return t.guid===e})):i.filter((function(i){var s=t.validateStringIsGuid(i.guid);return i.tag===e&&!s}))).length&&s.push({guid:n?a[0].guid:a[0].uid,tag:a[0].tag})})),s},differenceArrays:function(t,e){return t.filter((function(t){return e.indexOf(t)<0}))},getGuidsTagsDiscussionToDelete:function(){var t=this.plugins.tagsMultiSelect.value();return this.differenceArrays(this.tempTagsBeforeDelete,t)},setStateUIShowMoreComments:function(t,e){var i=t.siblings(".ui-bizagi-wp-project-discussion-showmore-comments"),s=i.find(".ui-bizagi-wp-project-discussion-showmore-comments-button"),a=i.find(".ui-bizagi-wp-project-discussion-showmore-no-more-comments"),n=i.find(".ui-bizagi-wp-project-discussion-showmore-loading-comments");"ALLOW_MORE_COMMENTS"===e&&(s.show(),a.hide(),n.hide()),"LOADING_MORE_COMMENTS"===e&&(s.hide(),a.hide(),n.show()),"NO_MORE_COMMENTS"===e&&(s.hide(),a.show(),n.hide())},getCurrentUserInfo:function(){return{name:bizagi.currentUser.userName,id:bizagi.currentUser.idUser,picture:""}},addGlobalTags:function(t,e){for(var i=0;i<t.length;i+=1){0===this.globalTags.filter((function(e){return e.tag===t[i].tag})).length&&(t[i].globalParent=this.radNumber,this.globalTags.push(t[i]),e&&this.dataService.postTag(t[i]))}this.plugins.tagsFilter.dataSource.data(this.globalTags),this.plugins.tagsMultiSelect.dataSource.data(this.globalTags)},removeGlobalTags:function(t){var e=this,i=$.map(e.listDataDiscussion,(function(t){return $.map(t.tags,(function(t){return t.guid}))})).concat(t),s=[];t.forEach((function(t){1===i.filter((function(e){return e===t})).length&&s.push(t)})),s.forEach((function(t){var i={idTag:t};e.dataService.deleteTag(i);for(var s=e.globalTags.length-1;s>=0;s-=1)e.globalTags[s].guid===t&&e.globalTags.splice(s,1)})),e.plugins.tagsFilter.dataSource.data(e.globalTags),e.plugins.tagsMultiSelect.dataSource.data(e.globalTags)},setClassesTagsByDiscussion:function(){for(var t=0;t<this.listDataDiscussion.length;t+=1){var e=$.map(this.listDataDiscussion[t].tags,(function(t){return t.guid})).join(" ");$(".ui-bizagi-wp-project-discussions-item[data-guid='"+this.listDataDiscussion[t].guid+"']",this.getContent()).addClass(e)}},updateTemplateListDiscussion:function(){for(var t=this,e=t.getContent(),i=t.getTemplate("project-discussions-list"),s=t.getCurrentUserInfo(),a=i.render({listDataDiscussions:t.listDataDiscussion,user:s,isOpen:!bizagi.util.parseBoolean(t.params.isClosedForAllUsers),returnServedCommentByParentId:function(e){return t.returnServedCommentByParentId(e)}}),n=0;n<this.listDataDiscussion.length;n++)this.mapTempComments($("#ui-bizagi-wp-project-discussions-list-wrapper",e).find(".ui-bizagi-wp-project-discussions-container-description-and-comments[data-guid="+this.listDataDiscussion[n].guid+"]"),a.find(".ui-bizagi-wp-project-discussions-container-description-and-comments[data-guid="+this.listDataDiscussion[n].guid+"]"));$("#ui-bizagi-wp-project-discussions-list-wrapper",e).empty().append(a),t.plugins.attchComments=t.applyFileAttachments("COMMENTS")},showFormAddDiscussion:function(t){var e=this;e.plugins.attchComments&&e.plugins.attchComments.close(),e.dialogBoxDiscussion.formContent.dialog({resizable:!1,draggable:!1,height:"auto",width:"650px",modal:!0,zIndex:1,title:bizagi.localization.getResource(t),maximize:!0,open:$.proxy(e.onOpenPopupDiscussion,e),close:function(){e.resetDiscussionAttachments(),e.onClosePopupDiscussion()}})},resetFormDiscussion:function(){this.form.buttonAddDiscussion.prop("disabled",!1),this.form.subject.val(""),this.form.description.val("");var t=$("#ui-bizagi-wp-project-discussions-popup-subject-input",this.dialogBoxDiscussion.formContent),e=$("#ui-bizagi-wp-project-discussions-popup-description-textarea",this.dialogBoxDiscussion.formContent);t.parent().find("span").empty(),e.parent().next().find("span").empty()},renderUserProfile:function(){var t=$.grep(this.userPictures,(function(t){return t.id===bizagi.currentUser.idUser}))[0],e=$(".ui-bizagi-wp-project-popupform-user"),i=e.find(".bz-wp-avatar-img"),s=e.find(".bz-wp-avatar-label");t&&(t.picture?i.attr("src","data:image/png;base64,"+t.picture):(i.hide(),s.html(t.name.getInitials()).show()))},renderUserProfilesAndImages:function(){var t=$.grep(this.userPictures,(function(t){return t.id===bizagi.currentUser.idUser}))[0];t&&($(".ui-bizagi-wp-project-discussions-create-comment .bz-wp-discussion-username").html(t.name),t.picture?($(".ui-bizagi-wp-project-discussions-item-user img").attr("src","data:image/png;base64,"+t.picture),$(".ui-bizagi-wp-project-popupform-image-current-user").attr("src","data:image/png;base64,"+t.picture)):($(".ui-bizagi-wp-project-discussions-item-user label.bz-wp-avatar-label").html(t.name.getInitials()).show(),$(".ui-bizagi-wp-project-discussions-item-user img").hide()));for(var e=0;e<this.userPictures.length;e++)$("div[data-iduser='"+this.userPictures[e].id+"'] .bz-wp-discussion-username").html(this.userPictures[e].name),this.userPictures[e].picture?$("div[data-iduser='"+this.userPictures[e].id+"'] .bz-wp-avatar-img").attr("src","data:image/png;base64,"+this.userPictures[e].picture):($("div[data-iduser='"+this.userPictures[e].id+"'] .bz-wp-avatar-img").hide(),$("div[data-iduser='"+this.userPictures[e].id+"'] label.bz-wp-avatar-label").html(this.userPictures[e].name.getInitials()))},switchCommentsEvents:function(t){var e=this,i=$(t.target),s=i.parent();if(i.is("textarea"))e.onShowButtonsPanel(i);else if(i.hasClass("ui-bizagi-wp-project-discussions-comment-buttons-cancel"))e.onCancelComment(i);else if(i.hasClass("ui-bizagi-wp-project-discussions-comment-buttons-share")){var a=i.closest(".ui-bizagi-wp-project-discussions-add-comment");if(e.validateAddCommentForm(a)){var n=Math.guid();e.onCreateComment(i,n)}}else i.hasClass("ui-bizagi-wp-project-discussions-comment-view")?e.onViewComment(i):i.hasClass("ui-bizagi-wp-project-discussion-showmore-comments-button")?e.onViewMoreComments(i):i.hasClass("bz-bizagi-wp-project-discussions-attachment-delete")?e.onRemoveFiles(i):s.hasClass("biz-wp-user-icon-admin")&&s.hasClass("biz-wp-action-edit-discussion")?e.onEditDiscussion(i):s.hasClass("ui-bizagi-wp-project-discussion-delete")?$.when(bizagi.showConfirmationBox(bizagi.localization.getResource("workportal-project-discussion-querydelete"),"","info")).done((function(){e.onDeleteComment(s)})):s.hasClass("bz-bizagi-wp-project-discussions-attachment-itemwrapper")&&e.onDownloadAttachment(i.closest("li"));t.stopPropagation()},onEditDiscussion:function(t){var e=t.closest(".ui-bizagi-wp-project-discussions-item").data("guid");this.setDiscussionsDataByGUID(e),this.showFormAddDiscussion("workportal-project-discussion-edit")},setDiscussionsDataByGUID:function(t){var e=this.getDiscussionDataByGUID(t),i=$(".ui-bizagi-wp-project-attachments-list",this.form.attachments);this.form.edition={guid:t},this.attchDiscussions={addition:e.attachments,remove:[]},this.form.title.text(bizagi.localization.getResource("workportal-project-discussion-edit")),this.form.subject.val(e.name),this.form.description.val(e.description);var s=$.map(e.tags,(function(t){return t.guid}));this.plugins.tagsMultiSelect.value(s),this.tempTagsBeforeDelete=[],this.tempTagsBeforeDelete=this.tempTagsBeforeDelete.concat(this.plugins.tagsMultiSelect.value()),this.renderAttachments(e.attachments,"DISCUSSIONS",i)},getDiscussionDataByGUID:function(t){for(var e,i=this.listDataDiscussion.length-1;i>=0;i--)this.listDataDiscussion[i].guid===t&&(e=this.listDataDiscussion[i],i=0);return e},onViewComment:function(t){var e=t.closest(".ui-bizagi-wp-project-discussions-comment-truncatewrapper");e.toggleClass("ui-bizagi-wp-project-discussions-comment-shortcomment"),e.toggleClass("ui-bizagi-wp-project-discussions-comment-longcomment")},onViewMoreComments:function(t){var e=this,i=t.closest(".ui-bizagi-wp-project-discussion-showmore-comments").siblings(".ui-bizagi-wp-project-discussion-comment-list"),s=i.closest(".ui-bizagi-wp-project-discussions-container-description-and-comments").data("guid");e.commentsList[s].total?e.getMoreComments(s,i):e.dataService.getCommentsCountByParent(s).done((function(t){e.commentsList[s].total=t.count,e.getMoreComments(s,i)}))},getMoreComments:function(t,e){var i,s=this;s.commentsList[t].total>s.commentsList[t].comments.length?(s.setStateUIShowMoreComments(e,"LOADING_MORE_COMMENTS"),i=0===s.commentsList[t].comments.length?s.getDateServer():s.commentsList[t].comments[s.commentsList[t].comments.length-1].date,i-=1,s.dataService.getCommentsData({dateTime:i,idParent:t,count:6}).done((function(i){if(i.length){Array.prototype.push.apply(s.commentsList[t].comments,i),s.commentsList[t].count+=i.length,s.renderCommentByDiscussion(e,t,i),s.renderUserProfilesAndImages(),i.length>5?s.setStateUIShowMoreComments(e,"ALLOW_MORE_COMMENTS"):s.setStateUIShowMoreComments(e,"NO_MORE_COMMENTS");var a=$.map(s.userPictures,(function(t){return t.id})),n=$.map(s.commentsList,(function(t){return $.map(t.comments,(function(t){return t.user}))})),o=$(n).not(a).get().join(",");s.getDataUsers(o).then((function(){s.renderUserProfilesAndImages()}))}else s.setStateUIShowMoreComments(e,"NO_MORE_COMMENTS")})).fail((function(){s.setStateUIShowMoreComments(e,"ALLOW_MORE_COMMENTS")}))):s.setStateUIShowMoreComments(e,"NO_MORE_COMMENTS")},renderCommentByDiscussion:function(t,e,i){var s,a=this.getTemplate("project-discussions-comments"),n={comments:[],user:this.getCurrentUserInfo(),isOpen:!bizagi.util.parseBoolean(this.params.isClosedForAllUsers)};i.length?(n.comments=i,s=a.render(n),t.append(s)):(n.comments=this.commentsList[e].comments,s=a.render(n),t.html(s))},getCommentByGuid:function(t,e){for(var i=this.commentsList[t].comments,s=0,a=i.length;s<a;s++)if(i[s].guid===e){for(var n=[],o=0,r=i[s].attachments.length;o<r;o++)n.push(i[s].attachments[o].guid);return{attachments:n,index:s}}return{}},returnServedCommentByParentId:function(t){if(void 0!==this.commentsList[t])return this.commentsList[t]},onShowButtonsPanel:function(t){t.closest(".ui-bizagi-wp-project-discussions-add-comment").find(".ui-bizagi-wp-project-discussions-comment-buttons-wrapper").show()},onRemoveFiles:function(t){var e,i,s,a=t.closest("li"),n=a.closest(".ui-bizagi-wp-project-attachments-list").data("type"),o=a.data("fileguid");if("COMMENT"===n){var r=a.closest(".ui-bizagi-wp-project-discussions-add-comment").data("guid");e=this.attchComments[r].addition,i=this.attchComments[r].remove}else e=this.attchDiscussions.addition,i=this.attchDiscussions.remove;for(var c=0,u=e.length-1;c<=u;c++)e[c].guid===o&&(s=e.splice(c,1),i.push(s[0].guid),c=u);a.remove()},onDeleteComment:function(t){var e=this,i=t.closest(".ui-bizagi-wp-project-discussions-item-comment"),s=i.data("cmmtguid"),a=i.closest(".ui-bizagi-wp-project-discussions-container-description-and-comments").data("guid"),n=e.getCommentByGuid(a,s),o={content:{guid:s},attachmentsToDelete:n.attachments};$.when(e.dataService.deleteComment(o)).always((function(t){if(200===t.status||void 0===t.status){e.commentsList[a].comments.splice(n.index,1),i.remove();var s=e.hasDiscussionsOrComment(e.commentsList);e.updateDiscussionsMenu(s)}else e.notifier.showErrorMessage(printf(bizagi.localization.getResource("workportal-project-discussion-errordelete"),""))}))},hasDiscussionsOrComment:function(t){for(var e=Object.keys(t),i=e.length>1,s=!1,a=0;a<e.length;a++)if(t[e[a]].comments.length>0){s=!0;break}return i||s},onSuccessFile:function(t,e){var i=t.files;if((t.XMLHttpRequest.response?JSON.parse(t.XMLHttpRequest.response):{}).error)"DISCUSSIONS"===e?this.plugins.attchDiscussions.onErrorFile(t):this.plugins.attchComments.onErrorFile(t);else{var s=$(t.sender.element).closest(".ui-bizagi-wp-project-discussion-textwrapper"),a=s.find(".ui-bizagi-wp-project-attachments-list");if("DISCUSSIONS"===e)this.plugins.attchDiscussions.setStatus("SUCCESS",i[0].guid),Array.prototype.push.apply(this.attchDiscussions.addition,i);else{this.plugins.attchComments.setStatus("SUCCESS",i[0].guid);var n=s.data("guid");this.attchComments[n]?Array.prototype.push.apply(this.attchComments[n].addition,i):this.attchComments[n]={addition:i,remove:[]},this.onShowButtonsPanel(a.parent())}this.renderAttachments(i,e,a)}},onDownloadAttachment:function(t){var e=t.data("fileguid");if(""!==e){var i=t.find(".bz-bizagi-wp-project-discussions-attachment-filename").text();this.dataService.getDownloadAttachment(e,i)}},onCancelComment:function(t){var e=t.closest(".ui-bizagi-wp-project-discussions-add-comment"),i=e.find(".ui-bizagi-wp-project-discussions-comment-buttons-wrapper"),s=e.find("textarea"),a=e.find(".ui-bizagi-wp-project-discussions-add-attachments form"),n=e.find(".k-tooltip-validation"),o=e.find(".ui-bizagi-wp-project-attachments-list"),r=e.data("guid");this.attchComments[r]={addition:[],remove:[]},this.plugins.attchComments.cancelFilesUpload(),a[0].reset(),o.empty(),s.val(""),n.hide(),i.hide()},onCreateComment:function(t,e){var i=this,s=t.closest(".ui-bizagi-wp-project-discussions-item-comment"),a=t.closest(".ui-bizagi-wp-project-discussions-comment-buttons-wrapper"),n=t.closest(".ui-bizagi-wp-project-discussions-add-comment"),o=n.find("textarea"),r=n.find(".ui-bizagi-wp-project-attachments-list"),c=n.data("guid"),u=i.prepareFilesToSave("COMMENTS",c),p={content:{guid:e,attachments:u.attachments,text:o.val(),parent:c,date:i.getDateServer(),user:bizagi.currentUser.idUser},attachmentsToCreate:u.attachmentsToCreate,attachmentsToDelete:u.attachmentsToDelete};$.when(i.dataService.postComment(p)).always((function(t){if(200===t.status||201===t.status||void 0===t.status){var e=s.siblings(".ui-bizagi-wp-project-discussion-comment-list"),n={user:p.content.user,attachments:p.content.attachments,text:p.content.text,guid:p.content.guid,parent:p.content.parent,date:p.content.date};i.attchComments[p.content.parent]={addition:[],remove:[]},o.val(""),r.empty(),a.hide(),i.commentsList[n.parent].comments.unshift(n),i.renderCommentByDiscussion(e,n.parent,[]),i.plugins.attchComments.close(),i.renderUserProfilesAndImages(),i.updateDiscussionsMenu(!0)}}))},renderAttachments:function(t,e,i){var s=this.getTemplate("project-discussions-attachments").render({attachments:t,type:e});i.append(s),bizagi.util.isIE()&&$(".ui-bizagi-wp-project-attachments-list li").hide(10,(function(){$(this).show()}))},prepareFilesToSave:function(t,e){for(var i=[],s="COMMENTS"===t?this.attchComments[e]:this.attchDiscussions,a=[],n=0,o=(s=s||{addition:[],remove:[]}).addition.length-1;n<=o;n++)i.push({guid:s.addition[n].guid,name:s.addition[n].name}),a.push(s.addition[n].guid);return{attachments:i,attachmentsToCreate:a,attachmentsToDelete:s.remove}},onClickCancel:function(t){t.preventDefault();this.resetDiscussionAttachments(),this.onClosePopupDiscussion(),this.plugins.attchDiscussions.cancelFilesUpload()},onClosePopupDiscussion:function(){this.resetFormDiscussion(),this.plugins.attchDiscussions.destroy(),this.dialogBoxDiscussion.formContent.dialog("destroy"),this.dialogBoxDiscussion.formContent.detach()},onOpenPopupDiscussion:function(){var t=this;t.plugins.attchDiscussions=t.applyFileAttachments("DISCUSSIONS"),t.dialogBoxDiscussion.formContent.parent().css("z-index",10001),t.dialogBoxDiscussion.formContent.parent().parent().find(".ui-widget-overlay").css("z-index",10001),setTimeout((function(){t.form.subject.focus()}),50)},onSubmitFormDiscussion:function(t){t.preventDefault();var e;this.validateAddDiscussionForm(this.dialogBoxDiscussion.formContent)&&(this.form.edition.guid?(e=this.form.edition.guid,$.proxy(this.sendDataUpdateDiscussion(e),this)):(e=Math.guid(),$.proxy(this.sendDataInsertDiscussion(e),this)))},restrictedEventsHandler:function(){var t=this.getContent();$("#ui-bizagi-wp-project-discussions-list-wrapper",t).on("click",".bz-bizagi-wp-project-discussions-attachment-itemwrapper",$.proxy(this.switchCommentsEvents,this))},eventsHandler:function(){var t=this,e=t.getContent();t.form.buttonShowFormNewDiscussion.on("click",$.proxy(t.onNotifyOpenPopup,t)),t.form.buttonCancel.on("click",$.proxy(t.onClickCancel,t)),t.form.buttonAddDiscussion.on("click",$.proxy(t.onSubmitFormDiscussion,t)),t.form.attachments.on("click",".bz-bizagi-wp-project-discussions-attachment-delete, .bz-bizagi-wp-project-discussions-attachment-itemwrapper",(function(e){$(e.target).hasClass("bz-bizagi-wp-project-discussions-attachment-delete")?t.onRemoveFiles($(e.target)):t.onDownloadAttachment($(e.target).closest("li")),e.stopPropagation()})),$("#ui-bizagi-wp-project-discussions-list-wrapper",e).on("click",".ui-bizagi-wp-project-discussions-add-comment textarea, .ui-bizagi-wp-project-discussions-comment-buttons-cancel, .ui-bizagi-wp-project-discussions-comment-buttons-share, .ui-bizagi-wp-project-discussion-showmore-comments button, .bz-bizagi-wp-project-discussions-attachment-delete, .ui-bizagi-wp-project-discussion-delete, .bz-bizagi-wp-project-discussions-attachment-itemwrapper, .ui-bizagi-wp-project-discussions-comment-view, .ui-bizagi-wp-project-discussions-items-edition, .biz-wp-action-edit-discussion",$.proxy(t.switchCommentsEvents,t)),t.sub("changeProjectWidget",(function(){t.resetWidget()})),t.sub("OPEN_POPUP_DISCUSSION",$.proxy(t.onNotifyOpenPopup,t))},resetWidget:function(){this.userPictures=[],this.plugins.attchComments&&this.plugins.attchComments.close()},clean:function(){for(var t in this.resetWidget(),this.form&&this.form.buttonShowFormNewDiscussion&&this.form.buttonShowFormNewDiscussion.off("click",$.proxy(this.onNotifyOpenPopup,this)),this.plugins)this.plugins[t]&&this.plugins[t].hasOwnProperty("destroy")&&this.plugins[t].destroy&&this.plugins[t].destroy()},mapTempComments:function(t,e){var i=t.find("textarea"),s=e.find("textarea"),a=t.find(".ui-bizagi-wp-project-attachments-list[data-type=COMMENT]").first(),n=e.find(".ui-bizagi-wp-project-attachments-list[data-type=COMMENT]").first();s.val(i.val()),n.empty().append(a.html())}}),bizagi.injector.register("bizagi.workportal.widgets.project.discussions",["workportalFacade","dataService","notifier",bizagi.workportal.widgets.project.discussions],!0),bizagi.workportal.widgets.project.base.extend("bizagi.workportal.widgets.project.plan.sidebar",{},{init:function(t,e,i,s){this._super(t,e,s),this.serviceloadDataPlan=i,this.params=s||{},s.supportNav=!1,this.loadTemplates({"project-plan-sidebar":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.plan.sidebar").concat("#project-plan-sidebar")})},renderContent:function(){var t=this,e=t.getTemplate("project-plan-sidebar");return t.content=e.render({}),$.when(t.areTemplatedLoaded()).done((function(){var e={idPlan:t.params.plan.id};t.params.planChild&&t.params.planChild.id&&(e.idPlan=t.params.planChild.id),t.serviceloadDataPlan.loadData(e,t.getDateServer,t.params),t.serviceloadDataPlan.subscribe("loadedWithDataActivities",$.proxy(t.loadedWithDataActivities,t)),t.serviceloadDataPlan.subscribe("loadedWithDataFirstParent",$.proxy(t.loadedWithDataFirstParent,t))})),t.content},loadedWithDataActivities:function(){this.pub("notify",{type:"LOADED_ACTIVITIES_PLAN",args:this.params}),this.pub("notify",{type:"UPDATE_INFO_PLAN",args:this.params}),this.pub("notify",{type:"LOAD_INFO_SUMMARY_PROGRESS_PLAN",args:this.params}),this.pub("notify",{type:"LOAD_INFO_ACTIVITIES_PLAN",args:this.params})},loadedWithDataFirstParent:function(){this.pub("notify",{type:"LOAD_INFO_SUMMARY_PLAN",args:this.params})},clean:function(){this.serviceloadDataPlan&&(this.serviceloadDataPlan.unsubscribe("loadedWithDataActivities",$.proxy(this.loadedWithDataActivities,this)),this.serviceloadDataPlan.unsubscribe("loadedWithDataFirstParent",$.proxy(this.loadedWithDataFirstParent,this)))}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.sidebar",["workportalFacade","dataService","bizagi.workportal.services.behaviors.loadDataPlan",bizagi.workportal.widgets.project.plan.sidebar],!0),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.discussion.sidebar",{},{init:function(t,e,i){this._super(t,e,i),(i=i||{}).supportNav=!1,this.loadTemplates({"project-discussion-sidebar":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.discussion.sidebar").concat("#project-discussion-sidebar")})},renderContent:function(){var t=this.getTemplate("project-discussion-sidebar");return this.content=t.render({isOpen:!bizagi.util.parseBoolean(this.params.isClosedForAllUsers)}),this.content},postRender:function(){var t=this.getContent();$(".ui-bizagi-wp-project-discussions-sidebar-action-add > a",t).on("click",$.proxy(this.onShowPopupDiscussion,this))},onShowPopupDiscussion:function(){this.pub("notify",{type:"OPEN_POPUP_DISCUSSION",args:{}})}}),bizagi.injector.register("bizagi.workportal.widgets.project.discussion.sidebar",["workportalFacade","dataService",bizagi.workportal.widgets.project.discussion.sidebar],!0),bizagi.workportal.widgets.project.base.extend("bizagi.workportal.widgets.project.plan.action",{},{init:function(t,e,i,s,a,n,o){this._super(t,e,o),this.PENDING_PLAN="PENDING",this.EXECUTING_PLAN="EXECUTING",this.CLOSED_PLAN="CLOSED",this.CONTEXT_ACTIVITYPLAN="ACTIVITYPLAN",this.CONTEXT_ACTIVITYPLANOVERVIEW="ACTIVITYPLANOVERVIEW",this.CONTEXT_PLANCREATE="PLANCREATE",this.CONTEXT_ACTIVITYPLANCREATE="ACTIVITYPLANCREATE",this.showActionsPlan=!1,this.projectDashboard=i,this.notifier=s,this.planTemplateCreate=a,this.planPopupEdit=n,this.loadTemplates({"plan-action-main":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.action").concat("#project-plan-action")})},renderContent:function(){var t=this.getTemplate("plan-action-main");return this.showActionsPlan=this.params.showContextByMenuDashboard!==this.CONTEXT_ACTIVITYPLAN&&this.params.showContextByMenuDashboard!==this.CONTEXT_ACTIVITYPLANOVERVIEW,this.plugins={},this.content=t.render({plan:this.params.plan.name,stateClosedPlan:this.CLOSED_PLAN,currentStatePlan:this.params.plan.currentState,showActionsPlan:this.showActionsPlan}),this.showActionsPlan&&(this.params.plan.contextualized=void 0===this.params.plan.contextualized||this.params.plan.contextualized),this.content},postRender:function(){var t=this,e=t.getContent();t.showActionsPlan&&(t.initilizeActionMenu(),$("a#to-close-plan",e).on("click",$.proxy(t.onClosePlan,t))),t.sub("LOAD_INFO_SUMMARY_PLAN",$.proxy(t.onNotifyLoadInfoSummaryPlan,t)),t.clearAlertsOnFocus(),t.planTemplateCreate.sub("planTemplateCreatedSuccess",(function(){t.notifier.showSucessMessage(printf(bizagi.localization.getResource("workportal-project-plan-create-template-success"),""))})),t.planTemplateCreate.sub("planTemplateCreatedFailed",(function(){t.notifier.showErrorMessage(printf(bizagi.localization.getResource("workportal-project-plan-create-template-fail"),""))})),t.planPopupEdit.sub("planEditedSuccess",(function(){t.setNamePlan(t.params.plan.name),t.pub("notify",{type:"UPDATE_INFO_PLAN"}),t.pub("notify",{type:"LOAD_INFO_SUMMARY_PLAN",args:t.params}),t.notifier.showSucessMessage(printf(bizagi.localization.getResource("workportal-project-plan-edit-success"),""))})),t.planPopupEdit.sub("planEditedFailed",(function(){t.notifier.showErrorMessage(printf(bizagi.localization.getResource("workportal-project-plan-edit-fail"),""))})),t.sub("EXPANDED_RIGHT_SIDEBAR",$.proxy(t.onNotifyExpandedRightSidebar,t))},onNotifyExpandedRightSidebar:function(){this.showActionsPlan&&this.initilizeActionMenu()},onNotifyLoadInfoSummaryPlan:function(){this.setStatePlan(this.params.plan.currentState),this.setNamePlan(this.params.plan.name)},setStatePlan:function(t){if(t)switch(t.toUpperCase()){case"PENDING":$(".state-pending-plan",this.content).show().siblings().hide();break;case"EXECUTING":$(".state-executing-plan",this.content).show().siblings().hide();break;case"CLOSED":$(".state-closed-plan",this.content).show().siblings().hide()}},setNamePlan:function(t){$(".ui-bizagi-wp-project-plan-header .bz-wp-section",this.content).text(bizagi.util.decodeHtmlEntities(t))},onSelectMenu:function(t,e){if(0===$(t.currentTarget).find("i").length)switch($(e.item).data("item")){case"edit":this.onClickMenuOpenEdition();break;case"delete":this.onClickMenuDeletePlan();break;case"saveastmpl":this.onClickMenuSaveAsTemplate()}},onClickMenuOpenEdition:function(){var t=this.params.plan;this.planPopupEdit.showPopup(this.params,this.dataService,t)},onClickMenuSaveAsTemplate:function(){this.planTemplateCreate.showPopupAddTemplatePlan(this.params,this.dataService,this.params.plan.contextualized,this.params.plan.id)},onClickMenuDeletePlan:function(){var t=this;$.when(bizagi.showConfirmationBox(bizagi.localization.getResource("workportal-project-plan-action-delete-confirmation"),"","info")).done((function(){var e={id:t.params.plan.id};$.when(t.callDeletePlan(e)).always((function(e){if(200===e.status||void 0===e.status){$.extend(t.params.plan,a),t.notifier.showSucessMessage(printf(bizagi.localization.getResource("workportal-project-plan-delete-success"),""));var i=t.pub("notify",{type:"NAVIGATOR_GETLEVEL"}),s=parseInt(i[0]),a=t.projectDashboard.getParamsByBackFromPlan(t.params,s,!0);t.pub("notify",{type:a.typeContext,args:$.extend(t.params,a.paramsNotify)})}else t.notifier.showErrorMessage(printf(bizagi.localization.getResource("workportal-project-plan-delete-fail"),""))}))}))},onSubmitFormPlan:function(t){t.preventDefault()},initilizeActionMenu:function(){$(".ui-bizagi-wp-project-plan-action-menu",this.content).menu({select:$.proxy(this.onSelectMenu,this)}).removeClass("ui-widget-content")},clearAlertsOnFocus:function(){$(".ui-bizagi-wp-project-container-validator-relative input, .ui-bizagi-wp-project-container-validator-relative textarea").focus((function(){$(this).parent().find(".k-invalid-msg").hide()})).focusout((function(){$(this).val().length<1&&$(this).parent().find(".k-invalid-msg").show()}))},callDeletePlan:function(t){return $.when(this.dataService.deletePlan(t))},clean:function(){this.planTemplateCreate.unsub("planTemplateCreatedSuccess"),this.planTemplateCreate.unsub("planTemplateCreatedFailed"),this.planPopupEdit.unsub("planEditedSuccess"),this.planPopupEdit.unsub("planEditedFailed"),this.unsub("EXPANDED_RIGHT_SIDEBAR",$.proxy(this.onNotifyExpandedRightSidebar,this))}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.action",["workportalFacade","dataService","bizagi.workportal.services.behaviors.projectDashboard","notifier","bizagi.workportal.widgets.project.plan.template.create","bizagi.workportal.widgets.project.plan.edit",bizagi.workportal.widgets.project.plan.action],!0),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.plan.state",{},{init:function(t,e,i){this._super(t,e,i),this.loadTemplates({"plan-state-main":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.state").concat("#project-plan-state")})},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){this.sub("LOAD_INFO_SUMMARY_PLAN",$.proxy(this.onNotifyLoadInfoSummaryPlan,this))},onNotifyLoadInfoSummaryPlan:function(t,e){var i=this.getTemplate("plan-state-main").render({});switch(this.params=$.extend(this.params,e.args),this.params.plan.currentState.toUpperCase()){case"PENDING":$(".state-pending",i).show().siblings().hide();break;case"EXECUTING":$(".state-executing",i).show().siblings().hide();break;case"CLOSED":$(".state-closed",i).show().siblings().hide()}this.content.empty().append(i)}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.state",["workportalFacade","dataService",bizagi.workportal.widgets.project.plan.state],!0),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.plan.progress",{},{init:function(t,e,i){this._super(t,e,i),this.loadTemplates({"plan-progress-main":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.progress").concat("#project-plan-progress")})},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){this.sub("LOAD_INFO_SUMMARY_PROGRESS_PLAN",$.proxy(this.onNotifyLoadInfoSummaryPlan,this))},onNotifyLoadInfoSummaryPlan:function(t,e){this.params=$.extend(this.params,e.args);var i=this.getContent().empty(),s=this.calculateProgress(),a={};a.progress=s,a.progress<33?a.colorBar="Red":a.progress<66?a.colorBar="Yellow":a.colorBar="Green",this.getTemplate("plan-progress-main").render(a).appendTo(i);var n=$(".remaining-days .time-remaining",i),o=$(".remaining-days .days",i).width();n.css("padding-left",(o+7).toString()+"px")},calculateProgress:function(){var t=0,e=this.params.plan.activities.length,i=0;return 0!==e&&(this.params.plan.activities.forEach((function(e){"Completed"===e.workItemState&&t++})),i=Math.round(t/e*100)),i}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.progress",["workportalFacade","dataService",bizagi.workportal.widgets.project.plan.progress],!0),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.plan.time",{},{init:function(t,e,i){this._super(t,e,i),this.PENDING_PLAN="PENDING",this.EXECUTING_PLAN="EXECUTING",this.CLOSED_PLAN="CLOSED",this.datePickerRegional=bizagi.localization.getResource("datePickerRegional"),this.loadTemplates({"plan-time-main":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.time").concat("#project-plan-time")})},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){this.sub("LOAD_INFO_SUMMARY_PLAN",$.proxy(this.onNotifyLoadInfoSummaryPlan,this))},onNotifyLoadInfoSummaryPlan:function(t,e){this.params=$.extend(this.params,e.args),this.params.plan&&(this.params.plan.dueDate?this.params.plan.currentState===this.PENDING_PLAN||this.params.plan.currentState===this.EXECUTING_PLAN?this.updateWidget(t,e):this.sub("LOADED_ACTIVITIES_PLAN",$.proxy(this.updateWidget,this)):this.getContent().empty())},planDatesToStamp:function(t){t.activities&&t.activities.map((function(t){t.estimatedFinishDate&&(t.estimatedFinishDate=new Date(t.estimatedFinishDate).getTime()),t.startDate&&(t.startDate=new Date(t.startDate).getTime()),t.finishDate&&(t.finishDate=new Date(t.finishDate).getTime())})),t.dueDate&&(t.dueDate=new Date(t.dueDate).getTime()),t.creationDate&&(t.creationDate=new Date(t.creationDate).getTime()),t.startDate&&(t.startDate=new Date(t.startDate).getTime()),t.closedDate&&(t.closedDate=new Date(t.closedDate).getTime()),t.finishDate&&(t.finishDate=new Date(t.finishDate).getTime())},updateWidget:function(t,e){var i=this;i.params=$.extend(i.params,e.args),i.planDatesToStamp(i.params.plan);var s=i.getContent().empty();i.params.plan.currentState===i.CLOSED_PLAN&&i.getClosedDatePlan(i.params.plan),$.when(i.getIntervalOnMinutes(i.params.plan)).done((function(t){var e=bizagi.util.dateFormatter.getRelativeTime(new Date(Date.now()-60*t.minutesToShowTime*1e3),null,!0),a=e.replace(/\d/g,""),n=i.getKeywordDifferenceDates(i.params.plan),o=bizagi.localization.getResource("workportal-project-plan-state-"+n);o=o.replace("%s",a);var r=e.replace(/\D/g,""),c=i.getSecondDate(i.params.plan),u=i.getWidthBar(i.params.plan,t),p=i.getColorBarByPercent(u),l={fromDate:i.getFormattedDate(new Date(i.getFirstDate(i.params.plan))),toDate:c?i.getFormattedDate(new Date(c)):null,valueOfTimeCalculated:r,messageDescripionDifference:o,percentBar:u,colorBar:p};i.getTemplate("plan-time-main").render(l).appendTo(s)}))},getFirstDate:function(t){switch(t.currentState){case this.PENDING_PLAN:return t.dueDate?t.dueDate:t.creationDate;case this.EXECUTING_PLAN:case this.CLOSED_PLAN:return t.startDate}},getSecondDate:function(t){switch(t.currentState){case this.PENDING_PLAN:return null;case this.EXECUTING_PLAN:return t.dueDate;case this.CLOSED_PLAN:return t.closedDate}},getLastActivity:function(t){return JSON.parse(JSON.stringify(t)).sort((function(t,e){return t.finishDate<e.finishDate?1:-1}))[0]},getClosedDatePlan:function(t){return t.closedDate=this.getLastActivity(t.activities).finishDate,t.closedDate},getDifferenceBetweenDates:function(t,e){var i=$.Deferred(),s={idUser:bizagi.currentUser.idUser,fromDate:t,toDate:e};return $.when(this.callGetEffectiveDuration(s)).done((function(t){i.resolve(t.minutes)})),i.promise()},getIntervalOnMinutes:function(t){var e=this,i=$.Deferred();switch(t.currentState){case e.PENDING_PLAN:t.dueDate>Date.now()?$.when(e.getDifferenceBetweenDates(Date.now(),t.dueDate)).done((function(s){$.when(e.getDifferenceBetweenDates(t.creationDate,Date.now())).done((function(t){i.resolve({minutesToShowTime:s,minutesCreateToNow:t})}))})):t.dueDate<t.creationDate?$.when(e.getDifferenceBetweenDates(t.dueDate,t.creationDate)).done((function(s){$.when(e.getDifferenceBetweenDates(t.creationDate,Date.now())).done((function(t){i.resolve({minutesToShowTime:s+t,minutesCreateToNow:t})}))})):t.dueDate>t.creationDate&&$.when(e.getDifferenceBetweenDates(t.creationDate,t.dueDate)).done((function(s){$.when(e.getDifferenceBetweenDates(t.dueDate,Date.now())).done((function(t){i.resolve({minutesToShowTime:s+t,minutesCreateToNow:t})}))}));break;case e.EXECUTING_PLAN:t.dueDate?t.dueDate>Date.now()?$.when(e.getDifferenceBetweenDates(Date.now(),t.dueDate)).done((function(s){$.when(e.getDifferenceBetweenDates(t.startDate,Date.now())).done((function(t){i.resolve({minutesToShowTime:s,minutesStartToNow:t})}))})):$.when(e.getDifferenceBetweenDates(t.dueDate,Date.now())).done((function(s){$.when(e.getDifferenceBetweenDates(t.startDate,t.dueDate)).done((function(t){i.resolve({minutesToShowTime:s,minutesStartToDueDate:t})}))})):$.when(e.getDifferenceBetweenDates(t.startDate,Date.now())).done((function(t){i.resolve({minutesToShowTime:t})}));break;case e.CLOSED_PLAN:$.when(e.getDifferenceBetweenDates(t.startDate,t.closedDate)).done((function(t){i.resolve({minutesToShowTime:t})}))}return i.promise()},getKeywordDifferenceDates:function(t){switch(t.currentState){case this.PENDING_PLAN:return t.dueDate>Date.now()?"remaining":"exceeded";case this.EXECUTING_PLAN:return t.dueDate?t.dueDate>Date.now()?"remaining":"exceeded":"opened";case this.CLOSED_PLAN:return"executed"}},getRelativeTime:function(t){return bizagi.util.dateFormatter.getRelativeTime(t,null,!1)},getWidthBar:function(t,e){var i={};switch(t.currentState){case this.PENDING_PLAN:if(t.dueDate){if(t.dueDate<Date.now())return 0;var s=e.minutesCreateToNow+e.minutesToShowTime;return valuePercentInterval=e.minutesToShowTime,Math.ceil(100*valuePercentInterval/s)}return 0;case this.EXECUTING_PLAN:if(t.dueDate){if(t.dueDate>Date.now()){s=e.minutesStartToNow+e.minutesToShowTime;return valuePercentInterval=e.minutesToShowTime,Math.ceil(100*valuePercentInterval/s)}return 0}return 0;case this.CLOSED_PLAN:if(t.closedDate>Date.now()){var a=t.closedDate-t.startDate;return i=Date.now()-t.startDate,Math.ceil(100*i/a)}return 100}},getColorBarByPercent:function(t){return t<33?"Red":t<66?"Yellow":"Green"},callGetEffectiveDuration:function(t){var e=$.Deferred();return $.when(this.dataService.getEffectiveDuration(t)).done((function(t){e.resolve(t)})),e.promise()},getFormattedDate:function(t){return this.datePickerRegional.monthNames[t.getMonth()]+" "+bizagi.util.dateFormatter.formatDate(t,"dd hh:mm tt",bizagi.localization.getResource("datePickerRegional"))}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.time",["workportalFacade","dataService",bizagi.workportal.widgets.project.plan.time],!0),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.plan.parent",{},{init:function(t,e,i){this._super(t,e,i),this.loadTemplates({"plan-parent-main":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.parent").concat("#project-plan-parent")})},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){this.sub("LOAD_INFO_SUMMARY_PLAN",$.proxy(this.onNotifyLoadInfoSummaryPlan,this))},onNotifyLoadInfoSummaryPlan:function(t,e){var i=this,s=i.getContent().empty();i.params=$.extend(i.params,e.args),i.params.plan.parentWorkItem&&$.when(i.dataService.getPlanParent({idPlan:i.params.plan.id})).done((function(t){if(i.params.plan.parent=t,i.params.plan.parent){var e={idParent:i.params.plan.parent.radNumber,nameParent:i.params.plan.parent.displayName,idCase:i.params.plan.parent.idCase,idWorkflow:i.params.plan.parent.idWorkflow,idWorkItem:i.params.plan.parent.idWorkItem,idTask:i.params.plan.parent.idTask,processName:i.params.process?i.params.process:i.params.plan.parent.planName};if(bizagi.util.isEmpty(i.params.plan.parent.guidActivity))i.goToParentCase(s,e);else{var a={idPlan:i.params.plan.id,idActivity:i.params.plan.parent.guidActivity};$.when(i.dataService.getActivity(a)).done((function(t){i.params.plan.parent.allowEdition=t.allowEdition,i.goToParentCase(s,e)}))}}})).fail((function(t){}))},goToParentCase:function(t,e){t.empty(),this.getTemplate("plan-parent-main").render(e).appendTo(t),$("#go-to-parent-case",t).on("click",$.proxy(this.onClickGoToParentCase,this))},onClickGoToParentCase:function(t){t.preventDefault();this.routingExecute($(t.target).closest("#go-to-parent-case"))}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.parent",["workportalFacade","dataService",bizagi.workportal.widgets.project.plan.parent],!0),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.plan.users",{},{init:function(t,e,i){this.usersMap={},this.plugins={},this.usersInformation=[],this.globalHandlersService=bizagi.injector.get("globalHandlersService"),this.usersAssignees=[],this._super(t,e,i),this.loadTemplates({"plan-users-main":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.users").concat("#project-plan-users")}),this.auxNoRepeatTypesUser={},this.hashTypesUser={assigned:bizagi.localization.getResource("workportal-project-user-assigned"),owner:bizagi.localization.getResource("workportal-project-user-owner")}},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){this.sub("LOAD_INFO_ACTIVITIES_PLAN",$.proxy(this.onNotifyLoadInfoSummaryPlan,this))},onNotifyLoadInfoSummaryPlan:function(t,e){var i=this,s=e.args,a=[],n=[],o=i.getContent().empty(),r=e.args.plan.idUserCreator,c=e.args.plan.idUserCreator;i.params=$.extend(i.params,e.args),n.push({idUser:c,userGuid:r,userType:["owner"]}),i.usersMap["-"+c+"-"]={picture:"",id:c,guid:r,name:"",userType:["owner"]},a.push(c),$.each(i.params.plan.activities,(function(t,e){var s=e.userAssigned,o=e.userAssignedGuid;1==e.isRunning&&(s===c?-1===$.inArray("Assigned",n[0].userType)&&(n[0].userType.push("Assigned"),i.usersMap["-"+c+"-"].userType.push("Assigned")):(i.usersMap["-"+s+"-"]={picture:"",id:s,guid:o,name:"",userType:["Assigned"]},0===n.filter((function(t){return t.idUser==s})).length&&(n.push({idUser:s,guidUser:o,userType:["Assigned"]}),a.push(s))))})),i.activitiesUsers=n,i.params=s,i.getTemplate("plan-users-main").render({assignee:i.justAssignees(n),label:bizagi.localization.getResource("workportal-project-plan-assignee")}).appendTo(o),i.initilizeTooltip(),i.addEventHandlersModal(),$.when(i.callGetDataUsers(a)).then((function(){i.showCreatorInformation(c),i.renderUserProfilesAndImages()}))},justAssignees:function(t){var e=[];return-1==["CLOSED","PENDING"].indexOf(this.params.plan.currentState)&&t.map((function(t){var i=-1!==t.userType.indexOf("owner"),s=-1!==t.userType.indexOf("Assigned");e.push(usersAdapter.createJsonUserInfo(t.idUser,"","","","","",s,i,[],[]))})),usersAdapter.justAssignees(e)},showCreatorInformation:function(t){var e=this.usersInformation.find((function(e){return e.id==t})),i=usersAdapter.createJsonUserInfo(e.id,e.name,e.username,e.picture?"data:image/png;base64,"+e.picture:void 0,e.email,e.name.getInitials(),!1,!0,[],[]);this.content.find(".ui-bizagi-wp-project-plan-users .ui-bizagi-wp-project-users-creator-info").userinformation(this,{user:i})},renderUserProfilesAndImages:function(){var t=this;$.each(t.usersMap,(function(e,i){var s=$(".ui-bizagi-wp-userlist li[data-iduser="+i.id+"]",t.content);""!==i.picture?(s.find("img").prop("src",i.picture),$(".bz-wp-avatar-label",s).hide()):void 0!==i.name?($(".bz-wp-avatar-img",s).hide(),$(".bz-wp-avatar-label",s).html(i.name.getInitials())):console.log("obj.name is undefined")}))},callGetDataUsers:function(t){var e,i=this,s=$.Deferred();return e={usersGuids:t.join(),width:50,height:50},$.when(i.dataService.getUsersData(e)).always((function(t){i.usersInformation=t;for(var e=0,a=t.length;e<a;e+=1)void 0===t[e].name?bizagi.log(t[e]+" Id Not Found",t,"error"):i.usersMap["-"+t[e].id+"-"]?(i.usersMap["-"+t[e].id+"-"].picture+=t[e].picture?"data:image/png;base64,"+t[e].picture:"",i.usersMap["-"+t[e].id+"-"].name=t[e].name||""):console.log("self.usersMap['-' + response[i].id + '-'] is undefined");i.getUsersAssignees(),s.resolve()})),s.promise()},activityRunning:function(t){return null!==t.startDate&&null===t.finishDate},getUsersAssignees:function(){for(var t=0;t<this.usersInformation.length;t++){var e=this.getUserAssignee(this.params.plan.activities,this.usersInformation[t]);!1!==e&&this.usersAssignees.push(e)}},getUserAssignee:function(t,e){var i=this,s=t.filter((function(t){return t.userAssigned===e.id&&i.activityRunning(t)})).map((function(t){return{name:t.name}}));if(0==s.length)return!1;e.tasks=s;var a=i.activitiesUsers.find((function(t){return t.idUser==e.id}));return e.types=void 0===a?[]:a.userType,usersAdapter.createJsonUserInfo(e.id,e.name,e.username,e.picture?"data:image/png;base64,"+e.picture:void 0,e.email,e.name.getInitials(),e.types.indexOf("Assigned")>-1,e.types.indexOf("owner")>-1,e.tasks,[])},initilizeTooltip:function(){var t=this;$(".ui-bizagi-wp-userlist > li",t.content).not(".moreUsers").on("mouseenter","",(function(e){var i=$(e.target),s=i.closest("[data-iduser]").attr("data-iduser"),a=t.usersInformation.find((function(t){return t.id==s})),n=[];a.tasks&&a.tasks.map((function(t){n.push(t.name)}));var o=t.activitiesUsers.find((function(t){return t.idUser==s}));a.types=o.userType,a.owner=a.types.find((function(t){return"owner"==t})),a.isAssignee=a.types.find((function(t){return"Assigned"==t}));var r=usersAdapter.createJsonUserInfo(a.id,a.name,a.username,a.picture?"data:image/png;base64,"+a.picture:void 0,a.email,a.name.getInitials(),a.isAssignee,a.owner,n,[]);i.parent().usertooltip(t,{target:i,user:r})}))},addEventHandlersModal:function(){var t=this;$(".moreUsers").click((function(e){e.preventDefault(),e.stopPropagation();var i=t.usersAssignees||[];t.globalHandlersService.publish("showDialogWidget",{widgetName:bizagi.workportal.widgets.widget.BIZAGI_WORKPORTAL_WIDGET_USERS_MODAL,closeVisible:!0,data:i,maximize:!0,modalParameters:{title:bizagi.localization.getResource("workportal-project-users-title")+" ("+i.length+")",width:790,height:526,refreshInbox:!1}})}))}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.users",["workportalFacade","dataService",bizagi.workportal.widgets.project.plan.users],!0);
//# sourceMappingURL=../../../../Maps/desktop/plancomments.desktop.production.js.map
