bizagi.workportal.widgets.project.base.extend("bizagi.workportal.widgets.project.plan.activity.sidebar",{},{init:function(t,e,i,a){this._super(t,e,a),this.serviceloadDataPlan=i,this.loadTemplates({"project-plan-activity-sidebar":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.activity.sidebar").concat("#project-plan-activity-sidebar")})},renderContent:function(){var t=this.getTemplate("project-plan-activity-sidebar");return this.content=t.render({}),this.content},postRender:function(){this.sub("LOAD_INFO_PLAN",$.proxy(this.onNotifyLoadInfoPlan,this))},onNotifyLoadInfoPlan:function(t,e){if(this.params.plan.idActivitySelected){var i={idPlan:this.params.plan.id};this.serviceloadDataPlan.loadData(i,this.getDateServer,this.params),this.serviceloadDataPlan.subscribe("loadedWithDataActivities",$.proxy(this.loadedWithDataActivities,this)),this.serviceloadDataPlan.subscribe("loadedWithDataFirstParent",$.proxy(this.loadedWithDataFirstParent,this))}},loadedWithDataActivities:function(){this.pub("notify",{type:"LOADED_ACTIVITIES_PLAN",args:this.params}),this.pub("notify",{type:"LOAD_INFO_SUMMARY_PROGRESS_PLAN",args:this.params}),this.pub("notify",{type:"LOAD_INFO_ACTIVITY_SUMMARY",args:this.params}),this.pub("notify",{type:"LOAD_INFO_ACTIVITIES_PLAN",args:this.params})},loadedWithDataFirstParent:function(){this.pub("notify",{type:"LOAD_INFO_SUMMARY_PLAN",args:this.params})},clean:function(){this.serviceloadDataPlan&&(this.serviceloadDataPlan.unsubscribe("loadedWithDataActivities",$.proxy(this.loadedWithDataActivities,this)),this.serviceloadDataPlan.unsubscribe("loadedWithDataFirstParent",$.proxy(this.loadedWithDataFirstParent,this)))}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.activity.sidebar",["workportalFacade","dataService","bizagi.workportal.services.behaviors.loadDataPlan",bizagi.workportal.widgets.project.plan.activity.sidebar],!0),bizagi.workportal.widgets.project.base.extend("bizagi.workportal.widgets.project.plan.activity.action",{},{init:function(t,e,i,a){this._super(t,e,a),this.dateFormat=bizagi.localization.getResource("dateFormat"),this.timeFormat=bizagi.localization.getResource("timeFormat"),this.estimatedFinishDateTime,this.beforeUserAssignedActivity="",this.notifier=i,this.loadTemplates({"activity-action-main":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.activity.action").concat("#project-plan-activity-action"),"activity-action-editionpopup":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.activity.action").concat("#project-plan-activity-action-editionpopup")}),this.dialogBox={}},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){this.sub("LOAD_INFO_ACTIVITY_SUMMARY",$.proxy(this.onNotifyLoadInfoActivityExecution,this)),this.sub("EXPANDED_RIGHT_SIDEBAR",$.proxy(this.onNotifyExpandedRightSidebar,this))},onNotifyLoadInfoActivityExecution:function(t,e){var i=this;i.params=$.extend(i.params,e.args);var a=i.getContent().empty(),n={};if(i.params.plan.idActivitySelected&&(n=i.params.plan.activities.filter((function(t){return t.id.toUpperCase()===i.params.plan.idActivitySelected.toUpperCase()}))[0]),i.params.plan.idUserCreator===bizagi.currentUser.idUser||n.userAssigned==bizagi.currentUser.idUser){var r={};r.currentActivityName=n.name,r.showEditAction=!0,i.params.plan.idUserCreator!==bizagi.currentUser.idUser&&(r.showEditAction=!1);var s=i.getTemplate("activity-action-main");a.append(s.render(r)),r.showEditAction&&(i.initilizeActionMenu(),i.beforeUserAssignedActivity=n.userAssigned,i.content.append(a),i.initializeTempleteAndEvents())}},initializeTempleteAndEvents:function(){this.plugins={},this.plugins.activityEdition=this.initPluginPopupEdition(),this.formEditActivity={assignee:$("#activity-form-assignee",this.plugins.activityEdition),date:$("#activity-form-date",this.plugins.activityEdition),duration:$("#activity-form-duration",this.plugins.activityEdition),buttonCancel:$("#ui-bizagi-wp-project-popupform-action-cancel",this.plugins.activityEdition),buttonUpdate:$("#ui-bizagi-wp-project-popupform-action-update",this.plugins.activityEdition)},this.formEditActivity.buttonCancel.on("click",$.proxy(this.onClickPopupButtonCancel,this)),this.formEditActivity.buttonUpdate.on("click",$.proxy(this.onClickPopupButtonUpdate,this)),this.formEditActivity.date.on("keydown",$.proxy(this.onDeleteDate,this)),this.formEditActivity.duration.on("keyup",$.proxy(this.onTypeDuration,this))},onNotifyExpandedRightSidebar:function(){this.initilizeActionMenu()},initilizeActionMenu:function(){$("#ui-bizagi-wp-project-plan-activity-action .menu",this.content).menu({select:$.proxy(this.onSelectMenu,this)}).removeClass("ui-widget-content")},initPluginPopupEdition:function(){var t=this.getTemplate("activity-action-editionpopup");return this.dialogBox.formContent=t.render({}),this.dialogBox.formContent},initializeAutoComplete:function(t){var e=this,i=e.dataService.serviceLocator.getUrl("admin-getUsersList");t.autocomplete({minLength:2,source:function(t,e){$.ajax({url:i,data:{domain:"",userName:"",fullName:t.term,organization:"",pag:1,pagSize:100,orderField:"fullName"},success:function(t){e($.map(t.users,(function(t){return{label:t.user,value:t.idUser}})))}})},select:function(i,a){var n=a.item.label;return t.val(n),e.formEditActivity.IdAssignee=a.item.value,!1},focus:function(){return!1},change:function(t,i){return null===i.item&&(e.formEditActivity.IdAssignee=null,e.formEditActivity.assignee.val("")),!1}})},initializeDatePicker:function(t){var e=this;t.datepicker({onSelect:function(){e.formEditActivity.duration.val(""),e.estimatedFinishDateTime=e.formEditActivity.date.datepicker("getDate")?e.formEditActivity.date.datepicker("getDate").getTime():void 0}}),t.datepicker("option","dateFormat",bizagi.util.dateFormatter.getDateFormatByDatePickerJqueryUI())},initializeSpiner:function(t){var e=this;function i(t,i){var a=i||$(t.target).val();bizagi.util.isNumeric(a)&&parseInt(a,10)>0?(e.formEditActivity.date.val(""),e.estimatedFinishDateTime=void 0):$(t.target).val("")}t.spinner({min:1,max:1e3,placeHolder:bizagi.localization.getResource("workportal-hours"),change:function(t){i(t)},spin:function(t,e){i(t,e.value)}})},onDeleteDate:function(t){8===t.keyCode&&($(t.target).val(""),this.fieldDurationActive(!0))},onTypeDuration:function(t){""!==$(t.target).val()?this.estimatedFinishDateTime=void 0:this.activateElement(this.form.date)},onSelectMenu:function(t,e){if(0===$(t.currentTarget).find("i").length)switch($(e.item).data("item")){case"edit":this.onClickOpenPopupEdition()}},onClickOpenPopupEdition:function(){this.initializeTempleteAndEvents(),this.dialogBox.formContent.dialog({resizable:!1,draggable:!1,height:"auto",width:"600px",modal:!0,title:bizagi.localization.getResource("workportal-project-plan-title-activity-properties"),maximize:!0,open:$.proxy(this.onOpenPopupEdition,this),close:$.proxy(this.onClosePopupEdition,this)})},onOpenPopupEdition:function(){var t=this,e=t.params.plan.activities.filter((function(e){return e.id.toUpperCase()===t.params.plan.idActivitySelected.toUpperCase()}))[0],i=e&&!bizagi.util.isEmpty(e.estimatedFinishDate)?e.estimatedFinishDate:"";isNaN(i)||(i=bizagi.util.dateFormatter.formatInvariant(new Date(i)));var a=i?bizagi.util.dateFormatter.getDateFromInvariant(i):"",n=a instanceof Date&&a.getTime()<t.getDateServer();t.initializeAutoComplete(t.formEditActivity.assignee),t.initializeDatePicker(t.formEditActivity.date),t.initializeSpiner(t.formEditActivity.duration),e.userAssigned&&t.setUserAssignedById(e.userAssigned),t.formEditActivity.date.datepicker("option","minDate",new Date(t.getDateServer())),e.estimatedFinishDate&&n&&t.formEditActivity.date.datepicker("option","minDate",a),e.estimatedFinishDate&&(a&&t.formEditActivity.date.datepicker("setDate",a),t.estimatedFinishDateTime=e.estimatedFinishDate),e.duration&&t.formEditActivity.duration.val(parseInt(e.duration,10))},onClosePopupEdition:function(){this.removePopupWidgets()},setUserAssignedById:function(t){var e=this;e.callGetDataUsers(t).then((function(t){e.formEditActivity.assignee.val(t[0].name)})),e.formEditActivity.IdAssignee=t},onClickPopupButtonCancel:function(t){t.preventDefault(),this.removePopupWidgets()},removePopupWidgets:function(){this.formEditActivity.assignee.next().find("span").html(""),this.dialogBox.formContent.remove(),$("#ui-datepicker-div").remove()},onClickPopupButtonUpdate:function(){var t=this;if(t.validateParamsOfFormEditActivity()){var e=t.params.plan.activities.filter((function(e){return e.id.toUpperCase()===t.params.plan.idActivitySelected.toUpperCase()}))[0],i=t.formEditActivity.IdAssignee||bizagi.currentUser.idUser;""!=t.formEditActivity.duration.val()&&(t.params.plan.activities.filter((function(e){return e.id.toUpperCase()===t.params.plan.idActivitySelected.toUpperCase()}))[0].estimatedFinishDate="");var a={progress:e.progress,id:e.id,startDate:e.startDate,duration:t.formEditActivity.duration.val(),userAssigned:i,allowEdition:e.allowEdition,description:e.description,name:e.name,idPlan:e.idPlan,estimatedFinishDate:t.estimatedFinishDateTime,finishDate:e.finishDate,items:e.items};$.when(t.dataService.editActivityPlan(a)).done((function(){e=$.extend(e,a),t.removePopupWidgets(),t.beforeUserAssignedActivity!==t.formEditActivity.IdAssignee?t.pub("notify",{type:"ACTIVITYPLANCOMMENTS",args:$.extend(t.params,{refreshAllWidgets:!0})}):t.pub("notify",{type:t.params.showContextByMenuDashboard,args:t.params}),t.removePopupWidgets(),t.notifier.showSucessMessage(bizagi.localization.getResource("workportal-project-plan-activity-update-message"))}))}},onClickFavorite:function(t){t.preventDefault();var e=this,i={};$(t.target).hasClass("bz-icon-star-outline")?(i={idObject:e.params.idCase,favoriteType:"CASES"},$.when(e.dataService.addFavorite(i)).done((function(i){e.params.guidFavorite=i.idFavorites,$(t.target).removeClass("bz-icon-star-outline"),$(t.target).addClass("bz-icon-star")}))):(i={idObject:e.params.guidFavorite,favoriteType:"CASES"},$.when(e.dataService.delFavorite(i)).done((function(){$(t.target).addClass("bz-icon-star-outline"),$(t.target).removeClass("bz-icon-star")})))},clean:function(){this.unsub("LOAD_INFO_ACTIVITY_SUMMARY",$.proxy(this.onNotifyLoadInfoActivityExecution,this)),this.unsub("EXPANDED_RIGHT_SIDEBAR",$.proxy(this.onNotifyExpandedRightSidebar,this))},validateParamsOfFormEditActivity:function(){var t=this.formEditActivity.assignee;if(t.val()&&""!==t.val()&&this.formEditActivity.IdAssignee)return!0;var e=bizagi.localization.getResource("workportal-general-error-field-required");return e=e.replace("{0}",bizagi.localization.getResource("workportal-project-plan-assignee").toLowerCase()),t.next().find("span").html(e),!1},callGetDataUsers:function(t){var e=$.Deferred(),i={userIds:t,width:50,height:50};return this.dataService.getUsersData(i).always((function(t){e.resolve(t)})),e.promise()}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.activity.action",["workportalFacade","dataService","notifier",bizagi.workportal.widgets.project.plan.activity.action]),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.plan.activity.time",{},{init:function(t,e,i){this._super(t,e,i),this.EXECUTING_ACTIVITY="EXECUTING",this.FINISHED_ACTIVITY="FINISHED",this.datePickerRegional=bizagi.localization.getResource("datePickerRegional"),this.loadTemplates({"plan-time-main":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.activity.time").concat("#project-plan-activity-time")})},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){this.sub("LOAD_INFO_ACTIVITY_SUMMARY",$.proxy(this.onNotifyLoadInfoActivitySummary,this))},onNotifyLoadInfoActivitySummary:function(t,e){var i=this;i.params=$.extend(i.params,e.args),i.getContent().empty();var a=i.params.plan.activities.filter((function(t){return t.id===i.params.plan.idActivitySelected}))[0];if(a.startDate){i.getStateActivity(a);var n={time:{fromDate:i.getFormattedDate(new Date(i.getFirstDate(a)))}},r=i.getDataByScenarios(a,!0);$.when(r.unitTime).done((function(t){r=$.extend(r,{unitTime:t}),i.updateWidget($.extend(n.time,r))}))}},updateWidget:function(t){var e=this.getContent().empty(),i=this.getTemplate("plan-time-main"),a=bizagi.util.dateFormatter.getRelativeTime(new Date(Date.now()-60*t.unitTime.minutes*1e3),null,!1),n=bizagi.localization.getResource("workportal-project-activity-state-"+t.keywordResource);t.messageTime=n.replace("%s",a),i.render(t).appendTo(e);var r=$(".remaining-days .time-remaining",e),s=$(".remaining-days .days",e).width();r.css("padding-left",(s+7).toString()+"px"),$(".remaining-days .bar-completed",e).css("width",t.percentBar+"%")},getStateActivity:function(t){return t.finishDate?(t.currentState=this.FINISHED_ACTIVITY,this.FINISHED_ACTIVITY):(t.currentState=this.EXECUTING_ACTIVITY,this.EXECUTING_ACTIVITY)},getFirstDate:function(t){return t.currentState===this.EXECUTING_ACTIVITY?t.startDate:t.finishDate},getDataByScenarios:function(t){var e={colorBar:null,percentBar:100,keywordResource:null,unitTime:null},i={};switch(t.currentState){case this.EXECUTING_ACTIVITY:e.keywordResource="opened",e.colorBar=this.getColorByCreatedAndEstimatedDate(t),i={idUser:bizagi.currentUser.idUser,fromDate:t.startDate,toDate:Date.now()},e.unitTime=this.callGetEffectiveDuration(i);break;case this.FINISHED_ACTIVITY:e.colorBar="Gray",e.keywordResource="closed",i={idUser:bizagi.currentUser.idUser,fromDate:t.finishDate,toDate:Date.now()},e.unitTime=this.callGetEffectiveDuration(i)}return e},getColorBar:function(t){return this.getDataByScenarios(t).colorBar},getPercentBar:function(t){return this.getDataByScenarios(t).percentBar},getKeywordResourceDescriptionBar:function(t){return this.getDataByScenarios(t).keywordResource},getUnitTime:function(t){return this.getDataByScenarios(t).unitTime},getColorByCreatedAndEstimatedDate:function(t){var e="Red";t.estimatedFinishDate&&(Date.now()<t.estimatedFinishDate&&(e=(new Date).getUTCDate()===new Date(t.estimatedFinishDate).getUTCDate()?"Yellow":"Green"));return e},getFormattedDate:function(t){return this.datePickerRegional.monthNames[t.getMonth()]+" "+bizagi.util.dateFormatter.formatDate(t,"dd hh:mm tt",bizagi.localization.getResource("datePickerRegional"))},callGetEffectiveDuration:function(t){var e=$.Deferred();return $.when(this.dataService.getEffectiveDuration(t)).done((function(t){e.resolve(t)})),e.promise()}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.activity.time",["workportalFacade","dataService",bizagi.workportal.widgets.project.plan.activity.time],!0),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.plan.activity.progress",{},{init:function(t,e,i){this._super(t,e,i),this.plugins={},this.dialogBox={},this.loadTemplates({"plan-progress-main":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.activity.progress").concat("#project-plan-activity-progress"),"plan-progress-popup-edit":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.activity.progress").concat("#project-plan-activity-edit-progress")})},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){this.sub("LOAD_INFO_ACTIVITY_SUMMARY",$.proxy(this.onNotifyLoadInfoActivityExecution,this)),this.sub("UPDATE_ITEMS_FROM_FORMRENDER",$.proxy(this.onNotifyUpdateItemFromRender,this))},onNotifyLoadInfoActivityExecution:function(t,e){var i=this;i.params=$.extend(i.params,e.args);var a=i.getContent().empty(),n=i.params.plan.activities.filter((function(t){return t.id.toUpperCase()==i.params.plan.idActivitySelected.toUpperCase()}))[0],r={valuePercentBarComplete:0};r.progress={progress:n.progress,canEdit:0===n.items.length},r.progress.progress&&(r.valuePercentBarComplete=r.progress.progress),i.getTemplate("plan-progress-main").render(r).appendTo(a),i.plugins.popupEditProgress=i.initPluginPopupEditProgress();var s=i.plugins.popupEditProgress;i.formEditProgress={sliderProgress:$("#sliderProgress",s).slider({orientation:"horizontal",range:"min",max:100,width:100,from:5,to:50,step:1,value:r.valuePercentBarComplete,slide:$.proxy(i.onChangesliderProgress,i),change:$.proxy(i.onChangesliderProgress,i)}).each((function(){for(var t=$(this).slider("option","max")-$(this).slider("option","min"),e=0;e<=t;e+=10){var i=$("<label class='step'>"+e+"</label>").css("left",e/t*100+"%");$(this).append(i)}})),numericTextBoxPlugin:$("#inputProgressNumericTextBox",s).spinner({format:"n0",min:0,max:100,spin:$.proxy(i.onChangeNumericTextBoxProgress,i),change:$.proxy(i.onChangeNumericTextBoxProgress,i),value:r.valuePercentBarComplete,decimals:0}),buttonChangeProgress:$("#button-accept-change-progress",s),buttonCancel:$("#button-cancel-change-progress",s)},$(".action-open-popup-edit-progress",a).on("click",$.proxy(i.onShowPopupEditProgress,i)),i.formEditProgress.buttonCancel.on("click",$.proxy(i.onClickCancel,i)),i.formEditProgress.buttonChangeProgress.on("click",$.proxy(i.onSubmitFormChangeProgress,i)),i.updateProgressUI(r.valuePercentBarComplete),i.formEditProgress.numericTextBoxPlugin.spinner("value",r.valuePercentBarComplete)},onNotifyUpdateItemFromRender:function(t,e){var i=e.args.items,a=e.args.activityWork;i.length>0?$(".action-open-popup-edit-progress",this.content).hide():$(".action-open-popup-edit-progress",this.content).show(),$(".bz-wp-timestamp span",this.content).text(a),$(".bz-wp-progress-bar",this.content).css("width",a+"%")},updateProgressUI:function(t){var e=this.getContent();$(".bz-wp-timestamp span",e).text(t);var i=$(".remaining-days .time-remaining",e),a=$(".remaining-days .days",e).width();i.css("padding-left",(a+7).toString()+"px"),$(".remaining-days .bar-completed",e).css("width",t.toString()+"%")},initPluginPopupEditProgress:function(){var t=this.getTemplate("plan-progress-popup-edit");return this.dialogBox.formContent=t.render(),this.dialogBox.formContent},onShowPopupEditProgress:function(){var t=this;t.dialogBox.formContent.dialog({resizable:!1,draggable:!1,height:"auto",width:"600px",modal:!0,title:bizagi.localization.getResource("workportal-project-plan-progress-title"),maximize:!0,open:$.proxy(t.onOpenPopupPlan,t),close:function(){t.dialogBox.formContent.dialog("destroy"),t.dialogBox.formContent.detach()}}),t.previusValueProgress=t.formEditProgress.sliderProgress.slider("value")},onChangeNumericTextBoxProgress:function(t){var e=this.formEditProgress.numericTextBoxPlugin.spinner("value");this.formEditProgress.sliderProgress.slider("value",e)},onChangesliderProgress:function(t){var e=this.formEditProgress.sliderProgress.slider("value");this.formEditProgress.numericTextBoxPlugin.spinner("value",e)},onClickCancel:function(t){t.preventDefault();this.dialogBox.formContent.dialog("destroy"),this.dialogBox.formContent.detach(),this.formEditProgress.sliderProgress.slider("value",this.previusValueProgress),this.formEditProgress.numericTextBoxPlugin.spinner("value",this.previusValueProgress)},onSubmitFormChangeProgress:function(t){t.preventDefault();var e=this;e.formEditProgress.buttonChangeProgress.prop("disabled",!0);var i=e.params.plan.activities.filter((function(t){return t.id==e.params.plan.idActivitySelected}))[0],a=$.extend(i,{progress:e.formEditProgress.numericTextBoxPlugin.spinner("value"),idPlan:e.params.plan.id});$.when(e.dataService.editActivityPlan(a)).done((function(){e.formEditProgress.buttonChangeProgress.prop("disabled",!1),i.progress=e.formEditProgress.numericTextBoxPlugin.spinner("value"),e.updateProgressUI(i.progress),e.dialogBox.formContent.dialog("destroy"),e.dialogBox.formContent.detach()}))}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.activity.progress",["workportalFacade","dataService",bizagi.workportal.widgets.project.plan.activity.progress],!0),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.plan.activity.subprocesses",{},{init:function(t,e,i){this._super(t,e,i),this.loadTemplates({"project-subprocesses":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.activity.subprocesses").concat("#project-plan-activity-plan-subprocesses-wrapper"),"project-subprocesses-tootip-custom-properties":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.activity.subprocesses").concat("#project-activity-plan-subprocesses-tooltip-custom-properties-wrapper")})},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.activity.subprocesses",["workportalFacade","dataService",bizagi.workportal.widgets.project.plan.activity.subprocesses]),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.plan.activity.parent",{},{init:function(t,e,i){this._super(t,e,i),this.loadTemplates({"plan-parent-main":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.activity.parent").concat("#project-plan-activity-parent")})},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){this.sub("LOAD_INFO_ACTIVITY_SUMMARY",$.proxy(this.onNotifyLoadInfoActivityExecution,this))},onNotifyLoadInfoActivityExecution:function(t,e){var i=this;i.params=$.extend(i.params,e.args);var a=i.getContent().empty();$.when(i.dataService.getPlanParent({idPlan:i.params.plan.id})).done((function(t){if(i.params.plan.parent=t,i.params.plan.parent){var e={};e.parent={idParent:i.params.plan.parent.radNumber,nameParent:i.params.plan.parent.displayName,idCase:i.params.plan.parent.idCase,idWorkflow:i.params.plan.parent.idWorkflow,idWorkItem:i.params.plan.parent.idWorkItem,idTask:i.params.plan.parent.idTask},i.getTemplate("plan-parent-main").render(e).appendTo(a),$("#go-to-parent-case",a).on("click",$.proxy(i.onClickGoToParentCase,i))}}))},onClickGoToParentCase:function(t){t.preventDefault();this.routingExecute($(t.target).closest("#go-to-parent-case"))}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.activity.parent",["workportalFacade","dataService",bizagi.workportal.widgets.project.plan.activity.parent],!0),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.dashboard.menu",{},{onDiscussionsMenuStatusChange:function(t,e){this.updateDiscussionsIcons(e.hasDiscussionsOrComment)},updateDiscussionsIcons:function(t){this.sub("UPDATE_DISCUSSIONS_MENU_STATUS",$.proxy(this.onDiscussionsMenuStatusChange,this)),$(".bz-icon-discussion-comment").toggle(t),$(".bz-icon-discussion-no-comment").toggle(!t),this.params.hasDiscussionsOrComment=t},clean:function(){this.unsub("UPDATE_DISCUSSIONS_MENU_STATUS",$.proxy(this.onDiscussionsMenuStatusChange,this))}}),bizagi.injector.register("bizagi.workportal.widgets.project.dashboard.menu",["workportalFacade","dataService",bizagi.workportal.widgets.project.dashboard.menu],!0),bizagi.workportal.widgets.project.dashboard.menu.extend("bizagi.workportal.widgets.project.dashboard.menu.activity",{},{init:function(t,e,i){this.params=i||{},this._super(t,e,i),this.loadTemplates({"project-dashboard-menu":bizagi.getTemplate("bizagi.workportal.desktop.widgets.project.dashboard.menu.activity").concat("#project-dashboard-menu1")})},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){var t=this;t._super(),t.params.contextsLeftSidebarCaseDashboard.forEach((function(e){t.sub(e,$.proxy(t.updateView,t))}))},updateView:function(t,e){this.params=$.extend(this.params,e.args),this.params.plan.idActivitySelected=void 0,this.clean();var i=this.getContent().empty();void 0!==t.type&&(this.params.showContextByMenuDashboard=t.type);var a={showFormOverview:this.params.menuDashboard.showFormOverview,showFormActivity:this.params.menuDashboard.showFormActivity,showCommentsOptionMenu:this.params.menuDashboard.showCommentsOptionMenu,showFilesOptionMenu:this.params.menuDashboard.showFilesOptionMenu,showTimeLineOptionMenu:this.params.menuDashboard.showTimeLineOptionMenu&&(!this.params.isAdhocProcess||this.params.isAdhocProcess&&bizagi.util.isEnableFeature("enableTimelineOnLiveProcesses")),showPlanOptionMenu:this.params.menuDashboard.showPlanOptionMenu,contextPlanOptionMenu:this.params.menuDashboard.contextPlanOptionMenu,contextFormActivityOptionMenu:this.params.menuDashboard.contextFormActivityOptionMenu};this.getTemplate("project-dashboard-menu").render(a).appendTo(i),this.params.showContextByMenuDashboard&&$("li[data-context='"+this.params.showContextByMenuDashboard.toUpperCase()+"']",this.content).addClass("active").siblings().removeClass("active"),this.updateDiscussionsIcons(this.params.hasDiscussionsOrComment),this.handlerEvents()},loadContentById:function(t){t.preventDefault();var e=$(t.target).closest("li");if(!e.hasClass("active")){var i=e.data("context");if(i){var a=this.pub("notify",{type:"NAVIGATOR_GETLEVEL"}),n=parseInt(a[0],10),r="",s=n;"PLANACTIVITIES"==i&&(s=n+1,r=bizagi.localization.getResource("workportal-project-casedashboard-plan")),this.params.refreshLastItemBreadcrumb=!1,this.pub("notify",{type:i.toUpperCase(),args:$.extend(this.params,{showContextByMenuDashboard:i,histName:r,level:s})}),$("li[data-context='"+this.params.showContextByMenuDashboard.toUpperCase()+"']",this.content).addClass("active").siblings().removeClass("active")}}},subMenuHandler:function(){var t=this.getContent(),e=$("[data-context='COMMENTS']",t),i=$("[data-context='FILES']",t),a=$("[data-context='TIMELINE']",t);$(".ui-bizagi-wp-project-tab-submenu a",t).on("click",(function(){e.toggle(),i.toggle(),a.toggle()}))},handlerEvents:function(){var t=this,e=t.getContent();t.subMenuHandler(),$(".ui-bizagi-wp-project-tab-links a",e).on("click",$.proxy(t.loadContentById,t)),$(".ui-bizagi-wp-project-tab-links li .ui-bizagi-refresh-form",e).on("click",(function(){var e={action:bizagi.workportal.actions.action.BIZAGI_WORKPORTAL_ACTION_ROUTING,idCase:t.params.idCase,idTask:t.params.idTask,idWorkflow:t.params.idWorkflow,idWorkItem:t.params.idWorkitem,referrer:t.params.referrer||"inboxGrid"};t.publish("executeAction",e)}))},clean:function(){var t=this,e=t.getContent();t._super(),t.params&&t.params.contextsLeftSidebarCaseDashboard&&t.params.contextsLeftSidebarCaseDashboard.forEach((function(e){t.unsub(e,$.proxy(t.updateView,t))})),$(".ui-bizagi-wp-project-tab-links a",e).off(),$(".ui-bizagi-wp-project-tab-links li .ui-bizagi-refresh-form",e).off()}}),bizagi.injector.register("bizagi.workportal.widgets.project.dashboard.menu.activity",["workportalFacade","dataService",bizagi.workportal.widgets.project.dashboard.menu.activity],!0),bizagi.workportal.widgets.project.dashboard.menu.extend("bizagi.workportal.widgets.project.dashboard.menu.activity.plan",{},{init:function(t,e,i){this.params=i||{},this._super(t,e,i),this.loadTemplates({"project-dashboard-menu":bizagi.getTemplate("bizagi.workportal.desktop.widgets.project.dashboard.menu.activity.plan").concat("#project-dashboard-menu2")})},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){var t=this;t._super(),t.params.contextsLeftSidebarCaseDashboard.forEach((function(e){t.sub(e,$.proxy(t.updateView,t))}))},updateView:function(t,e){var i=this;i.params=$.extend(i.params,e.args),i.clean();var a=i.getContent().empty(),n={showFormOverview:i.params.menuDashboard.showFormOverview,showFormActivity:i.params.menuDashboard.showFormActivity,showCommentsOptionMenu:i.params.menuDashboard.showCommentsOptionMenu,showFilesOptionMenu:i.params.menuDashboard.showFilesOptionMenu,showTimeLineOptionMenu:i.params.menuDashboard.showTimeLineOptionMenu,showPlanOptionMenu:i.params.menuDashboard.showPlanOptionMenu,contextPlanOptionMenu:i.params.menuDashboard.contextPlanOptionMenu,contextFormActivityOptionMenu:i.params.menuDashboard.contextFormActivityOptionMenu,contextualized:i.params.plan.contextualized};i.getTemplate("project-dashboard-menu").render(n).appendTo(a),i.params.showContextByMenuDashboard&&$("li[data-context='"+t.type.toUpperCase()+"']",i.content).addClass("active").siblings().removeClass("active"),i.updateDiscussionsIcons(i.params.hasDiscussionsOrComment),i.handlerEvents();var r={idPlan:i.params.plan.id};$.when(i.callGetPlan(r)).then((function(t){$.extend(i.params.plan,t),i.pub("notify",{type:"LOAD_INFO_PLAN",args:i.params})}))},loadContentById:function(t){var e=this;t.preventDefault();var i=$(t.target).closest("li");i.hasClass("active")||$.when(bizagi.util.autoSave()).done((function(){$(document).data("auto-save","");var t=i.data("context");if(t){var a=e.pub("notify",{type:"NAVIGATOR_GETLEVEL"}),n=parseInt(a[0]);e.params.refreshLastItemBreadcrumb=!1,e.pub("notify",{type:t.toUpperCase(),args:$.extend(e.params,{showContextByMenuDashboard:t,histName:"",level:n})}),$("li[data-context='"+e.params.showContextByMenuDashboard.toUpperCase()+"']",e.content).addClass("active").siblings().removeClass("active")}}))},callGetPlan:function(t){var e=$.Deferred();return this.dataService.getPlan(t).always((function(t){200===t.status||201===t.status||void 0===t.status?e.resolve(t):e.reject()})),e.promise()},subMenuHandler:function(){var t=this.getContent(),e=$("[data-context='ACTIVITYPLANCOMMENTS']",t),i=$("[data-context='ACTIVITYPLANFILES']",t),a=$("[data-context='ACTIVITYPLANTIMELINE']",t);$(".ui-bizagi-wp-project-tab-submenu a",t).on("click",(function(){e.toggle(),i.toggle(),a.toggle()}))},handlerEvents:function(){var t=this.getContent();this.subMenuHandler(),$(".ui-bizagi-wp-project-tab-links a",t).on("click",$.proxy(this.loadContentById,this))},clean:function(){var t=this,e=t.getContent();t._super(),t.params&&t.params.contextsLeftSidebarCaseDashboard&&t.params.contextsLeftSidebarCaseDashboard.forEach((function(e){t.unsub(e,$.proxy(t.updateView,t))})),$(".ui-bizagi-wp-project-tab-links a",e).off()}}),bizagi.injector.register("bizagi.workportal.widgets.project.dashboard.menu.activity.plan",["workportalFacade","dataService",bizagi.workportal.widgets.project.dashboard.menu.activity.plan],!0),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.content.dashboard",{},{init:function(t,e,i){this._super(t,e,i),this.loadTemplates({"project-content-dashboard":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.content.dashboard").concat("#project-plan-content-dashboard")})},renderContent:function(){var t=this.getTemplate("project-content-dashboard");return this.content=t.render({}),this.content},postRender:function(){setTimeout((function(){$(window).trigger("resize")}),1e3)}}),bizagi.injector.register("bizagi.workportal.widgets.project.content.dashboard",["workportalFacade","dataService",bizagi.workportal.widgets.project.content.dashboard],!0),bizagi.workportal.widgets.project.base.extend("bizagi.workportal.widgets.project.plan.activities",{},{init:function(t,e,i,a,n){this._super(t,e,n),this.serviceOrderActivitiesByTransitions=a,this.PENDING_PLAN="PENDING_PLAN",this.EXECUTING_PLAN="EXECUTING_PLAN",this.CONTEXT_PLANACTIVITIES="PLANACTIVITIES",this.CONTEXT_PLANOVERVIEW="PLANOVERVIEW",this.CONTEXT_PLANCREATE="PLANCREATE",this.plugins={},this.fromIndexEnabledSortingActivities=0,this.idActivityEditing="",this.plugins.notifier=i,this._statePlan=this.PENDING_PLAN,this.userPictures=[],this.refresh=n.refreshAllWidgets,this.loadTemplates({"plan-activities-main":bizagi.getTemplate("bizagi.workportal.desktop.widgets.project.plan.activities").concat("#project-plan-activities"),"plan-activities-item":bizagi.getTemplate("bizagi.workportal.desktop.widgets.project.plan.activities").concat("#project-plan-activities-item")})},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){this.sub("LOAD_INFO_SUMMARY_PROGRESS_PLAN",$.proxy(this.onNotifySummaryProgressPlan,this)),this.sub("UPDATE_INFO_PLAN",$.proxy(this.onNotifyUpdatePlan,this)),this.sub("UPDATE_LIST_ACTIVITIES",$.proxy(this.renderWidgetByStatePlan,this)),this.sub("UPDATE_ACTIVITY_INFO",$.proxy(this.refreshActivityRow,this)),this.refresh||this.collapseSidebars()},onNotifySummaryProgressPlan:function(t,e){this.params=$.extend(this.params,e.args);var i=this.params.plan.currentState;this._statePlan=i+"_PLAN",this.renderWidgetByStatePlan(t.type)},renderWidgetByStatePlan:function(t){this.idActivityEditing="";var e=this.getContent().empty(),i=this.enableEventsOnActivitiesByCurrentContext(this.params.showContextByMenuDashboard),a=this.params.plan.activities.filter((function(t){return t.finishDate})).length,n={showContextByMenuDashboard:this.params.showContextByMenuDashboard,statePlan:this._statePlan,statePendingPlan:this.PENDING_PLAN,stateExecutingPlan:this.EXECUTING_PLAN,contextPlanActivities:this.CONTEXT_PLANACTIVITIES,plan:this.params.plan,showFormAddActivityByNotFinishedAllActivities:a!==this.params.plan.activities.length,currentUserGuid:bizagi.currentUser.userGuid};this.getTemplate("plan-activities-main").render($.extend(this.params,n)).appendTo(e),this._statePlan!==this.PENDING_PLAN&&this._statePlan!==this.EXECUTING_PLAN||!i||(this.plugins.sortablelist=this.initializeSortableList(),this.addEventHandlers()),this.setContentWrapper(e),$(".project-plan-activity-list",e).on("click","li",$.proxy(this.onClickEditActivity,this)),$(".project-plan-activity-list",e).on("click","li .activity-view",$.proxy(this.onClickEditActivity,this)),$(".project-plan-activity-list",e).on("click","li .bz-icon-trash-outline",$.proxy(this.onClickDeleteActivity,this)),$(".project-plan-activity-list",e).on("click","li .item-workonit-button",$.proxy(this.onClickWorkonItActivity,this)),this.params.showContextByMenuDashboard===this.CONTEXT_PLANACTIVITIES&&$(".project-plan-activity-list",e).on("click","li .ui-bizagi-wrapper-parallel-icon",$.proxy(this.onClickChangeParallel,this)),this._statePlan===this.PENDING_PLAN?$("a#to-execute-plan",e).on("click",$.proxy(this.onExecutePlan,this)):"CLOSED_PLAN"!==this._statePlan&&$("a#to-close-plan",e).on("click",$.proxy(this.onClosePlan,this)),this.renderActivities(),t&&"UPDATE_LIST_ACTIVITIES"===t.type&&this.updateTransitions()},getCopyObjectPlan:function(){return{id:this.params.plan.id,name:this.params.plan.name,description:this.params.plan.description,dueDate:this.params.plan.dueDate,waitForCompletion:this.params.plan.waitForCompletion,currentState:this.params.plan.currentState,parentWorkItem:this.params.plan.parentWorkItem,creationDate:this.params.plan.creationDate,startDate:this.params.plan.startDate,idUserCreator:this.params.plan.idUserCreator,contextualized:this.params.plan.contextualized,activities:this.params.plan.activities}},enableEventsOnActivitiesByCurrentContext:function(t){return t===this.CONTEXT_PLANACTIVITIES},onNotifyUpdatePlan:function(){this.params.showContextByMenuDashboard===this.CONTEXT_PLANOVERVIEW&&($(".ui-bizagi-wp-project-plan-activities-header h3",this.content).text(this.params.plan.name),$(".ui-bizagi-wp-project-plan-activities-header p",this.content).text(this.params.plan.description))},initializeSortableList:function(){var t=this;return $(".project-plan-activity-list",t.content).kendoSortable({hint:function(t){var e=t.clone().width(t.width());return $("<ol class='project-plan-activity-list ui-bizagi-wp-nolist'></ol>").append(e)},change:$.proxy(t.onChangePosition,t),disabled:".disabled",end:function(e){if(e.newIndex<t.fromIndexEnabledSortingActivities)e.preventDefault();else if(e.oldIndex!==e.newIndex){t.serviceOrderActivitiesByTransitions.movePositionActivity(t.params.plan.activities,e.oldIndex,e.newIndex);var i=$(".project-plan-activity-list li",t.content).eq(e.newIndex);if(!t.canChangeToParallelActivity(t.params.plan.activities,i)){t.params.plan.activities[e.newIndex].parallel=!1,e.newIndex,setTimeout((function(){$(".project-plan-activity-list li .wrapper-arrow-css i",t.content).eq(0).removeClass("bz-icon-arrow-right-outline").addClass("bz-icon-arrow-down-outline")}),50)}}}}).data("kendoSortable")},updateTransitions:function(){var t=this,e=$.Deferred(),i={idPlan:t.params.plan.id,transitions:t.getActualTransitions()};return $.when(t.dataService.changeTransitions(i)).always((function(a,n,r){500===r.status&&t.plugins.notifier.showErrorMessage(bizagi.localization.getResource("workportal-project-plan-activities-sorterror"),"error"),t.params.plan.activities=t.orderActivitiesByTransitions(t.params.plan.activities,i.transitions),e.resolve()})),e.promise()},orderActivitiesByTransitions:function(t,e){return this.serviceOrderActivitiesByTransitions.getActivitiesByTransitions(t,e)},getActualTransitions:function(){var t=this,e=t.serviceOrderActivitiesByTransitions.getActualTransitionsByActivities(t.params.plan.activities);return e.forEach((function(e){e.id=void 0,e.idPlan=t.params.plan.id})),e},onChangePosition:function(){this.updateTransitions()},onCreateActivity:function(t){t.preventDefault();var e,i=this,a=$("#project-plan-activity-create",$(t.target)).val();if(e=i.params.plan.activities.length>0?i.params.plan.activities[i.params.plan.activities.length-1].userAssigned:bizagi.currentUser.idUser,""!==a.replace(/\s/g,"")){var n={progress:0,id:"",startDate:null,duration:null,userAssigned:e,allowEdition:!0,description:null,name:a,idPlan:i.params.plan.id,estimatedFinishDate:null,finishDate:null};if(i.params.plan.parent&&!bizagi.util.isEmpty(i.params.plan.parent.guidActivity)){var r={idPlan:i.params.plan.id,idActivity:i.params.plan.parent.guidActivity};$.when(i.dataService.getActivity(r)).done((function(t){n.allowEdition=t.allowEdition,i.createPlanActivity(n)}))}else i.createPlanActivity(n)}t.target.reset(),t.preventDefault()},createPlanActivity:function(t){var e=this;$.when(e.dataService.createPlanActivity(t)).always((function(i,a,n){if(201===n.status){var r={idPlan:t.idPlan,idActivity:i.id};$.when(e.dataService.getActivity(r)).always((function(t){var a=$.extend(t,{id:i.id,items:[],numTotalItems:0,numResolvedItems:0,parallel:!1});e.renderActivities([a]),e.params.plan.activities.push(a);var n=$(".project-plan-activity-list",e.content);$("li:last .bz-icon-pencil-outline",n).trigger("click"),e.updateTransitions()}))}else 500===i.status&&e.plugins.notifier.showErrorMessage(bizagi.localization.getResource("workportal-project-plan-activities-createarror"),"error")}))},onClickChangeParallel:function(t){t.preventDefault();var e,i=$(".wrapper-arrow-css",t.currentTarget),a=i.closest("li"),n=a.data("id");this.canChangeToParallelActivity(this.params.plan.activities,a)&&($("i",i).hasClass("bz-icon-arrow-down-outline")?(e=!0,$("i",i).removeClass("bz-icon-arrow-down-outline").addClass("bz-icon-arrow-right-outline").prop("title",bizagi.localization.getResource("workportal-project-plan-activity-parallel"))):(e=!1,$("i",i).removeClass("bz-icon-arrow-right-outline").addClass("bz-icon-arrow-down-outline").prop("title",bizagi.localization.getResource("workportal-project-plan-activity-sequential"))),this.changeActivityProperties(n,{parallel:e}),this.updateTransitions())},canChangeToParallelActivity:function(t,e){var i=!0,a=this.getLastParallelActivityIsRunningOrClose(t);a&&(a===e.prev().data("id")&&(i=!1));return i},onClickEditActivity:function(t){var e=this,i=$(t.currentTarget),a=i.data("id"),n=e.params.plan.activities.filter((function(t){return t.id===a}))[0],r="CLOSED_PLAN"!==e._statePlan&&"Completed"!==n.workItemState;if(e.params.showContextByMenuDashboard===e.CONTEXT_PLANACTIVITIES){!function(t){e.idActivityEditing!==t&&(e.params.plan.idActivitySelected=t,i.closest("li").addClass("selected").siblings().removeClass("selected"),e.idActivityEditing=t,e.pub("notify",{type:"EDITACTIVITY",args:$.extend(e.params,{isEditableFormActivity:r,idActivityToShow:t})}),e.pub("notify",{type:"OPEN_RIGHT_SIDEBAR"}))}(a)}},changeActivityProperties:function(t,e){for(var i=0,a=this.params.plan.activities.length;i<a;i+=1)if(this.params.plan.activities[i].id===t){$.extend(this.params.plan.activities[i],e);break}},addEventHandlers:function(){$("#project-plan-activity-createform",this.content).on("submit",$.proxy(this.onCreateActivity,this)),$("#project-plan-activity-create",this.content).focus()},renderActivities:function(t){var e=this,i=$(".project-plan-activity-list",e.content),a=e.getTemplate("plan-activities-item");e.params.showContextByMenuDashboard===e.CONTEXT_PLANACTIVITIES&&i.addClass("enabled-actions");var n="PENDING"===e.params.plan.currentState?$("a#to-execute-plan",e.content):$("a#to-close-plan",e.content);t||e.params.plan.activities.length>0?n.show():n.hide();var r=t||e.params.plan.activities,s={statePlan:e._statePlan,statePendingPlan:e.PENDING_PLAN,stateExecutingPlan:e.EXECUTING_PLAN,context:e.params.showContextByMenuDashboard,activities:t||e.params.plan.activities,currentUserId:bizagi.currentUser.idUser};e._statePlan===e.EXECUTING_PLAN&&r.forEach((function(t){t.startDate?t.classEnabledActionActivities="disabled":t.classEnabledActionActivities=e.params.showContextByMenuDashboard===e.CONTEXT_PLANACTIVITIES?"enabled":"disabled",t.isRunning=e.runningActivity(t)})),s.activities=s.activities.map((function(t){return t.name=bizagi.util.decodeHtmlEntities(t.name),t.description=bizagi.util.decodeHtmlEntities(t.description),t}));var o=a.render(s);i.append(o),e.fromIndexEnabledSortingActivities=e.params.plan.activities.filter((function(t){return"disabled"===t.classEnabledActionActivities})).length,e.loadAndShowImagesUsers(e.params.plan.activities)},runningActivity:function(t){return"Active"===t.workItemState||"Inactive"===t.workItemState},loadAndShowImagesUsers:function(t){var e=this;var i=function(t){for(var e={},i=[],a=t.length,n=0,r=0;r<a;r++){var s=t[r];1!==e[s]&&(e[s]=1,i[n++]=s)}return i}($.map(t,(function(t){return t.userAssigned})).concat(bizagi.currentUser.userGuid)).join(",");e.getDataUsers(i).then((function(){e.renderUserProfilesAndImages()}))},renderUserProfilesAndImages:function(){for(var t=0;t<this.userPictures.length;t+=1)$("div[data-iduser='"+this.userPictures[t].id+"']  span.ui-bizagi-user-initials").html(this.userPictures[t].name.getInitials()),this.userPictures[t].picture&&($("div[data-iduser='"+this.userPictures[t].id+"']  img").show(),$("div[data-iduser='"+this.userPictures[t].id+"']  span.ui-bizagi-user-initials").hide(),$("div[data-iduser='"+this.userPictures[t].id+"']  img").attr("src","data:image/png;base64,"+this.userPictures[t].picture))},getDataUsers:function(t){var e=this,i=$.Deferred(),a={usersGuids:t,width:50,height:50};return e.dataService.getUsersData(a).always((function(t){e.userPictures=function(t){for(var e=t.concat(),i=0;i<e.length;++i)for(var a=i+1;a<e.length;++a)e[i]===e[a]&&e.splice(a-=1,1);return e}(e.userPictures.concat(t)),i.resolve(t)})),i.promise()},onCancelActivityForm:function(){this.closeSidebar(),this.pub("notify",{type:"PLANSIDEBAR",args:this.params})},setContentWrapper:function(t){var e=$(".project-plan-content-wrapper",t);e.on("click",$.proxy(this.onCancelActivityForm,this)),$("#project-plan-activities-wrapper",t).on("click",(function(t){t.stopPropagation()}));var i=$(window).height()-156;e.css("height",i+"px")},onClickDeleteActivity:function(t){t.stopPropagation();var e=this,i=$(t.currentTarget).data("id"),a={idPlan:e.params.plan.id,id:i};$.when(bizagi.showConfirmationBox(bizagi.localization.getResource("workportal-project-plan-activity-delete-confirmation"),"","info")).done((function(){$.when(e.dataService.deleteActivityPlan(a)).done((function(){e.closeSidebar();for(var t=0,a=e.params.plan.activities.length;t<a;t+=1)e.params.plan.activities[t].id===i&&a>t+1&&t>0&&e.params.plan.activities[t+1].parallel&&e.params.plan.activities[t-1].parallel&&(e.params.plan.activities[t+1].parallel=!1,$(".project-plan-activity-list li[data-id='"+e.params.plan.activities[t].id+"']",e.content).next().find(".wrapper-arrow-css i").removeClass("bz-icon-arrow-right-outline").addClass("bz-icon-arrow-down-outline"));e.params.plan.activities=e.params.plan.activities.filter((function(t){return t.id!==i})),$.when(e.updateTransitions()).done((function(){e.renderWidgetByStatePlan(),e.pub("notify",{type:"PLANSIDEBAR",args:e.params})}))}))}))},onClickWorkonItActivity:function(t){t.preventDefault();var e=$(t.target).closest("li").data("id"),i=this.params.plan.activities.filter((function(t){return t.id===e}))[0];this.publish("executeAction",{action:bizagi.workportal.actions.action.BIZAGI_WORKPORTAL_ACTION_ROUTING,idCase:i.idCase,idWorkItem:i.idWorkItem})},onExecutePlan:function(t){t.preventDefault();var e=this;if(e.params.plan.activities.length>0){if(!$(t.target).closest("a").hasClass("disabled")){e.params.plan.currentState="EXECUTING",$(t.target).closest("a").addClass("disabled");var i={idPlan:e.params.plan.id};$.when(e.dataService.putExecutePlan(i)).done((function(){var i=$.extend(e.getCopyObjectPlan(),{startDate:e.getDateServer()});function a(t){e.params.planChild&&(e.params.planChild.currentState=e.params.plan.currentState),e._notifyPlanActivities(t)}e.callUpdatePlan(i),$(t.target).closest("a").removeClass("disabled"),void 0===e.radNumber?$.when(e.dataService.getCaseByPlan({idPlan:e.params.plan.id})).done((function(t){e.params.idCase=t.id,a(e.params)})):a(e.params)}))}}else e.plugins.notifier.showErrorMessage(printf(bizagi.localization.getResource("workportal-project-plan-action-execute-message-activities-required"),""))},_notifyPlanActivities:function(t){this.pub("notify",{type:"PLANACTIVITIES",args:$.extend(t,{refreshAllWidgets:!0})})},onClosePlan:function(t){var e=this;t.preventDefault(),e.activitiesAreCompleted(e.params.plan.activities)?e.closePlan():$.when(bizagi.showConfirmationBox(bizagi.localization.getResource("workportal-project-plan-action-close-message-activities-finished"),"","info")).done((function(){e.closePlan()}))},closePlan:function(){var t=this,e=$.extend(t.getCopyObjectPlan(),{currentState:"CLOSED"});$.when(t.callUpdatePlan(e)).done((function(){$.when(t.callClosePlan({idPlan:e.id})).done((function(){t.params.plan=e,t.pub("notify",{type:"LOAD_INFO_SUMMARY_PLAN",args:t.params}),t.pub("notify",{type:"LOAD_INFO_SUMMARY_PROGRESS_PLAN",args:t.params})})).fail((function(){t.notifier.showErrorMessage(printf(bizagi.localization.getResource("workportal-project-plan-close-fail"),""))}))})).fail((function(){t.notifier.showErrorMessage(printf(bizagi.localization.getResource("workportal-project-plan-close-fail"),""))}))},callUpdatePlan:function(t){var e=this;return $.when(e.dataService.updatePlan(t)).done((function(){$.extend(e.params.plan,t)}))},callClosePlan:function(t){var e=this;return $.when(e.dataService.closePlan(t)).done((function(){$.extend(e.params.plan,t),e.plugins.notifier.showSucessMessage(printf(bizagi.localization.getResource("workportal-project-plan-close-success"),""))}))},activitiesAreCompleted:function(t){return(t||[]).filter((function(t){return t.finishDate})).length===t.length},getLastParallelActivityIsRunningOrClose:function(t){var e=-1,i=t.filter((function(t){if(null!==t.startDate&&t.parallel)return e+=1,!0}));return e>=0&&e+1!==t.length?i[i.length-1].id:null},_getJElementSelectedActivity:function(t){var e=$(".project-plan-activity-list li[data-id='"+t.args.id+"']"),i=$(".project-plan-activity-list li.selected");return t.args.id?e:i},refreshActivityRow:function(t,e){var i=this._getJElementSelectedActivity(e);if(e.args.displayName&&$("p>span",i).text(e.args.displayName),e.args.assignee){var a=$(i).data("id"),n=this.params.plan.activities.filter((function(t){return t.id===a}))[0];e.args.assignee!==bizagi.currentUser.idUser||"Active"!==n.workItemState&&"Inactive"!==n.workItemState?$(".item-workonit-button",i).hide():$(".item-workonit-button",i).show(),this.getDataUsers([e.args.assignee].join()).then((function(t){if($(".bz-wp-avatar span.ui-bizagi-user-initials",i).html(t[0].name.getInitials()),$("div.ui-bizagi-wp-project-plan-activity-infobox[data-iduser]",i).attr("data-iduser",e.args.assignee),t[0].picture){$(".bz-wp-avatar img",i).show(),$(".bz-wp-avatar  span.ui-bizagi-user-initials",i).hide(),$(".bz-wp-avatar img",i).attr("src","data:image/png;base64,"+t[0].picture)}else $(".bz-wp-avatar img",i).hide(),$(".bz-wp-avatar  span.ui-bizagi-user-initials",i).show()}))}},closeSidebar:function(){bizagi.services.preferences().getPreference("activityCollapseSidebars")&&"none"==$(".ui-bizagi-wp-project-panel-rowicon-right i.bz-icon-left-outline").css("display")&&$("li.clearfix.selected").length>0&&this.pub("notify",{type:"CLOSE_RIGHT_SIDEBAR"})},collapseSidebars:function(){bizagi.services.preferences().getPreference("activityCollapseSidebars")&&($("#ui-bizagi-wp-project-homeportal-main").addClass("ui-bizagi-wp-project-collapse-rightpanel"),$("#ui-bizagi-wp-project-homeportal-main").removeClass("ui-bizagi-wp-project-open-rightpanel"),$("#right-sidebar-wrapper").addClass("always-collpase"),$("#ui-bizagi-wp-project-homeportal-main").addClass("ui-bizagi-wp-project-collapse-leftpanel"),$("#ui-bizagi-wp-project-homeportal-main").removeClass("ui-bizagi-wp-project-open-leftpanel"),$("#left-sidebar-wrapper").addClass("always-collpase"))}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.activities",["workportalFacade","dataService","notifier","bizagi.workportal.services.behaviors.orderActivitiesByTransitions",bizagi.workportal.widgets.project.plan.activities],!0),bizagi.workportal.widgets.project.base.extend("bizagi.workportal.widgets.project.plan.sidebar",{},{init:function(t,e,i,a){this._super(t,e,a),this.serviceloadDataPlan=i,this.params=a||{},a.supportNav=!1,this.loadTemplates({"project-plan-sidebar":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.plan.sidebar").concat("#project-plan-sidebar")})},renderContent:function(){var t=this,e=t.getTemplate("project-plan-sidebar");return t.content=e.render({}),$.when(t.areTemplatedLoaded()).done((function(){var e={idPlan:t.params.plan.id};t.params.planChild&&t.params.planChild.id&&(e.idPlan=t.params.planChild.id),t.serviceloadDataPlan.loadData(e,t.getDateServer,t.params),t.serviceloadDataPlan.subscribe("loadedWithDataActivities",$.proxy(t.loadedWithDataActivities,t)),t.serviceloadDataPlan.subscribe("loadedWithDataFirstParent",$.proxy(t.loadedWithDataFirstParent,t))})),t.content},loadedWithDataActivities:function(){this.pub("notify",{type:"LOADED_ACTIVITIES_PLAN",args:this.params}),this.pub("notify",{type:"UPDATE_INFO_PLAN",args:this.params}),this.pub("notify",{type:"LOAD_INFO_SUMMARY_PROGRESS_PLAN",args:this.params}),this.pub("notify",{type:"LOAD_INFO_ACTIVITIES_PLAN",args:this.params})},loadedWithDataFirstParent:function(){this.pub("notify",{type:"LOAD_INFO_SUMMARY_PLAN",args:this.params})},clean:function(){this.serviceloadDataPlan&&(this.serviceloadDataPlan.unsubscribe("loadedWithDataActivities",$.proxy(this.loadedWithDataActivities,this)),this.serviceloadDataPlan.unsubscribe("loadedWithDataFirstParent",$.proxy(this.loadedWithDataFirstParent,this)))}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.sidebar",["workportalFacade","dataService","bizagi.workportal.services.behaviors.loadDataPlan",bizagi.workportal.widgets.project.plan.sidebar],!0),bizagi.workportal.widgets.project.base.extend("bizagi.workportal.widgets.project.plan.action",{},{init:function(t,e,i,a,n,r,s){this._super(t,e,s),this.PENDING_PLAN="PENDING",this.EXECUTING_PLAN="EXECUTING",this.CLOSED_PLAN="CLOSED",this.CONTEXT_ACTIVITYPLAN="ACTIVITYPLAN",this.CONTEXT_ACTIVITYPLANOVERVIEW="ACTIVITYPLANOVERVIEW",this.CONTEXT_PLANCREATE="PLANCREATE",this.CONTEXT_ACTIVITYPLANCREATE="ACTIVITYPLANCREATE",this.showActionsPlan=!1,this.projectDashboard=i,this.notifier=a,this.planTemplateCreate=n,this.planPopupEdit=r,this.loadTemplates({"plan-action-main":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.action").concat("#project-plan-action")})},renderContent:function(){var t=this.getTemplate("plan-action-main");return this.showActionsPlan=this.params.showContextByMenuDashboard!==this.CONTEXT_ACTIVITYPLAN&&this.params.showContextByMenuDashboard!==this.CONTEXT_ACTIVITYPLANOVERVIEW,this.plugins={},this.content=t.render({plan:this.params.plan.name,stateClosedPlan:this.CLOSED_PLAN,currentStatePlan:this.params.plan.currentState,showActionsPlan:this.showActionsPlan}),this.showActionsPlan&&(this.params.plan.contextualized=void 0===this.params.plan.contextualized||this.params.plan.contextualized),this.content},postRender:function(){var t=this,e=t.getContent();t.showActionsPlan&&(t.initilizeActionMenu(),$("a#to-close-plan",e).on("click",$.proxy(t.onClosePlan,t))),t.sub("LOAD_INFO_SUMMARY_PLAN",$.proxy(t.onNotifyLoadInfoSummaryPlan,t)),t.clearAlertsOnFocus(),t.planTemplateCreate.sub("planTemplateCreatedSuccess",(function(){t.notifier.showSucessMessage(printf(bizagi.localization.getResource("workportal-project-plan-create-template-success"),""))})),t.planTemplateCreate.sub("planTemplateCreatedFailed",(function(){t.notifier.showErrorMessage(printf(bizagi.localization.getResource("workportal-project-plan-create-template-fail"),""))})),t.planPopupEdit.sub("planEditedSuccess",(function(){t.setNamePlan(t.params.plan.name),t.pub("notify",{type:"UPDATE_INFO_PLAN"}),t.pub("notify",{type:"LOAD_INFO_SUMMARY_PLAN",args:t.params}),t.notifier.showSucessMessage(printf(bizagi.localization.getResource("workportal-project-plan-edit-success"),""))})),t.planPopupEdit.sub("planEditedFailed",(function(){t.notifier.showErrorMessage(printf(bizagi.localization.getResource("workportal-project-plan-edit-fail"),""))})),t.sub("EXPANDED_RIGHT_SIDEBAR",$.proxy(t.onNotifyExpandedRightSidebar,t))},onNotifyExpandedRightSidebar:function(){this.showActionsPlan&&this.initilizeActionMenu()},onNotifyLoadInfoSummaryPlan:function(){this.setStatePlan(this.params.plan.currentState),this.setNamePlan(this.params.plan.name)},setStatePlan:function(t){if(t)switch(t.toUpperCase()){case"PENDING":$(".state-pending-plan",this.content).show().siblings().hide();break;case"EXECUTING":$(".state-executing-plan",this.content).show().siblings().hide();break;case"CLOSED":$(".state-closed-plan",this.content).show().siblings().hide()}},setNamePlan:function(t){$(".ui-bizagi-wp-project-plan-header .bz-wp-section",this.content).text(bizagi.util.decodeHtmlEntities(t))},onSelectMenu:function(t,e){if(0===$(t.currentTarget).find("i").length)switch($(e.item).data("item")){case"edit":this.onClickMenuOpenEdition();break;case"delete":this.onClickMenuDeletePlan();break;case"saveastmpl":this.onClickMenuSaveAsTemplate()}},onClickMenuOpenEdition:function(){var t=this.params.plan;this.planPopupEdit.showPopup(this.params,this.dataService,t)},onClickMenuSaveAsTemplate:function(){this.planTemplateCreate.showPopupAddTemplatePlan(this.params,this.dataService,this.params.plan.contextualized,this.params.plan.id)},onClickMenuDeletePlan:function(){var t=this;$.when(bizagi.showConfirmationBox(bizagi.localization.getResource("workportal-project-plan-action-delete-confirmation"),"","info")).done((function(){var e={id:t.params.plan.id};$.when(t.callDeletePlan(e)).always((function(e){if(200===e.status||void 0===e.status){$.extend(t.params.plan,n),t.notifier.showSucessMessage(printf(bizagi.localization.getResource("workportal-project-plan-delete-success"),""));var i=t.pub("notify",{type:"NAVIGATOR_GETLEVEL"}),a=parseInt(i[0]),n=t.projectDashboard.getParamsByBackFromPlan(t.params,a,!0);t.pub("notify",{type:n.typeContext,args:$.extend(t.params,n.paramsNotify)})}else t.notifier.showErrorMessage(printf(bizagi.localization.getResource("workportal-project-plan-delete-fail"),""))}))}))},onSubmitFormPlan:function(t){t.preventDefault()},initilizeActionMenu:function(){$(".ui-bizagi-wp-project-plan-action-menu",this.content).menu({select:$.proxy(this.onSelectMenu,this)}).removeClass("ui-widget-content")},clearAlertsOnFocus:function(){$(".ui-bizagi-wp-project-container-validator-relative input, .ui-bizagi-wp-project-container-validator-relative textarea").focus((function(){$(this).parent().find(".k-invalid-msg").hide()})).focusout((function(){$(this).val().length<1&&$(this).parent().find(".k-invalid-msg").show()}))},callDeletePlan:function(t){return $.when(this.dataService.deletePlan(t))},clean:function(){this.planTemplateCreate.unsub("planTemplateCreatedSuccess"),this.planTemplateCreate.unsub("planTemplateCreatedFailed"),this.planPopupEdit.unsub("planEditedSuccess"),this.planPopupEdit.unsub("planEditedFailed"),this.unsub("EXPANDED_RIGHT_SIDEBAR",$.proxy(this.onNotifyExpandedRightSidebar,this))}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.action",["workportalFacade","dataService","bizagi.workportal.services.behaviors.projectDashboard","notifier","bizagi.workportal.widgets.project.plan.template.create","bizagi.workportal.widgets.project.plan.edit",bizagi.workportal.widgets.project.plan.action],!0),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.plan.state",{},{init:function(t,e,i){this._super(t,e,i),this.loadTemplates({"plan-state-main":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.state").concat("#project-plan-state")})},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){this.sub("LOAD_INFO_SUMMARY_PLAN",$.proxy(this.onNotifyLoadInfoSummaryPlan,this))},onNotifyLoadInfoSummaryPlan:function(t,e){var i=this.getTemplate("plan-state-main").render({});switch(this.params=$.extend(this.params,e.args),this.params.plan.currentState.toUpperCase()){case"PENDING":$(".state-pending",i).show().siblings().hide();break;case"EXECUTING":$(".state-executing",i).show().siblings().hide();break;case"CLOSED":$(".state-closed",i).show().siblings().hide()}this.content.empty().append(i)}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.state",["workportalFacade","dataService",bizagi.workportal.widgets.project.plan.state],!0),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.plan.progress",{},{init:function(t,e,i){this._super(t,e,i),this.loadTemplates({"plan-progress-main":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.progress").concat("#project-plan-progress")})},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){this.sub("LOAD_INFO_SUMMARY_PROGRESS_PLAN",$.proxy(this.onNotifyLoadInfoSummaryPlan,this))},onNotifyLoadInfoSummaryPlan:function(t,e){this.params=$.extend(this.params,e.args);var i=this.getContent().empty(),a=this.calculateProgress(),n={};n.progress=a,n.progress<33?n.colorBar="Red":n.progress<66?n.colorBar="Yellow":n.colorBar="Green",this.getTemplate("plan-progress-main").render(n).appendTo(i);var r=$(".remaining-days .time-remaining",i),s=$(".remaining-days .days",i).width();r.css("padding-left",(s+7).toString()+"px")},calculateProgress:function(){var t=0,e=this.params.plan.activities.length,i=0;return 0!==e&&(this.params.plan.activities.forEach((function(e){"Completed"===e.workItemState&&t++})),i=Math.round(t/e*100)),i}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.progress",["workportalFacade","dataService",bizagi.workportal.widgets.project.plan.progress],!0),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.plan.time",{},{init:function(t,e,i){this._super(t,e,i),this.PENDING_PLAN="PENDING",this.EXECUTING_PLAN="EXECUTING",this.CLOSED_PLAN="CLOSED",this.datePickerRegional=bizagi.localization.getResource("datePickerRegional"),this.loadTemplates({"plan-time-main":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.time").concat("#project-plan-time")})},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){this.sub("LOAD_INFO_SUMMARY_PLAN",$.proxy(this.onNotifyLoadInfoSummaryPlan,this))},onNotifyLoadInfoSummaryPlan:function(t,e){this.params=$.extend(this.params,e.args),this.params.plan&&(this.params.plan.dueDate?this.params.plan.currentState===this.PENDING_PLAN||this.params.plan.currentState===this.EXECUTING_PLAN?this.updateWidget(t,e):this.sub("LOADED_ACTIVITIES_PLAN",$.proxy(this.updateWidget,this)):this.getContent().empty())},planDatesToStamp:function(t){t.activities&&t.activities.map((function(t){t.estimatedFinishDate&&(t.estimatedFinishDate=new Date(t.estimatedFinishDate).getTime()),t.startDate&&(t.startDate=new Date(t.startDate).getTime()),t.finishDate&&(t.finishDate=new Date(t.finishDate).getTime())})),t.dueDate&&(t.dueDate=new Date(t.dueDate).getTime()),t.creationDate&&(t.creationDate=new Date(t.creationDate).getTime()),t.startDate&&(t.startDate=new Date(t.startDate).getTime()),t.closedDate&&(t.closedDate=new Date(t.closedDate).getTime()),t.finishDate&&(t.finishDate=new Date(t.finishDate).getTime())},updateWidget:function(t,e){var i=this;i.params=$.extend(i.params,e.args),i.planDatesToStamp(i.params.plan);var a=i.getContent().empty();i.params.plan.currentState===i.CLOSED_PLAN&&i.getClosedDatePlan(i.params.plan),$.when(i.getIntervalOnMinutes(i.params.plan)).done((function(t){var e=bizagi.util.dateFormatter.getRelativeTime(new Date(Date.now()-60*t.minutesToShowTime*1e3),null,!0),n=e.replace(/\d/g,""),r=i.getKeywordDifferenceDates(i.params.plan),s=bizagi.localization.getResource("workportal-project-plan-state-"+r);s=s.replace("%s",n);var o=e.replace(/\D/g,""),p=i.getSecondDate(i.params.plan),c=i.getWidthBar(i.params.plan,t),l=i.getColorBarByPercent(c),d={fromDate:i.getFormattedDate(new Date(i.getFirstDate(i.params.plan))),toDate:p?i.getFormattedDate(new Date(p)):null,valueOfTimeCalculated:o,messageDescripionDifference:s,percentBar:c,colorBar:l};i.getTemplate("plan-time-main").render(d).appendTo(a)}))},getFirstDate:function(t){switch(t.currentState){case this.PENDING_PLAN:return t.dueDate?t.dueDate:t.creationDate;case this.EXECUTING_PLAN:case this.CLOSED_PLAN:return t.startDate}},getSecondDate:function(t){switch(t.currentState){case this.PENDING_PLAN:return null;case this.EXECUTING_PLAN:return t.dueDate;case this.CLOSED_PLAN:return t.closedDate}},getLastActivity:function(t){return JSON.parse(JSON.stringify(t)).sort((function(t,e){return t.finishDate<e.finishDate?1:-1}))[0]},getClosedDatePlan:function(t){return t.closedDate=this.getLastActivity(t.activities).finishDate,t.closedDate},getDifferenceBetweenDates:function(t,e){var i=$.Deferred(),a={idUser:bizagi.currentUser.idUser,fromDate:t,toDate:e};return $.when(this.callGetEffectiveDuration(a)).done((function(t){i.resolve(t.minutes)})),i.promise()},getIntervalOnMinutes:function(t){var e=this,i=$.Deferred();switch(t.currentState){case e.PENDING_PLAN:t.dueDate>Date.now()?$.when(e.getDifferenceBetweenDates(Date.now(),t.dueDate)).done((function(a){$.when(e.getDifferenceBetweenDates(t.creationDate,Date.now())).done((function(t){i.resolve({minutesToShowTime:a,minutesCreateToNow:t})}))})):t.dueDate<t.creationDate?$.when(e.getDifferenceBetweenDates(t.dueDate,t.creationDate)).done((function(a){$.when(e.getDifferenceBetweenDates(t.creationDate,Date.now())).done((function(t){i.resolve({minutesToShowTime:a+t,minutesCreateToNow:t})}))})):t.dueDate>t.creationDate&&$.when(e.getDifferenceBetweenDates(t.creationDate,t.dueDate)).done((function(a){$.when(e.getDifferenceBetweenDates(t.dueDate,Date.now())).done((function(t){i.resolve({minutesToShowTime:a+t,minutesCreateToNow:t})}))}));break;case e.EXECUTING_PLAN:t.dueDate?t.dueDate>Date.now()?$.when(e.getDifferenceBetweenDates(Date.now(),t.dueDate)).done((function(a){$.when(e.getDifferenceBetweenDates(t.startDate,Date.now())).done((function(t){i.resolve({minutesToShowTime:a,minutesStartToNow:t})}))})):$.when(e.getDifferenceBetweenDates(t.dueDate,Date.now())).done((function(a){$.when(e.getDifferenceBetweenDates(t.startDate,t.dueDate)).done((function(t){i.resolve({minutesToShowTime:a,minutesStartToDueDate:t})}))})):$.when(e.getDifferenceBetweenDates(t.startDate,Date.now())).done((function(t){i.resolve({minutesToShowTime:t})}));break;case e.CLOSED_PLAN:$.when(e.getDifferenceBetweenDates(t.startDate,t.closedDate)).done((function(t){i.resolve({minutesToShowTime:t})}))}return i.promise()},getKeywordDifferenceDates:function(t){switch(t.currentState){case this.PENDING_PLAN:return t.dueDate>Date.now()?"remaining":"exceeded";case this.EXECUTING_PLAN:return t.dueDate?t.dueDate>Date.now()?"remaining":"exceeded":"opened";case this.CLOSED_PLAN:return"executed"}},getRelativeTime:function(t){return bizagi.util.dateFormatter.getRelativeTime(t,null,!1)},getWidthBar:function(t,e){var i={};switch(t.currentState){case this.PENDING_PLAN:if(t.dueDate){if(t.dueDate<Date.now())return 0;var a=e.minutesCreateToNow+e.minutesToShowTime;return valuePercentInterval=e.minutesToShowTime,Math.ceil(100*valuePercentInterval/a)}return 0;case this.EXECUTING_PLAN:if(t.dueDate){if(t.dueDate>Date.now()){a=e.minutesStartToNow+e.minutesToShowTime;return valuePercentInterval=e.minutesToShowTime,Math.ceil(100*valuePercentInterval/a)}return 0}return 0;case this.CLOSED_PLAN:if(t.closedDate>Date.now()){var n=t.closedDate-t.startDate;return i=Date.now()-t.startDate,Math.ceil(100*i/n)}return 100}},getColorBarByPercent:function(t){return t<33?"Red":t<66?"Yellow":"Green"},callGetEffectiveDuration:function(t){var e=$.Deferred();return $.when(this.dataService.getEffectiveDuration(t)).done((function(t){e.resolve(t)})),e.promise()},getFormattedDate:function(t){return this.datePickerRegional.monthNames[t.getMonth()]+" "+bizagi.util.dateFormatter.formatDate(t,"dd hh:mm tt",bizagi.localization.getResource("datePickerRegional"))}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.time",["workportalFacade","dataService",bizagi.workportal.widgets.project.plan.time],!0),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.plan.parent",{},{init:function(t,e,i){this._super(t,e,i),this.loadTemplates({"plan-parent-main":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.parent").concat("#project-plan-parent")})},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){this.sub("LOAD_INFO_SUMMARY_PLAN",$.proxy(this.onNotifyLoadInfoSummaryPlan,this))},onNotifyLoadInfoSummaryPlan:function(t,e){var i=this,a=i.getContent().empty();i.params=$.extend(i.params,e.args),i.params.plan.parentWorkItem&&$.when(i.dataService.getPlanParent({idPlan:i.params.plan.id})).done((function(t){if(i.params.plan.parent=t,i.params.plan.parent){var e={idParent:i.params.plan.parent.radNumber,nameParent:i.params.plan.parent.displayName,idCase:i.params.plan.parent.idCase,idWorkflow:i.params.plan.parent.idWorkflow,idWorkItem:i.params.plan.parent.idWorkItem,idTask:i.params.plan.parent.idTask,processName:i.params.process?i.params.process:i.params.plan.parent.planName};if(bizagi.util.isEmpty(i.params.plan.parent.guidActivity))i.goToParentCase(a,e);else{var n={idPlan:i.params.plan.id,idActivity:i.params.plan.parent.guidActivity};$.when(i.dataService.getActivity(n)).done((function(t){i.params.plan.parent.allowEdition=t.allowEdition,i.goToParentCase(a,e)}))}}})).fail((function(t){}))},goToParentCase:function(t,e){t.empty(),this.getTemplate("plan-parent-main").render(e).appendTo(t),$("#go-to-parent-case",t).on("click",$.proxy(this.onClickGoToParentCase,this))},onClickGoToParentCase:function(t){t.preventDefault();this.routingExecute($(t.target).closest("#go-to-parent-case"))}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.parent",["workportalFacade","dataService",bizagi.workportal.widgets.project.plan.parent],!0),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.plan.users",{},{init:function(t,e,i){this.usersMap={},this.plugins={},this.usersInformation=[],this.globalHandlersService=bizagi.injector.get("globalHandlersService"),this.usersAssignees=[],this._super(t,e,i),this.loadTemplates({"plan-users-main":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.users").concat("#project-plan-users")}),this.auxNoRepeatTypesUser={},this.hashTypesUser={assigned:bizagi.localization.getResource("workportal-project-user-assigned"),owner:bizagi.localization.getResource("workportal-project-user-owner")}},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){this.sub("LOAD_INFO_ACTIVITIES_PLAN",$.proxy(this.onNotifyLoadInfoSummaryPlan,this))},onNotifyLoadInfoSummaryPlan:function(t,e){var i=this,a=e.args,n=[],r=[],s=i.getContent().empty(),o=e.args.plan.idUserCreator,p=e.args.plan.idUserCreator;i.params=$.extend(i.params,e.args),r.push({idUser:p,userGuid:o,userType:["owner"]}),i.usersMap["-"+p+"-"]={picture:"",id:p,guid:o,name:"",userType:["owner"]},n.push(p),$.each(i.params.plan.activities,(function(t,e){var a=e.userAssigned,s=e.userAssignedGuid;1==e.isRunning&&(a===p?-1===$.inArray("Assigned",r[0].userType)&&(r[0].userType.push("Assigned"),i.usersMap["-"+p+"-"].userType.push("Assigned")):(i.usersMap["-"+a+"-"]={picture:"",id:a,guid:s,name:"",userType:["Assigned"]},0===r.filter((function(t){return t.idUser==a})).length&&(r.push({idUser:a,guidUser:s,userType:["Assigned"]}),n.push(a))))})),i.activitiesUsers=r,i.params=a,i.getTemplate("plan-users-main").render({assignee:i.justAssignees(r),label:bizagi.localization.getResource("workportal-project-plan-assignee")}).appendTo(s),i.initilizeTooltip(),i.addEventHandlersModal(),$.when(i.callGetDataUsers(n)).then((function(){i.showCreatorInformation(p),i.renderUserProfilesAndImages()}))},justAssignees:function(t){var e=[];return-1==["CLOSED","PENDING"].indexOf(this.params.plan.currentState)&&t.map((function(t){var i=-1!==t.userType.indexOf("owner"),a=-1!==t.userType.indexOf("Assigned");e.push(usersAdapter.createJsonUserInfo(t.idUser,"","","","","",a,i,[],[]))})),usersAdapter.justAssignees(e)},showCreatorInformation:function(t){var e=this.usersInformation.find((function(e){return e.id==t})),i=usersAdapter.createJsonUserInfo(e.id,e.name,e.username,e.picture?"data:image/png;base64,"+e.picture:void 0,e.email,e.name.getInitials(),!1,!0,[],[]);this.content.find(".ui-bizagi-wp-project-plan-users .ui-bizagi-wp-project-users-creator-info").userinformation(this,{user:i})},renderUserProfilesAndImages:function(){var t=this;$.each(t.usersMap,(function(e,i){var a=$(".ui-bizagi-wp-userlist li[data-iduser="+i.id+"]",t.content);""!==i.picture?(a.find("img").prop("src",i.picture),$(".bz-wp-avatar-label",a).hide()):void 0!==i.name?($(".bz-wp-avatar-img",a).hide(),$(".bz-wp-avatar-label",a).html(i.name.getInitials())):console.log("obj.name is undefined")}))},callGetDataUsers:function(t){var e,i=this,a=$.Deferred();return e={usersGuids:t.join(),width:50,height:50},$.when(i.dataService.getUsersData(e)).always((function(t){i.usersInformation=t;for(var e=0,n=t.length;e<n;e+=1)void 0===t[e].name?bizagi.log(t[e]+" Id Not Found",t,"error"):i.usersMap["-"+t[e].id+"-"]?(i.usersMap["-"+t[e].id+"-"].picture+=t[e].picture?"data:image/png;base64,"+t[e].picture:"",i.usersMap["-"+t[e].id+"-"].name=t[e].name||""):console.log("self.usersMap['-' + response[i].id + '-'] is undefined");i.getUsersAssignees(),a.resolve()})),a.promise()},activityRunning:function(t){return null!==t.startDate&&null===t.finishDate},getUsersAssignees:function(){for(var t=0;t<this.usersInformation.length;t++){var e=this.getUserAssignee(this.params.plan.activities,this.usersInformation[t]);!1!==e&&this.usersAssignees.push(e)}},getUserAssignee:function(t,e){var i=this,a=t.filter((function(t){return t.userAssigned===e.id&&i.activityRunning(t)})).map((function(t){return{name:t.name}}));if(0==a.length)return!1;e.tasks=a;var n=i.activitiesUsers.find((function(t){return t.idUser==e.id}));return e.types=void 0===n?[]:n.userType,usersAdapter.createJsonUserInfo(e.id,e.name,e.username,e.picture?"data:image/png;base64,"+e.picture:void 0,e.email,e.name.getInitials(),e.types.indexOf("Assigned")>-1,e.types.indexOf("owner")>-1,e.tasks,[])},initilizeTooltip:function(){var t=this;$(".ui-bizagi-wp-userlist > li",t.content).not(".moreUsers").on("mouseenter","",(function(e){var i=$(e.target),a=i.closest("[data-iduser]").attr("data-iduser"),n=t.usersInformation.find((function(t){return t.id==a})),r=[];n.tasks&&n.tasks.map((function(t){r.push(t.name)}));var s=t.activitiesUsers.find((function(t){return t.idUser==a}));n.types=s.userType,n.owner=n.types.find((function(t){return"owner"==t})),n.isAssignee=n.types.find((function(t){return"Assigned"==t}));var o=usersAdapter.createJsonUserInfo(n.id,n.name,n.username,n.picture?"data:image/png;base64,"+n.picture:void 0,n.email,n.name.getInitials(),n.isAssignee,n.owner,r,[]);i.parent().usertooltip(t,{target:i,user:o})}))},addEventHandlersModal:function(){var t=this;$(".moreUsers").click((function(e){e.preventDefault(),e.stopPropagation();var i=t.usersAssignees||[];t.globalHandlersService.publish("showDialogWidget",{widgetName:bizagi.workportal.widgets.widget.BIZAGI_WORKPORTAL_WIDGET_USERS_MODAL,closeVisible:!0,data:i,maximize:!0,modalParameters:{title:bizagi.localization.getResource("workportal-project-users-title")+" ("+i.length+")",width:790,height:526,refreshInbox:!1}})}))}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.users",["workportalFacade","dataService",bizagi.workportal.widgets.project.plan.users],!0);
//# sourceMappingURL=../../../../Maps/desktop/activityplanoverview.desktop.production.js.map
