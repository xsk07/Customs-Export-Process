bizagi.workportal.widgets.project.base.extend("bizagi.workportal.widgets.project.plan.activity.sidebar",{},{init:function(t,e,i,s){this._super(t,e,s),this.serviceloadDataPlan=i,this.loadTemplates({"project-plan-activity-sidebar":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.activity.sidebar").concat("#project-plan-activity-sidebar")})},renderContent:function(){var t=this.getTemplate("project-plan-activity-sidebar");return this.content=t.render({}),this.content},postRender:function(){this.sub("LOAD_INFO_PLAN",$.proxy(this.onNotifyLoadInfoPlan,this))},onNotifyLoadInfoPlan:function(t,e){if(this.params.plan.idActivitySelected){var i={idPlan:this.params.plan.id};this.serviceloadDataPlan.loadData(i,this.getDateServer,this.params),this.serviceloadDataPlan.subscribe("loadedWithDataActivities",$.proxy(this.loadedWithDataActivities,this)),this.serviceloadDataPlan.subscribe("loadedWithDataFirstParent",$.proxy(this.loadedWithDataFirstParent,this))}},loadedWithDataActivities:function(){this.pub("notify",{type:"LOADED_ACTIVITIES_PLAN",args:this.params}),this.pub("notify",{type:"LOAD_INFO_SUMMARY_PROGRESS_PLAN",args:this.params}),this.pub("notify",{type:"LOAD_INFO_ACTIVITY_SUMMARY",args:this.params}),this.pub("notify",{type:"LOAD_INFO_ACTIVITIES_PLAN",args:this.params})},loadedWithDataFirstParent:function(){this.pub("notify",{type:"LOAD_INFO_SUMMARY_PLAN",args:this.params})},clean:function(){this.serviceloadDataPlan&&(this.serviceloadDataPlan.unsubscribe("loadedWithDataActivities",$.proxy(this.loadedWithDataActivities,this)),this.serviceloadDataPlan.unsubscribe("loadedWithDataFirstParent",$.proxy(this.loadedWithDataFirstParent,this)))}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.activity.sidebar",["workportalFacade","dataService","bizagi.workportal.services.behaviors.loadDataPlan",bizagi.workportal.widgets.project.plan.activity.sidebar],!0),bizagi.workportal.widgets.project.base.extend("bizagi.workportal.widgets.project.plan.activity.action",{},{init:function(t,e,i,s){this._super(t,e,s),this.dateFormat=bizagi.localization.getResource("dateFormat"),this.timeFormat=bizagi.localization.getResource("timeFormat"),this.estimatedFinishDateTime,this.beforeUserAssignedActivity="",this.notifier=i,this.loadTemplates({"activity-action-main":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.activity.action").concat("#project-plan-activity-action"),"activity-action-editionpopup":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.activity.action").concat("#project-plan-activity-action-editionpopup")}),this.dialogBox={}},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){this.sub("LOAD_INFO_ACTIVITY_SUMMARY",$.proxy(this.onNotifyLoadInfoActivityExecution,this)),this.sub("EXPANDED_RIGHT_SIDEBAR",$.proxy(this.onNotifyExpandedRightSidebar,this))},onNotifyLoadInfoActivityExecution:function(t,e){var i=this;i.params=$.extend(i.params,e.args);var s=i.getContent().empty(),a={};if(i.params.plan.idActivitySelected&&(a=i.params.plan.activities.filter((function(t){return t.id.toUpperCase()===i.params.plan.idActivitySelected.toUpperCase()}))[0]),i.params.plan.idUserCreator===bizagi.currentUser.idUser||a.userAssigned==bizagi.currentUser.idUser){var o={};o.currentActivityName=a.name,o.showEditAction=!0,i.params.plan.idUserCreator!==bizagi.currentUser.idUser&&(o.showEditAction=!1);var n=i.getTemplate("activity-action-main");s.append(n.render(o)),o.showEditAction&&(i.initilizeActionMenu(),i.beforeUserAssignedActivity=a.userAssigned,i.content.append(s),i.initializeTempleteAndEvents())}},initializeTempleteAndEvents:function(){this.plugins={},this.plugins.activityEdition=this.initPluginPopupEdition(),this.formEditActivity={assignee:$("#activity-form-assignee",this.plugins.activityEdition),date:$("#activity-form-date",this.plugins.activityEdition),duration:$("#activity-form-duration",this.plugins.activityEdition),buttonCancel:$("#ui-bizagi-wp-project-popupform-action-cancel",this.plugins.activityEdition),buttonUpdate:$("#ui-bizagi-wp-project-popupform-action-update",this.plugins.activityEdition)},this.formEditActivity.buttonCancel.on("click",$.proxy(this.onClickPopupButtonCancel,this)),this.formEditActivity.buttonUpdate.on("click",$.proxy(this.onClickPopupButtonUpdate,this)),this.formEditActivity.date.on("keydown",$.proxy(this.onDeleteDate,this)),this.formEditActivity.duration.on("keyup",$.proxy(this.onTypeDuration,this))},onNotifyExpandedRightSidebar:function(){this.initilizeActionMenu()},initilizeActionMenu:function(){$("#ui-bizagi-wp-project-plan-activity-action .menu",this.content).menu({select:$.proxy(this.onSelectMenu,this)}).removeClass("ui-widget-content")},initPluginPopupEdition:function(){var t=this.getTemplate("activity-action-editionpopup");return this.dialogBox.formContent=t.render({}),this.dialogBox.formContent},initializeAutoComplete:function(t){var e=this,i=e.dataService.serviceLocator.getUrl("admin-getUsersList");t.autocomplete({minLength:2,source:function(t,e){$.ajax({url:i,data:{domain:"",userName:"",fullName:t.term,organization:"",pag:1,pagSize:100,orderField:"fullName"},success:function(t){e($.map(t.users,(function(t){return{label:t.user,value:t.idUser}})))}})},select:function(i,s){var a=s.item.label;return t.val(a),e.formEditActivity.IdAssignee=s.item.value,!1},focus:function(){return!1},change:function(t,i){return null===i.item&&(e.formEditActivity.IdAssignee=null,e.formEditActivity.assignee.val("")),!1}})},initializeDatePicker:function(t){var e=this;t.datepicker({onSelect:function(){e.formEditActivity.duration.val(""),e.estimatedFinishDateTime=e.formEditActivity.date.datepicker("getDate")?e.formEditActivity.date.datepicker("getDate").getTime():void 0}}),t.datepicker("option","dateFormat",bizagi.util.dateFormatter.getDateFormatByDatePickerJqueryUI())},initializeSpiner:function(t){var e=this;function i(t,i){var s=i||$(t.target).val();bizagi.util.isNumeric(s)&&parseInt(s,10)>0?(e.formEditActivity.date.val(""),e.estimatedFinishDateTime=void 0):$(t.target).val("")}t.spinner({min:1,max:1e3,placeHolder:bizagi.localization.getResource("workportal-hours"),change:function(t){i(t)},spin:function(t,e){i(t,e.value)}})},onDeleteDate:function(t){8===t.keyCode&&($(t.target).val(""),this.fieldDurationActive(!0))},onTypeDuration:function(t){""!==$(t.target).val()?this.estimatedFinishDateTime=void 0:this.activateElement(this.form.date)},onSelectMenu:function(t,e){if(0===$(t.currentTarget).find("i").length)switch($(e.item).data("item")){case"edit":this.onClickOpenPopupEdition()}},onClickOpenPopupEdition:function(){this.initializeTempleteAndEvents(),this.dialogBox.formContent.dialog({resizable:!1,draggable:!1,height:"auto",width:"600px",modal:!0,title:bizagi.localization.getResource("workportal-project-plan-title-activity-properties"),maximize:!0,open:$.proxy(this.onOpenPopupEdition,this),close:$.proxy(this.onClosePopupEdition,this)})},onOpenPopupEdition:function(){var t=this,e=t.params.plan.activities.filter((function(e){return e.id.toUpperCase()===t.params.plan.idActivitySelected.toUpperCase()}))[0],i=e&&!bizagi.util.isEmpty(e.estimatedFinishDate)?e.estimatedFinishDate:"";isNaN(i)||(i=bizagi.util.dateFormatter.formatInvariant(new Date(i)));var s=i?bizagi.util.dateFormatter.getDateFromInvariant(i):"",a=s instanceof Date&&s.getTime()<t.getDateServer();t.initializeAutoComplete(t.formEditActivity.assignee),t.initializeDatePicker(t.formEditActivity.date),t.initializeSpiner(t.formEditActivity.duration),e.userAssigned&&t.setUserAssignedById(e.userAssigned),t.formEditActivity.date.datepicker("option","minDate",new Date(t.getDateServer())),e.estimatedFinishDate&&a&&t.formEditActivity.date.datepicker("option","minDate",s),e.estimatedFinishDate&&(s&&t.formEditActivity.date.datepicker("setDate",s),t.estimatedFinishDateTime=e.estimatedFinishDate),e.duration&&t.formEditActivity.duration.val(parseInt(e.duration,10))},onClosePopupEdition:function(){this.removePopupWidgets()},setUserAssignedById:function(t){var e=this;e.callGetDataUsers(t).then((function(t){e.formEditActivity.assignee.val(t[0].name)})),e.formEditActivity.IdAssignee=t},onClickPopupButtonCancel:function(t){t.preventDefault(),this.removePopupWidgets()},removePopupWidgets:function(){this.formEditActivity.assignee.next().find("span").html(""),this.dialogBox.formContent.remove(),$("#ui-datepicker-div").remove()},onClickPopupButtonUpdate:function(){var t=this;if(t.validateParamsOfFormEditActivity()){var e=t.params.plan.activities.filter((function(e){return e.id.toUpperCase()===t.params.plan.idActivitySelected.toUpperCase()}))[0],i=t.formEditActivity.IdAssignee||bizagi.currentUser.idUser;""!=t.formEditActivity.duration.val()&&(t.params.plan.activities.filter((function(e){return e.id.toUpperCase()===t.params.plan.idActivitySelected.toUpperCase()}))[0].estimatedFinishDate="");var s={progress:e.progress,id:e.id,startDate:e.startDate,duration:t.formEditActivity.duration.val(),userAssigned:i,allowEdition:e.allowEdition,description:e.description,name:e.name,idPlan:e.idPlan,estimatedFinishDate:t.estimatedFinishDateTime,finishDate:e.finishDate,items:e.items};$.when(t.dataService.editActivityPlan(s)).done((function(){e=$.extend(e,s),t.removePopupWidgets(),t.beforeUserAssignedActivity!==t.formEditActivity.IdAssignee?t.pub("notify",{type:"ACTIVITYPLANCOMMENTS",args:$.extend(t.params,{refreshAllWidgets:!0})}):t.pub("notify",{type:t.params.showContextByMenuDashboard,args:t.params}),t.removePopupWidgets(),t.notifier.showSucessMessage(bizagi.localization.getResource("workportal-project-plan-activity-update-message"))}))}},onClickFavorite:function(t){t.preventDefault();var e=this,i={};$(t.target).hasClass("bz-icon-star-outline")?(i={idObject:e.params.idCase,favoriteType:"CASES"},$.when(e.dataService.addFavorite(i)).done((function(i){e.params.guidFavorite=i.idFavorites,$(t.target).removeClass("bz-icon-star-outline"),$(t.target).addClass("bz-icon-star")}))):(i={idObject:e.params.guidFavorite,favoriteType:"CASES"},$.when(e.dataService.delFavorite(i)).done((function(){$(t.target).addClass("bz-icon-star-outline"),$(t.target).removeClass("bz-icon-star")})))},clean:function(){this.unsub("LOAD_INFO_ACTIVITY_SUMMARY",$.proxy(this.onNotifyLoadInfoActivityExecution,this)),this.unsub("EXPANDED_RIGHT_SIDEBAR",$.proxy(this.onNotifyExpandedRightSidebar,this))},validateParamsOfFormEditActivity:function(){var t=this.formEditActivity.assignee;if(t.val()&&""!==t.val()&&this.formEditActivity.IdAssignee)return!0;var e=bizagi.localization.getResource("workportal-general-error-field-required");return e=e.replace("{0}",bizagi.localization.getResource("workportal-project-plan-assignee").toLowerCase()),t.next().find("span").html(e),!1},callGetDataUsers:function(t){var e=$.Deferred(),i={userIds:t,width:50,height:50};return this.dataService.getUsersData(i).always((function(t){e.resolve(t)})),e.promise()}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.activity.action",["workportalFacade","dataService","notifier",bizagi.workportal.widgets.project.plan.activity.action]),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.plan.activity.time",{},{init:function(t,e,i){this._super(t,e,i),this.EXECUTING_ACTIVITY="EXECUTING",this.FINISHED_ACTIVITY="FINISHED",this.datePickerRegional=bizagi.localization.getResource("datePickerRegional"),this.loadTemplates({"plan-time-main":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.activity.time").concat("#project-plan-activity-time")})},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){this.sub("LOAD_INFO_ACTIVITY_SUMMARY",$.proxy(this.onNotifyLoadInfoActivitySummary,this))},onNotifyLoadInfoActivitySummary:function(t,e){var i=this;i.params=$.extend(i.params,e.args),i.getContent().empty();var s=i.params.plan.activities.filter((function(t){return t.id===i.params.plan.idActivitySelected}))[0];if(s.startDate){i.getStateActivity(s);var a={time:{fromDate:i.getFormattedDate(new Date(i.getFirstDate(s)))}},o=i.getDataByScenarios(s,!0);$.when(o.unitTime).done((function(t){o=$.extend(o,{unitTime:t}),i.updateWidget($.extend(a.time,o))}))}},updateWidget:function(t){var e=this.getContent().empty(),i=this.getTemplate("plan-time-main"),s=bizagi.util.dateFormatter.getRelativeTime(new Date(Date.now()-60*t.unitTime.minutes*1e3),null,!1),a=bizagi.localization.getResource("workportal-project-activity-state-"+t.keywordResource);t.messageTime=a.replace("%s",s),i.render(t).appendTo(e);var o=$(".remaining-days .time-remaining",e),n=$(".remaining-days .days",e).width();o.css("padding-left",(n+7).toString()+"px"),$(".remaining-days .bar-completed",e).css("width",t.percentBar+"%")},getStateActivity:function(t){return t.finishDate?(t.currentState=this.FINISHED_ACTIVITY,this.FINISHED_ACTIVITY):(t.currentState=this.EXECUTING_ACTIVITY,this.EXECUTING_ACTIVITY)},getFirstDate:function(t){return t.currentState===this.EXECUTING_ACTIVITY?t.startDate:t.finishDate},getDataByScenarios:function(t){var e={colorBar:null,percentBar:100,keywordResource:null,unitTime:null},i={};switch(t.currentState){case this.EXECUTING_ACTIVITY:e.keywordResource="opened",e.colorBar=this.getColorByCreatedAndEstimatedDate(t),i={idUser:bizagi.currentUser.idUser,fromDate:t.startDate,toDate:Date.now()},e.unitTime=this.callGetEffectiveDuration(i);break;case this.FINISHED_ACTIVITY:e.colorBar="Gray",e.keywordResource="closed",i={idUser:bizagi.currentUser.idUser,fromDate:t.finishDate,toDate:Date.now()},e.unitTime=this.callGetEffectiveDuration(i)}return e},getColorBar:function(t){return this.getDataByScenarios(t).colorBar},getPercentBar:function(t){return this.getDataByScenarios(t).percentBar},getKeywordResourceDescriptionBar:function(t){return this.getDataByScenarios(t).keywordResource},getUnitTime:function(t){return this.getDataByScenarios(t).unitTime},getColorByCreatedAndEstimatedDate:function(t){var e="Red";t.estimatedFinishDate&&(Date.now()<t.estimatedFinishDate&&(e=(new Date).getUTCDate()===new Date(t.estimatedFinishDate).getUTCDate()?"Yellow":"Green"));return e},getFormattedDate:function(t){return this.datePickerRegional.monthNames[t.getMonth()]+" "+bizagi.util.dateFormatter.formatDate(t,"dd hh:mm tt",bizagi.localization.getResource("datePickerRegional"))},callGetEffectiveDuration:function(t){var e=$.Deferred();return $.when(this.dataService.getEffectiveDuration(t)).done((function(t){e.resolve(t)})),e.promise()}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.activity.time",["workportalFacade","dataService",bizagi.workportal.widgets.project.plan.activity.time],!0),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.plan.activity.progress",{},{init:function(t,e,i){this._super(t,e,i),this.plugins={},this.dialogBox={},this.loadTemplates({"plan-progress-main":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.activity.progress").concat("#project-plan-activity-progress"),"plan-progress-popup-edit":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.activity.progress").concat("#project-plan-activity-edit-progress")})},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){this.sub("LOAD_INFO_ACTIVITY_SUMMARY",$.proxy(this.onNotifyLoadInfoActivityExecution,this)),this.sub("UPDATE_ITEMS_FROM_FORMRENDER",$.proxy(this.onNotifyUpdateItemFromRender,this))},onNotifyLoadInfoActivityExecution:function(t,e){var i=this;i.params=$.extend(i.params,e.args);var s=i.getContent().empty(),a=i.params.plan.activities.filter((function(t){return t.id.toUpperCase()==i.params.plan.idActivitySelected.toUpperCase()}))[0],o={valuePercentBarComplete:0};o.progress={progress:a.progress,canEdit:0===a.items.length},o.progress.progress&&(o.valuePercentBarComplete=o.progress.progress),i.getTemplate("plan-progress-main").render(o).appendTo(s),i.plugins.popupEditProgress=i.initPluginPopupEditProgress();var n=i.plugins.popupEditProgress;i.formEditProgress={sliderProgress:$("#sliderProgress",n).slider({orientation:"horizontal",range:"min",max:100,width:100,from:5,to:50,step:1,value:o.valuePercentBarComplete,slide:$.proxy(i.onChangesliderProgress,i),change:$.proxy(i.onChangesliderProgress,i)}).each((function(){for(var t=$(this).slider("option","max")-$(this).slider("option","min"),e=0;e<=t;e+=10){var i=$("<label class='step'>"+e+"</label>").css("left",e/t*100+"%");$(this).append(i)}})),numericTextBoxPlugin:$("#inputProgressNumericTextBox",n).spinner({format:"n0",min:0,max:100,spin:$.proxy(i.onChangeNumericTextBoxProgress,i),change:$.proxy(i.onChangeNumericTextBoxProgress,i),value:o.valuePercentBarComplete,decimals:0}),buttonChangeProgress:$("#button-accept-change-progress",n),buttonCancel:$("#button-cancel-change-progress",n)},$(".action-open-popup-edit-progress",s).on("click",$.proxy(i.onShowPopupEditProgress,i)),i.formEditProgress.buttonCancel.on("click",$.proxy(i.onClickCancel,i)),i.formEditProgress.buttonChangeProgress.on("click",$.proxy(i.onSubmitFormChangeProgress,i)),i.updateProgressUI(o.valuePercentBarComplete),i.formEditProgress.numericTextBoxPlugin.spinner("value",o.valuePercentBarComplete)},onNotifyUpdateItemFromRender:function(t,e){var i=e.args.items,s=e.args.activityWork;i.length>0?$(".action-open-popup-edit-progress",this.content).hide():$(".action-open-popup-edit-progress",this.content).show(),$(".bz-wp-timestamp span",this.content).text(s),$(".bz-wp-progress-bar",this.content).css("width",s+"%")},updateProgressUI:function(t){var e=this.getContent();$(".bz-wp-timestamp span",e).text(t);var i=$(".remaining-days .time-remaining",e),s=$(".remaining-days .days",e).width();i.css("padding-left",(s+7).toString()+"px"),$(".remaining-days .bar-completed",e).css("width",t.toString()+"%")},initPluginPopupEditProgress:function(){var t=this.getTemplate("plan-progress-popup-edit");return this.dialogBox.formContent=t.render(),this.dialogBox.formContent},onShowPopupEditProgress:function(){var t=this;t.dialogBox.formContent.dialog({resizable:!1,draggable:!1,height:"auto",width:"600px",modal:!0,title:bizagi.localization.getResource("workportal-project-plan-progress-title"),maximize:!0,open:$.proxy(t.onOpenPopupPlan,t),close:function(){t.dialogBox.formContent.dialog("destroy"),t.dialogBox.formContent.detach()}}),t.previusValueProgress=t.formEditProgress.sliderProgress.slider("value")},onChangeNumericTextBoxProgress:function(t){var e=this.formEditProgress.numericTextBoxPlugin.spinner("value");this.formEditProgress.sliderProgress.slider("value",e)},onChangesliderProgress:function(t){var e=this.formEditProgress.sliderProgress.slider("value");this.formEditProgress.numericTextBoxPlugin.spinner("value",e)},onClickCancel:function(t){t.preventDefault();this.dialogBox.formContent.dialog("destroy"),this.dialogBox.formContent.detach(),this.formEditProgress.sliderProgress.slider("value",this.previusValueProgress),this.formEditProgress.numericTextBoxPlugin.spinner("value",this.previusValueProgress)},onSubmitFormChangeProgress:function(t){t.preventDefault();var e=this;e.formEditProgress.buttonChangeProgress.prop("disabled",!0);var i=e.params.plan.activities.filter((function(t){return t.id==e.params.plan.idActivitySelected}))[0],s=$.extend(i,{progress:e.formEditProgress.numericTextBoxPlugin.spinner("value"),idPlan:e.params.plan.id});$.when(e.dataService.editActivityPlan(s)).done((function(){e.formEditProgress.buttonChangeProgress.prop("disabled",!1),i.progress=e.formEditProgress.numericTextBoxPlugin.spinner("value"),e.updateProgressUI(i.progress),e.dialogBox.formContent.dialog("destroy"),e.dialogBox.formContent.detach()}))}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.activity.progress",["workportalFacade","dataService",bizagi.workportal.widgets.project.plan.activity.progress],!0),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.plan.activity.subprocesses",{},{init:function(t,e,i){this._super(t,e,i),this.loadTemplates({"project-subprocesses":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.activity.subprocesses").concat("#project-plan-activity-plan-subprocesses-wrapper"),"project-subprocesses-tootip-custom-properties":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.activity.subprocesses").concat("#project-activity-plan-subprocesses-tooltip-custom-properties-wrapper")})},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.activity.subprocesses",["workportalFacade","dataService",bizagi.workportal.widgets.project.plan.activity.subprocesses]),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.plan.activity.parent",{},{init:function(t,e,i){this._super(t,e,i),this.loadTemplates({"plan-parent-main":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.activity.parent").concat("#project-plan-activity-parent")})},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){this.sub("LOAD_INFO_ACTIVITY_SUMMARY",$.proxy(this.onNotifyLoadInfoActivityExecution,this))},onNotifyLoadInfoActivityExecution:function(t,e){var i=this;i.params=$.extend(i.params,e.args);var s=i.getContent().empty();$.when(i.dataService.getPlanParent({idPlan:i.params.plan.id})).done((function(t){if(i.params.plan.parent=t,i.params.plan.parent){var e={};e.parent={idParent:i.params.plan.parent.radNumber,nameParent:i.params.plan.parent.displayName,idCase:i.params.plan.parent.idCase,idWorkflow:i.params.plan.parent.idWorkflow,idWorkItem:i.params.plan.parent.idWorkItem,idTask:i.params.plan.parent.idTask},i.getTemplate("plan-parent-main").render(e).appendTo(s),$("#go-to-parent-case",s).on("click",$.proxy(i.onClickGoToParentCase,i))}}))},onClickGoToParentCase:function(t){t.preventDefault();this.routingExecute($(t.target).closest("#go-to-parent-case"))}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.activity.parent",["workportalFacade","dataService",bizagi.workportal.widgets.project.plan.activity.parent],!0),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.plan.activity.users",{},{init:function(t,e,i){this.usersMap={},this.plugins={},this.usersInformation=[],this.globalHandlersService=bizagi.injector.get("globalHandlersService"),this.usersAssignees=[],this._super(t,e,i),this.loadTemplates({"plan-users-main":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.users").concat("#project-plan-users")})},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){this.sub("LOAD_INFO_ACTIVITY_SUMMARY",$.proxy(this.onNotifyLoadInfoActivityExecution,this))},activityRunning:function(t){return null!==t.startDate&&null===t.finishDate},onNotifyLoadInfoActivityExecution:function(t,e){var i=this,s=[],a=[],o=i.getContent().empty();i.params=$.extend(i.params,e.args);var n=i.params.plan.idUserCreator,r=i.params.plan.idUserCreator;a.push({idUser:n,guidUser:r,userType:["owner"]}),i.usersMap["-"+n+"-"]={picture:"",id:n,guid:r,name:"",userType:["owner"]},s.push(r),$.each(i.params.plan.activities,(function(t,e){if(i.activityRunning(e)){var o=e.userAssigned,r=e.userAssignedGuid;if(o===n)-1===$.inArray("Assigned",a[0].userType)&&(a[0].userType.push("Assigned"),i.usersMap["-"+n+"-"].userType.push("Assigned"));else if(i.usersMap["-"+o+"-"]={picture:"",id:o,name:"",userType:["Assigned"]},0===a.filter((function(t){return t.idUser==o})).length){var c=r||o;a.push({idUser:c,userGuid:c,userType:["Assigned"]}),s.push(c)}}})),i.activitiesUsers=a,i.getTemplate("plan-users-main").render({assignee:i.justAssignees(a),label:bizagi.localization.getResource("workportal-project-plan-assignee")}).appendTo(o),i.addEventHandlersModal(),$.when(i.callGetDataUsers(s)).then((function(){i.showCreatorInformation(n),i.renderUserProfilesAndImages()}))},justAssignees:function(t){var e=[];return t.map((function(t){var i=-1!==t.userType.indexOf("owner"),s=-1!==t.userType.indexOf("Assigned");e.push(usersAdapter.createJsonUserInfo(t.idUser,"","","","","",s,i,[],[]))})),usersAdapter.justAssignees(e)},showCreatorInformation:function(t){var e=this.usersMap["-"+t+"-"],i=usersAdapter.createJsonUserInfo(e.id,e.name,e.username,e.picture?e.picture:void 0,e.email,e.name.getInitials(),!1,!0,[],[]);this.content.find(".ui-bizagi-wp-project-plan-users .ui-bizagi-wp-project-users-creator-info").userinformation(this,{user:i})},renderUserProfilesAndImages:function(){var t=this;$.each(t.usersMap,(function(e,i){var s=$(".ui-bizagi-wp-userlist li[data-iduser="+i.id+"]",t.content);""!==i.picture?s.find("img").prop("src",i.picture):(s.find("img").hide(),void 0!==i.name?s.find("span").html(i.name.getInitials()):console.log("obj.name is undefined"))})),$(".ui-bizagi-wp-userlist li",t.content).not(".moreUsers").on("mouseenter",(function(e){var i,s=$(e.target),a=$(this).data("iduser");$.each(t.usersMap,(function(t,e){e.id===a&&(i=e)}));var o=t.usersAssignees.find((function(t){return t.userAssigned===i.id})),n=[];o&&o.activities.map((function(t){n.push(t.name)}));var r=usersAdapter.createJsonUserInfo(i.id,i.name,i.username,i.picture,i.email,i.name.getInitials(),t.getIsAssignee(i),t.getIsOwner(i),n,void 0);s.parent().usertooltip(t,{target:s,user:r})}))},getIsAssignee:function(t){return t.userType.indexOf("Assigned")>-1},getIsOwner:function(t){return t.userType.indexOf("owner")>-1},callGetDataUsers:function(t){var e,i=this,s=$.Deferred();return e={usersGuids:t.join(),width:50,height:50},$.when(i.dataService.getUsersData(e)).always((function(t){i.usersInformation=t;for(var e=0,a=t.length;e<a;e+=1)void 0===t[e].name?bizagi.log(t[e]+" Id Not Found",t,"error"):i.usersMap["-"+t[e].id+"-"]?(i.usersMap["-"+t[e].id+"-"].picture+=t[e].picture?"data:image/png;base64,"+t[e].picture:"",i.usersMap["-"+t[e].id+"-"].name=t[e].name||"",i.usersMap["-"+t[e].id+"-"].username=t[e].username||"",i.usersMap["-"+t[e].id+"-"].email=t[e].email||""):console.log("The object is undefined");i.getUsersAssignees(),s.resolve()})),s.promise()},getUsersAssignees:function(){for(var t=0;t<this.usersInformation.length;t++)this.usersAssignees.push(this.getUserAssignee(this.usersInformation[t]))},getUserAssignee:function(t){var e=this,i=[];$.each(e.params.plan.activities,(function(s,a){a.userAssigned===t.id&&e.activityRunning(a)&&i.push({name:a.name})})),t.tasks=i;var s=e.activitiesUsers.find((function(e){return e.idUser==t.id}));return t.userType=s.userType,usersAdapter.createJsonUserInfo(t.id,t.name,t.username,t.picture?"data:image/png;base64,"+t.picture:void 0,t.email,t.name.getInitials(),e.getIsAssignee(t),e.getIsOwner(t),t.tasks,[])},addEventHandlersModal:function(){var t=this;$(".moreUsers").click((function(e){e.preventDefault(),e.stopPropagation();var i=t.usersAssignees||[];t.globalHandlersService.publish("showDialogWidget",{widgetName:bizagi.workportal.widgets.widget.BIZAGI_WORKPORTAL_WIDGET_USERS_MODAL,closeVisible:!0,data:i,maximize:!0,modalParameters:{title:bizagi.localization.getResource("workportal-project-users-title")+" ("+i.length+")",width:790,height:526,refreshInbox:!1}})}))}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.activity.users",["workportalFacade","dataService",bizagi.workportal.widgets.project.plan.activity.users],!0),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.dashboard.menu",{},{onDiscussionsMenuStatusChange:function(t,e){this.updateDiscussionsIcons(e.hasDiscussionsOrComment)},updateDiscussionsIcons:function(t){this.sub("UPDATE_DISCUSSIONS_MENU_STATUS",$.proxy(this.onDiscussionsMenuStatusChange,this)),$(".bz-icon-discussion-comment").toggle(t),$(".bz-icon-discussion-no-comment").toggle(!t),this.params.hasDiscussionsOrComment=t},clean:function(){this.unsub("UPDATE_DISCUSSIONS_MENU_STATUS",$.proxy(this.onDiscussionsMenuStatusChange,this))}}),bizagi.injector.register("bizagi.workportal.widgets.project.dashboard.menu",["workportalFacade","dataService",bizagi.workportal.widgets.project.dashboard.menu],!0),bizagi.workportal.widgets.project.dashboard.menu.extend("bizagi.workportal.widgets.project.dashboard.menu.activity.plan",{},{init:function(t,e,i){this.params=i||{},this._super(t,e,i),this.loadTemplates({"project-dashboard-menu":bizagi.getTemplate("bizagi.workportal.desktop.widgets.project.dashboard.menu.activity.plan").concat("#project-dashboard-menu2")})},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){var t=this;t._super(),t.params.contextsLeftSidebarCaseDashboard.forEach((function(e){t.sub(e,$.proxy(t.updateView,t))}))},updateView:function(t,e){var i=this;i.params=$.extend(i.params,e.args),i.clean();var s=i.getContent().empty(),a={showFormOverview:i.params.menuDashboard.showFormOverview,showFormActivity:i.params.menuDashboard.showFormActivity,showCommentsOptionMenu:i.params.menuDashboard.showCommentsOptionMenu,showFilesOptionMenu:i.params.menuDashboard.showFilesOptionMenu,showTimeLineOptionMenu:i.params.menuDashboard.showTimeLineOptionMenu,showPlanOptionMenu:i.params.menuDashboard.showPlanOptionMenu,contextPlanOptionMenu:i.params.menuDashboard.contextPlanOptionMenu,contextFormActivityOptionMenu:i.params.menuDashboard.contextFormActivityOptionMenu,contextualized:i.params.plan.contextualized};i.getTemplate("project-dashboard-menu").render(a).appendTo(s),i.params.showContextByMenuDashboard&&$("li[data-context='"+t.type.toUpperCase()+"']",i.content).addClass("active").siblings().removeClass("active"),i.updateDiscussionsIcons(i.params.hasDiscussionsOrComment),i.handlerEvents();var o={idPlan:i.params.plan.id};$.when(i.callGetPlan(o)).then((function(t){$.extend(i.params.plan,t),i.pub("notify",{type:"LOAD_INFO_PLAN",args:i.params})}))},loadContentById:function(t){var e=this;t.preventDefault();var i=$(t.target).closest("li");i.hasClass("active")||$.when(bizagi.util.autoSave()).done((function(){$(document).data("auto-save","");var t=i.data("context");if(t){var s=e.pub("notify",{type:"NAVIGATOR_GETLEVEL"}),a=parseInt(s[0]);e.params.refreshLastItemBreadcrumb=!1,e.pub("notify",{type:t.toUpperCase(),args:$.extend(e.params,{showContextByMenuDashboard:t,histName:"",level:a})}),$("li[data-context='"+e.params.showContextByMenuDashboard.toUpperCase()+"']",e.content).addClass("active").siblings().removeClass("active")}}))},callGetPlan:function(t){var e=$.Deferred();return this.dataService.getPlan(t).always((function(t){200===t.status||201===t.status||void 0===t.status?e.resolve(t):e.reject()})),e.promise()},subMenuHandler:function(){var t=this.getContent(),e=$("[data-context='ACTIVITYPLANCOMMENTS']",t),i=$("[data-context='ACTIVITYPLANFILES']",t),s=$("[data-context='ACTIVITYPLANTIMELINE']",t);$(".ui-bizagi-wp-project-tab-submenu a",t).on("click",(function(){e.toggle(),i.toggle(),s.toggle()}))},handlerEvents:function(){var t=this.getContent();this.subMenuHandler(),$(".ui-bizagi-wp-project-tab-links a",t).on("click",$.proxy(this.loadContentById,this))},clean:function(){var t=this,e=t.getContent();t._super(),t.params&&t.params.contextsLeftSidebarCaseDashboard&&t.params.contextsLeftSidebarCaseDashboard.forEach((function(e){t.unsub(e,$.proxy(t.updateView,t))})),$(".ui-bizagi-wp-project-tab-links a",e).off()}}),bizagi.injector.register("bizagi.workportal.widgets.project.dashboard.menu.activity.plan",["workportalFacade","dataService",bizagi.workportal.widgets.project.dashboard.menu.activity.plan],!0),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.content.dashboard",{},{init:function(t,e,i){this._super(t,e,i),this.loadTemplates({"project-content-dashboard":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.content.dashboard").concat("#project-plan-content-dashboard")})},renderContent:function(){var t=this.getTemplate("project-content-dashboard");return this.content=t.render({}),this.content},postRender:function(){setTimeout((function(){$(window).trigger("resize")}),1e3)}}),bizagi.injector.register("bizagi.workportal.widgets.project.content.dashboard",["workportalFacade","dataService",bizagi.workportal.widgets.project.content.dashboard],!0),function(t){var e=window.kendo.ui,i=e.Widget,s=i.extend({init:function(t,e){i.fn.init.call(this,t,e),this._maxFilesSize=e.maxSize,this._fileList=[],this._onlyValidateServerFileExtension=e.onlyValidateServerFileExtension||!0,this._supportFileExt=e.extensions,this._uploadMaxFilesSize=e.maxSize,this.upload=this._initUpload(),this.loadNotifier=this._initLoadNotifier(),this.notification=this._initNotification(),this._eventsHandler(),this._initLocalization(this.options.localization)},options:{name:"ProjectAttachments",wrapper:t('<div class="project-attachments"></div>'),multiple:!0,dropZone:!0,maxFilesSize:bizagi.currentUser?bizagi.currentUser.uploadMaxFileSize:25e3,enabled:!0,localization:{}},_initUpload:function(){var t=this,e=t.options,i=e.localization||{},s=0;return t._initLocalization(i),this.element.kendoUpload({async:{saveUrl:e.saveUrl+"?xsrf="+bizagi.getXSRFToken(),autoUpload:!0},select:function(e){t._filterMaxFilesSize(e),s=0},complete:function(){var e=setInterval((function(){0===t.loadNotifier.wrapper.find("li.k-file-progress").length&&(t._showNotificationCompleteUpload(t.loadNotifier.wrapper,s),clearInterval(e))}),300)},upload:e.upload,progress:function(e){t._onProgressFile(e)},success:function(i){t._fileList.push(i.files[0]),s+=1,e.success(i)},error:function(e){t.onErrorFile(e)},localization:{select:i.selectFiles,dropFilesHere:i.dropFilesHere},multiple:e.multiple,enabled:e.enabled,dropZone:e.dropZone,showFileList:!1}).data("kendoUpload")},_initNotification:function(){return t("<div></div>").kendoNotification({position:{pinned:!0}}).data("kendoNotification")},_initLoadNotifier:function(){var t=this.options.localization;return this.options.wrapper.kendoWindow({title:t.notifierTitle,actions:["Close"],animation:{open:{duration:100},close:{duration:100}},open:function(){this.wrapper.addClass("project-attachments-wrapper-window")},visible:!1,resizable:!1,draggable:!1,maxHeight:"300px",minWidth:"430px"}).data("kendoWindow")},_initLocalization:function(e){var i={selectFiles:bizagi.localization.getResource("workportal-project-attachments-addfiles"),notifierTitle:bizagi.localization.getResource("workportal-project-attachments-notifiertitle"),errorUpload:bizagi.localization.getResource("workportal-project-attachments-file-error"),errorSecurity:bizagi.localization.getResource("workportal-project-attachments-blockedext"),errorSize:bizagi.localization.getResource("workportal-project-attachments-blockedsize"),errorMaxFilesSize:bizagi.localization.getResource("workportal-project-discussion-maxfilessize").replace("%s",this._getSize(this._maxFilesSize)),dropFilesHere:bizagi.localization.getResource("workportal-project-attachments-drophere"),cancel:bizagi.localization.getResource("workportal-widget-reports-confirm-cancel"),retry:bizagi.localization.getResource("workportal-project-attachments-retry"),close:bizagi.localization.getResource("workportal-widget-dialog-box-close")};t.extend(e,i)},_getSize:function(t){return Math.round(t/1048576,-1)},_onProgressFile:function(e){var i=this._getFileItemByUID(e.files[0].uid),s=e.percentComplete;t(".k-progress",i).css({width:s+"%"}),t(".k-upload-pct",i).removeClass("k-icon k-loading").text(s+"%"),100===s&&t(".k-upload-action .k-icon",i).hide()},_onShowUploadNotifier:function(t){var e=t.files,i=this.options.template;this.loadNotifier.content(i.render({files:e})),this.loadNotifier.wrapper.css({top:"auto",left:"auto",bottom:"1em",right:"1em"}),this.loadNotifier.open()},_showNotificationCompleteUpload:function(t,e){t.find("li.k-file-success").length===e&&0===t.find("li.k-file-error").length&&this._autoHideMessage(t)},_autoHideMessage:function(t){var e=this;setTimeout((function(){t.fadeOut((function(){e.loadNotifier.close()}))}),2e3)},_onCancelFile:function(t){var e=t.closest("li"),i=this.upload.wrapper,s=e.data("guid");i.find("li[data-uid="+s+"] .k-upload-action").trigger("click"),e.remove()},_onRemoveFile:function(t){t.closest("li").remove()},_onRetryFile:function(e){var i=e.closest("li").data("guid"),s=t.grep(this._fileList,(function(t){return t.uid===i}));this.options.retry(s[0])},onErrorFile:function(t){var e=this.options.localization,i=t.files[0],s=this._isValidFile(i),a=""!==s.message?s.message:e.errorUpload;this.setStatus("ERROR",i.uid,a)},_isValidFile:function(e){var i=this.options.localization,s=!0,a="";return(e.size>this._uploadMaxFilesSize||null==e.size||0==e.size)&&(a=i.errorSize,s=!1),this._onlyValidateServerFileExtension||-1===t.inArray(e.extension,this._supportFileExt)&&(a=i.errorSecurity,s=!1),{valid:s,message:a}},_filterMaxFilesSize:function(t){for(var e=0,i=0,s=t.files.length;i<s;i++)e+=t.files[i].size;e>this._maxFilesSize?(this._notifySizeExceeded(),t.preventDefault()):this._onShowUploadNotifier(t)},_notifySizeExceeded:function(){this.notification.show(this.options.localization.errorMaxFilesSize,"error")},_getFileItemByUID:function(e){return t("li[data-guid="+e+"]",this.loadNotifier.element)},_switchEvents:function(e){var i=t(".k-icon",e.currentTarget);i.hasClass("k-update")||i.hasClass("k-remove")?this._onRemoveFile(i):i.hasClass("k-retry")?this._onRetryFile(i):i.hasClass("k-cancel")&&this._onCancelFile(i)},_eventsHandler:function(){var t=this;t.loadNotifier.element.on("click","button.k-upload-action",(function(e){t._switchEvents(e)}))},cancelFilesUpload:function(){this.upload.wrapper.find("li .k-upload-action").trigger("click"),this.close()},close:function(){this.loadNotifier.close()},destroy:function(){this.loadNotifier.destroy(),this.upload.destroy()},setStatus:function(e,i,s){var a=this._getFileItemByUID(i),o=this.options.localization;switch(e){case"SUCCESS":a.removeClass("k-file-progress k-file-error").addClass("k-file-success"),t(".k-upload-action .k-icon",a).removeClass("k-cancel k-i-refresh k-retry").addClass("k-update").prop("title",o.close).show(),t(".k-errormsg",a).text("");break;case"ERROR":a.removeClass("k-file-progress").addClass("k-file-error"),t(".k-upload-action .k-icon",a).removeClass("k-i-refresh k-retry").addClass("k-remove").show(),t(".k-upload-status .k-upload-pct",a).removeClass("k-upload-pct k-loading").addClass("k-icon k-warning"),t(".k-errormsg",a).text(s).prop("title",s);break;case"RETRY":a.removeClass("k-file-progress").addClass("k-file-error"),t(".k-upload-status .k-upload-pct",a).removeClass("k-upload-pct k-loading").addClass("k-warning").text(""),t(".k-upload-action .k-icon",a).removeClass("k-cancel k-remove").addClass("k-i-refresh k-retry").prop("title",o.retry).show(),t(".k-errormsg",a).text(o.errorUpload).prop("title",o.errorUploadiis)}}});e.plugin(s)}(jQuery),bizagi.workportal.widgets.project.base.extend("bizagi.workportal.widgets.project.discussions",{},{init:function(t,e,i,s){this.typeResource="DiscussionGuid",this.plugins={},this.dialogBoxDiscussion={},this.attchComments={},this.attchDiscussions={remove:[],addition:[]},this.listDataDiscussion=[],this.userPictures=[],this.commentsList={},this.globalTags=[],this.tempTagsBeforeDelete=[],this.tempTagsToDelete=[],this.keySentenceAddTag=bizagi.localization.getResource("workportal-project-discussion-add-new-tag")+": ",this.notifier=i,this._super(t,e,s),this.loadTemplates({"project-discussions":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.discussions").concat("#project-discussions-wrapper"),"project-discussions-popup":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.discussions").concat("#project-discussions-popup-wrapper"),"project-discussions-list":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.discussions").concat("#project-discussions-list-wrapper"),"project-discussions-comments":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.discussions").concat("#project-discussions-comments-list"),"project-discussions-attachments":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.discussions").concat("#project-discussions-attachments-list"),"project-attachments":bizagi.getTemplate("bizagi.workportal.desktop.widgets.project.attachments").concat("#project-attachments")})},renderContent:function(){var t=this.getTemplate("project-discussions");return this.content=t.render({}),this.content},postRender:function(){var t=this.getContent();this.plugins.popupDiscussion=this.initPluginPopupDiscussion();var e=this.plugins.popupDiscussion;this.form={buttonShowFormNewDiscussion:$(".ui-bizagi-wp-action-new",t),title:$(".ui-bizagi-wp-project-popupform-h4",e),subject:$("#ui-bizagi-wp-project-discussions-popup-subject-input",e),description:$("#ui-bizagi-wp-project-discussions-popup-description-textarea",e),buttonShowPopupDiscussionToAdd:$("#ui-bizagi-wp-project-discussions-button-action-show-popup-to-add",t),buttonAddDiscussion:$("#ui-bizagi-wp-project-discussions-popup-action-add-discussion",e),buttonCancel:$("#ui-bizagi-wp-project-popupform-action-cancel",e),formDiscussion:$(".ui-bizagi-wp-project-discussions-popup",e),attachments:$(".ui-bizagi-wp-project-discussions-attachments-cmnwrapper",e),edition:!1},this.plugins.tagsFilter=this.initPluginTagsFilter(),this.plugins.tagsMultiSelect=this.initPluginTagsMultiSelect(e),this.getDiscussions(),this.eventsHandler(),this.restrictedEventsHandler()},getDiscussions:function(){var t=this;t.getDataDiscussions().done((function(){var e=$.map(t.listDataDiscussion,(function(t){return t.user})),i=$.map(t.commentsList,(function(t){return $.map(t.comments,(function(t){return t.user}))}));var s=function(t){for(var e={},i=[],s=t.length,a=0,o=0;o<s;o++){var n=t[o];1!==e[n]&&(e[n]=1,i[a++]=n)}return i}(e.concat(i).concat(bizagi.currentUser.idUser)).join(",");t.getDataUsers(s).then((function(){t.renderUserProfilesAndImages()})),t.setClassesTagsByDiscussion()}))},onNotifyOpenPopup:function(){this.form.edition=!1,this.showFormAddDiscussion("workportal-project-discussion-adddiscussion"),this.renderUserProfile()},initPluginPopupDiscussion:function(){var t=this.getTemplate("project-discussions-popup");return this.dialogBoxDiscussion.formContent=t.render({attachments:[]}),this.dialogBoxDiscussion.formContent},initPluginTagsMultiSelect:function(t){var e,i=this,s=t.find("#ui-bizagi-wp-project-discussions-options-multiselect-tags"),a=!1,o=!1;return s.kendoMultiSelect({change:function(){var t=this.value().slice(0),e=this.dataSource.data();t.length>0&&-1!==e[0].tag.replace(i.keySentenceAddTag,"").indexOf(t[t.length-1])&&(t[t.length-1]=e[0].tag.replace(i.keySentenceAddTag,"")),t=(t=t.filter(Boolean)).filter((function(t,e,i){return i.indexOf(t)===e}));var s="";if(e.length>0&&-1!==e[0].tag.indexOf(i.keySentenceAddTag)){s=e[0].tag.replace(i.keySentenceAddTag,"");var n={};-1!==t.indexOf(s)?(n=this.dataSource.at(0),a=!0,this.dataSource.remove(n),a=!1,this.refresh(),o=!0):s&&($("li:first",this.list).hasClass("k-state-focused")&&(o=!0,t.push(s)),n=this.dataSource.at(0),a=!0,this.dataSource.remove(n),a=!1)}s&&(o&&(0===this.dataSource.data().filter((function(t){return t.tag===s})).length&&this.dataSource.add({guid:s,tag:s}),o=!1));this.dataSource.filter({}),this.value(t)},dataBound:function(){if((e||this._prev)&&e!==this._prev&&!a){e=this._prev;var t=this.dataSource.data(),s=!1;t.length>0&&-1!==t[0].tag.indexOf(i.keySentenceAddTag)&&(t[0].tag=i.keySentenceAddTag+e,this.refresh(),s=!0,$("li",this.list).removeClass("k-state-focused"),$("li:first",this.list).addClass("k-state-focused")),s||this.dataSource.insert(0,i.createEmptyTag(i.keySentenceAddTag,e)),0==this.dataSource.total()&&(this.search(),this.open(),this.refresh(),$("li",this.list).removeClass("k-state-focused"),$("li:first",this.list).addClass("k-state-focused"))}},dataSource:[],dataTextField:"tag",dataValueField:"guid",filter:"contains",animation:!1}).data("kendoMultiSelect")},createEmptyTag:function(t,e){return{tag:t+e,guid:""}},initPluginTagsFilter:function(){var t=this,e=t.getContent();return $("#ui-bizagi-wp-project-discussions-options-tags-filter",e).kendoMultiSelect({change:function(){t.hideOrShowDiscussionsByFilter()},autoClose:!1,tagMode:"single",dataTextField:"tag",dataValueField:"guid"}).data("kendoMultiSelect")},hideOrShowDiscussionsByFilter:function(){var t=this,e=t.plugins.tagsFilter.value();e.length>0?($(".ui-bizagi-wp-project-discussions-item",t.getContent()).hide(),e.forEach((function(e){$(".ui-bizagi-wp-project-discussions-item."+e,t.getContent()).show()}))):$(".ui-bizagi-wp-project-discussions-item",t.getContent()).show()},validateAddCommentForm:function(t){var e=!1,i=$("textarea",t);if(""===i.val().trim()){var s=bizagi.localization.getResource("workportal-project-discussion-requiredcomment");i.parent().next().find("span").html(s)}else i.parent().next().find("span").empty(),e=!0;return e},validateAddDiscussionForm:function(t){var e=!1,i=$("#ui-bizagi-wp-project-discussions-popup-subject-input",t),s=$("#ui-bizagi-wp-project-discussions-popup-description-textarea",t);if(""!==i.val().trim()&&""!==s.val().trim()&&(e=!0),""===i.val().trim()){var a=bizagi.localization.getResource("workportal-project-discussion-subjectrequired");i.parent().find("span").html(a)}else i.parent().find("span").empty();if(""===s.val().trim()){var o=bizagi.localization.getResource("workportal-project-discussion-requireddescription");s.parent().next().find("span").html(o)}else s.parent().next().find("span").empty();return e},applyFileAttachments:function(t){var e=this,i="DISCUSSIONS"===t?e.plugins.popupDiscussion:e.getContent();return $(".ui-bizagi-wp-project-discussions-attachment-upload",i).kendoProjectAttachments({saveUrl:e.dataService.serviceLocator.getUrl("project-comments-uploadfiles"),template:e.getTemplate("project-attachments"),success:function(i){e.onSuccessFile(i,t)},upload:$.proxy(e.addFileData,e),dropZone:!1,extensions:e.supportFileExt,maxSize:e.uploadMaxFilesSize}).data("kendoProjectAttachments")},addFileData:function(t){var e=t.files[0].uid;t.files[0].guid=e,t.data={guid:e}},getDataDiscussions:function(){var t=this,e=$.Deferred(),i={globalParent:t.radNumber,typeResource:t.typeResource};return"FLOW-DECONTEXTUALIZED-PLANS"===t.params.flowContext&&(i.globalParent=t.params.plan.id),t.dataService.getDiscussionsData(i).pipe((function(e){return t.callForListComments(e)})).done((function(i){t.listDataDiscussion=t.sortDiscussions(i),t.updateTemplateListDiscussion(),e.resolve()})),e.promise()},getDataUsers:function(t){var e=this,i=$.Deferred(),s={usersGuids:t,width:50,height:50};return s.usersGuids?e.dataService.getUsersData(s).always((function(t){e.userPictures=function(t){for(var e=t.concat(),i=0;i<e.length;++i)for(var s=i+1;s<e.length;++s)e[i]===e[s]&&e.splice(s--,1);return e}(e.userPictures.concat(t)),i.resolve()})):i.resolve(),i.promise()},callForListComments:function(t){for(var e=this,i=$.Deferred(),s=[],a=0,o=t.length-1;a<=o;a++){e.addGlobalTags(t[a].tags,!1);var n={idParent:t[a].guid,dateTime:e.getDateServer(),count:6};e.commentsList[n.idParent]={comments:[],count:0,total:0};var r=$.when(e.dataService.getCommentsData(n)).done((function(t){t.length>0&&(e.commentsList[t[0].parent]={comments:t,count:t.length,total:0})}));s.push(r)}return $.when.apply($,s).done((function(){i.resolve(t)})),i.promise()},sortDiscussions:function(t){var e=[];if(t.length&&(e=t.sort((function(t,e){var i=t.date;return e.date-i}))).length>0){for(var i=-1,s=0;s<e.length;s++)if("workportal-project-discussion-generaldiscussion"===e[s].name){i=s;break}i>0&&function(t,e,i){if(i>=t.length)for(var s=i-t.length+1;s--;)t.push(void 0);t.splice(i,0,t.splice(e,1)[0])}(e,i,0)}return e},resetDiscussionAttachments:function(){var t=this.plugins.popupDiscussion;$(".ui-bizagi-wp-project-attachments-list",t).empty(),this.plugins.tagsMultiSelect.value([]),this.attchDiscussions.addition=[],this.attchDiscussions.remove=[],this.getDiscussions()},sendDataUpdateDiscussion:function(t){var e=this,i=e.prepareFilesToSave();e.form.buttonAddDiscussion.prop("disabled",!0);var s=e.getTagsDiscussionBySave(),a=e.getGuidsTagsDiscussionToDelete(),o={content:{name:e.form.subject.val(),description:e.form.description.val(),globalParent:e.radNumber.toString(),user:bizagi.currentUser.idUser,attachments:i.attachments,guid:t,tags:s,typeResource:"DiscussionGuid",general:!1,date:e.getDateServer()},attachmentsToCreate:i.attachmentsToCreate,attachmentsToDelete:i.attachmentsToDelete};e.plugins.attchDiscussions.close(),e.dataService.editDiscussion(o).always((function(i){if(200===i.status||201===i.status||void 0===i.status){e.addGlobalTags(s,!0);var n=e.getDiscussionDataByGUID(t);n.name=o.content.name,n.description=o.content.description,n.attachments=o.content.attachments,n.tags=o.content.tags,e.onClosePopupDiscussion(),e.resetDiscussionAttachments(),e.updateTemplateListDiscussion(),e.removeGlobalTags(a),e.notifier.showSucessMessage(printf(bizagi.localization.getResource("workportal-project-discussion-edited"),""))}else e.form.buttonAddDiscussion.prop("disabled",!1),e.onClosePopupDiscussion(),e.notifier.showErrorMessage(printf(bizagi.localization.getResource("workportal-project-discussion-error-edition"),""));e.renderUserProfilesAndImages(),e.setClassesTagsByDiscussion(),e.hideOrShowDiscussionsByFilter()}))},validateStringIsGuid:function(t){return/^({|()?[0-9a-fA-F]{8}-([0-9a-fA-F]{4}-){3}[0-9a-fA-F]{12}(}|))?$/.test(t)&&!/^({|()?0{8}-(0{4}-){3}0{12}(}|))?$/.test(t)},sendDataInsertDiscussion:function(t){var e=this,i=e.prepareFilesToSave();e.form.buttonAddDiscussion.prop("disabled",!0);var s=e.getTagsDiscussionBySave(),a={content:{name:e.form.subject.val(),description:e.form.description.val(),globalParent:e.radNumber.toString(),user:bizagi.currentUser.idUser,attachments:i.attachments,guid:t,tags:s,typeResource:"DiscussionGuid",general:!1,date:e.getDateServer()},attachmentsToCreate:i.attachmentsToCreate,attachmentsToDelete:i.attachmentsToDelete};e.plugins.attchDiscussions.close(),e.dataService.postDiscussion(a).always((function(t){if(200===t.status||201===t.status||void 0===t.status){e.addGlobalTags(s,!0),e.form.buttonAddDiscussion.prop("disabled",!1);var i={name:a.content.name,description:a.content.description,date:a.content.date,user:a.content.user,attachments:a.content.attachments,radNumber:a.content.globalParent,general:a.content.general,guid:a.content.guid,tags:a.content.tags,typeResource:a.content.typeResource};e.commentsList[a.content.guid]={comments:[],count:0,total:0},0===e.listDataDiscussion.length?e.listDataDiscussion.push(i):e.listDataDiscussion.splice(1,0,i),e.resetDiscussionAttachments(),e.onClosePopupDiscussion(),e.notifier.showSucessMessage(printf(bizagi.localization.getResource("workportal-project-discussion-created"),"")),e.updateTemplateListDiscussion(),e.updateDiscussionsMenu(!0)}else e.form.buttonAddDiscussion.prop("disabled",!1),e.onClosePopupDiscussion(),e.notifier.showErrorMessage(printf(bizagi.localization.getResource("workportal-project-discussion-error-creation"),""));e.renderUserProfilesAndImages(),e.setClassesTagsByDiscussion(),e.hideOrShowDiscussionsByFilter()}))},updateDiscussionsMenu:function(t){this.pub("notify",{type:"UPDATE_DISCUSSIONS_MENU_STATUS",hasDiscussionsOrComment:t})},getTagsDiscussionBySave:function(){var t=this,e=t.plugins.tagsMultiSelect.value(),i=t.plugins.tagsMultiSelect.dataSource.data(),s=[];return e.forEach((function(e){var a,o=t.validateStringIsGuid(e);1===(a=o?i.filter((function(t){return t.guid===e})):i.filter((function(i){var s=t.validateStringIsGuid(i.guid);return i.tag===e&&!s}))).length&&s.push({guid:o?a[0].guid:a[0].uid,tag:a[0].tag})})),s},differenceArrays:function(t,e){return t.filter((function(t){return e.indexOf(t)<0}))},getGuidsTagsDiscussionToDelete:function(){var t=this.plugins.tagsMultiSelect.value();return this.differenceArrays(this.tempTagsBeforeDelete,t)},setStateUIShowMoreComments:function(t,e){var i=t.siblings(".ui-bizagi-wp-project-discussion-showmore-comments"),s=i.find(".ui-bizagi-wp-project-discussion-showmore-comments-button"),a=i.find(".ui-bizagi-wp-project-discussion-showmore-no-more-comments"),o=i.find(".ui-bizagi-wp-project-discussion-showmore-loading-comments");"ALLOW_MORE_COMMENTS"===e&&(s.show(),a.hide(),o.hide()),"LOADING_MORE_COMMENTS"===e&&(s.hide(),a.hide(),o.show()),"NO_MORE_COMMENTS"===e&&(s.hide(),a.show(),o.hide())},getCurrentUserInfo:function(){return{name:bizagi.currentUser.userName,id:bizagi.currentUser.idUser,picture:""}},addGlobalTags:function(t,e){for(var i=0;i<t.length;i+=1){0===this.globalTags.filter((function(e){return e.tag===t[i].tag})).length&&(t[i].globalParent=this.radNumber,this.globalTags.push(t[i]),e&&this.dataService.postTag(t[i]))}this.plugins.tagsFilter.dataSource.data(this.globalTags),this.plugins.tagsMultiSelect.dataSource.data(this.globalTags)},removeGlobalTags:function(t){var e=this,i=$.map(e.listDataDiscussion,(function(t){return $.map(t.tags,(function(t){return t.guid}))})).concat(t),s=[];t.forEach((function(t){1===i.filter((function(e){return e===t})).length&&s.push(t)})),s.forEach((function(t){var i={idTag:t};e.dataService.deleteTag(i);for(var s=e.globalTags.length-1;s>=0;s-=1)e.globalTags[s].guid===t&&e.globalTags.splice(s,1)})),e.plugins.tagsFilter.dataSource.data(e.globalTags),e.plugins.tagsMultiSelect.dataSource.data(e.globalTags)},setClassesTagsByDiscussion:function(){for(var t=0;t<this.listDataDiscussion.length;t+=1){var e=$.map(this.listDataDiscussion[t].tags,(function(t){return t.guid})).join(" ");$(".ui-bizagi-wp-project-discussions-item[data-guid='"+this.listDataDiscussion[t].guid+"']",this.getContent()).addClass(e)}},updateTemplateListDiscussion:function(){for(var t=this,e=t.getContent(),i=t.getTemplate("project-discussions-list"),s=t.getCurrentUserInfo(),a=i.render({listDataDiscussions:t.listDataDiscussion,user:s,isOpen:!bizagi.util.parseBoolean(t.params.isClosedForAllUsers),returnServedCommentByParentId:function(e){return t.returnServedCommentByParentId(e)}}),o=0;o<this.listDataDiscussion.length;o++)this.mapTempComments($("#ui-bizagi-wp-project-discussions-list-wrapper",e).find(".ui-bizagi-wp-project-discussions-container-description-and-comments[data-guid="+this.listDataDiscussion[o].guid+"]"),a.find(".ui-bizagi-wp-project-discussions-container-description-and-comments[data-guid="+this.listDataDiscussion[o].guid+"]"));$("#ui-bizagi-wp-project-discussions-list-wrapper",e).empty().append(a),t.plugins.attchComments=t.applyFileAttachments("COMMENTS")},showFormAddDiscussion:function(t){var e=this;e.plugins.attchComments&&e.plugins.attchComments.close(),e.dialogBoxDiscussion.formContent.dialog({resizable:!1,draggable:!1,height:"auto",width:"650px",modal:!0,zIndex:1,title:bizagi.localization.getResource(t),maximize:!0,open:$.proxy(e.onOpenPopupDiscussion,e),close:function(){e.resetDiscussionAttachments(),e.onClosePopupDiscussion()}})},resetFormDiscussion:function(){this.form.buttonAddDiscussion.prop("disabled",!1),this.form.subject.val(""),this.form.description.val("");var t=$("#ui-bizagi-wp-project-discussions-popup-subject-input",this.dialogBoxDiscussion.formContent),e=$("#ui-bizagi-wp-project-discussions-popup-description-textarea",this.dialogBoxDiscussion.formContent);t.parent().find("span").empty(),e.parent().next().find("span").empty()},renderUserProfile:function(){var t=$.grep(this.userPictures,(function(t){return t.id===bizagi.currentUser.idUser}))[0],e=$(".ui-bizagi-wp-project-popupform-user"),i=e.find(".bz-wp-avatar-img"),s=e.find(".bz-wp-avatar-label");t&&(t.picture?i.attr("src","data:image/png;base64,"+t.picture):(i.hide(),s.html(t.name.getInitials()).show()))},renderUserProfilesAndImages:function(){var t=$.grep(this.userPictures,(function(t){return t.id===bizagi.currentUser.idUser}))[0];t&&($(".ui-bizagi-wp-project-discussions-create-comment .bz-wp-discussion-username").html(t.name),t.picture?($(".ui-bizagi-wp-project-discussions-item-user img").attr("src","data:image/png;base64,"+t.picture),$(".ui-bizagi-wp-project-popupform-image-current-user").attr("src","data:image/png;base64,"+t.picture)):($(".ui-bizagi-wp-project-discussions-item-user label.bz-wp-avatar-label").html(t.name.getInitials()).show(),$(".ui-bizagi-wp-project-discussions-item-user img").hide()));for(var e=0;e<this.userPictures.length;e++)$("div[data-iduser='"+this.userPictures[e].id+"'] .bz-wp-discussion-username").html(this.userPictures[e].name),this.userPictures[e].picture?$("div[data-iduser='"+this.userPictures[e].id+"'] .bz-wp-avatar-img").attr("src","data:image/png;base64,"+this.userPictures[e].picture):($("div[data-iduser='"+this.userPictures[e].id+"'] .bz-wp-avatar-img").hide(),$("div[data-iduser='"+this.userPictures[e].id+"'] label.bz-wp-avatar-label").html(this.userPictures[e].name.getInitials()))},switchCommentsEvents:function(t){var e=this,i=$(t.target),s=i.parent();if(i.is("textarea"))e.onShowButtonsPanel(i);else if(i.hasClass("ui-bizagi-wp-project-discussions-comment-buttons-cancel"))e.onCancelComment(i);else if(i.hasClass("ui-bizagi-wp-project-discussions-comment-buttons-share")){var a=i.closest(".ui-bizagi-wp-project-discussions-add-comment");if(e.validateAddCommentForm(a)){var o=Math.guid();e.onCreateComment(i,o)}}else i.hasClass("ui-bizagi-wp-project-discussions-comment-view")?e.onViewComment(i):i.hasClass("ui-bizagi-wp-project-discussion-showmore-comments-button")?e.onViewMoreComments(i):i.hasClass("bz-bizagi-wp-project-discussions-attachment-delete")?e.onRemoveFiles(i):s.hasClass("biz-wp-user-icon-admin")&&s.hasClass("biz-wp-action-edit-discussion")?e.onEditDiscussion(i):s.hasClass("ui-bizagi-wp-project-discussion-delete")?$.when(bizagi.showConfirmationBox(bizagi.localization.getResource("workportal-project-discussion-querydelete"),"","info")).done((function(){e.onDeleteComment(s)})):s.hasClass("bz-bizagi-wp-project-discussions-attachment-itemwrapper")&&e.onDownloadAttachment(i.closest("li"));t.stopPropagation()},onEditDiscussion:function(t){var e=t.closest(".ui-bizagi-wp-project-discussions-item").data("guid");this.setDiscussionsDataByGUID(e),this.showFormAddDiscussion("workportal-project-discussion-edit")},setDiscussionsDataByGUID:function(t){var e=this.getDiscussionDataByGUID(t),i=$(".ui-bizagi-wp-project-attachments-list",this.form.attachments);this.form.edition={guid:t},this.attchDiscussions={addition:e.attachments,remove:[]},this.form.title.text(bizagi.localization.getResource("workportal-project-discussion-edit")),this.form.subject.val(e.name),this.form.description.val(e.description);var s=$.map(e.tags,(function(t){return t.guid}));this.plugins.tagsMultiSelect.value(s),this.tempTagsBeforeDelete=[],this.tempTagsBeforeDelete=this.tempTagsBeforeDelete.concat(this.plugins.tagsMultiSelect.value()),this.renderAttachments(e.attachments,"DISCUSSIONS",i)},getDiscussionDataByGUID:function(t){for(var e,i=this.listDataDiscussion.length-1;i>=0;i--)this.listDataDiscussion[i].guid===t&&(e=this.listDataDiscussion[i],i=0);return e},onViewComment:function(t){var e=t.closest(".ui-bizagi-wp-project-discussions-comment-truncatewrapper");e.toggleClass("ui-bizagi-wp-project-discussions-comment-shortcomment"),e.toggleClass("ui-bizagi-wp-project-discussions-comment-longcomment")},onViewMoreComments:function(t){var e=this,i=t.closest(".ui-bizagi-wp-project-discussion-showmore-comments").siblings(".ui-bizagi-wp-project-discussion-comment-list"),s=i.closest(".ui-bizagi-wp-project-discussions-container-description-and-comments").data("guid");e.commentsList[s].total?e.getMoreComments(s,i):e.dataService.getCommentsCountByParent(s).done((function(t){e.commentsList[s].total=t.count,e.getMoreComments(s,i)}))},getMoreComments:function(t,e){var i,s=this;s.commentsList[t].total>s.commentsList[t].comments.length?(s.setStateUIShowMoreComments(e,"LOADING_MORE_COMMENTS"),i=0===s.commentsList[t].comments.length?s.getDateServer():s.commentsList[t].comments[s.commentsList[t].comments.length-1].date,i-=1,s.dataService.getCommentsData({dateTime:i,idParent:t,count:6}).done((function(i){if(i.length){Array.prototype.push.apply(s.commentsList[t].comments,i),s.commentsList[t].count+=i.length,s.renderCommentByDiscussion(e,t,i),s.renderUserProfilesAndImages(),i.length>5?s.setStateUIShowMoreComments(e,"ALLOW_MORE_COMMENTS"):s.setStateUIShowMoreComments(e,"NO_MORE_COMMENTS");var a=$.map(s.userPictures,(function(t){return t.id})),o=$.map(s.commentsList,(function(t){return $.map(t.comments,(function(t){return t.user}))})),n=$(o).not(a).get().join(",");s.getDataUsers(n).then((function(){s.renderUserProfilesAndImages()}))}else s.setStateUIShowMoreComments(e,"NO_MORE_COMMENTS")})).fail((function(){s.setStateUIShowMoreComments(e,"ALLOW_MORE_COMMENTS")}))):s.setStateUIShowMoreComments(e,"NO_MORE_COMMENTS")},renderCommentByDiscussion:function(t,e,i){var s,a=this.getTemplate("project-discussions-comments"),o={comments:[],user:this.getCurrentUserInfo(),isOpen:!bizagi.util.parseBoolean(this.params.isClosedForAllUsers)};i.length?(o.comments=i,s=a.render(o),t.append(s)):(o.comments=this.commentsList[e].comments,s=a.render(o),t.html(s))},getCommentByGuid:function(t,e){for(var i=this.commentsList[t].comments,s=0,a=i.length;s<a;s++)if(i[s].guid===e){for(var o=[],n=0,r=i[s].attachments.length;n<r;n++)o.push(i[s].attachments[n].guid);return{attachments:o,index:s}}return{}},returnServedCommentByParentId:function(t){if(void 0!==this.commentsList[t])return this.commentsList[t]},onShowButtonsPanel:function(t){t.closest(".ui-bizagi-wp-project-discussions-add-comment").find(".ui-bizagi-wp-project-discussions-comment-buttons-wrapper").show()},onRemoveFiles:function(t){var e,i,s,a=t.closest("li"),o=a.closest(".ui-bizagi-wp-project-attachments-list").data("type"),n=a.data("fileguid");if("COMMENT"===o){var r=a.closest(".ui-bizagi-wp-project-discussions-add-comment").data("guid");e=this.attchComments[r].addition,i=this.attchComments[r].remove}else e=this.attchDiscussions.addition,i=this.attchDiscussions.remove;for(var c=0,p=e.length-1;c<=p;c++)e[c].guid===n&&(s=e.splice(c,1),i.push(s[0].guid),c=p);a.remove()},onDeleteComment:function(t){var e=this,i=t.closest(".ui-bizagi-wp-project-discussions-item-comment"),s=i.data("cmmtguid"),a=i.closest(".ui-bizagi-wp-project-discussions-container-description-and-comments").data("guid"),o=e.getCommentByGuid(a,s),n={content:{guid:s},attachmentsToDelete:o.attachments};$.when(e.dataService.deleteComment(n)).always((function(t){if(200===t.status||void 0===t.status){e.commentsList[a].comments.splice(o.index,1),i.remove();var s=e.hasDiscussionsOrComment(e.commentsList);e.updateDiscussionsMenu(s)}else e.notifier.showErrorMessage(printf(bizagi.localization.getResource("workportal-project-discussion-errordelete"),""))}))},hasDiscussionsOrComment:function(t){for(var e=Object.keys(t),i=e.length>1,s=!1,a=0;a<e.length;a++)if(t[e[a]].comments.length>0){s=!0;break}return i||s},onSuccessFile:function(t,e){var i=t.files;if((t.XMLHttpRequest.response?JSON.parse(t.XMLHttpRequest.response):{}).error)"DISCUSSIONS"===e?this.plugins.attchDiscussions.onErrorFile(t):this.plugins.attchComments.onErrorFile(t);else{var s=$(t.sender.element).closest(".ui-bizagi-wp-project-discussion-textwrapper"),a=s.find(".ui-bizagi-wp-project-attachments-list");if("DISCUSSIONS"===e)this.plugins.attchDiscussions.setStatus("SUCCESS",i[0].guid),Array.prototype.push.apply(this.attchDiscussions.addition,i);else{this.plugins.attchComments.setStatus("SUCCESS",i[0].guid);var o=s.data("guid");this.attchComments[o]?Array.prototype.push.apply(this.attchComments[o].addition,i):this.attchComments[o]={addition:i,remove:[]},this.onShowButtonsPanel(a.parent())}this.renderAttachments(i,e,a)}},onDownloadAttachment:function(t){var e=t.data("fileguid");if(""!==e){var i=t.find(".bz-bizagi-wp-project-discussions-attachment-filename").text();this.dataService.getDownloadAttachment(e,i)}},onCancelComment:function(t){var e=t.closest(".ui-bizagi-wp-project-discussions-add-comment"),i=e.find(".ui-bizagi-wp-project-discussions-comment-buttons-wrapper"),s=e.find("textarea"),a=e.find(".ui-bizagi-wp-project-discussions-add-attachments form"),o=e.find(".k-tooltip-validation"),n=e.find(".ui-bizagi-wp-project-attachments-list"),r=e.data("guid");this.attchComments[r]={addition:[],remove:[]},this.plugins.attchComments.cancelFilesUpload(),a[0].reset(),n.empty(),s.val(""),o.hide(),i.hide()},onCreateComment:function(t,e){var i=this,s=t.closest(".ui-bizagi-wp-project-discussions-item-comment"),a=t.closest(".ui-bizagi-wp-project-discussions-comment-buttons-wrapper"),o=t.closest(".ui-bizagi-wp-project-discussions-add-comment"),n=o.find("textarea"),r=o.find(".ui-bizagi-wp-project-attachments-list"),c=o.data("guid"),p=i.prepareFilesToSave("COMMENTS",c),u={content:{guid:e,attachments:p.attachments,text:n.val(),parent:c,date:i.getDateServer(),user:bizagi.currentUser.idUser},attachmentsToCreate:p.attachmentsToCreate,attachmentsToDelete:p.attachmentsToDelete};$.when(i.dataService.postComment(u)).always((function(t){if(200===t.status||201===t.status||void 0===t.status){var e=s.siblings(".ui-bizagi-wp-project-discussion-comment-list"),o={user:u.content.user,attachments:u.content.attachments,text:u.content.text,guid:u.content.guid,parent:u.content.parent,date:u.content.date};i.attchComments[u.content.parent]={addition:[],remove:[]},n.val(""),r.empty(),a.hide(),i.commentsList[o.parent].comments.unshift(o),i.renderCommentByDiscussion(e,o.parent,[]),i.plugins.attchComments.close(),i.renderUserProfilesAndImages(),i.updateDiscussionsMenu(!0)}}))},renderAttachments:function(t,e,i){var s=this.getTemplate("project-discussions-attachments").render({attachments:t,type:e});i.append(s),bizagi.util.isIE()&&$(".ui-bizagi-wp-project-attachments-list li").hide(10,(function(){$(this).show()}))},prepareFilesToSave:function(t,e){for(var i=[],s="COMMENTS"===t?this.attchComments[e]:this.attchDiscussions,a=[],o=0,n=(s=s||{addition:[],remove:[]}).addition.length-1;o<=n;o++)i.push({guid:s.addition[o].guid,name:s.addition[o].name}),a.push(s.addition[o].guid);return{attachments:i,attachmentsToCreate:a,attachmentsToDelete:s.remove}},onClickCancel:function(t){t.preventDefault();this.resetDiscussionAttachments(),this.onClosePopupDiscussion(),this.plugins.attchDiscussions.cancelFilesUpload()},onClosePopupDiscussion:function(){this.resetFormDiscussion(),this.plugins.attchDiscussions.destroy(),this.dialogBoxDiscussion.formContent.dialog("destroy"),this.dialogBoxDiscussion.formContent.detach()},onOpenPopupDiscussion:function(){var t=this;t.plugins.attchDiscussions=t.applyFileAttachments("DISCUSSIONS"),t.dialogBoxDiscussion.formContent.parent().css("z-index",10001),t.dialogBoxDiscussion.formContent.parent().parent().find(".ui-widget-overlay").css("z-index",10001),setTimeout((function(){t.form.subject.focus()}),50)},onSubmitFormDiscussion:function(t){t.preventDefault();var e;this.validateAddDiscussionForm(this.dialogBoxDiscussion.formContent)&&(this.form.edition.guid?(e=this.form.edition.guid,$.proxy(this.sendDataUpdateDiscussion(e),this)):(e=Math.guid(),$.proxy(this.sendDataInsertDiscussion(e),this)))},restrictedEventsHandler:function(){var t=this.getContent();$("#ui-bizagi-wp-project-discussions-list-wrapper",t).on("click",".bz-bizagi-wp-project-discussions-attachment-itemwrapper",$.proxy(this.switchCommentsEvents,this))},eventsHandler:function(){var t=this,e=t.getContent();t.form.buttonShowFormNewDiscussion.on("click",$.proxy(t.onNotifyOpenPopup,t)),t.form.buttonCancel.on("click",$.proxy(t.onClickCancel,t)),t.form.buttonAddDiscussion.on("click",$.proxy(t.onSubmitFormDiscussion,t)),t.form.attachments.on("click",".bz-bizagi-wp-project-discussions-attachment-delete, .bz-bizagi-wp-project-discussions-attachment-itemwrapper",(function(e){$(e.target).hasClass("bz-bizagi-wp-project-discussions-attachment-delete")?t.onRemoveFiles($(e.target)):t.onDownloadAttachment($(e.target).closest("li")),e.stopPropagation()})),$("#ui-bizagi-wp-project-discussions-list-wrapper",e).on("click",".ui-bizagi-wp-project-discussions-add-comment textarea, .ui-bizagi-wp-project-discussions-comment-buttons-cancel, .ui-bizagi-wp-project-discussions-comment-buttons-share, .ui-bizagi-wp-project-discussion-showmore-comments button, .bz-bizagi-wp-project-discussions-attachment-delete, .ui-bizagi-wp-project-discussion-delete, .bz-bizagi-wp-project-discussions-attachment-itemwrapper, .ui-bizagi-wp-project-discussions-comment-view, .ui-bizagi-wp-project-discussions-items-edition, .biz-wp-action-edit-discussion",$.proxy(t.switchCommentsEvents,t)),t.sub("changeProjectWidget",(function(){t.resetWidget()})),t.sub("OPEN_POPUP_DISCUSSION",$.proxy(t.onNotifyOpenPopup,t))},resetWidget:function(){this.userPictures=[],this.plugins.attchComments&&this.plugins.attchComments.close()},clean:function(){for(var t in this.resetWidget(),this.form&&this.form.buttonShowFormNewDiscussion&&this.form.buttonShowFormNewDiscussion.off("click",$.proxy(this.onNotifyOpenPopup,this)),this.plugins)this.plugins[t]&&this.plugins[t].hasOwnProperty("destroy")&&this.plugins[t].destroy&&this.plugins[t].destroy()},mapTempComments:function(t,e){var i=t.find("textarea"),s=e.find("textarea"),a=t.find(".ui-bizagi-wp-project-attachments-list[data-type=COMMENT]").first(),o=e.find(".ui-bizagi-wp-project-attachments-list[data-type=COMMENT]").first();s.val(i.val()),o.empty().append(a.html())}}),bizagi.injector.register("bizagi.workportal.widgets.project.discussions",["workportalFacade","dataService","notifier",bizagi.workportal.widgets.project.discussions],!0),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.discussion.sidebar",{},{init:function(t,e,i){this._super(t,e,i),(i=i||{}).supportNav=!1,this.loadTemplates({"project-discussion-sidebar":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.discussion.sidebar").concat("#project-discussion-sidebar")})},renderContent:function(){var t=this.getTemplate("project-discussion-sidebar");return this.content=t.render({isOpen:!bizagi.util.parseBoolean(this.params.isClosedForAllUsers)}),this.content},postRender:function(){var t=this.getContent();$(".ui-bizagi-wp-project-discussions-sidebar-action-add > a",t).on("click",$.proxy(this.onShowPopupDiscussion,this))},onShowPopupDiscussion:function(){this.pub("notify",{type:"OPEN_POPUP_DISCUSSION",args:{}})}}),bizagi.injector.register("bizagi.workportal.widgets.project.discussion.sidebar",["workportalFacade","dataService",bizagi.workportal.widgets.project.discussion.sidebar],!0);
//# sourceMappingURL=../../../../Maps/desktop/activityplancomments.desktop.production.js.map
