bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.plans.manager",{},{usersMap:{},init:function(e,t,i,a,s,n,o,r){this._super(e,t,r),this.serviceOrderActivitiesByTransitions=o,this.plans={},this.editDialogBox={},this.allIdUsers=[],this.allGuidUsers=[],this.notifier=a,this.planTemplateCreate=s,this.planPopupEdit=n,this.globalHandlersService=bizagi.injector.get("globalHandlersService"),this.usersFromIdPlan=Array(),this.loadTemplates({"plans.manager.wrapper":bizagi.getTemplate("bizagi.workportal.desktop.widget.decontextualized.plans.manager").concat("#plans-manager-wrapper"),"plans.manager.empty":bizagi.getTemplate("bizagi.workportal.desktop.widget.decontextualized.plans.manager").concat("#plans-manager-empty-message"),"plans.manager.users":bizagi.getTemplate("bizagi.workportal.desktop.widget.decontextualized.plans.manager").concat("#plans-manager-users"),"plans.manager.activities.tooltip":bizagi.getTemplate("bizagi.workportal.desktop.widget.decontextualized.plans.manager").concat("#plans-manager-activities-tooltip"),"plans.manager.context.menu.content":bizagi.getTemplate("bizagi.workportal.desktop.widget.decontextualized.plans.manager").concat("#plans-manager-context-menu-content")})},renderContent:function(){return this.content=$("<div/>"),this.content},postRender:function(){var e=this;e.getCalculatedDateServer(),e.sub("PLANS-VIEW",$.proxy(e.updateView,e)),e.planTemplateCreate.sub("planTemplateCreatedSuccess",(function(){e.notifier.showSucessMessage(printf(bizagi.localization.getResource("workportal-project-plan-create-template-success"),""))})),e.planTemplateCreate.sub("planTemplateCreatedFailed",(function(){e.notifier.showErrorMessage(printf(bizagi.localization.getResource("workportal-project-plan-create-template-fail"),""))})),e.planPopupEdit.sub("planEditedSuccess",(function(){var t={histName:e.params.histName,planState:e.params.planState,level:1};e.pub("notify",{type:"PLANS-VIEW",args:$.extend(e.params,t)}),e.notifier.showSucessMessage(printf(bizagi.localization.getResource("workportal-project-plan-edit-success"),""))})),e.planPopupEdit.sub("planEditedFailed",(function(){e.notifier.showErrorMessage(printf(bizagi.localization.getResource("workportal-project-plan-edit-fail"),""))}))},configureHandlers:function(){var e=this,t=e.getContent();$(".wdg-plans-manager-card",t).on("click",$.proxy(e.onClickPlan,e)),$(".wdg-plans-manager-card .btn-workonit",t).on("click",(function(t){t.stopPropagation();var i=$(t.target).closest(".wdg-plans-manager-card").data("plan-id");e.plans[i].activities.forEach((function(t){e.runningActivity(t)&&e.goToWorkOnIt(t.idCase,t.idWorkItem)}))}))},onClickPlan:function(e){var t=$(e.target).closest(".wdg-plans-manager-card"),i=t.data("plan-id"),a={name:t.data("plan-name"),id:i};this.showPlanDashBoard(a)},showPlanDashBoard:function(e){var t=this,i=new bizagi.workportal.services.behaviors.projectDashboard(t.dataService);t.params.showContextByMenuDashboard="PLANACTIVITIES",t.params.menuPlanDashboard={},t.params.menuPlanDashboard.showCommentsOptionMenu=i.getMenuDashboardSecurity(bizagi.menuSecurity).isVisibleButtonComments,t.params.menuPlanDashboard.showFilesOptionMenu=i.getMenuDashboardSecurity(bizagi.menuSecurity).isVisibleButtonFiles,t.params.menuPlanDashboard.showTimeLineOptionMenu=i.getMenuDashboardSecurity(bizagi.menuSecurity).isVisibleButtonTimeLine,(e=t.plans[e.id]).name.length>28&&(e.name=e.name.substring(0,29)+"..."),e.contextualized&&delete t.params.flowContext,$.when(i.getFirstParentInfo(e.id,e.contextualized)).done((function(i){t.params.radNumber=i.id;var a={plan:e,level:2,histName:e.name,hasDiscussionsOrComment:i.hasDiscussionsOrComment};t.pub("notify",{type:t.params.showContextByMenuDashboard,args:$.extend(t.params,a)})}))},deletePlan:function(e){var t=this;$.when(bizagi.showConfirmationBox(bizagi.localization.getResource("workportal-project-plan-action-delete-confirmation"),"","info")).done((function(){var i={id:e.id};$.when(t.dataService.deletePlan(i)).always((function(e){if(200===e.status||void 0===e.status){$.extend(t.params.plan,i);var a={histName:t.params.histName,planState:t.params.planState,level:1};t.pub("notify",{type:"PLANS-VIEW",args:$.extend(t.params,a)}),t.notifier.showSucessMessage(printf(bizagi.localization.getResource("workportal-project-plan-delete-success"),""))}else t.notifier.showErrorMessage(printf(bizagi.localization.getResource("workportal-project-plan-delete-fail"),""))}))}))},executePlan:function(e){var t=this;if(e.activitiesLength>0){var i={idPlan:e.id};$.when(t.dataService.putExecutePlan(i)).done((function(){var i=t.plans[e.id];i&&(i.currentState="EXECUTING",i=$.extend(i,{startDate:t.getDateServer()}),$.when(t.dataService.updatePlan(i)).done((function(){var e={histName:t.params.histName,planState:t.params.planState,level:1};t.pub("notify",{type:"PLANS-VIEW",args:$.extend(t.params,e)}),t.notifier.showSucessMessage(printf(bizagi.localization.getResource("workportal-project-plan-state-change-running"),""))})))}))}else t.notifier.showErrorMessage(printf(bizagi.localization.getResource("workportal-project-plan-action-execute-message-activities-required"),""))},closePlan:function(e){var t=this,i=t.plans[e.id];i&&(i.currentState="CLOSED",$.when(t.dataService.closePlan({idPlan:e.id})).done((function(){$.when(t.dataService.updatePlan(i)).done((function(){var e={histName:t.params.histName,planState:t.params.planState,level:1};t.pub("notify",{type:"PLANS-VIEW",args:$.extend(t.params,e)}),t.notifier.showSucessMessage(printf(bizagi.localization.getResource("workportal-project-plan-close-success"),""))}))})).fail((function(){t.notifier.showErrorMessage(printf(bizagi.localization.getResource("workportal-project-plan-close-fail"),""))})))},openPopupEditTemplate:function(){var e=this.plans[this.selectedPlan.id]||{};this.planPopupEdit.showPopup(this.params,this.dataService,e)},openPopupSaveTemplate:function(){var e=this.plans[this.selectedPlan.id]||{};this.planTemplateCreate.showPopupAddTemplatePlan(this.params,this.dataService,e.contextualized,e.id)},updateView:function(e,t){var i=this;i.params=t.args,i.getContent().empty();var a=i.getTemplate("plans.manager.wrapper");$.when(i.getData()).done((function(e){if(e.length>0){i.content.empty(),i.arrayPlans=i.processData(e);var t=i.arrayPlans.length,s=i.arrayPlans;s.totalAssignees=t,i.content.append(a.render({plans:s})),$(".wdg-plans-row-dial",i.content).knob(),i.updatePlanDetails(),i.configureHandlers(),i.configureContextMenu(),$("#ui-bizagi-wp-project-homeportal-main").addClass("disabled-right-sidebar").removeClass("enabled-right-sidebar")}else i.content.empty(),i.content.append(i.getTemplate("plans.manager.empty").render())}))},getPictureAndName:function(e){if(!1===this.thereWasUsersMap&&this.usersMap)for(var t=0;t<this.usersFromIdPlan[e].length;t+=1){var i=this.usersMap[this.usersFromIdPlan[e][t].userAssigned];this.usersFromIdPlan[e][t].picture=i.picture,this.usersFromIdPlan[e][t].name=i.name}},orderActivitiesByTransitions:function(e,t){return this.serviceOrderActivitiesByTransitions.getActivitiesByTransitions(e,t)},processData:function(e){for(var t=e.length,i=0;i<t;i+=1){this.plans[e[i].id]=e[i];var a=e[i].startDate||e[i].creationDate,s=e[i].dueDate;a&&(a=new Date(a),e[i].fromDate=bizagi.util.dateFormatter.getRelativeTime(a,null,!1)),s&&(s=new Date(s),e[i].toDate=bizagi.util.dateFormatter.getRelativeTime(s,null,!1)),e[i].value=0,e[i].completedActivities=0,e[i].activitiesLength=0,e[i].dueDate&&(e[i].dueDateFormat=this.getFormattedDate(new Date(e[i].dueDate))),e[i].locatedState=bizagi.localization.getResource("workportal-project-plan-state-"+e[i].currentState.toLowerCase())}return e},updatePlanDetails:function(){for(var e=this,t=[],i=[],a=0;a<e.arrayPlans.length;a+=1){t.push(e.arrayPlans[a].idUserCreator);var s=e.getMetaData(e.arrayPlans[a].id);$.when(s,e.arrayPlans[a].id).done((function(t,i){e.plans[i].activities=t,e.paintPlanDetails(t,i),e.configureActivitiesTooltip(t,i)})),i.push(s)}$.when.apply($,i).then((function(){$.equalizeHeights(".wdg-plans-manager-card"),e.getUsers(t.concat(e.allIdUsers))}))},getUsersFromIdPlan:function(e){var t=this,i=[];return t.usersFromIdPlan[e].map((function(e){var a=t.usersMap[e.userAssigned];i.push(usersAdapter.createJsonUserInfo(e.userAssigned,a.name,a.username,a.picture,a.email,a.name.getInitials(),!1,!1,e.activities,[]))})),i},paintPlanDetails:function(e,t){var i=this,a=e.length,s=0,n=0,o=[],r=[],l=[],c=i.getTemplate("plans.manager.users");i.plans[t].users={};var d,h,p=i.plans[t].startDate||i.plans[t].creationDate,u=$('[data-plan-id="'+i.plans[t].id+'"]',i.content);if(0==a)i.usersFromIdPlan[t]=[{userAssigned:i.plans[t].idUserCreator,activities:[]}];else{i.usersFromIdPlan[t]=[];for(var g=0;g<a;g+=1){var m=e[g].finishDate||e[g].startDate;p=p<m?m:p,"Completed"===e[g].workItemState&&(s+=1,e[g].progress=100),i.runningActivity(e[g])&&(o.push(e[g].name),e[g].progress=0),r.indexOf(e[g].userAssigned)<0?(i.plans[t].users[e[g].userAssigned]=[e[g]],r.push(e[g].userAssigned)):i.plans[t].users[e[g].userAssigned].push(e[g]),i.allIdUsers.indexOf(e[g].userAssigned)<0&&(i.allIdUsers.push(e[g].userAssigned),i.allGuidUsers.push(e[g].userAssigned)),n+=e[g].progress}for(var f=0;f<r.length;f+=1)if(i.usersMap[r[f]]){var v=i.usersMap[r[f]];l.push(v),thereWasUsersMap=!0,i.usersFromIdPlan[t].push({userAssigned:r[f],activities:[]})}else i.thereWasUsersMap=!1,l.push({userAssigned:r[f],picture:"",name:""}),i.usersFromIdPlan[t].push(usersAdapter.createJsonUserInfo(r[f],"","","","","",!1,!1,[],[]));for(var w=0;w<i.plans[t].activities.length;w++)for(var b=0;b<i.usersFromIdPlan[t].length;b++)i.usersFromIdPlan[t][b].userAssigned===i.plans[t].activities[w].userAssigned&&(null==i.usersFromIdPlan[t][b].activities&&(i.usersFromIdPlan[t][b].activities=[]),i.usersFromIdPlan[t][b].activities.push(i.plans[t].activities[w]));n=Math.round(n/a),u.find(".wdg-plans-row-completed").html(s),u.find(".wdg-plans-row-activities-length").html(a),u.find(".wdg-plans-row-dial").val(n).trigger("change"),l.idPlan=i.plans[t].id,u.find(".wdg-plans-users").html(c.render({users:l})),u.find(".moreUsers").click((function(e){e.preventDefault(),e.stopPropagation();var t=$(this).attr("data-plan-id");i.getPictureAndName(t);var a=i.getUsersFromIdPlan(t);i.globalHandlersService.publish("showDialogWidget",{widgetName:bizagi.workportal.widgets.widget.BIZAGI_WORKPORTAL_WIDGET_USERS_MODAL,closeVisible:!0,data:a,maximize:!0,modalParameters:{title:bizagi.localization.getResource("workportal-project-users-title")+" ("+a.length+")",width:790,height:526,refreshInbox:!1}})})),i.getVisibleButtonWorkonit(i.plans[t],n,o)?(u.find(".wdg-plans-row-activities").html(o.join(",")),u.find(".wdg-plans-workonit-row").show()):(u.find(".wdg-plans-activities-row").hide(),u.find(".wdg-plans-workonit-row").hide())}"PENDING"===i.plans[t].currentState?(d=bizagi.localization.getResource("workportal-general-properties-last-update"),h=i.plans[t].creationDate):"EXECUTING"===i.plans[t].currentState?(d=bizagi.localization.getResource("workportal-general-properties-start-date"),h=i.plans[t].startDate):"CLOSED"===i.plans[t].currentState&&(d=bizagi.localization.getResource("workportal-general-properties-closed-date"),h=p);var k=i.getFormattedDate(new Date(h));u.find(".first-date-plan").html(d+": "+k)},getResource:function(e){return bizagi.localization.getResource(e)},getFormattedDate:function(e){var t=this.getResource("dateFormat"),i=bizagi.util.dateFormatter.formatInvariant(e,!1),a=$("<span class='formatDate'>"+i+"</span>");return bizagi.util.formatInvariantDate(a,t),a.text()},getVisibleButtonWorkonit:function(e,t,i){var a=!1;return"EXECUTING"===e.currentState&&t<100&&i.length>0&&(a=!0),a},goToWorkOnIt:function(e,t){this.publish("executeAction",{action:bizagi.workportal.actions.action.BIZAGI_WORKPORTAL_ACTION_ROUTING,idCase:e,idWorkItem:t})},configureActivitiesTooltip:function(e,t){var i=this,a=i.getTemplate("plans.manager.activities.tooltip");$('[data-plan-id="'+t+'"]',i.content).find(".wdg-plans-activities-row").tooltip({content:function(){var t=$();return e.forEach((function(e){if(i.runningActivity(e)){var s=e.estimatedFinishDate?new Date(e.estimatedFinishDate):null;i.usersMap[e.userAssigned]&&(e.userName=i.usersMap[e.userAssigned].name,e.userPicture=i.usersMap[e.userAssigned].picture,e.formatedEstimatedFinishDate=s?bizagi.util.dateFormatter.formatDate(s,bizagi.localization.getResource("dateFormat")):null);var n=a.render({activity:e});t.push.apply(t,n)}})),t}})},runningActivity:function(e){return"Active"===e.workItemState||"Inactive"===e.workItemState},configureUserTooltip:function(){var e=this;$(".wdg-plans-users > li",e.content).not(".icon-more").on("mouseenter","",(function(t){var i=$(t.target),a=i.closest("[data-iduser]").attr("data-iduser"),s=i.closest(".wdg-plans-manager-card").attr("data-plan-id"),n=e.usersFromIdPlan[s].find((function(e){return e.userAssigned==a}));if(n&&n.userAssigned==a){var o=[];n.activities.map((function(e){o.push(e.name)})),n=e.usersMap[n.userAssigned];var r=usersAdapter.createJsonUserInfo(n.userAssigned,n.name,n.username,n.picture,n.email,n.name.getInitials(),!1,!1,o,[]);i.closest(".wdg-plans-users").usertooltip(e,{target:i,user:r})}}))},getUsers:function(e){for(var t=this,i=[],a=e.length,s=0;s<a;s+=1)t.usersMap[e[s]]||i.push(e[s]);if(i.length>0){var n={usersGuids:e.join(),width:32,height:32};$.when(t.dataService.getUsersData(n)).done((function(e){for(var i=e.length,a=0;a<i;a+=1)t.usersMap[e[a].id]={picture:e[a].picture?"data:image/png;base64,"+e[a].picture:"",name:e[a].name||"",userAssigned:e[a].id,username:e[a].username,isAnonymized:e[a].isAnonymized,email:e[a].email},t.configureAvatar(e[a].id);t.configureUserTooltip()}))}else{for(var o=0;o<e.length;o+=1)t.configureAvatar(e[o]);t.configureUserTooltip()}},configureAvatar:function(e){var t=$('[data-iduser="'+e+'"]',this.content);this.usersMap[e].picture?t.find(".bz-wp-avatar-img").attr("src",this.usersMap[e].picture):(t.find(".bz-wp-avatar-img").hide(),t.find(".wdg-plans-row-user-label").html(this.usersMap[e].name.getInitials()).show())},configureContextMenu:function(){var e=this,t=e.getContent(),i=e.getTemplate("plans.manager.context.menu.content");$(".wdg-plans-leftmenu",t).on("click",(function(a){a.stopPropagation();var s=$(a.target),n=s.closest(".wdg-plans-manager-card"),o=n.data("plan-id"),r=n.data("plan-name"),l=n.data("plan-current-state"),c=parseInt(n.find(".wdg-plans-row-activities-length").html(),0),d=parseInt(n.find(".wdg-plans-row-completed").html(),0),h=isNaN(c)||isNaN(d)?0:c-d;e.selectedPlan={id:o,name:r,activitiesLength:isNaN(c)?0:c,completed:h<=0};var p=i.render({currentState:l,completed:e.selectedPlan.completed});$(".plans-manager-context-menu-wrapper",t).append(p),p.menu(),e.configureMenuHandlers(p),p.position({my:"left top",at:"left bottom",of:s,collision:"fit"}),p.show(),$(document).one("click",(function(){p.remove()})),$(".wdg-plans-manager-card").one("click",(function(){p.remove()})),$(".wdg-plans-leftmenu").one("click",(function(){p.remove()}))}))},configureMenuHandlers:function(e){var t=this;$("#edit",e).on("click",(function(e){e.stopPropagation(),t.openPopupEditTemplate(t.selectedPlan)})),$("#save",e).on("click",(function(e){e.stopPropagation(),t.openPopupSaveTemplate(t.selectedPlan)})),$("#enable",e).on("click",(function(e){e.stopPropagation(),t.executePlan(t.selectedPlan)})),$("#delete",e).on("click",(function(e){e.stopPropagation(),t.deletePlan(t.selectedPlan)})),$("#close",e).on("click",(function(e){e.stopPropagation(),t.closePlan(t.selectedPlan)}))},getMetaData:function(e){var t=this,i=$.Deferred(),a={idPlan:e},s={idPlan:e},n={idPlan:e};return $.when(t.dataService.getActivities(a),t.dataService.getWorkitemsPlan(s),t.dataService.getTransitionsByPlan(n)).done((function(e,a,s){var n;n=t.orderActivitiesByTransitions(e,s),t.mergePropertiesActivitiesWithWorkitems(n,a),i.resolve(n)})),i.promise()},getCalculatedDateServer:function(){var e=this;return $.when(e.dataService.getCurrentTimeDateServer()).done((function(t){e.differenceMillisecondsServer=bizagi.util.dateFormatter.getDifferenceBetweenDates(new Date,new Date(t.date),"milliseconds")}))},getDateServer:function(){return(new Date).getTime()+this.differenceMillisecondsServer},getData:function(){var e={};return"all"!==this.params.planState&&(e.currentState=this.params.planState),this.dataService.getUserPlans(e)},getEmptyDataMessage:function(){return this.getTemplate("plans.manager.empty")},mergePropertiesActivitiesWithWorkitems:function(e,t){e.forEach((function(e){var i=t.filter((function(t){return t.guidActivity==e.id}));i.length>0&&$.extend(e,{startDate:i[0].wiEntryDate||null,finishDate:i[0].wiSolutionDate||null,idWorkItem:i[0].idWorkItem,workItemState:i[0].workItemState,idCase:i[0].idCase,estimatedFinishDate:i[0].wiEstimatedSolutionDate||e.estimatedFinishDate})}))},clean:function(){this.params={},this.unsub("PLANS-VIEW",$.proxy(this.updateView,this)),this.planTemplateCreate.unsub("planTemplateCreatedSuccess"),this.planTemplateCreate.unsub("planTemplateCreatedFailed"),this.planPopupEdit.unsub("planEditedSuccess"),this.planPopupEdit.unsub("planEditedFailed")}}),bizagi.injector.register("bizagi.workportal.widgets.plans.manager",["workportalFacade","dataService","actionService","notifier","bizagi.workportal.widgets.project.plan.template.create","bizagi.workportal.widgets.project.plan.edit","bizagi.workportal.services.behaviors.orderActivitiesByTransitions",bizagi.workportal.widgets.plans.manager]),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.plans.topmenu",{},{init:function(e,t,i,a){this.params=a,this._super(e,t,a),this.planCreate=i,this.loadTemplates({"plans.topmenu.wrapper":bizagi.getTemplate("bizagi.workportal.desktop.widget.decontextualized.plans.topmenu").concat("#plans-topmenu-wrapper")})},renderContent:function(){var e=this.getTemplate("plans.topmenu.wrapper");return this.content=e.render({}),this.content},postRender:function(){this.configureHandlers()},configureHandlers:function(){var e=this.getContent();$(".wdg-topmenu-add",e).on("click",$.proxy(this.onClickAddPlan,this))},onClickAddPlan:function(){var e=this;e.planCreate.showPopupAddPlan(e.params,e.dataService,!1),e.planCreate.unsub("planCreated"),e.planCreate.sub("planCreated",(function(t,i){var a=i.paramsNewPlan,s=a.name;a.name.length>28&&(s=a.name.substring(0,29)+"..."),e.params.radNumber=i.radNumber,e.params.showContextByMenuDashboard="PLANACTIVITIES",e.params.hasDiscussionsOrComment=i.hasDiscussionsOrComment,e.pub("notify",{type:"PLANACTIVITIES",args:$.extend(e.params,{plan:i.paramsNewPlan,level:2,histName:s})})}))}}),bizagi.injector.register("bizagi.workportal.widgets.plans.topmenu",["workportalFacade","dataService","bizagi.workportal.widgets.project.plan.create",bizagi.workportal.widgets.plans.topmenu]),function(e){"use strict";var t={},i=Math.max,a=Math.min;t.c={},t.c.d=e(document),t.c.t=function(e){return e.originalEvent.touches.length-1},t.o=function(){var i=this;this.o=null,this.$=null,this.i=null,this.g=null,this.v=null,this.cv=null,this.x=0,this.y=0,this.w=0,this.h=0,this.$c=null,this.c=null,this.t=0,this.isInit=!1,this.fgColor=null,this.pColor=null,this.dH=null,this.cH=null,this.eH=null,this.rH=null,this.scale=1,this.relative=!1,this.relativeWidth=!1,this.relativeHeight=!1,this.$div=null,this.run=function(){var t=function(e,t){var a;for(a in t)i.o[a]=t[a];i._carve().init(),i._configure()._draw()};if(!this.$.data("kontroled")){if(this.$.data("kontroled",!0),this.extend(),this.o=e.extend({min:void 0!==this.$.data("min")?this.$.data("min"):0,max:void 0!==this.$.data("max")?this.$.data("max"):100,stopper:!0,readOnly:this.$.data("readonly")||"readonly"===this.$.attr("readonly"),cursor:(!0===this.$.data("cursor")?30:this.$.data("cursor"))||0,thickness:this.$.data("thickness")&&Math.max(Math.min(this.$.data("thickness"),1),.01)||.35,lineCap:this.$.data("linecap")||"butt",width:this.$.data("width")||200,height:this.$.data("height")||200,displayInput:null==this.$.data("displayinput")||this.$.data("displayinput"),displayPrevious:this.$.data("displayprevious"),fgColor:this.$.data("fgcolor")||"#87CEEB",inputColor:this.$.data("inputcolor"),font:this.$.data("font")||"Arial",fontWeight:this.$.data("font-weight")||"bold",inline:!1,step:this.$.data("step")||1,rotation:this.$.data("rotation"),draw:null,change:null,cancel:null,release:null,format:function(e){return e},parse:function(e){return parseFloat(e)}},this.o),this.o.flip="anticlockwise"===this.o.rotation||"acw"===this.o.rotation,this.o.inputColor||(this.o.inputColor=this.o.fgColor),this.$.is("fieldset")?(this.v={},this.i=this.$.find("input"),this.i.each((function(t){var a=e(this);i.i[t]=a,i.v[t]=i.o.parse(a.val()),a.bind("change blur",(function(){var e={};e[t]=a.val(),i.val(i._validate(e))}))})),this.$.find("legend").remove()):(this.i=this.$,this.v=this.o.parse(this.$.val()),""===this.v&&(this.v=this.o.min),this.$.bind("change blur",(function(){i.val(i._validate(i.o.parse(i.$.val())))}))),!this.o.displayInput&&this.$.hide(),this.$c=e(document.createElement("canvas")).attr({width:this.o.width,height:this.o.height}),this.$div=e('<div style="'+(this.o.inline?"display:inline;":"")+"width:"+this.o.width+"px;height:"+this.o.height+'px;"></div>'),this.$.wrap(this.$div).before(this.$c),this.$div=this.$.parent(),"undefined"!=typeof G_vmlCanvasManager&&G_vmlCanvasManager.initElement(this.$c[0]),this.c=this.$c[0].getContext?this.$c[0].getContext("2d"):null,!this.c)throw{name:"CanvasNotSupportedException",message:"Canvas not supported. Please use excanvas on IE8.0.",toString:function(){return this.name+": "+this.message}};return this.scale=(window.devicePixelRatio||1)/(this.c.webkitBackingStorePixelRatio||this.c.mozBackingStorePixelRatio||this.c.msBackingStorePixelRatio||this.c.oBackingStorePixelRatio||this.c.backingStorePixelRatio||1),this.relativeWidth=this.o.width%1!=0&&this.o.width.indexOf("%"),this.relativeHeight=this.o.height%1!=0&&this.o.height.indexOf("%"),this.relative=this.relativeWidth||this.relativeHeight,this._carve(),this.v instanceof Object?(this.cv={},this.copy(this.v,this.cv)):this.cv=this.v,this.$.bind("configure",t).parent().bind("configure",t),this._listen()._configure()._xy().init(),this.isInit=!0,this.$.val(this.o.format(this.v)),this._draw(),this}},this._carve=function(){if(this.relative){var e=this.relativeWidth?this.$div.parent().width()*parseInt(this.o.width)/100:this.$div.parent().width(),t=this.relativeHeight?this.$div.parent().height()*parseInt(this.o.height)/100:this.$div.parent().height();this.w=this.h=Math.min(e,t)}else this.w=this.o.width,this.h=this.o.height;return this.$div.css({width:this.w+"px",height:this.h+"px"}),this.$c.attr({width:this.w,height:this.h}),1!==this.scale&&(this.$c[0].width=this.$c[0].width*this.scale,this.$c[0].height=this.$c[0].height*this.scale,this.$c.width(this.w),this.$c.height(this.h)),this},this._draw=function(){var e=!0;i.g=i.c,i.clear(),i.dH&&(e=i.dH()),!1!==e&&i.draw()},this._touch=function(e){var a=function(e){var t=i.xy2val(e.originalEvent.touches[i.t].pageX,e.originalEvent.touches[i.t].pageY);t!=i.cv&&(i.cH&&!1===i.cH(t)||(i.change(i._validate(t)),i._draw()))};return this.t=t.c.t(e),a(e),t.c.d.bind("touchmove.k",a).bind("touchend.k",(function(){t.c.d.unbind("touchmove.k touchend.k"),i.val(i.cv)})),this},this._mouse=function(e){var a=function(e){var t=i.xy2val(e.pageX,e.pageY);t!=i.cv&&(i.cH&&!1===i.cH(t)||(i.change(i._validate(t)),i._draw()))};return a(e),t.c.d.bind("mousemove.k",a).bind("keyup.k",(function(e){if(27===e.keyCode){if(t.c.d.unbind("mouseup.k mousemove.k keyup.k"),i.eH&&!1===i.eH())return;i.cancel()}})).bind("mouseup.k",(function(e){t.c.d.unbind("mousemove.k mouseup.k keyup.k"),i.val(i.cv)})),this},this._xy=function(){var e=this.$c.offset();return this.x=e.left,this.y=e.top,this},this._listen=function(){return this.o.readOnly?this.$.attr("readonly","readonly"):(this.$c.bind("mousedown",(function(e){e.preventDefault(),i._xy()._mouse(e)})).bind("touchstart",(function(e){e.preventDefault(),i._xy()._touch(e)})),this.listen()),this.relative&&e(window).resize((function(){i._carve().init(),i._draw()})),this},this._configure=function(){return this.o.draw&&(this.dH=this.o.draw),this.o.change&&(this.cH=this.o.change),this.o.cancel&&(this.eH=this.o.cancel),this.o.release&&(this.rH=this.o.release),this.o.displayPrevious?(this.pColor=this.h2rgba(this.o.fgColor,"0.4"),this.fgColor=this.h2rgba(this.o.fgColor,"0.6")):this.fgColor=this.o.fgColor,this},this._clear=function(){this.$c[0].width=this.$c[0].width},this._validate=function(e){var t=~~((e<0?-.5:.5)+e/this.o.step)*this.o.step;return Math.round(100*t)/100},this.listen=function(){},this.extend=function(){},this.init=function(){},this.change=function(e){},this.val=function(e){},this.xy2val=function(e,t){},this.draw=function(){},this.clear=function(){this._clear()},this.h2rgba=function(e,t){var i;return e=e.substring(1,7),"rgba("+(i=[parseInt(e.substring(0,2),16),parseInt(e.substring(2,4),16),parseInt(e.substring(4,6),16)])[0]+","+i[1]+","+i[2]+","+t+")"},this.copy=function(e,t){for(var i in e)t[i]=e[i]}},t.Dial=function(){t.o.call(this),this.startAngle=null,this.xy=null,this.radius=null,this.lineWidth=null,this.cursorExt=null,this.w2=null,this.PI2=2*Math.PI,this.extend=function(){this.o=e.extend({bgColor:this.$.data("bgcolor")||"#EEEEEE",angleOffset:this.$.data("angleoffset")||0,angleArc:this.$.data("anglearc")||360,inline:!0},this.o)},this.val=function(e,t){if(null==e)return this.v;e=this.o.parse(e),!1!==t&&e!=this.v&&this.rH&&!1===this.rH(e)||(this.cv=this.o.stopper?i(a(e,this.o.max),this.o.min):e,this.v=this.cv,this.$.val(this.o.format(this.v)),this._draw())},this.xy2val=function(e,t){var s,n;return s=Math.atan2(e-(this.x+this.w2),-(t-this.y-this.w2))-this.angleOffset,this.o.flip&&(s=this.angleArc-s-this.PI2),this.angleArc!=this.PI2&&s<0&&s>-.5?s=0:s<0&&(s+=this.PI2),n=s*(this.o.max-this.o.min)/this.angleArc+this.o.min,this.o.stopper&&(n=i(a(n,this.o.max),this.o.min)),n},this.listen=function(){var t,s,n,o,r=this,l=function(e){e.preventDefault();var n=e.originalEvent,o=n.detail||n.wheelDeltaX,l=n.detail||n.wheelDeltaY,c=r._validate(r.o.parse(r.$.val()))+(o>0||l>0?r.o.step:o<0||l<0?-r.o.step:0);c=i(a(c,r.o.max),r.o.min),r.val(c,!1),r.rH&&(clearTimeout(t),t=setTimeout((function(){r.rH(c),t=null}),100),s||(s=setTimeout((function(){t&&r.rH(c),s=null}),200)))},c=1,d={37:-r.o.step,38:r.o.step,39:r.o.step,40:-r.o.step};this.$.bind("keydown",(function(t){var s=t.keyCode;if(s>=96&&s<=105&&(s=t.keyCode=s-48),n=parseInt(String.fromCharCode(s)),isNaN(n)&&(13!==s&&8!==s&&9!==s&&189!==s&&(190!==s||r.$.val().match(/\./))&&t.preventDefault(),e.inArray(s,[37,38,39,40])>-1)){t.preventDefault();var l=r.o.parse(r.$.val())+d[s]*c;r.o.stopper&&(l=i(a(l,r.o.max),r.o.min)),r.change(r._validate(l)),r._draw(),o=window.setTimeout((function(){c*=2}),30)}})).bind("keyup",(function(e){isNaN(n)?o&&(window.clearTimeout(o),o=null,c=1,r.val(r.$.val())):r.$.val()>r.o.max&&r.$.val(r.o.max)||r.$.val()<r.o.min&&r.$.val(r.o.min)})),this.$c.bind("mousewheel DOMMouseScroll",l),this.$.bind("mousewheel DOMMouseScroll",l)},this.init=function(){(this.v<this.o.min||this.v>this.o.max)&&(this.v=this.o.min),this.$.val(this.v),this.w2=this.w/2,this.cursorExt=this.o.cursor/100,this.xy=this.w2*this.scale,this.lineWidth=this.xy*this.o.thickness,this.lineCap=this.o.lineCap,this.radius=this.xy-this.lineWidth/2,this.o.angleOffset&&(this.o.angleOffset=isNaN(this.o.angleOffset)?0:this.o.angleOffset),this.o.angleArc&&(this.o.angleArc=isNaN(this.o.angleArc)?this.PI2:this.o.angleArc),this.angleOffset=this.o.angleOffset*Math.PI/180,this.angleArc=this.o.angleArc*Math.PI/180,this.startAngle=1.5*Math.PI+this.angleOffset,this.endAngle=1.5*Math.PI+this.angleOffset+this.angleArc;var e=i(String(Math.abs(this.o.max)).length,String(Math.abs(this.o.min)).length,2)+2;this.o.displayInput&&this.i.css({width:(this.w/2+4>>0)+"px",height:(this.w/3>>0)+"px",position:"absolute","vertical-align":"middle","margin-top":(this.w/3>>0)+"px","margin-left":"-"+(3*this.w/4+2>>0)+"px",border:0,background:"none",font:this.o.fontWeight+" "+(this.w/e>>0)+"px "+this.o.font,"text-align":"center",color:this.o.inputColor||this.o.fgColor,padding:"0px","-webkit-appearance":"none"})||this.i.css({width:"0px",visibility:"hidden"})},this.change=function(e){this.cv=e,this.$.val(this.o.format(e))},this.angle=function(e){return(e-this.o.min)*this.angleArc/(this.o.max-this.o.min)},this.arc=function(e){var t,i;return e=this.angle(e),i=this.o.flip?(t=this.endAngle+1e-5)-e-1e-5:(t=this.startAngle-1e-5)+e+1e-5,this.o.cursor&&(t=i-this.cursorExt)&&(i+=this.cursorExt),{s:t,e:i,d:this.o.flip&&!this.o.cursor}},this.draw=function(){var e,t=this.g,i=this.arc(this.cv),a=1;t.lineWidth=this.lineWidth,t.lineCap=this.lineCap,"none"!==this.o.bgColor&&(t.beginPath(),t.strokeStyle=this.o.bgColor,t.arc(this.xy,this.xy,this.radius,this.endAngle-1e-5,this.startAngle+1e-5,!0),t.stroke()),this.o.displayPrevious&&(e=this.arc(this.v),t.beginPath(),t.strokeStyle=this.pColor,t.arc(this.xy,this.xy,this.radius,e.s,e.e,e.d),t.stroke(),a=this.cv==this.v),t.beginPath(),t.strokeStyle=a?this.o.fgColor:this.fgColor,t.arc(this.xy,this.xy,this.radius,i.s,i.e,i.d),t.stroke()},this.cancel=function(){this.val(this.v)}},e.fn.dial=e.fn.knob=function(i){return this.each((function(){var a=new t.Dial;a.o=i,a.$=e(this),a.run()})).parent()}}($),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.plans.filters",{},{init:function(e,t,i){this.params=i,this._super(e,t,i),this.plansLinks=bizagi.injector.get("bizagi.workportal.widgets.decontextualized.plans",i),this.loadTemplates({"plans.filters.wrapper":bizagi.getTemplate("bizagi.workportal.desktop.widget.decontextualized.plans.filters").concat("#plans-filter-wrapper")})},renderContent:function(){var e,t,i={};return t=this.getTemplate("plans.filters.wrapper"),e=this.getData(),i.items=e.items,this.content=t.render(i),this.content},postRender:function(){this.configureHandlers()},setSelectedFilter:function(e){$(e).addClass("wdg-ftr-selected").siblings().removeClass("wdg-ftr-selected")},onLoadPlansView:function(e,t){this.setSelectedFilter($(".wdg-plan-filter-card[data-data='"+t.args.planState+"']",this.content))},configureHandlers:function(){var e=this.getContent();$(".wdg-plan-filter-card",e).on("click",$.proxy(this.onClickFilter,this)),this.sub("PLANS-VIEW",$.proxy(this.onLoadPlansView,this))},clean:function(){var e=this.getContent();e&&$(".wdg-plan-filter-card",e).off("click"),this.unsub("PLANS-VIEW",$.proxy(this.onLoadPlansView,this))},getData:function(){return this.plansLinks.getData()},onClickFilter:function(e){var t=$(e.target).closest(".wdg-plan-filter-card"),i=t.data("title"),a=t.data("data");a.toLowerCase();this.setSelectedFilter(t);var s={histName:i,planState:a,level:1};this.pub("notify",{type:"PLANS-VIEW",args:$.extend(this.params,s)})}}),bizagi.injector.register("bizagi.workportal.widgets.plans.filters",["workportalFacade","dataService",bizagi.workportal.widgets.plans.filters]),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.plan.activities.sidebar",{},{init:function(e,t,i){this._super(e,t,i),i=i||{},this.loadTemplates({"project-plan-activities-sidebar":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.activities.sidebar").concat("#project-plan-activities-sidebar")})},renderContent:function(){var e=this.getTemplate("project-plan-activities-sidebar");return this.content=e.render({}),this.content}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.activities.sidebar",["workportalFacade","dataService",bizagi.workportal.widgets.project.plan.activities.sidebar],!0),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.plan.create",{},{init:function(e,t,i,a){this.params=a,this.contextualized,this._super(e,t,a),this.notifier=i,this.loadTemplates({"plan-create":bizagi.getTemplate("bizagi.workportal.desktop.widgets.project.plan.create").concat("#plan-create")}),this.dialogBox={}},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){this.initPlugins()},initPlugins:function(){var e=this.getTemplate("plan-create");this.dialogBox.formContent=e.render({}),this.dialogBox.elements={inputName:$("#input-name-plan",this.dialogBox.formContent),inputTemplate:$("#templates-plan",this.dialogBox.formContent),buttonSave:$("#button-accept-create-plan",this.dialogBox.formContent),buttonCancel:$("#button-cancel-create-plan",this.dialogBox.formContent)},this.dialogBox.elements.buttonSave.on("click",$.proxy(this.onClickSavePlan,this)),this.dialogBox.elements.buttonCancel.on("click",$.proxy(this.closeDialogBox,this)),this.notifier=bizagi.injector.get("notifier")},closeDialogBox:function(){this.dialogBox.formContent.dialog("destroy"),this.dialogBox.formContent.detach(),this.dialogBox.templateGuid=""},showPopupAddPlan:function(e,t,i){var a=this;a.params=e,a.dataService=t,a.contextualized=i,a.content=$("<div></div>"),a.initPlugins(),a.dialogBox.elements.inputTemplate.html(""),a.dataService.getTemplatesByParentWorkItem({parentWorkItem:e.guidWorkItem}).done((function(e){var t={combo:[],id:"templates"};t.combo=e,a.dialogBox.elements.inputTemplate.uicombo({isEditable:!1,data:t,itemValue:function(e){return e.id},itemText:function(e){return e.name},onChange:function(e){var t=e.ui.data("value");a.dialogBox.elements.inputTemplate.val(t),a.dialogBox.templateGuid=t},css:"display: none"}),a.dialogBox.elements.inputTemplate.keydown((function(){8!=event.keyCode&&46!=event.keyCode||(event.preventDefault(),a.dialogBox.templateGuid="",a.dialogBox.elements.inputTemplate.val(""),$("input",a.dialogBox.elements.inputTemplate).val(""))})),e.length>0?$(".field-template",a.dialogBox.formContent).show():$(".field-template",a.dialogBox.formContent).hide()})).fail((function(){$(".field-template",a.dialogBox.formContent).hide()})),a.dialogBox.formContent.dialog({resizable:!1,draggable:!1,height:"auto",width:"600px",modal:!0,title:bizagi.localization.getResource("workportal-project-plan-popup-title-add-plan"),maximize:!1,close:function(){a.dialogBox.formContent.dialog("destroy"),a.dialogBox.formContent.detach()}})},onClickSavePlan:function(e){e.preventDefault();this.validateParams()&&this.createNewPlan()},createNewPlan:function(){var e=this,t=e.params.guidWorkItem||null,i={idUserCreator:bizagi.currentUser.idUser,id:void 0,startDate:null,creationDate:null,parentWorkItem:t,description:null,currentState:"PENDING",name:e.dialogBox.elements.inputName.val(),waitForCompletion:!0,dueDate:null,contextualized:e.contextualized,idTemplate:e.dialogBox.templateGuid};$.when(e.sendDataInsertPlan(i)).then((function(t){(i=$.extend(i,{id:t.id})).activities=[],i.users=[];var a=new bizagi.workportal.services.behaviors.projectDashboard(e.dataService);e.params.menuPlanDashboard={},e.params.menuPlanDashboard.showCommentsOptionMenu=a.getMenuDashboardSecurity(bizagi.menuSecurity).isVisibleButtonComments,e.params.menuPlanDashboard.showFilesOptionMenu=a.getMenuDashboardSecurity(bizagi.menuSecurity).isVisibleButtonFiles,e.params.menuPlanDashboard.showTimeLineOptionMenu=a.getMenuDashboardSecurity(bizagi.menuSecurity).isVisibleButtonTimeLine,i.name=bizagi.util.encodeHtml(i.name),$.when(a.getFirstParentInfo(i.id,i.contextualized)).done((function(t){var a={paramsNewPlan:i,radNumber:t.id,hasDiscussionsOrComment:t.hasDiscussionsOrComment};e.pub("planCreated",a),e.closeDialogBox(),e.notifier.showSucessMessage(printf(bizagi.localization.getResource("workportal-project-plan-created"),""))}))}))},validateParams:function(){var e=this.dialogBox.elements.inputName;if(e.val()&&""!==e.val())return!0;var t=bizagi.localization.getResource("workportal-project-plan-popup-field-name-required");return e.next().find("span").html(t),!1},sendDataInsertPlan:function(e){var t=$.Deferred();return $.when(this.dataService.postPlan(e)).always((function(e,i,a){201===a.status?t.resolve(e):t.reject()})),t.promise()}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.create",["workportalFacade","dataService","notifier",bizagi.workportal.widgets.project.plan.create]),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.plan.edit",{},{init:function(e,t,i,a){this.params=a,this.planToEdit,this._super(e,t,a),this.notifier=i,this.loadTemplates({"plans.manager.popup.edit.plan":bizagi.getTemplate("bizagi.workportal.desktop.widgets.project.plan.edit").concat("#plans-manager-popup-edit-plan")}),this.editDialogBox={}},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){},closeEditDialogBox:function(){this.editDialogBox.elements.inputDueDate.datepicker("destroy"),this.editDialogBox.formContent.dialog("destroy"),this.editDialogBox.formContent.detach()},showPopup:function(e,t,i){var a=this,s=$.Deferred();return a.planToEdit=i,a.initEditDialogBox(i),a.editDialogBox.elements.inputName.val(bizagi.util.decodeHtmlEntities(i.name)),a.editDialogBox.elements.inputDesc.val(bizagi.util.decodeHtmlEntities(i.description)),a.editDialogBox.elements.inputWaitForCompletion.prop("checked",i.waitForCompletion),a.editDialogBox.elements.inputDueDate.datepicker(),a.editDialogBox.elements.inputDueDate.datepicker("option","dateFormat",bizagi.util.dateFormatter.getDateFormatByDatePickerJqueryUI()),i.dueDate&&a.editDialogBox.elements.inputDueDate.datepicker("setDate",new Date(i.dueDate)),a.editDialogBox.formContent.dialog({resizable:!1,draggable:!1,height:"auto",width:"600px",modal:!0,title:bizagi.localization.getResource("workportal-project-plan-editplan"),maximize:!0,close:function(e,t){a.editDialogBox.elements.inputDueDate.datepicker("destroy"),a.editDialogBox.formContent.dialog("destroy"),a.editDialogBox.formContent.detach(),s.resolve()}}),s.promise()},initEditDialogBox:function(e){var t=this.getTemplate("plans.manager.popup.edit.plan");this.editDialogBox.formContent=t.render(e),this.editDialogBox.elements={inputName:$("#input-name-plan",this.editDialogBox.formContent),inputDesc:$("#input-desc-plan",this.editDialogBox.formContent),inputDueDate:$("#input-dueDate-plan",this.editDialogBox.formContent),inputWaitForCompletion:$("#input-waitForCompletion",this.editDialogBox.formContent),buttonSave:$("#button-accept-edit-plan",this.editDialogBox.formContent),buttonCancel:$("#button-cancel-edit-plan",this.editDialogBox.formContent)},this.editDialogBox.elements.buttonSave.on("click",$.proxy(this.saveEditedPlan,this)),this.editDialogBox.elements.buttonCancel.on("click",$.proxy(this.closeEditDialogBox,this))},saveEditedPlan:function(e){e.preventDefault();var t=this;t.validateEditDialogBoxParams()&&$.when(t.getParamsUpdatePlan()).done((function(e){$.when(t.dataService.updatePlan(e)).done((function(){t.closeEditDialogBox(),t.pub("planEditedSuccess",{paramsEditPlan:e})})).fail((function(){t.pub("planEditedFailed")}))}))},getParamsUpdatePlan:function(){var e=$.Deferred(),t={};(t=this.planToEdit).name=this.editDialogBox.elements.inputName.val(),t.description=this.editDialogBox.elements.inputDesc.val(),0!==this.editDialogBox.elements.inputWaitForCompletion.length&&(t.waitForCompletion=this.editDialogBox.elements.inputWaitForCompletion.prop("checked"));var i=this.editDialogBox.elements.inputDueDate.datepicker("getDate");if(i){var a={idUser:bizagi.currentUser.idUser,date:i.getTime()};$.when(this.dataService.getEndHourWorkingByDate(a)).done((function(i){t.dueDate=i.dateTime,e.resolve(t)}))}else e.resolve(t);return e.promise()},validateEditDialogBoxParams:function(){var e=this.editDialogBox.elements.inputName;if(e.val()&&""!==e.val())return!0;var t=bizagi.localization.getResource("workportal-project-plan-popup-field-name-required");return e.next().find("span").html(t),!1}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.edit",["workportalFacade","dataService","notifier",bizagi.workportal.widgets.project.plan.edit],!0),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.plan.template.create",{},{init:function(e,t,i){this.params=i,this.contextualized,this.idPlanSelected,this._super(e,t,i),this.loadTemplates({"plan-template-create":bizagi.getTemplate("bizagi.workportal.desktop.widgets.project.plan.template.create").concat("#plan-template-create")}),this.dialogBox={}},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){this.initPlugins()},initPlugins:function(){var e=this.getTemplate("plan-template-create");this.dialogBox.formContent=e.render({}),this.dialogBox.elements={inputName:$("#input-name-template",this.dialogBox.formContent),buttonSave:$("#button-accept-create-template",this.dialogBox.formContent),buttonCancel:$("#button-cancel-create-template",this.dialogBox.formContent)},this.dialogBox.elements.buttonSave.on("click",$.proxy(this.onClickSaveTemplate,this)),this.dialogBox.elements.buttonCancel.on("click",$.proxy(this.closeDialogBox,this))},closeDialogBox:function(){this.dialogBox.formContent.dialog("destroy"),this.dialogBox.formContent.detach()},showPopupAddTemplatePlan:function(e,t,i,a){var s=this;s.params=e,s.dataService=t,s.contextualized=i,s.idPlanSelected=a,s.content=$("<div></div>"),s.initPlugins(),s.dialogBox.formContent.dialog({resizable:!1,draggable:!1,height:"auto",width:"600px",modal:!0,title:bizagi.localization.getResource("workportal-project-plan-action-popup-save-as-template"),maximize:!1,close:function(e,t){s.dialogBox.formContent.dialog("destroy"),s.dialogBox.formContent.detach()}})},onClickSaveTemplate:function(e){e.preventDefault();var t=this;if(t.validateSaveDialogBoxParams()){var i={idPlan:t.idPlanSelected,name:t.dialogBox.elements.inputName.val()};$.when(t.dataService.createTemplateByPlan(i)).done((function(){t.closeDialogBox(),t.pub("planTemplateCreatedSuccess",{})})).fail((function(){t.pub("planTemplateCreatedFailed",{})}))}},validateSaveDialogBoxParams:function(){var e=this.dialogBox.elements.inputName;if(e.val()&&""!==e.val())return!0;var t=bizagi.localization.getResource("workportal-project-plan-popup-field-name-required");return e.next().find("span").html(t),!1}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.template.create",["workportalFacade","dataService",bizagi.workportal.widgets.project.plan.template.create]),bizagi.workportal.widgets.admin.caseSearch.extend("bizagi.workportal.widgets.reassigncase",{},{init:function(e,t,i){this._super(e,t,i),this.loadTemplates({"admin.case.search":bizagi.getTemplate("bizagi.workportal.desktop.widgets.admin.caseSearch").concat("#ui-bizagi-workportal-widget-admin-case-search"),"admin.case.search.fields":bizagi.getTemplate("bizagi.workportal.desktop.widgets.admin.caseSearch").concat("#ui-bizagi-workportal-widget-admin-case-search-fields"),"admin.case.search.button":bizagi.getTemplate("bizagi.workportal.desktop.widgets.admin.caseSearch").concat("#ui-bizagi-workportal-widget-admin-case-search-buttons"),"admin.case.search.result":bizagi.getTemplate("bizagi.workportal.desktop.widgets.admin.caseSearch").concat("#ui-bizagi-workportal-widget-admin-case-search-result"),"admin.case.search.pagination":bizagi.getTemplate("bizagi.workportal.desktop.widgets.admin.caseSearch").concat("#ui-bizagi-workportal-widget-admin-case-search-pagination"),"admin.case.search.invalidate":bizagi.getTemplate("bizagi.workportal.desktop.widgets.admin.caseSearch").concat("#ui-bizagi-workportal-widget-admin-case-search-invalidate"),"admin.case.search.reassign":bizagi.getTemplate("bizagi.workportal.desktop.widgets.admin.caseSearch").concat("#ui-bizagi-workportal-widget-admin-case-search-reassign"),"admin.case.search.reassign.form":bizagi.getTemplate("bizagi.workportal.desktop.widgets.admin.caseSearch").concat("#ui-bizagi-workportal-widget-admin-case-search-reassign-form"),"admin.case.search.action.result":bizagi.getTemplate("bizagi.workportal.desktop.widgets.admin.caseSearch").concat("#ui-bizagi-workportal-widget-admin-case-search-action-result"),useNewEngine:!1})},getWidgetName:function(){return bizagi.workportal.widgets.widget.BIZAGI_WORKPORTAL_WIDGET_REASSIGN_CASE},renderContent:function(){var e,t=this.getTemplate("admin.case.search");return e=this.content=$.tmpl(t,{}),this.loadtemplates(),e},loadtemplates:function(){this.generalContentTmpl=this.getTemplate("admin.case.search"),this.fieldsContentTmpl=this.getTemplate("admin.case.search.fields"),this.buttonContentTmpl=this.getTemplate("admin.case.search.button"),this.resultContentTmpl=this.getTemplate("admin.case.search.result"),this.paginationTmpl=this.getTemplate("admin.case.search.pagination"),this.invalidateContentTmpl=this.getTemplate("admin.case.search.invalidate"),this.reassignContentTmpl=this.getTemplate("admin.case.search.reassign"),this.reassignFormTmpl=this.getTemplate("admin.case.search.reassign.form"),this.actionResultContentTmpl=this.getTemplate("admin.case.search.action.result")},postRender:function(){this.maxElemShow=10,this.maxPageToShow=5,this.processNavigation=[],this.setupData()},setupData:function(){var e={cases:[]},t=[];this.setupInitialData(),this.setupDatePicker(),this.setupProcessTree(),this.setupMainButtons(),e.cases.push({idCase:this.params.data.idCase,idWorkItem:this.params.data.idWorkItem}),t.push({taskItem:this.params.data.idCase+": "+this.params.data.idtask,idWorkItem:this.params.data.idWorkItem}),this.selectedTasks=e,this.selectedTasksToShow=t,this.showReassignForm(this.content,this.selectedTasksToShow)},setupInitialData:function(){var e,t=this.getContent();this.buttonBackAction="backToMainForm",this.selectedUserId="",this.selectedUserName="",this.selectedTasks="",this.selectedTasksToShow="",this.searchParams="",this.processTree="",$("#generalTitle").html(bizagi.localization.getResource("workportal-widget-admincasesearch-subtitle")),$("#mainForm",t).remove(),$("#dinamicContent",t).remove(),$("#case-search-log-data-buttonset",t).remove(),e=$.tmpl(this.reassignFormTmpl,{}),t.append(e)},setupDatePicker:function(){var e=this.getContent();$(".biz-wp-form-datepicker",e).datepicker({controlType:"select",dateFormat:"dd/mm/yy"})},setupProcessTree:function(){var e=this.getContent();bizagi.treeRoutSelected=[],$("#treeLinksId").remove(),this.processTree=new bizagi.workportal.widgets.processtree(this.workportalFacade,this.dataService,$.extend(this.params,{canvas:$("#processTree",e)})),this.processTree.render()},setupUsersSearchForm:function(){var e=this,t=e.getContent(),i=$.Deferred();$("#biz-wp-users-table-form").html(""),e.usersTable=new bizagi.workportal.widgets.userstable(e.workportalFacade,e.dataService,$.extend(e.params,{canvas:$("#biz-wp-users-table-form",t),userLinkLabel:[bizagi.localization.getResource("workportal-widget-admincasesearch-reassign")],parentDef:i})),e.usersTable.render(),$.when(i).done((function(t,i){e.assignEventReassignLinks(t,i)}))},findResults:function(e,t,i){var a=this;t.Page=i||1,$.when(a.dataService.getAdminCasesList(t)).done((function(i){if($(".biz-wp-table").remove(),$(".case-search-action-wrapper").remove(),$("#biz-wp-table-summary-wrapper").remove(),a.totalRecords=i.records,a.totalPages=i.total,i.rows.length>0){a.showCasesSearchResultFrame(e,i),a.setupActionsButton(e);var s,n=a.maxPageToShow>a.totalPages?a.totalPages:a.maxPageToShow,o=$("#biz-wp-table-pager-wrapper"),r={};r.pagination=a.totalPages>1,r.page=i.page,r.pages={};for(var l=1;l<=n;l++)r.pages[l]={pageNumber:l};s=$.tmpl(a.paginationTmpl,r).html(),o.append(s),$("ul").bizagiPagination({maxElemShow:a.maxElemShow,totalPages:a.totalPages,actualPage:i.page,listElement:$("#biz-wp-table-pager-wrapper"),clickCallBack:function(i){a.findResults(e,t,i.page)}})}else bizagi.showMessageBox(bizagi.localization.getResource("workportal-widget-authentication-log-none"),"Bizagi","warning")})).fail((function(e){bizagi.log(e)}))},showCasesSearchResultFrame:function(e,t){var i=this.preprocessResultList(t.headers,t),a=$.tmpl(this.resultContentTmpl,{headers:t.headers,rows:i}),s=$.tmpl(this.invalidateContentTmpl,{}),n=$.tmpl(this.reassignContentTmpl,{});$("#mainForm",e).hide(),$("#dinamicContent",e).html(a),$(".case-search-action-wrapper",e).append(s),$(".case-search-action-wrapper",e).append(n),$("#generalTitle").html(bizagi.localization.getResource("workportal-widget-admincasesearch-table-title")),$("#btn-admin-case-search-clear",e).hide(),$("#btn-admin-case-search",e).hide(),$("#btn-admin-case-back",e).css("display","inline"),this.setupActivitiesLink(e),this.setupGraphicQueryEvent(e)},preprocessResultList:function(e,t){for(var i=[],a=t.rows.length,s=0;s<a;s++)i.push(this.processResultItem(e,t.rows[s]));return i},processResultItem:function(e,t){var i,a,s,n,o=t.data,r=t.idCase,l=t.idWorkFlow,c=[],d=[],h=[],p=-1,u=0,g=!1;for(d.push({id:"checkCaseAdmin",value:r});p++<e.length-1;)switch(e[p].fieldName){case this.columnsID.caseNumber:d.push({id:"caseNumber",value:{idCase:r,caseNumber:o[u]}}),u++;break;case this.columnsID.process:d.push({id:"idWorkItem",value:o[u]}),u++;break;case this.columnsID.userName:case this.columnsID.task:case this.columnsID.taskDueDate:if(void 0===i){for(var m=o.length;m-- >0;)if(Array.isArray(o[m])){i=o[m],g=!0;break}u++}g?(e[p].fieldName==this.columnsID.taskDueDate&&o.splice(p,1),s=i[0],this.columnsID.userName==e[p].fieldName?(d=d.concat(this.processTaskObjectUser(s)),-1==h.indexOf(this.columnsID.userName)&&h.push(this.columnsID.userName)):this.columnsID.task==e[p].fieldName?(d=d.concat(this.processTaskObject(s,r)),-1==h.indexOf(this.columnsID.task)&&h.push(this.columnsID.task)):this.columnsID.taskDueDate==e[p].fieldName&&(d=d.concat(this.processTaskObjectDate(s)),-1==h.indexOf(this.columnsID.taskDueDate)&&h.push(this.columnsID.taskDueDate))):e[p].fieldName==this.columnsID.taskDueDate&&(d=d.concat({estimatedSolutionDate:o[p]}),-1==h.indexOf(this.columnsID.taskDueDate)&&h.push(this.columnsID.taskDueDate));break;case this.columnsID.processCreationDate:d.push({id:"processCreationDate",value:o[u]}),u++;break;case this.columnsID.processDueDate:d.push({id:"processDueDate",value:o[u]}),u++;break;default:d.push({id:"customField",value:o[u]}),u++}if(d.push({id:"viewProcess",value:{idCase:r,idworkflow:l}}),c.push({attr:"first_row",data:d}),(a=i?i.length:0)>1){n=h.length;for(var f=1;f<a;f++){var v=[];for(m=-1;m++<n-1;)h[m]==this.columnsID.task?v.push(this.processTaskObject(i[f],r)):h[m]==this.columnsID.taskDueDate?v.push(this.processTaskObjectDate(i[f])):h[m]==this.columnsID.userName&&v.push(this.processTaskObjectUser(i[f]));c.push({attr:"next_row",data:v})}}return{data:c,totalTask:a}},processTaskObject:function(e,t){return{taskName:e.taskName,colorState:e.colorState,idCase:t,idWorkItem:e.idWorkItem,idTask:e.idTask}},processTaskObjectDate:function(e){var t={};return e.estimatedSolutionDate?t.estimatedSolutionDate=e.estimatedSolutionDate:t.estimatedSolutionDate="",t},processTaskObjectUser:function(e){var t={};return e.assignee?t.userName=e.assignee:t.userName="",t},invalidateCases:function(e){var t=this,i={cases:[]};$("input:checkbox[name=CaseAdmin]:checked",e).each((function(){var e=$(this).val();i.cases.push({idCase:e})})),0==i.cases.length?bizagi.showMessageBox(bizagi.localization.getResource("workportal-widget-admincasesearch-invalidate-empty-msg"),"Bizagi","warning"):$.when(bizagi.showConfirmationBox(bizagi.localization.getResource("workportal-widget-admincasesearch-invalidate-confirm-msg"),"Bizagi","warning")).done((function(){var a=$("#txtReason",e).val(),s={action:"abort",cases:JSON.stringify(i),reason:a};$.when(t.dataService.abortReassignItems(s)).done((function(i){t.showActionResultFrame(e,i.response,"invalidate")})).fail((function(e){bizagi.log(e)}))}))},showReassignTasksFrame:function(e){var t={cases:[]},i=[];$("input:checkbox[name=workItemAdmin]:checked",e).each((function(){var e=$(this).val();e=e.split("|"),t.cases.push({idCase:e[0],idWorkItem:e[1]}),i.push({taskItem:e[0]+": "+e[2],idWorkItem:e[1]})})),0==i.length?bizagi.showMessageBox(bizagi.localization.getResource("workportal-widget-admincasesearch-reassign-empty-msg"),"Bizagi","warning"):(this.selectedTasks=t,this.selectedTasksToShow=i,this.showReassignForm(e,i))},showReassignForm:function(e,t){this.buttonBackAction="backToCases";var i=$.tmpl(this.reassignFormTmpl,{tasks:t});$("#dinamicContent",e).hide(),$("#dinamicContent2",e).html(i),$("#btn-admin-case-search-clear",e).hide(),$("#btn-admin-case-search",e).hide(),$("#generalTitle").html(bizagi.localization.getResource("workportal-widget-admincasesearch-reassign-title")),this.setupUsersSearchForm()},reassignTasks:function(){var e=this,t=e.getContent(),i={action:"reassignItems",cases:JSON.stringify(e.selectedTasks),idNewUser:e.selectedUserId};$.when(e.dataService.reassignCurrent(i)).done((function(i){e.showActionResultFrame(t,i.response,"reassign")})).fail((function(e){bizagi.log(e)}))},showActionResultFrame:function(e,t,i){var a=t.length>1?"-several":"",s="",n="",o=[];if("invalidate"==(a=i+a))for(var r=0;r<t.length;r++)1==t[r].deleted?(s=t[r].idCase,s+=r+1<t.length?", ":"",o[0]=!0):(n=t[r].idCase,n+=r+1<t.length?", ":"",o[1]=!1);else if("invalidate-several"==a)for(r=0;r<t.length;r++)1==t[r].deleted?(s+=t[r].idCase,s+=r+1<t.length?", ":"",o[0]=!0):(n+=t[r].idCase,n+=r+1<t.length?", ":"",o[1]=!1);else if("reassign"==a)for(r=0;r<t.length;r++)1==t[r].reassigned?(s+=t[r].idCase,s+=r+1<t.length?", ":"",o[0]=!0):(n=t[r].idCase,n+=r+1<t.length?", ":"",o[1]=!1);else if("reassign-several"==a){s+="<br/><br/>",n+="<br/><br/>";for(r=0;r<t.length;r++)1==t[r].reassigned?(s+=t[r].idCase+"<br/>",o[0]=!0):(n+=t[r].idCase+"<br/>",o[1]=!1);s+="<br/>",n+="<br/>"}var l=$.tmpl(this.actionResultContentTmpl,{action:a,resultStatus:o});l=(l=(l=(l=l[0].innerHTML.replace("{0}","<strong>"+s+"</strong>")).replace("{3}","<strong>"+n+"</strong>")).replace("{1}",this.selectedUserName)).replace("{1}",this.selectedUserName),"invalidate"==i&&$("#generalTitle").html(bizagi.localization.getResource("workportal-widget-admincasesearch-invalidate-result-title")),$("#mainForm",e).html(""),$("#dinamicContent",e).css("display","inline"),$("#dinamicContent",e).html(l),$("#dinamicContent2",e).remove(),$("#usersTable",e).remove(),$("#btn-admin-case-back",e).css("display","none"),$("#btn-admin-case-search-clear",e).css("display","none"),$("#btn-admin-case-search",e).css("display","none"),$("#btn-admin-case-finish",e).css("display","inline"),$("#biz-wp-userstable-wrapperform").hide(),$("#biz-wp-userstable-wrapperlist").hide(),this.usersTable.resultStatus=-1==o.indexOf(!1)},setupMainButtons:function(){var e=this,t=e.getContent(),i=$.tmpl(e.buttonContentTmpl,{});t.append(i);var a=$("#case-search-log-data-buttonset",t);$("#btn-admin-case-search-clear",a).click((function(i){$(".biz-wp-input-text",t).val(""),$(".biz-wp-form-datepicker",t).val(""),e.setupProcessTree()})),$("#btn-admin-case-search",a).click((function(i){var a="",s="",n="",o="",r="",l=e.processTree.getTreeRouteSelected();l.length>0&&(2==l.length?(a=l[1],n=l[0],s=""):(a=l[l.length-1],s=l[1],n=l[0]));var c={h_action:"getCases",I_ProcessState:"Running",h_idApp:"",I_Users:"ALL",eventAsTask:!0,orderType:1,order:"",orderField:"",I_radNumber:$("#caseInput").val(),I_idWFClass:n,I_USERFULLNAME:$("#userNameInput").val(),I_USERPOSITION:$("#userPositionInput").val(),I_From__CreationDate:$("#sinceDate").val(),I_To__CreationDate:$("#toDate").val(),h_idWFClassAuth:"",I_idCategory:s,I_idApplication:a,PageSize:e.maxElemShow};""==$("#sinceDate").val()||bizagi.util.isDate($("#sinceDate").val())?""==$("#toDate").val()||bizagi.util.isDate($("#toDate").val())?(e.searchParams=c,e.findResults(t,c)):(o=bizagi.localization.getResource("workportal-general-invalid-date"),r=bizagi.localization.getResource("workportal-widget-admincasesearch-to-date"),o=o.replace("{0}",r),bizagi.showMessageBox(o,"Bizagi","warning")):(o=bizagi.localization.getResource("workportal-general-invalid-date"),r=bizagi.localization.getResource("workportal-widget-admincasesearch-date-since"),o=o.replace("{0}",r),bizagi.showMessageBox(o,"Bizagi","warning"))})),$("#btn-admin-case-back",a).click((function(t){"backToMainForm"==e.buttonBackAction?e.backToMainForm():"backToCases"==e.buttonBackAction&&e.backToCases()})),$("#btn-admin-case-finish",a).click((function(t){e.publish("closeCurrentDialog")}))},backToCases:function(){var e=this.getContent();this.buttonBackAction="backToMainForm",$("#dinamicContent",e).show(),$("#dinamicContent2",e).html(""),$("#usersTable").remove(),$("#generalTitle").html(bizagi.localization.getResource("workportal-widget-admincasesearch-table-title")),$("#btn-admin-case-search-clear",e).hide(),$("#btn-admin-case-search",e).hide()},backToMainForm:function(){var e=this.getContent();$("#mainForm",e).show(),$("#dinamicContent",e).html(""),$("#generalTitle").html(bizagi.localization.getResource("workportal-widget-admincasesearch-subtitle")),$("#btn-admin-case-search-clear",e).show(),$("#btn-admin-case-search",e).show(),$("#btn-admin-case-back",e).css("display","none")},assignEventReassignLinks:function(e,t){this.selectedUserId=e,this.selectedUserName=t,this.reassignTasks()},setupActionsButton:function(e){var t=this;$("#btn-admin-case-invalidate",e).click((function(i){t.invalidateCases(e)})),$("#btn-admin-case-reassign",e).click((function(i){t.showReassignTasksFrame(e)}))},setupActivitiesLink:function(e){var t=this;$(".activityClicked",e).click((function(){t.publish("executeAction",{action:bizagi.workportal.actions.action.BIZAGI_WORKPORTAL_ACTION_ROUTING,idCase:$(this)[0].getAttribute("data-idCase"),idWorkItem:$(this)[0].getAttribute("data-idworkItem"),idTask:$(this)[0].getAttribute("data-idTask")}),t.publish("closeCurrentDialog")})),$(".caseClicked",e).click((function(){t.publish("executeAction",{action:bizagi.workportal.actions.action.BIZAGI_WORKPORTAL_ACTION_ROUTING,idCase:$(this)[0].getAttribute("data-idCase"),idWorkItem:"",idTask:""}),t.publish("closeCurrentDialog")})),$(".cases-column-header",e).click((function(){var i=$(this)[0].getAttribute("data-columnorder"),a=$(this)[0].getAttribute("data-ordertype"),s=$(this)[0].getAttribute("data-columnOrderName");a="1"==a?0:1,t.searchParams.order=i,t.searchParams.orderType=a,t.searchParams.orderField=s,t.findResults(e,t.searchParams,t.searchParams.Page)}))},setupGraphicQueryEvent:function(e){var t=this;$(".biz-wp-diagram-view-icon",e).click((function(){var e=$(this).data("idcase"),i=$(this).data("idworkflow");t.showGraphicQuery({idCase:e,idWorkflow:i})}))}});
//# sourceMappingURL=../../../../Maps/desktop/plans-view.desktop.production.js.map
