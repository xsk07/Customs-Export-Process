bizagi.workportal.widgets.project.base.extend("bizagi.workportal.desktop.widgets.project.plan.activities.form",{},{init:function(t,e,i,a){this._super(t,e,a),this.dateFormat=bizagi.localization.getResource("dateFormat"),this.timeFormat=bizagi.localization.getResource("timeFormat"),this.estimatedFinishDateTime,this.MAX_HOURS=9999999,this.plugins={},this.form={},this.notifier=i,this.loadTemplates({"plan-activities-main":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.activities.form").concat("#project-plan-activities-form"),"plan-activity-items":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.activities.form").concat("#project-activity-items")})},renderContent:function(){var t=this.getTemplate("plan-activities-main");return this.params.plan.contextualized=void 0===this.params.plan.contextualized||this.params.plan.contextualized,this.content=t.render(this.params.plan),this.content},postRender:function(){var t=this,e=t.getContent();t.sub("GETDATA_FORM_EDIT_ACTIVITIY",(function(){return t.getDataActivityForm()})),t.form={name:$("#activity-form-itemname",t.content),description:$("#activity-form-description",t.content),assignee:$("#activity-form-assignee",t.content),date:$("#activity-form-date",t.content),duration:$("#activity-form-duration",t.content),allowEdition:$("#activity-form-allowedition",t.content),sendNotification:$("#activity-form-send-notification",t.content),cancel:$("#project-plan-activity-form-cancel",t.content)},t.initializeAutoComplete(t.form.assignee),t.initializeDatePicker(t.form.date),t.initializeSpiner(t.form.duration),$("#link-add-new-item",e).on("click",$.proxy(t.addNewItem,t)),t.eventsHandler()},initializeItems:function(t){var e=this.getContent(),i=this.getTemplate("plan-activity-items"),a={};a.items=t;var n=i.render(a),o=$(".list-items",e);o.empty().append(n),$(".inputtext",o).on("change",$.proxy(this.onSaveForm,this))},initializeAutoComplete:function(t){var e=this,i=e.dataService.serviceLocator.getUrl("admin-getUsersListForPlans");t.autocomplete({minLength:2,source:function(t,a){$.ajax({url:i,data:{domain:"",userName:"",fullName:t.term,organization:"",pag:1,pagSize:100,orderField:"fullName"},success:function(t){a($.map(t.users,(function(t){return{label:t.user,value:t.idUser}}))),e.fitList()}})},select:function(i,a){var n=a.item.label;return t.val(n),e.form.IdAssignee=a.item.value,e.onSaveForm(i),e.pub("notify",{type:"UPDATE_ACTIVITY_INFO",args:{assignee:e.form.IdAssignee}}),!1},focus:function(){return!1},change:function(t,i){return null===i.item&&(e.form.IdAssignee=null,e.form.assignee.val("")),!1}}),$(window).on("resize.activityAssignee",(function(){$("#activity-form-assignee",e.content).blur()}))},fitList:function(){setTimeout((function(){var t=$("body > ul.ui-autocomplete"),e=$(window).height()-$(t).position().top-10;$(t).css({"max-height":e+"px",overflow:"auto"})}))},initializeDatePicker:function(t){var e=this;t.datepicker({onSelect:function(){e.form.duration.val("");e.estimatedFinishDateTime=e.form.date.datepicker("getDate")?e.form.date.datepicker("getDate").getTime()+86399950:void 0,e.onSaveForm()},onClose:function(){""===t.val()&&e.fieldDurationActive(!0)}}),t.datepicker("option","dateFormat",bizagi.util.dateFormatter.getDateFormatByDatePickerJqueryUI())},initializeSpiner:function(t){var e,i=this,a=bizagi.clone(i.params.plan.idActivitySelected);function n(t,e){var a=e||$(t.target).val();bizagi.util.isNumeric(a)&&parseInt(a,10)>0?(i.form.date.val(""),i.estimatedFinishDateTime=void 0):$(t.target).val("")}t.spinner({min:1,max:i.MAX_HOURS,placeHolder:bizagi.localization.getResource("workportal-hours"),change:function(t){n(t),a===i.params.plan.idActivitySelected&&i.onSaveForm()},spin:function(t,a){n(t,a.value),clearTimeout(e),$("#myInput").val&&(e=setTimeout($.proxy(i.onSaveForm,i),500))}})},onKeyPressInputItem:function(t){var e=this.getContent();setTimeout((function(){$(t.target).siblings(".showtext").text($(t.target).val()),$(t.target).prop("title",$(t.target).val())}),51);var i=t.keyCode||t.which;function a(){setTimeout((function(){$(".list-items .item.edit",e).find(".inputtext").focus();var t=$(".list-items .item.edit",e).find(".inputtext").val();$(".list-items .item.edit",e).find(".inputtext").val(t)}),51)}function n(t){$(t.target).closest(".item").removeClass("edit"),$(t.target).closest(".item").next().addClass("edit"),a()}function o(t){$(t.target).closest(".item").removeClass("edit"),$(t.target).closest(".item").prev().addClass("edit"),a()}switch($(".container-items").removeClass("editing-mouse"),i.toString()){case"13":if(""!==$(t.target).val()){$(t.target).closest(".item").removeClass("edit");var s=$(t.target).closest(".item").index();this.addNewItem("",s)}break;case"27":0!==$(t.target).closest(".item").prev().length?o(t):0!==$(t.target).closest(".item").next().length&&n(t),$(t.target).closest(".item").remove(),this.onSaveForm(t);break;case"38":0!==$(t.target).closest(".item").prev().length&&o(t);break;case"40":0!==$(t.target).closest(".item").next().length&&n(t)}},onFocusInputItem:function(t){$(t.target).closest(".item").addClass("edit").siblings().removeClass("edit")},onFocusOutInputItem:function(t){if(""===$.trim($(t.target).val())){var e=$(t.target).closest(".item");$(e).css("display","block").empty().css("background","#E7BA99").animate({backgroundColor:"#FFF",height:"0px"},300,"linear",(function(){$(this).remove()}))}else $(t.target).closest(".item").removeClass("edit")},onMouseLeaveItem:function(){var t=this.getContent();$(".container-items",t).addClass("editing-mouse")},onClickDeleteItem:function(t){$(t.target).closest(".item").off("keyup",".inputtext",$.proxy(this.onKeyPressInputItem,this)),$(t.target).closest(".item").off("click",".item-button.delete",$.proxy(this.onClickDeleteItem,this)),$(t.target).closest(".item").remove(),this.onSaveForm(t)},addNewItem:function(t,e){var i=this.getContent();void 0===e&&-1===(e=$(".list-items .item",i).length-1)&&(e=0);var a={items:[{}]},n=this.getTemplate("plan-activity-items").render(a);$(n).addClass("edit"),0===$(".list-items",i).children().length?$(".list-items",i).append(n):$(".list-items",i).children().eq(e).after(n),$(".inputtext",n).on("change",$.proxy(this.onSaveForm,this)),setTimeout((function(){$(".list-items .item.edit",i).find(".inputtext").focus()}),51)},onDeleteDate:function(t){8===t.keyCode&&($(t.target).val(""),this.fieldDurationActive(!0))},onTypeDuration:function(t){var e=$(t.target);""!==e.val()&&(e.val(bizagi.util.getOnlyNumbersByString(e.val())),this.validateMaxHoursDurationField(e),this.form.date.val(""),this.estimatedFinishDateTime=void 0)},onCancelForm:function(){this.pub("notify",{type:"PLANSIDEBAR",args:this.params})},onSaveForm:function(t){t&&t.preventDefault();var e=this;return _defer=new $.Deferred,dataFormActivity=e.getDataActivityForm(),resolve=_defer.resolve.bind(null,dataFormActivity),dataFormActivity?$.when(e.dataService.editActivityPlan(dataFormActivity)).always((function(t,i,a){200===a.status&&"success"!==i?(e.notifier.showSucessMessage(printf(bizagi.localization.getResource("workportal-project-plan-activity-update-message"),"")),_defer.reject(i)):resolve()})):_defer.reject(),_defer.done(e.onChangeActivityName.bind(e)),_defer},getDataActivityForm:function(){var t=this;if(t.validateParams(t.form.name.val())){var e=t.form.IdAssignee||bizagi.currentUser.idUser,i=t.form.allowEdition.is(":checked")||!1,a=t.form.sendNotification.is(":checked"),n={};return $.each(t.params.plan.activities,(function(){var o;this.id===t._idActivitySelected()&&(t.form.duration.val(bizagi.util.getOnlyNumbersByString(t.form.duration.val())),t.validateMaxHoursDurationField(t.form.duration),this.duration=t.form.duration.val(),this.userAssigned=e,this.userAssignedGuid=e,this.allowEdition=i,this.sendNotification=a,this.description=t.form.description.val(),this.name=t.form.name.val(),this.estimatedFinishDate=t.estimatedFinishDateTime,this.items=(o=[],$(".list-items .inputtext").each((function(){""!==$(this).val().trim()&&o.push({id:void 0,resolved:$(this).closest(".item").find("input[type='checkbox']").is(":checked"),name:$(this).val()})})),o),this.numTotalItems=this.items.length,n=this)})),n}return!1},validateParams:function(t){if(""===t){var e="* "+bizagi.localization.getResource("workportal-project-plan-popup-field-name-required");return this.form.name.next().find("span").html(e),!1}return this.form.name.next().find("span").empty(),!0},_idActivitySelected:function(t){return void 0!==t&&(this._idActivitySelectedValue=t),this._idActivitySelectedValue},onChangeForm:function(t,e){var i=this;(void 0!==i._idActivitySelected()?i.onSaveForm():function(){var t=new $.Deferred;return t.resolve(),t}()).done((function(){i.estimatedFinishDateTime=void 0;var t=e.args.idActivityToShow||i.params.plan.idActivitySelected;i._idActivitySelected(t);var a=i.params.plan.activities.filter((function(e){return e.id===t}))[0];i.setValuesFormFields(e.args.isEditableFormActivity,a),i.setEnabledFormFields(e.args.isEditableFormActivity,a)}))},onChangeActivityName:function(t){this.pub("notify",{type:"UPDATE_ACTIVITY_INFO",args:{displayName:t.name,id:t.id}})},setEnabledFormFields:function(t,e){$(this.form.date).blur(),t?($(".ui-bizagi-wp-project-plan-activity-action-menu",this.content).show(),$("#activity-form-itemname",this.content).prop("disabled",!1),$("#activity-form-itemname",this.content).removeClass("ui-state-disabled"),$("#activity-form-description",this.content).prop("disabled",!1),$("#activity-form-description",this.content).removeClass("ui-state-disabled"),this.form.assignee.removeClass("ui-state-disabled"),this.activateElement(this.form.assignee),this.fieldDurationActive(!0),this.activateElement(this.form.date),this.form.date.removeClass("ui-state-disabled"),$("#activity-form-allowedition",this.content).prop("disabled",!1),$("#activity-form-send-notification",this.content).prop("disabled",!1),$(".container-items",this.content).addClass("is-editing"),$("#link-add-new-item",this.content).show()):($(".ui-bizagi-wp-project-plan-activity-action-menu",this.content).hide(),$("#activity-form-itemname",this.content).prop("disabled",!0),$("#activity-form-itemname",this.content).addClass("ui-state-disabled"),$("#activity-form-description",this.content).prop("disabled",!0),$("#activity-form-description",this.content).addClass("ui-state-disabled"),this.form.assignee.addClass("ui-state-disabled"),this.deactivateElement(this.form.assignee),this.deactivateElement(this.form.date),this.form.date.addClass("ui-state-disabled"),this.fieldDurationActive(!1),$("#activity-form-allowedition",this.content).prop("disabled",!0),$("#activity-form-send-notification",this.content).prop("disabled",!0),$(".container-items",this.content).removeClass("is-editing"),$("#link-add-new-item",this.content).hide())},setValuesFormFields:function(t,e){var i=e&&!bizagi.util.isEmpty(e.estimatedFinishDate)?e.estimatedFinishDate:"",a=i?bizagi.util.dateFormatter.getDateFromInvariant(i):"";isNaN(e.estimatedFinishDate)||(a=new Date(e.estimatedFinishDate));var n=a instanceof Date&&a.getTime()<this.getDateServer();$("#project-plan-activity-form",this.content)[0].reset(),$(".list-items .item",this.content).remove(),this.form.name.val(bizagi.util.decodeHtmlEntities(e.name)),this.form.description.val(bizagi.util.decodeHtmlEntities(e.description)),e.userAssigned&&this.setUserAssignedIDGuid(e.userAssigned,e.userAssignedGuid),this.form.date.datepicker("option","minDate",new Date(this.getDateServer())),e.estimatedFinishDate&&n&&this.form.date.datepicker("option","minDate",a),e.estimatedFinishDate&&(this.form.date.datepicker("setDate",a),this.estimatedFinishDateTime=e.estimatedFinishDate),e.duration&&this.form.duration.val(parseInt(e.duration,10)),this.params.plan.parent&&!1===this.params.plan.parent.allowEdition?(e.allowEdition=!1,this.form.allowEdition.parent().hide()):this.form.allowEdition.parent().show(),!0===e.allowEdition?this.form.allowEdition.prop("checked",!0):this.form.allowEdition.prop("checked",!1),!0===e.sendNotification?this.form.sendNotification.prop("checked",!0):this.form.sendNotification.prop("checked",!1),e.numTotalItems>0?($(".container-items h4",this.content).show(),$(".container-items span",this.content).hide(),this.initializeItems(e.items)):t?$(".container-items span",this.content).hide():$(".container-items span",this.content).show()},validateMaxHoursDurationField:function(t){""!==bizagi.util.getOnlyNumbersByString(t.val())&&parseInt(t.val())>this.MAX_HOURS&&t.val(this.MAX_HOURS)},fieldDurationActive:function(t){t?(this.form.duration.prop("disabled",!1),this.form.duration.spinner("option","disabled",!1)):(this.form.duration.prop("disabled",!0),this.form.duration.spinner("option","disabled",!0))},deactivateElement:function(t){t.prop?(t.prop("disabled",!0),t.closest("tr").addClass("ui-bizagi-workportal-opacity")):(t.enable(!1),t.wrapper.closest("tr").addClass("ui-bizagi-workportal-opacity"))},activateElement:function(t){t.prop?(t.prop("disabled",!1),t.closest("tr").removeClass("ui-bizagi-workportal-opacity")):(t.enable(!0),t.wrapper.closest("tr").removeClass("ui-bizagi-workportal-opacity"))},setUserAssignedIDGuid:function(t,e){var i=this;i.callGetDataUsers(t).then((function(t){i.form.assignee.val(t[0].name)})),i.form.IdAssignee=t},eventsHandler:function(){var t=this;t.form.date.on("keydown",$.proxy(t.onDeleteDate,t)),t.form.duration.on("keyup",$.proxy(t.onTypeDuration,t)),t.form.cancel.on("click",$.proxy(t.onCancelForm,t)),t.form.name.on("change",$.proxy(t.onSaveForm,t)),t.form.name.on("blur",$.proxy(t.onSaveForm,t)),t.form.description.on("change",$.proxy(t.onSaveForm,t)),t.form.allowEdition.on("change",$.proxy(t.onSaveForm,t)),t.form.sendNotification.on("change",$.proxy(t.onSaveForm,t)),t.form.description.donetyping((function(){t.onSaveForm()})),t.form.duration.donetyping((function(){t.onSaveForm()})),$(".list-items",t.content).on("keyup",".inputtext",$.proxy(t.onKeyPressInputItem,t)),$(".list-items",t.content).on("focusout",".inputtext",$.proxy(t.onFocusOutInputItem,t)),$(".list-items",t.content).on("focus",".inputtext",$.proxy(t.onFocusInputItem,t)),$(".list-items",t.content).on("click",".item-button.delete",$.proxy(t.onClickDeleteItem,t)),$(".list-items",t.content).on("mouseleave",".item",$.proxy(t.onMouseLeaveItem,t)),t.sub("EDITACTIVITY",$.proxy(t.onChangeForm,t))},callGetDataUsers:function(t){var e=$.Deferred(),i={usersGuids:t,width:50,height:50};return this.dataService.getUsersData(i).always((function(t){e.resolve(t)})),e.promise()},clean:function(){this.unsub("EDITACTIVITY",$.proxy(this.onChangeForm,this)),$(window).off("resize.activityAssignee")}}),bizagi.injector.register("bizagi.workportal.desktop.widgets.project.plan.activities.form",["workportalFacade","dataService","notifier",bizagi.workportal.desktop.widgets.project.plan.activities.form],!0);
//# sourceMappingURL=../../../../Maps/desktop/editactivity.desktop.production.js.map
