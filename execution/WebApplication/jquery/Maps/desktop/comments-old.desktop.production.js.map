{"version":3,"sources":["jquery/workportal/js/base/widget/bizagi.workportal.widgets.comments.js"],"names":["bizagi","workportal","comments","renderComments","data","self","this","cache","htmlContent","def","$","Deferred","_Comments","_getRenderCommentList","_currentUser","currentUser","idUser","commentsCanvas","canvas","readOnly","setStorage","caseNumber","workportalFacade","getTemplate","commentsList","commentsReplies","commentsDropdown","commentsConfirm","showComments","getCommentSync","commentsToSync","maxIdComment","when","getComments","idCase","done","users","getCategoryColor","category","color","hideReplies","ul","children","slideUp","parent","removeClass","replyToggle","li","replies","button","length","addClass","timeAgo","commentTime","timeago","Date","getUserPicture","image","each","key","value","Picture","getUserName","name","DisplayName","resetRepliesFlags","getRenderCommentList","usr","totalRecords","setPagination","totalPages","actualPage","tmpl","User","CurrentUser","RelatedElementId","replaceTextToSmiles","params","selector","hasPagination","page","pageSelector","paginationData","pagination","pages","empty","show","hide","pageToshow","i","push","pageNumber","paginationHtml","paginationTemplate","html","append","bizagiPagination","listElement","clickCallBack","options","idColorCategory","pag","renderCommentList","appendTo","hideAllReplies","util","setInterval","context","singleton","timeout","killWhenExitContext","getWidgetName","call","getStorage","dataService","getNewComments","idLastComment","numberOfNewComments","newComments","newReplies","totalNewComments","bufferLocalNewComments","newMessage","replace","text","click","e","isPropagationStopped","stopPropagation","getCategoryName","resources","getResource","renderCommentsPanel","tooltip","find","off","slideDown","focus","fadeIn","blur","val","message","listId","list","makeNewReply","idComment","comment","dataNewComment","incrementStorage","newReply","Replies","renderCommentsReplies","makeNewComment","newComment","prepend","categoryClose","delegate","keyCode","selfParent","oldIcon","attr","oldText","newText","siblings","iconCategory","filterTextColor","hasClass","removeAttr","renameCommentCategory","colorName","selfParentItem","selfParentLength","showDropDownMenu","menu","referer","css","position","my","at","collision","of","getCommentsCategories","categories","renderDropDownMenu","bind","getIdCase","oldVal","split","editControls","select","categoryId","filterText","trim","setCommentCategory","target","on","id","textForReply","first","parents","liId","dialog","resizable","modal","title","buttons","removeReply","idReply","state","evalState","removeComment","action","remove","alert","desktop","popup","closePopupInstance","replyToggleBotton","resolve","promise","callBack","parseMessage","preParseMessage","securityPatterns","<br>","[<]","[>]","pattern","RegExp",":)",":!",":$",":(",":'(",";)",":|",":D",":o",":p",":s"," Y "," N ","scapeKey","label","result","sessionStorage","setItem","increment","newValue","parseInt","undefined","getItem"],"mappings":"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","sourcesContent":["/**\r\n * @name: Bizagi workportal comments\r\n * @description: This file define functionality of comments into the render\r\n * @author: Edward J Morales\r\n */\n\n\nbizagi.workportal.comments = {\n  /**\r\n                                * Make functionality to comments tab in case summary\r\n                                */\n  renderComments: function renderComments(data) {\n    var self = this;\n    var cache = {};\n    var htmlContent = \"\";\n    var def = new $.Deferred();\n    var _Comments = {};\n    var _getRenderCommentList = -1;\n    var _currentUser = bizagi.currentUser.idUser;\n    var commentsCanvas = data.canvas;\n    var readOnly = data.readOnly || false;\n\n    self.setStorage('bufferLocalNewComments_' + data.caseNumber, 0);\n    self.setStorage('idCase', data.caseNumber);\n\n    // Templates definition\n    self.comments = self.workportalFacade.getTemplate(\"comments\");\n    self.commentsList = self.workportalFacade.getTemplate(\"comments-list\");\n    self.commentsReplies = self.workportalFacade.getTemplate(\"comments-replies\");\n    self.commentsDropdown = self.workportalFacade.getTemplate(\"comments-dropdown\");\n    self.commentsConfirm = self.workportalFacade.getTemplate(\"comments-confirm\");\n\n    data.showComments = true;\n\n    var getCommentSync = function getCommentSync(commentsToSync) {\n      _Comments = commentsToSync.comments;\n      self.setStorage('maxIdComment_' + data.caseNumber, commentsToSync.maxIdComment);\n      self.setStorage('bufferLocalNewComments_' + data.caseNumber, 0);\n    };\n\n\n    $.when(\n    self.getComments({\n      idCase: data.caseNumber },\n    getCommentSync)).\n    done(function (comments) {\n      var users = comments.users || [];\n      var getCategoryColor = function getCategoryColor(category) {\n        var color = \"\";\n        switch (category) {\n          case 0:\n            color = \"orange\";\n            break;\n          case 1:\n            color = \"red\";\n            break;\n          case 2:\n            color = \"yellow\";\n            break;\n          case 3:\n            color = \"blue\";\n            break;\n          case 4:\n            color = \"purple\";\n            break;\n          case 5:\n            color = \"green\";\n            break;\n          default:\n            color = \"disable\";\n            break;}\n\n        return color;\n      };\n\n      var showReplies = function showReplies(ul) {\n        $(ul).children('li:not(:last)').slideDown('fast');\n      };\n\n      // This function hide all replies except the last\n      var hideReplies = function hideReplies(ul) {\n        $(ul).children('li:not(:last)').slideUp('fast');\n        $(\"span.reply-toggler > span\", ul.parent()).removeClass(\"expanded\");\n      };\n\n      // Show or hide toggle button\n      var replyToggle = function replyToggle(li) {\n        var replies = $(\".reply-list li\", li) || [];\n        var button = $(\".reply-toggler\", li);\n        if (replies.length > 1) {\n          button.removeClass('hidden');\n        } else {\n          button.addClass('hidden');\n        }\n      };\n\n      // Calculate time ago\n      var timeAgo = function timeAgo(commentTime) {\n        return $.timeago(new Date(commentTime));\n      };\n\n      // Get base64 user image\n      var getUserPicture = function getUserPicture(idUser) {\n        var image = \"\";\n        $.each(users, function (key, value) {\n          if (users[key]['Id'] == idUser) {\n            image = value.Picture;\n          }\n        });\n        return image;\n      };\n\n      var getUserName = function getUserName(idUser) {\n        var name = \"\";\n        $.each(users, function (key, value) {\n          if (users[key]['Id'] == idUser) {\n            name = value.DisplayName;\n          }\n        });\n        return name;\n      };\n\n      // Reset replies flags\n      var resetRepliesFlags = function resetRepliesFlags() {\n        $(\".comments-text-box\").removeClass('comments-reply-box');\n        $(\".comments-text-box li:first-child\").data('reply-mode', '');\n        $(\".comments-text-box li:first-child\").data('id', '');\n      };\n\n      var countReplies = function countReplies(comments) {\n        var countReplies = 0;\n        $.each(comments.comments, function (key, value) {\n          countReplies += value.Replies.length;\n        });\n      };\n\n      var renderCommentsPanel = function renderCommentsPanel(comments, usr) {\n        _Comments.totalRecords = comments.totalRecords;\n        users = usr;\n\n        return $.tmpl(self.comments, {\n          comments: comments.comments,\n          readOnly: readOnly,\n          User: users,\n          idCase: data.caseNumber,\n\n          CurrentUser: _currentUser,\n          RelatedElementId: null,\n          getCategoryColor: getCategoryColor,\n          replaceTextToSmiles: self.replaceTextToSmiles,\n          timeAgo: timeAgo,\n          getUserPicture: getUserPicture,\n          getUserName: getUserName,\n          getCategoryName: function getCategoryName(name) {\n            return self.resources.getResource(\"workportal-widget-comments-\" + name);\n          } });\n\n      };\n\n      var getRenderCommentList = function getRenderCommentList(data, usr) {\n        _Comments.totalRecords = comments.totalRecords;\n        users = usr;\n\n        // Render Pagination\n        setPagination({\n          totalPages: data.totalPages,\n          actualPage: data.actualPage });\n\n\n        return $.tmpl(self.commentsList, {\n          comments: data.comments,\n          User: users,\n          CurrentUser: _currentUser,\n          RelatedElementId: null,\n          getCategoryColor: getCategoryColor,\n          replaceTextToSmiles: self.replaceTextToSmiles,\n          timeAgo: timeAgo,\n          getUserPicture: getUserPicture,\n          getUserName: getUserName,\n          readOnly: readOnly });\n\n      };\n\n      var renderCommentsReplies = function renderCommentsReplies(data, usr) {\n        _Comments.totalRecords = comments.totalRecords;\n        users = usr;\n\n        return $.tmpl(self.commentsReplies, {\n          Replies: data.Replies,\n          User: users,\n          CurrentUser: _currentUser,\n          RelatedElementId: null,\n          getCategoryColor: getCategoryColor,\n          replaceTextToSmiles: self.replaceTextToSmiles,\n          timeAgo: timeAgo,\n          getUserPicture: getUserPicture,\n          getUserName: getUserName,\n          readOnly: readOnly });\n\n      };\n\n      var renderDropDownMenu = function renderDropDownMenu(options) {\n        return $.tmpl(self.commentsDropdown, {\n          categories: options.categories,\n          css: options.css,\n          idComment: options.idComment,\n          getCategoryColor: getCategoryColor,\n          readOnly: readOnly });\n\n      };\n\n      var setPagination = function setPagination(params, selector) {\n        var totalPages = params.totalPages || 1;\n        var hasPagination = totalPages > 1 ? true : false;\n        var nElemToShow = 5;\n        var page = params.actualPage || 1;\n        var pageSelector = $('.comments-pagination') || selector;\n        var paginationData = {};\n        paginationData.pagination = hasPagination;\n        paginationData.totalPages = totalPages;\n        paginationData.pages = [];\n        paginationData.page = page;\n\n        // Empty container of pagination\n        pageSelector.empty();\n\n        if (hasPagination) {\n          pageSelector.show();\n        } else {\n          pageSelector.hide();\n        }\n\n        var pageToshow = nElemToShow > totalPages ? totalPages : nElemToShow;\n        for (var i = 1; i <= pageToshow; i++) {\n          paginationData.pages.push({\n            \"pageNumber\": i });\n\n        }\n\n        var paginationHtml = $.tmpl(self.paginationTemplate, paginationData).html();\n        $(pageSelector).append(paginationHtml);\n\n        // Crate pagination control \n        $(\"ul\").bizagiPagination({\n          totalPages: paginationData.totalPages,\n          actualPage: paginationData.page,\n          listElement: $(\"ul\", pageSelector),\n          clickCallBack: function clickCallBack(options) {\n            $.when(self.getComments({\n              idCase: data.caseNumber,\n              idColorCategory: _getRenderCommentList,\n              pag: options.page })).\n\n            done(function (comments) {\n              renderCommentList(comments, comments.users, true);\n            });\n          } });\n\n      };\n\n      var renderCommentList = function renderCommentList(comments, users) {\n        _Comments.totalRecords = comments.totalRecords;\n        // Empty list\n        $(\"#comment-list\").empty();\n\n        htmlContent = getRenderCommentList(comments, users);\n\n        htmlContent.appendTo($(\"#comment-list\"));\n        cache[\"subprocess\"] = $(\"#comment-list\");\n        hideAllReplies();\n\n        return htmlContent;\n      };\n\n      // Check new comments\n      if (!readOnly) {\n        bizagi.util.setInterval({\n          name: 'comments',\n          params: {\n            idCase: bizagi.context.idCase },\n\n          singleton: true,\n          timeout: 30000,\n          killWhenExitContext: false,\n          context: '(bizagi.context.widget==\"' + self.getWidgetName() + '\" && bizagi.context.idCase == \"' + data.caseNumber + '\" && bizagi.context.commentsFocus)',\n          call: function call(options) {\n            options = options || {};\n            var maxIdComment = self.getStorage('maxIdComment_' + options.idCase);\n\n            $.when(self.dataService.getNewComments({\n              idCase: options.idCase,\n              idLastComment: maxIdComment })).\n\n            done(function (numberOfNewComments) {\n              if (numberOfNewComments.newComments > 0 || numberOfNewComments.newReplies > 0) {\n                var totalNewComments = numberOfNewComments.newComments + numberOfNewComments.newReplies;\n                var bufferLocalNewComments = self.getStorage('bufferLocalNewComments_' + options.idCase) || totalNewComments;\n                var newMessage = $(\".comments-update\").data('message').replace(/{totalNewComments}/, totalNewComments - bufferLocalNewComments);\n\n                // Check if total of new comments its equal to local added comments\n                if (totalNewComments > bufferLocalNewComments) {\n                  $(\".comments-update\").text(newMessage);\n                  $(\".comments-update\").show().click(function (e) {\n                    if (e.isPropagationStopped())\n                    return;\n                    e.stopPropagation();\n                    $('#filterClear').click();\n                  });\n                }\n              }\n            });\n          } });\n\n      }\n\n      htmlContent = renderCommentsPanel(comments, users);\n\n      // Tooltip for category button\n      $(\".comment-frame .button-category\", htmlContent).tooltip();\n\n      // Remove all 'live' events\n      $(htmlContent).find(\"*\").off('click');\n\n      // Refresh all comments \n      $('.button-refresh', htmlContent).click(function () {\n        $('.comments-update').hide();\n        // Get json and render again \n        $.when(\n        self.getComments({\n          idCase: data.caseNumber,\n\n          idColorCategory: _getRenderCommentList },\n        getCommentSync)).\n        done(function (comments) {\n          var users = comments.users || [];\n\n          // Empty list\n          $(\"#comment-list\").empty();\n\n          htmlContent = renderCommentList(comments, users);\n\n          htmlContent.appendTo($(\"#comment-list\"));\n          cache[\"subprocess\"] = $(\"#comment-list\");\n          hideAllReplies();\n        });\n      });\n\n      // Show textarea to create a new comment\n      $(\".make-new-comments\", htmlContent).click(function () {\n        resetRepliesFlags();\n        $(\".comments-text-box li:first-child\").slideDown('fast');\n        $(\".comment-box\", htmlContent).focus().fadeIn();\n        $(this).hide();\n        $(\".action-buttons\").show().slideDown('fast');\n        $(\".text-to-reply\").hide();\n      });\n\n      // Cancel new message\n      $(\".comment-box\", htmlContent).blur(function () {\n        var message = $(\".comments-text-box textarea\").val();\n\n        if (message.length == 0) {\n          $(\".comments-text-box textarea\").val('');\n          $(\".comments-text-box li:first-child\").slideUp('fast');\n          $(\".make-new-comments\").fadeIn();\n          $(\".action-buttons\").hide();\n\n          resetRepliesFlags();\n        }\n      });\n\n      // Send a new message\n      $(\".send-new-comments\", htmlContent).click(function () {\n        var message = $(\".comments-text-box textarea\").val();\n\n        if (message.length == 0) {\n          return;\n        }\n\n        // Create new reply\n        if ($(\".comments-text-box li:first-child\").data('reply-mode') == \"true\") {\n          var listId = $(\".comments-text-box li:first-child\").data('id');\n          var list = $(\"li[data-id='\" + listId + \"']\");\n          $.when(self.dataService.makeNewReply({\n            idCase: data.caseNumber,\n\n            idComment: listId,\n            comment: message })).\n          done(function (dataNewComment) {\n            // Increment global control of local new messages\n            self.incrementStorage('bufferLocalNewComments_' + data.caseNumber, 1);\n\n            var newReply = renderCommentsReplies(dataNewComment, dataNewComment.users);\n\n            $(\".reply-list\", list).append(newReply);\n            $(\".reply-list li:last\", list).show('highlight', 'slow');\n\n            hideReplies($(\".reply-list\", list));\n            replyToggle($(list));\n          });\n        } else {\n          // create new comment\n          $.when(self.dataService.makeNewComment({\n            idCase: data.caseNumber,\n\n            comment: message })).\n          done(function (dataNewComment) {\n            // Increment global control of local new messages\n            self.incrementStorage('bufferLocalNewComments_' + data.caseNumber, 1);\n\n            var newComment = getRenderCommentList(dataNewComment, dataNewComment.users);\n\n            $(\".reply-toggler\", newComment).addClass('hidden');\n            $(\"#comment-list\").prepend(newComment);\n            $(\"#comment-list li:first\").show('highlight', 'fast');\n\n          });\n        }\n\n        $(\".comments-text-box li:first-child\").slideUp('fast');\n        $(\".make-new-comments\").show();\n        $(\".action-buttons\").hide();\n        $(\".comments-text-box textarea\").val('');\n        $(\".time-ago\").timeago();\n\n        resetRepliesFlags();\n      });\n\n      // Edit controls for categories\n      var categoryEdit = function categoryEdit() {\n        var self = $(this),\n        selfParent = self.parent(),\n        oldVal = selfParent.text().replace(/^\\s+|\\s+$/g, ''), // Trim, remove blank spaces\n        oldIcon = self.siblings('a').children('span').attr('class').split(' ')[1],\n        oldText = selfParent.html(),\n        editControls = '<input type=\"text\" class=\"editBox\" value=\"' + oldVal + '\" /> <span class=\"filter-icon-ctrl btnSave\"></span> <span class=\"filter-icon-ctrl btnDiscard\"></span>';\n\n        selfParent.attr('data-old-icon', oldIcon);\n        selfParent.html(editControls).attr('data-old-text', oldText).addClass('no-pad');\n        $('.editBox').select();\n      };\n\n      $(htmlContent).delegate('.editBox', 'keypress', function (e) {\n        if (e.keyCode == 13) {\n          $(this).parent().find('.btnSave').click();\n        }\n      });\n\n      // Save text of category changes\n      $(htmlContent).delegate('.btnSave', 'click', function () {\n        var selfParent = $(this).parent(),\n        oldIcon = selfParent.attr('data-old-icon'),\n        oldText = selfParent.attr('data-old-text'),\n        newText = $(this).siblings('.editBox').val(),\n        iconCategory = selfParent.html(oldText).find('a span.filter-icon'),\n        filterTextColor = $('#filterText').attr('class'),\n        filterTextDisable = $('#filterText').hasClass('disable');\n\n        if (!filterTextDisable && oldIcon === filterTextColor) {\n          $('#filterText', htmlContent).text(newText);\n          $('.filter-dropdown').removeClass('is-visible').addClass('is-hidden');\n        }\n\n        selfParent.removeAttr('data-old-text').html(oldText).find('a').empty().append(iconCategory, newText).removeClass('no-pad');\n\n        self.dataService.renameCommentCategory({\n          idColorCategory: selfParent.data(\"category-id\"),\n          colorName: newText });\n\n      });\n\n      // Discard text of category changes\n      $(htmlContent).delegate('.btnDiscard', 'click', function () {\n        var selfParent = $(this).parent(),\n        selfParentLength = selfParent.length,\n        i = 0,\n        selfParentItem,\n        oldText;\n        for (; i < selfParentLength; i++) {\n          selfParentItem = selfParent[i];\n          oldText = $(selfParentItem).attr('data-old-text');\n          $(selfParentItem).removeAttr('data-old-text').html(oldText).removeClass('no-pad');\n        }\n      });\n\n      // Close the category dropdown\n      function categoryClose() {\n        $(\".categories-dropdownmenu\").empty();\n        $(\".categories-dropdownmenu\").data('visible', false);\n      }\n\n      /**\r\n         *  Show sub menu with colors categories \r\n         *  @param options {referer,position}\r\n         */\n      var showDropDownMenu = function showDropDownMenu(options) {\n        var menu = $('.categories-dropdownmenu');\n        var referer = options.referer || $();\n        var css = options.css || '';\n        var idComment = options.idComment || '';\n        var position = options.position || {\n          \"my\": \"right top\",\n          \"at\": \"right top\",\n          \"collision\": \"fit\",\n          \"of\": referer.selector || referer };\n\n\n        if (menu.data('name') != options.name) {\n          categoryClose();\n          menu.data('name', options.name || '');\n          showDropDownMenu(options);\n        } else if (menu.data('visible')) {\n          categoryClose();\n        } else {\n          $.when(self.dataService.getCommentsCategories()).\n          done(function (categories) {\n            menu.empty();\n            // Set position\n            menu.position(position);\n\n            renderDropDownMenu({\n              categories: categories.categories,\n              css: css,\n              idComment: idComment,\n              referer: referer }).\n            appendTo(menu);\n            // Set visibility\n            menu.data('visible', true);\n            menu.data('name', options.name || '');\n          });\n        }\n      };\n\n      // Set events to button filter categories\n      $(\"#buttonFilter\", htmlContent).bind(\"click\", function () {\n        var self = this;\n        var options = {\n          referer: $(\"#buttonFilter\", htmlContent),\n          name: 'editCategories',\n          css: 'editCategories' };\n\n\n        if (readOnly) {\n          options.position = {\n            \"my\": \"left bottom\",\n            \"at\": \"left bottom\",\n            \"collision\": \"fit\",\n            \"of\": self };\n\n        }\n        showDropDownMenu(options);\n      });\n\n\n      var getIdCase = function getIdCase() {\n        return $('.comment-controls').data('idcase');\n      };\n\n      var setEventFilterCategory = function setEventFilterCategory(e) {\n        if (e.isPropagationStopped()) {\n          return;\n        }\n        var categoryId = $(this).parent().data('category-id');\n        var name = $('.categories-dropdownmenu').data('name');\n        var filterText = bizagi.util.trim($(this).text());\n\n        if (name == 'setCategories') {\n          var idComment = $(this).data('idcomment');\n\n          $.when(self.dataService.setCommentCategory({\n            idCase: getIdCase,\n            idColorCategory: categoryId,\n            idComment: idComment })).\n\n          done(function () {\n            $(\"#\" + idComment).removeClass();\n            $(\"#\" + idComment).addClass(\"button-category\");\n            $(\"#\" + idComment).addClass(getCategoryColor(categoryId));\n            categoryClose();\n          });\n        } else {\n          // Filter by category\n          $.when(self.dataService.getComments({\n            idCase: getIdCase,\n            idColorCategory: categoryId })).\n\n          done(function (data) {\n            var target = $(\".comment-filter > #buttonFilter\");\n            if (categoryId >= 0) {\n              // Set filter name\n              _getRenderCommentList = categoryId;\n              $('.button-refresh').data('category-id', categoryId);\n              $('#filterName').removeClass('is-hidden');\n              $(\"#filterText\").text(filterText);\n            } else {\n              $('#filterName').addClass('is-hidden');\n              $(\"#filterText\").text(\"\");\n              _getRenderCommentList = -1;\n            }\n\n            $('#comment-list').empty();\n            $('#comment-list').append(getRenderCommentList(data, data.users));\n\n            // Set Color \n            target.removeClass();\n            target.addClass('button-category ' + getCategoryColor(categoryId));\n            categoryClose();\n            // Set category to refresh bottom\n            $('.button-refresh').data('category-id', categoryId);\n            hideAllReplies();\n            $('.button-refresh').click();\n\n          });\n        }\n        e.stopPropagation();\n      };\n\n      var setEventFilterClear = function setEventFilterClear() {\n        $('#filterClear').bind('click', function (e) {\n          if (e.isPropagationStopped()) {\n            return;\n          }\n          e.stopPropagation();\n          _getRenderCommentList = -1;\n          $(\".comment-filter > #buttonFilter\").removeClass();\n          $(\".comment-filter > #buttonFilter\").addClass('button-category ' + getCategoryColor());\n\n          // Set category to refresh bottom\n          $('.button-refresh').data('category-id', '');\n          $('#filterName').addClass('is-hidden');\n          $('#filterText').text('');\n          $('.button-refresh').click();\n        });\n      };\n\n\n      $(htmlContent).delegate('.close', 'click', categoryClose);\n      $(htmlContent).delegate('.btnEdit', 'click', categoryEdit);\n      $(htmlContent).delegate('.filter-category', 'click', setEventFilterCategory);\n      $(htmlContent).delegate('#filterClear', 'click', setEventFilterClear);\n\n      // Define events to edit mode\n      if (!readOnly) {\n        $(htmlContent).on(\"click\", \".button-category[data-own='true']\", function (e) {\n          if (readOnly) {\n            return;\n          }\n          if (e.isPropagationStopped()) {\n            return;\n          }\n          e.stopPropagation();\n          var self = this;\n          showDropDownMenu({\n            referer: self,\n            name: 'setCategories',\n            css: 'setCategories',\n            idComment: $(self).data('id'),\n            position: {\n              \"my\": \"right top\",\n              \"at\": \"left bottom\",\n              \"collision\": \"fit\",\n              \"of\": self } });\n\n\n        });\n\n        $(htmlContent).on('click', \".button-reply\", function (e) {\n          if (e.isPropagationStopped())\n          return;\n\n          var id = $(this).data(\"id\");\n          var textForReply = $(\"li[data-id='\" + id + \"'] .comment-text\").first().text();\n\n          // Set data to active reply functionality\n          $(\".comments-text-box li:first-child\").data('reply-mode', 'true');\n          $(\".comments-text-box li:first-child\").data('id', id);\n\n          // Set text to reply\n          $(\".text-to-reply\").text(textForReply);\n          $(\".text-to-reply\").show();\n\n          $(\".comments-text-box textarea\").focus();\n          $(\".comments-text-box\").addClass('comments-reply-box');\n          $(\".comments-text-box li:first-child\").show().slideDown('fast');\n          $(\".make-new-comments\").hide();\n          $(\".action-buttons\").show().slideDown('fast');\n          e.stopPropagation();\n        });\n\n        $(htmlContent).on(\"click\", \".button-delete\", function (e) {\n          //if (e.isPropagationStopped()) return;\n          //e.stopPropagation();\n          var li = $(this).parents('li:first');\n          var liId = $(this).data('id');\n          var parent = li.parent();\n\n          $.tmpl(self.commentsConfirm).dialog({\n            resizable: true,\n            modal: true,\n            title: self.getResource(\"workportal-widget-comments-title\"),\n            buttons: [\n            {\n              text: self.getResource(\"workportal-widget-comments-delete\"),\n              click: function click() {\n                // Call service\n                // Check if its reply or comment\n                if (parent.hasClass('reply-list')) {\n                  var idComment = li.parents('li:first').data('id');\n                  $.when(self.dataService.removeReply({\n                    idCase: getIdCase,\n                    idComment: idComment,\n                    idReply: liId }).\n                  done(function (state) {\n                    evalState(state);\n                  }));\n                } else {\n                  $.when(self.dataService.removeComment({\n                    idCase: getIdCase,\n                    idComment: liId }).\n                  done(function (state) {\n                    evalState(state);\n                  }));\n                }\n\n                var evalState = function evalState(state) {\n                  if (state.action) {\n                    $.when(li.hide('highlight', 'fast')).\n                    done(function () {\n                      li.remove();\n                      if (parent.hasClass('reply-list')) {\n                        parent.find('li').hide();\n                        parent.find('li:last').show();\n                        replyToggle(parent.parents('li:first'));\n                      }\n                    });\n                  } else {\n                    alert(state.message);\n                  }\n                };\n\n                // Close dialog and menu\n                $(this).dialog(\"close\");\n                bizagi.workportal.desktop.popup.closePopupInstance();\n              } },\n\n            {\n              text: self.getResource(\"workportal-widget-comments-cancel\"),\n              click: function click() {\n                $(this).dialog(\"close\");\n              } }] });\n\n\n\n        });\n      }\n\n      // Hide replies if it has more than one\n      var hideAllReplies = function hideAllReplies() {\n        $.each($(\".reply-list\", htmlContent), function () {\n          var replyToggleBotton = $(\".reply-toggler\", $(this).parents(\"li:first\"));\n          if ($(\"li\", this).length > 1) {\n            $(this).children('li:not(:last)').hide();\n            replyToggleBotton.removeClass('hidden');\n          } else {\n            replyToggleBotton.addClass('hidden');\n          }\n        });\n      };\n\n      // Show replies if it does been hidden\n      $(htmlContent).on('click', \".reply-toggler\", function (e) {\n        if (e.isPropagationStopped())\n        return;\n        e.stopPropagation();\n        //Define show and hide actions\n        if ($(this).data('toggle-action') != \"hide\") {\n          // Show list\n          showReplies($(this).parent().find(\"ul\"));\n          $(\"span\", this).addClass(\"expanded\");\n          $(this).data('toggle-action', 'hide');\n        } else {\n          // Show replies\n          hideReplies($(this).parent().find(\"ul\"));\n          $(\"span\", this).removeClass(\"expanded\");\n          $(this).data('toggle-action', 'show');\n        }\n      });\n\n      hideAllReplies();\n      htmlContent.appendTo(commentsCanvas);\n\n      setPagination({\n        totalPages: comments.totalPages,\n        actualPage: comments.actualPage },\n      $('.comments-pagination'));\n\n      def.resolve(commentsCanvas);\n    });\n\n    return def.promise();\n  },\n  getComments: function getComments(options, callBack) {\n    var self = this;\n    var def = new $.Deferred();\n    options = options || {};\n    callBack = callBack || function () {\n    };\n    $.when(self.dataService.getComments(options)).\n    done(function (comments) {\n      callBack(comments);\n      def.resolve(comments);\n    });\n    return def.promise();\n  },\n  replaceTextToSmiles: function replaceTextToSmiles(message) {\n    var parseMessage = message;\n    var preParseMessage = \"\";\n    var securityPatterns = {\n      \"<br>\": \"\\n\",\n      \"[<]\": \"&lt;\",\n      \"[>]\": \"&gt;\" };\n\n    var patterns = {\n      \":)\": \"smiley\",\n      \":!\": \"sarcastic\",\n      \":$\": \"embarrassed\",\n      \":(\": \"sad\",\n      \":'(\": \"cry\",\n      \";)\": \"wink\",\n      \":|\": \"disappointed\",\n      \":D\": \"happy\",\n      \":o\": \"surprise\",\n      \":p\": \"tongue\",\n      \":s\": \"confused\",\n      \" Y \": \"yes\",\n      \" N \": \"no\" };\n\n\n    // Check XSS injection\n    while (preParseMessage != parseMessage) {\n      $.each(securityPatterns, function (key, value) {\n        var pattern = new RegExp(key, \"gm\");\n        preParseMessage = parseMessage;\n        parseMessage = parseMessage.replace(pattern, value, \"gm\");\n      });\n    }\n\n    $.each(patterns, function (key, value) {\n      var scapeKey = key.replace(/[\\-\\[\\]\\/\\{\\}\\(\\)\\*\\+\\?\\.\\\\\\^\\$\\|]/g, \"\\\\$&\");\n      var pattern = new RegExp(scapeKey);\n      var label = \"<div class='smiles \" + value + \"'></div>\";\n      parseMessage = parseMessage.replace(pattern, label, \"g\");\n    });\n\n    return parseMessage;\n  },\n  setStorage: function setStorage(key, value) {\n    var result = \"\";\n    key = key || \"\";\n\n    if (sessionStorage) {\n      result = sessionStorage.setItem(key, value);\n    }\n    return result;\n  },\n  incrementStorage: function incrementStorage(key, increment) {\n    var result = true;\n    var self = this;\n    if (sessionStorage) {\n      var newValue = parseInt(self.getStorage(key)) + parseInt(increment);\n      self.setStorage(key, newValue);\n    } else {\n      result = false;\n    }\n    return result;\n  },\n  getStorage: function getStorage(key) {\n    var result = undefined;\n    key = key || \"\";\n\n    if (sessionStorage) {\n      result = sessionStorage.getItem(key);\n    }\n    return result;\n  } };"]}